(()=>{"use strict";var t={621:(t,e,i)=>{t.exports=i.p+"9f86b5397894e28b5ae2.wasm"}},e={};function i(s){var a=e[s];if(void 0!==a)return a.exports;var r=e[s]={exports:{}};return t[s](r,r.exports,i),r.exports}i.m=t,i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.p="/Client2/",i.b=document.baseURI||self.location.href,(()=>{class t{id=-1;debugname=null;decodeType=(t,e)=>{for(this.id=t;;){const i=e.g1;if(0===i)break;this.decode(t,i,e)}}}const e=async t=>new Promise((e=>setTimeout(e,t))),s=async t=>new Int8Array(await(await fetch(t)).arrayBuffer()),a=(t,e,i,s,a)=>{for(;a--;)i[s++]=t[e++]};class r{id;prev;next;constructor(){this.id=0,this.prev=this,this.next=this}unlink=()=>{this.next&&this.prev&&(this.next.prev=this.prev,this.prev.next=this.next,this.prev=null,this.next=null)}}class n{head;peeked=null;constructor(){const t=new r;t.prev=t,t.next=t,this.head=t}pushBack=t=>{t.next&&t.unlink(),t.next=this.head.next,t.prev=this.head,t.next&&(t.next.prev=t),t.prev.next=t};pushFront=t=>{t.next&&t.unlink(),t.next=this.head,t.prev=this.head.prev,t.next.prev=t,t.prev&&(t.prev.next=t)};pollFront=()=>{const t=this.head.prev;return t===this.head?null:(t?.unlink(),t)};peekFront=()=>{const t=this.head.prev;return t===this.head?(this.peeked=null,null):(this.peeked=t?.prev||null,t)};peekBack=()=>{const t=this.head.next;return t===this.head?(this.peeked=null,null):(this.peeked=t?.next||null,t)};prev=()=>{const t=this.peeked;return t===this.head?(this.peeked=null,null):(this.peeked=t?.prev||null,t)};next=()=>{const t=this.peeked;return t===this.head?(this.peeked=null,null):(this.peeked=t?.next||null,t)};clear=()=>{for(;;){const t=this.head.prev;if(t===this.head)return;t?.unlink()}}}class h extends r{nextHashable;prevHashable;constructor(){super(),this.nextHashable=this,this.prevHashable=this}uncache=()=>{this.prevHashable&&this.nextHashable&&(this.prevHashable.nextHashable=this.nextHashable,this.nextHashable.prevHashable=this.prevHashable,this.nextHashable=null,this.prevHashable=null)}}class o extends h{static CRC32_POLYNOMIAL=3988292384;static crctable=new Int32Array(256);static bitmask=new Uint32Array(33);static cacheMin=new n;static cacheMid=new n;static cacheMax=new n;static cacheMinCount=0;static cacheMidCount=0;static cacheMaxCount=0;static{for(let t=0;t<32;t++)o.bitmask[t]=(1<<t)-1;o.bitmask[32]=4294967295;for(let t=0;t<256;t++){let e=t;for(let t=0;t<8;t++)1==(1&e)?e=e>>>1^o.CRC32_POLYNOMIAL:e>>>=1;o.crctable[t]=e}}static crc32=t=>{let e=4294967295;for(let i=0;i<t.length;i++)e=e>>>8^o.crctable[255&(e^t[i])];return~e};data;pos;bitPos=0;random=null;constructor(t){if(!t)throw new Error("Input src packet array was null!");super(),this.data=t,this.pos=0}static alloc=t=>{let e=null;return 0===t&&o.cacheMinCount>0?(o.cacheMinCount--,e=o.cacheMin.pollFront()):1===t&&o.cacheMidCount>0?(o.cacheMidCount--,e=o.cacheMid.pollFront()):2===t&&o.cacheMaxCount>0&&(o.cacheMaxCount--,e=o.cacheMax.pollFront()),e?(e.pos=0,e):new o(0===t?new Uint8Array(100):1===t?new Uint8Array(5e3):new Uint8Array(3e4))};release=()=>{this.pos=0,100===this.data.length&&o.cacheMinCount<1e3?(o.cacheMin.pushBack(this),o.cacheMinCount++):5e3===this.data.length&&o.cacheMidCount<250?(o.cacheMid.pushBack(this),o.cacheMidCount++):3e4===this.data.length&&o.cacheMaxCount<50&&(o.cacheMax.pushBack(this),o.cacheMaxCount++)};get g1(){return this.data[this.pos++]}get g1b(){return this.data[this.pos++]<<24>>24}get g2(){return this.data[this.pos++]<<8|this.data[this.pos++]}get g2b(){let t=this.data[this.pos++]<<8|this.data[this.pos++];return t>32767&&(t-=65536),t}get g3(){return this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]}get g4(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]}get g8(){return(0xffffffffn&BigInt(this.g4))<<32n|0xffffffffn&BigInt(this.g4)}get gsmart(){return this.data[this.pos]<128?this.g1-64:this.g2-49152}get gsmarts(){return this.data[this.pos]<128?this.g1:this.g2-32768}get gjstr(){let t="";for(;10!==this.data[this.pos]&&this.pos<this.data.length;)t+=String.fromCharCode(this.data[this.pos++]);return this.pos++,t}gdata=(t,e,i)=>{for(let s=e;s<e+t;s++)i[s]=this.data[this.pos++]};p1isaac=t=>{this.data[this.pos++]=t+(this.random?.nextInt??0)&255};p1=t=>{this.data[this.pos++]=t};p2=t=>{this.data[this.pos++]=t>>>8,this.data[this.pos++]=t};ip2=t=>{this.data[this.pos++]=t,this.data[this.pos++]=t>>>8};p3=t=>{this.data[this.pos++]=t>>>16,this.data[this.pos++]=t>>>8,this.data[this.pos++]=t};p4=t=>{this.data[this.pos++]=t>>>24,this.data[this.pos++]=t>>>16,this.data[this.pos++]=t>>>8,this.data[this.pos++]=t};ip4=t=>{this.data[this.pos++]=t,this.data[this.pos++]=t>>>8,this.data[this.pos++]=t>>>16,this.data[this.pos++]=t>>>24};p8=t=>{this.p4(Number(t>>32n)),this.p4(Number(0xffffffffn&t))};pjstr=t=>{for(let e=0;e<t.length;e++)this.data[this.pos++]=t.charCodeAt(e);this.data[this.pos++]=10};pdata=(t,e,i)=>{for(let s=i;s<i+e;s++)this.data[this.pos++]=t[s]};psize1=t=>{this.data[this.pos-t-1]=t};bits=()=>{this.bitPos=8*this.pos};bytes=()=>{this.pos=Math.trunc((this.bitPos+7)/8)};gBit=t=>{let e=this.bitPos>>>3,i=8-(7&this.bitPos),s=0;for(this.bitPos+=t;t>i;i=8)s+=(this.data[e++]&o.bitmask[i])<<t-i,t-=i;return s+=t===i?this.data[e]&o.bitmask[i]:this.data[e]>>>i-t&o.bitmask[t],s};rsaenc=(t,e)=>{const i=new Uint8Array(this.pos);a(this.data,0,i,0,this.pos);const s=(t=>{const e=[];for(;t>BigInt(0);)e.unshift(Number(t&BigInt(255))),t>>=BigInt(8);return new Uint8Array(e)})(((t,e,i)=>{let s=BigInt(1);for(;e>BigInt(0);)e%BigInt(2)===BigInt(1)&&(s=s*t%i),t=t*t%i,e>>=BigInt(1);return s})((t=>{let e=BigInt(0);for(let i=0;i<t.length;i++)e=(e<<BigInt(8))+BigInt(t[i]);return e})(i),e,t));this.pos=0,this.p1(s.length),this.pdata(s,s.length,0)}}class l{static instances=[];static unpack=t=>{const e=new o(t.read("base_head.dat")),i=new o(t.read("base_type.dat")),s=new o(t.read("base_label.dat")),a=e.g2;e.pos+=2;for(let t=0;t<a;t++){const t=e.g2,a=e.g1,r=new Uint8Array(a),n=new Array(a);for(let t=0;t<a;t++){r[t]=i.g1;const e=s.g1;n[t]=new Uint8Array(e);for(let i=0;i<e;i++)n[t][i]=s.g1}this.instances[t]=new l,this.instances[t].length=a,this.instances[t].types=r,this.instances[t].labels=n}};length=0;types=null;labels=null}class c{static instances=[];static unpack=t=>{const e=new o(t.read("frame_head.dat")),i=new o(t.read("frame_tran1.dat")),s=new o(t.read("frame_tran2.dat")),a=new o(t.read("frame_del.dat")),r=e.g2;e.pos+=2;const n=new Int32Array(500),h=new Int32Array(500),d=new Int32Array(500),f=new Int32Array(500);for(let t=0;t<r;t++){const t=e.g2,r=this.instances[t]=new c;r.delay=a.g1;const o=e.g2,u=l.instances[o];r.base=u;const p=e.g1;let m=-1,g=0;for(let t=0;t<p;t++){if(!u.types)throw new Error("SeqBase not loaded!!!");const e=i.g1;if(e>0){if(0!==u.types[t])for(let e=t-1;e>m;e--)if(0===u.types[e]){n[g]=e,h[g]=0,d[g]=0,f[g]=0,g++;break}n[g]=t;let i=0;3===u.types[n[g]]&&(i=128),h[g]=0==(1&e)?i:s.gsmart,d[g]=0==(2&e)?i:s.gsmart,f[g]=0==(4&e)?i:s.gsmart,m=t,g++}}r.length=g,r.bases=new Int32Array(g),r.x=new Int32Array(g),r.y=new Int32Array(g),r.z=new Int32Array(g);for(let t=0;t<g;t++)r.bases[t]=n[t],r.x[t]=h[t],r.y[t]=d[t],r.z[t]=f[t]}};delay=0;base=null;length=0;bases=null;x=null;y=null;z=null}class d extends t{static count=0;static instances=[];static unpack=t=>{const e=new o(t.read("seq.dat"));this.count=e.g2;for(let t=0;t<this.count;t++)this.instances[t]=new d,this.instances[t].decodeType(t,e)};frameCount=0;frames=null;iframes=null;delay=null;replayoff=-1;labelGroups=null;stretches=!1;priority=5;mainhand=-1;offhand=-1;replaycount=99;duration=0;decode=(t,e,i)=>{if(1===e){this.frameCount=i.g1,this.frames=new Int16Array(this.frameCount),this.iframes=new Int16Array(this.frameCount),this.delay=new Int16Array(this.frameCount);for(let t=0;t<this.frameCount;t++)this.frames[t]=i.g2,this.iframes[t]=i.g2,65535===this.iframes[t]&&(this.iframes[t]=-1),this.delay[t]=i.g2,0===this.delay[t]&&(this.delay[t]=c.instances[this.frames[t]].delay),0===this.delay[t]&&(this.delay[t]=1),this.duration+=this.delay[t]}else if(2===e)this.replayoff=i.g2;else if(3===e){const t=i.g1;this.labelGroups=new Int32Array(t+1);for(let e=0;e<t;e++)this.labelGroups[e]=i.g1;this.labelGroups[t]=9999999}else if(4===e)this.stretches=!0;else if(5===e)this.priority=i.g1;else if(6===e)this.mainhand=i.g2;else if(7===e)this.offhand=i.g2;else{if(8!==e)throw new Error(`Unrecognized seq config code: ${e}`);this.replaycount=i.g1}}}class f{head;constructor(){this.head=new h}push=t=>{t.prevHashable&&t.uncache(),t.prevHashable=this.head.prevHashable,t.nextHashable=this.head,t.prevHashable&&(t.prevHashable.nextHashable=t),t.nextHashable.prevHashable=t};pop=()=>{const t=this.head.nextHashable;return t===this.head?null:(t?.uncache(),t)}}class u{size;nodes;constructor(t){this.size=t,this.nodes=[];for(let e=0;e<t;e++)this.nodes[e]=new r}get=t=>{const e=this.nodes[t&this.size-1];if(!e.prev)return null;for(let i=e.prev;i!==e;i=i.prev)if(i&&i.id===t)return i;return null};put=(t,e)=>{e.next&&e.unlink();const i=this.nodes[t&this.size-1];e.next=i.next,e.prev=i,e.next&&(e.next.prev=e),e.prev.next=e,e.id=t}}class p{capacity;hashtable;history;available;constructor(t){this.capacity=t,this.available=t,this.hashtable=new u(1024),this.history=new f}get=t=>{const e=this.hashtable.get(t);return e&&this.history.push(e),e};put=(t,e)=>{if(0===this.available){const t=this.history.pop();t?.unlink(),t?.uncache()}else this.available--;this.hashtable.put(t,e),this.history.push(e)};clear=()=>{const t=this.history.pop();t?(t.unlink(),t.uncache()):this.available=this.capacity}}class m extends t{static count=0;static cache=null;static dat=null;static offsets=null;static cachePos=0;static modelCacheStatic=new p(500);static modelCacheDynamic=new p(30);static unpack=t=>{this.dat=new o(t.read("loc.dat"));const e=new o(t.read("loc.idx"));this.count=e.g2,this.offsets=new Int32Array(this.count);let i=2;for(let t=0;t<this.count;t++)this.offsets[t]=i,i+=e.g2;this.cache=new Array(10);for(let t=0;t<10;t++)this.cache[t]=new m};static get=t=>{if(!this.cache||!this.offsets||!this.dat)throw new Error("LocType not loaded!!!");for(let e=0;e<10;e++)if(this.cache[e].index===t)return this.cache[e];this.cachePos=(this.cachePos+1)%10;const e=this.cache[this.cachePos];return this.dat.pos=this.offsets[t],e.index=t,e.reset(),e.decodeType(t,this.dat),e};static unload=()=>{this.modelCacheStatic=null,this.modelCacheDynamic=null,this.offsets=null,this.cache=null,this.dat=null};index=-1;models=null;shapes=null;name=null;desc=null;recol_s=null;recol_d=null;width=1;length=1;blockwalk=!0;blockrange=!0;active=-1;hillskew=!1;sharelight=!1;occlude=!1;anim=-1;disposeAlpha=!1;walloff=16;ambient=0;contrast=0;ops=[];mapfunction=-1;mapscene=-1;mirror=!1;shadow=!0;resizex=128;resizey=128;resizez=128;forceapproach=0;xoff=0;yoff=0;zoff=0;forcedecor=!1;decode=(t,e,i)=>{if(1===e){const t=i.g1;this.models=new Uint16Array(t),this.shapes=new Uint8Array(t);for(let e=0;e<t;e++)this.models[e]=i.g2,this.shapes[e]=i.g1}else if(2===e)this.name=i.gjstr;else if(3===e)this.desc=i.gjstr;else if(14===e)this.width=i.g1;else if(15===e)this.length=i.g1;else if(17===e)this.blockwalk=!1;else if(18===e)this.blockrange=!1;else if(19===e)this.active=i.g1;else if(21===e)this.hillskew=!0;else if(22===e)this.sharelight=!0;else if(23===e)this.occlude=!0;else if(24===e)this.anim=i.g2,65535===this.anim&&(this.anim=-1);else if(25===e)this.disposeAlpha=!0;else if(28===e)this.walloff=i.g1;else if(29===e)this.ambient=i.g1b;else if(39===e)this.contrast=i.g1b;else if(e>=30&&e<35)this.ops[e-30]=i.gjstr,"hidden"===this.ops[e-30]&&(this.ops[e-30]=null);else if(40===e){const t=i.g1;this.recol_s=new Uint16Array(t),this.recol_d=new Uint16Array(t);for(let e=0;e<t;e++)this.recol_s[e]=i.g2,this.recol_d[e]=i.g2}else 60===e?this.mapfunction=i.g2:62===e?this.mirror=!0:64===e?this.shadow=!1:65===e?this.resizex=i.g2:66===e?this.resizey=i.g2:67===e?this.resizez=i.g2:68===e?this.mapscene=i.g2:69===e?this.forceapproach=i.g1:70===e?this.xoff=i.g2b:71===e?this.yoff=i.g2b:72===e?this.zoff=i.g2b:73===e&&(this.forcedecor=!0)};reset=()=>{this.models=null,this.shapes=null,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.width=1,this.length=1,this.blockwalk=!0,this.blockrange=!0,this.active=0,this.hillskew=!1,this.sharelight=!1,this.occlude=!1,this.anim=-1,this.walloff=16,this.ambient=0,this.contrast=0,this.ops=[],this.disposeAlpha=!1,this.mapfunction=-1,this.mapscene=-1,this.mirror=!1,this.shadow=!0,this.resizex=128,this.resizey=128,this.resizez=128,this.forceapproach=0,this.xoff=0,this.yoff=0,this.zoff=0,this.forcedecor=!1}}class g extends t{static count=0;static instances=[];static unpack=t=>{const e=new o(t.read("flo.dat"));this.count=e.g2;for(let t=0;t<this.count;t++)this.instances[t]=new g,this.instances[t].decodeType(t,e)};rgb=0;texture=-1;opcode3=!1;occludes=!0;name=null;decode=(t,e,i)=>{1===e?this.rgb=i.g3:2===e?this.texture=i.g1:3===e?this.opcode3=!0:5===e?this.occludes=!1:6===e?this.name=i.gjstr:console.log("Error unrecognised config code: ",e)}}class w{static pixels=new Int32Array;static width=0;static height=0;static top=0;static bottom=0;static left=0;static right=0;static boundX=0;static centerX=0;static centerY=0;static bind=(t,e,i)=>{this.pixels=t,this.width=e,this.height=i,this.setBounds(0,0,e,i)};static resetBounds=()=>{this.left=0,this.top=0,this.right=this.width,this.bottom=this.height,this.boundX=this.right-1,this.centerX=Math.trunc(this.right/2)};static setBounds=(t,e,i,s)=>{t<0&&(t=0),e<0&&(e=0),i>this.width&&(i=this.width),s>this.height&&(s=this.height),this.top=e,this.bottom=s,this.left=t,this.right=i,this.boundX=this.right-1,this.centerX=Math.trunc(this.right/2),this.centerY=Math.trunc(this.bottom/2)};static clear=()=>{this.pixels.fill(0)};static drawRect=(t,e,i,s,a)=>{this.drawHorizontalLine(t,e,a,i),this.drawHorizontalLine(t,e+s-1,a,i),this.drawVerticalLine(t,e,a,s),this.drawVerticalLine(t+i-1,e,a,s)};static drawHorizontalLine=(t,e,i,s)=>{if(e<this.top||e>=this.bottom)return;t<this.left&&(s-=this.left-t,t=this.left),t+s>this.right&&(s=this.right-t);const a=t+e*this.width;for(let t=0;t<s;t++)this.pixels[a+t]=i};static drawVerticalLine=(t,e,i,s)=>{if(t<this.left||t>=this.right)return;e<this.top&&(s-=this.top-e,e=this.top),e+s>this.bottom&&(s=this.bottom-e);const a=t+e*this.width;for(let t=0;t<s;t++)this.pixels[a+t*this.width]=i};static drawLine=(t,e,i,s,a)=>{const r=Math.abs(i-t),n=Math.abs(s-e),h=t<i?1:-1,o=e<s?1:-1;let l=r-n;for(;t>=this.left&&t<this.right&&e>=this.top&&e<this.bottom&&(this.pixels[t+e*this.width]=a),t!==i||e!==s;){const i=2*l;i>-n&&(l-=n,t+=h),i<r&&(l+=r,e+=o)}};static fillRect=(t,e,i,s,a)=>{t<this.left&&(i-=this.left-t,t=this.left),e<this.top&&(s-=this.top-e,e=this.top),t+i>this.right&&(i=this.right-t),e+s>this.bottom&&(s=this.bottom-e);const r=this.width-i;let n=t+e*this.width;for(let t=-s;t<0;t++){for(let t=-i;t<0;t++)this.pixels[n++]=a;n+=r}}}const y=document.getElementById("canvas"),C=y.getContext("2d",{willReadFrequently:!0}),b=document.createElement("canvas"),S=document.createElement("img"),T=b.getContext("2d",{willReadFrequently:!0});class v extends h{pixels;width;height;cropX;cropY;cropW;cropH;constructor(t,e){super(),this.pixels=new Int32Array(t*e),this.width=this.cropW=t,this.height=this.cropH=e,this.cropX=this.cropY=0}static fromJpeg=async(t,e)=>{const i=t.read(e+".dat");if(!i)throw new Error(`${e} jpeg not found!`);const s=await(async t=>{255!==t[0]&&(t[0]=255),URL.revokeObjectURL(S.src),S.src=URL.createObjectURL(new Blob([t],{type:"image/jpeg"})),await new Promise((t=>S.onload=()=>t())),T.clearRect(0,0,b.width,b.height);const e=S.naturalWidth,i=S.naturalHeight;return b.width=e,b.height=i,T.drawImage(S,0,0),T.getImageData(0,0,e,i)})(i),a=new v(s.width,s.height),r=a.pixels,n=s.data;for(let t=0;t<r.length;t++){const e=4*t;r[t]=n[e+3]<<24|n[e]<<16|n[e+1]<<8|n[e+2]<<0}return a};static fromArchive=(t,e,i=0)=>{const s=new o(t.read(e+".dat")),a=new o(t.read("index.dat"));a.pos=s.g2;const r=a.g2,n=a.g2,h=[],l=a.g1-1;for(let t=0;t<l;t++)h[t+1]=a.g3,0===h[t+1]&&(h[t+1]=1);for(let t=0;t<i;t++)a.pos+=2,s.pos+=a.g2*a.g2,a.pos+=1;const c=a.g1,d=a.g1,f=a.g2,u=a.g2,p=new v(f,u);p.cropX=c,p.cropY=d,p.cropW=r,p.cropH=n;const m=a.g1;if(0===m){const t=p.width*p.height;for(let e=0;e<t;e++)p.pixels[e]=h[s.g1]}else if(1===m){const t=p.width;for(let e=0;e<t;e++){const i=p.height;for(let a=0;a<i;a++)p.pixels[e+a*t]=h[s.g1]}}return p};draw=(t,e)=>{t=Math.trunc(t),e=Math.trunc(e);let i=(t+=this.cropX)+(e+=this.cropY)*w.width,s=0,a=this.height,r=this.width,n=w.width-r,h=0;if(e<w.top){const t=w.top-e;a-=t,e=w.top,s+=t*r,i+=t*w.width}if(e+a>w.bottom&&(a-=e+a-w.bottom),t<w.left){const e=w.left-t;r-=e,t=w.left,s+=e,i+=e,h+=e,n+=e}if(t+r>w.right){const e=t+r-w.right;r-=e,h+=e,n+=e}r>0&&a>0&&this.copyImageDraw(r,a,this.pixels,s,h,w.pixels,i,n)};drawAlpha=(t,e,i)=>{e=Math.trunc(e),i=Math.trunc(i);let s=(e+=this.cropX)+(i+=this.cropY)*w.width,a=0,r=this.height,n=this.width,h=w.width-n,o=0;if(i<w.top){const t=w.top-i;r-=t,i=w.top,a+=t*n,s+=t*w.width}if(i+r>w.bottom&&(r-=i+r-w.bottom),e<w.left){const t=w.left-e;n-=t,e=w.left,a+=t,s+=t,o+=t,h+=t}if(e+n>w.right){const t=e+n-w.right;n-=t,o+=t,h+=t}n>0&&r>0&&this.copyPixelsAlpha(n,r,this.pixels,a,o,w.pixels,s,h,t)};blitOpaque=(t,e)=>{t=Math.trunc(t),e=Math.trunc(e);let i=(t+=this.cropX)+(e+=this.cropY)*w.width,s=0,a=this.height,r=this.width,n=w.width-r,h=0;if(e<w.top){const t=w.top-e;a-=t,e=w.top,s+=t*r,i+=t*w.width}if(e+a>w.bottom&&(a-=e+a-w.bottom),t<w.left){const e=w.left-t;r-=e,t=w.left,s+=e,i+=e,h+=e,n+=e}if(t+r>w.right){const e=t+r-w.right;r-=e,h+=e,n+=e}r>0&&a>0&&this.copyImageBlitOpaque(r,a,this.pixels,s,h,w.pixels,i,n)};flipHorizontally=()=>{const t=this.pixels,e=this.width,i=this.height;for(let s=0;s<i;s++){const i=e/2;for(let a=0;a<i;a++){const i=a+s*e,r=e-a-1+s*e,n=t[i];t[i]=t[r],t[r]=n}}};flipVertically=()=>{const t=this.pixels,e=this.width,i=this.height;for(let s=0;s<i/2;s++)for(let a=0;a<e;a++){const r=a+s*e,n=a+(i-s-1)*e,h=t[r];t[r]=t[n],t[n]=h}};translate=(t,e,i)=>{for(let s=0;s<this.pixels.length;s++){const a=this.pixels[s];if(0!==a){let r=a>>16&255;r+=t,r<1?r=1:r>255&&(r=255);let n=a>>8&255;n+=e,n<1?n=1:n>255&&(n=255);let h=255&a;h+=i,h<1?h=1:h>255&&(h=255),this.pixels[s]=(r<<16)+(n<<8)+h}}};crop=(t,e,i,s)=>{t=Math.trunc(t),e=Math.trunc(e),i=Math.trunc(i),s=Math.trunc(s);try{const a=this.width;let r=0,n=0;const h=this.cropW,o=this.cropH,l=Math.trunc((h<<16)/i),c=Math.trunc((o<<16)/s);t+=Math.trunc((this.cropX*i+h-1)/h),e+=Math.trunc((this.cropY*s+o-1)/o),this.cropX*i%h!=0&&(r=Math.trunc((h-this.cropX*i%h<<16)/i)),this.cropY*s%o!=0&&(n=Math.trunc((o-this.cropY*s%o<<16)/s)),i=Math.trunc(i*(this.width-(r>>16))/h),s=Math.trunc(s*(this.height-(n>>16))/o);let d=t+e*w.width,f=w.width-i;if(e<w.top){const t=w.top-e;s-=t,e=0,d+=t*w.width,n+=c*t}if(e+s>w.bottom&&(s-=e+s-w.bottom),t<w.left){const e=w.left-t;i-=e,t=0,d+=e,r+=l*e,f+=e}if(t+i>w.right){const e=t+i-w.right;i-=e,f+=e}this.scale(i,s,this.pixels,r,n,w.pixels,f,d,a,l,c)}catch(t){console.error("error in sprite clipping routine")}};scale=(t,e,i,s,a,r,n,h,o,l,c)=>{try{const d=s;for(let f=-e;f<0;f++){const e=(a>>16)*o;for(let a=-t;a<0;a++){const t=i[(s>>16)+e];0===t?h++:r[h++]=t,s+=l}a+=c,s=d,h+=n}}catch(t){console.error("error in plot_scale")}};copyImageBlitOpaque=(t,e,i,s,a,r,n,h)=>{const o=-(t>>2);t=-(3&t);for(let l=-e;l<0;l++){for(let t=o;t<0;t++)r[n++]=i[s++],r[n++]=i[s++],r[n++]=i[s++],r[n++]=i[s++];for(let e=t;e<0;e++)r[n++]=i[s++];n+=h,s+=a}};copyPixelsAlpha=(t,e,i,s,a,r,n,h,o)=>{const l=256-o;for(let c=-e;c<0;c++){for(let e=-t;e<0;e++){const t=i[s++];if(0===t)n++;else{const e=r[n];r[n++]=((16711935&t)*o+(16711935&e)*l&4278255360)+((65280&t)*o+(65280&e)*l&16711680)>>8}}n+=h,s+=a}};copyImageDraw=(t,e,i,s,a,r,n,h)=>{const o=-(t>>2);t=-(3&t);for(let l=-e;l<0;l++){for(let t=o;t<0;t++){let t=i[s++];0===t?n++:r[n++]=t,t=i[s++],0===t?n++:r[n++]=t,t=i[s++],0===t?n++:r[n++]=t,t=i[s++],0===t?n++:r[n++]=t}for(let e=t;e<0;e++){const t=i[s++];0===t?n++:r[n++]=t}n+=h,s+=a}}}class x extends h{pixels;width;height;cropX;cropY;cropW;cropH;palette;constructor(t,e,i){super(),this.pixels=new Int8Array(t*e),this.width=this.cropW=t,this.height=this.cropH=e,this.cropX=this.cropY=0,this.palette=i}static fromArchive=(t,e,i=0)=>{const s=new o(t.read(e+".dat")),a=new o(t.read("index.dat"));a.pos=s.g2;const r=a.g2,n=a.g2,h=a.g1,l=new Int32Array(h);for(let t=1;t<h;t++)l[t]=a.g3,0===l[t]&&(l[t]=1);for(let t=0;t<i;t++)a.pos+=2,s.pos+=a.g2*a.g2,a.pos+=1;const c=a.g1,d=a.g1,f=a.g2,u=a.g2,p=new x(f,u,l);p.cropX=c,p.cropY=d,p.cropW=r,p.cropH=n;const m=p.pixels,g=a.g1;if(0===g){const t=p.width*p.height;for(let e=0;e<t;e++)m[e]=s.g1b}else if(1===g){const t=p.width,e=p.height;for(let i=0;i<t;i++)for(let a=0;a<e;a++)m[i+a*t]=s.g1b}return p};draw=(t,e,i=-1,s=-1)=>{t=Math.trunc(t),e=Math.trunc(e),i=Math.trunc(i),s=Math.trunc(s);let a=(t+=this.cropX)+(e+=this.cropY)*w.width,r=0,n=this.height,h=this.width;-1!==i&&(h=i),-1!==s&&(n=s);let o=w.width-h,l=0;if(e<w.top){const t=w.top-e;n-=t,e=w.top,r+=t*h,a+=t*w.width}if(e+n>w.bottom&&(n-=e+n-w.bottom),t<w.left){const e=w.left-t;h-=e,t=w.left,r+=e,a+=e,l+=e,o+=e}if(t+h>w.right){const e=t+h-w.right;h-=e,l+=e,o+=e}h>0&&n>0&&this.copyImage(h,n,this.pixels,r,l,w.pixels,a,o)};flipHorizontally=()=>{const t=this.pixels,e=this.width,i=this.height;for(let s=0;s<i;s++){const i=e/2;for(let a=0;a<i;a++){const i=a+s*e,r=e-a-1+s*e,n=t[i];t[i]=t[r],t[r]=n}}};flipVertically=()=>{const t=this.pixels,e=this.width,i=this.height;for(let s=0;s<i/2;s++)for(let a=0;a<e;a++){const r=a+s*e,n=a+(i-s-1)*e,h=t[r];t[r]=t[n],t[n]=h}};translate=(t,e,i)=>{for(let s=0;s<this.palette.length;s++){let a=this.palette[s]>>16&255;a+=t,a<0?a=0:a>255&&(a=255);let r=this.palette[s]>>8&255;r+=e,r<0?r=0:r>255&&(r=255);let n=255&this.palette[s];n+=i,n<0?n=0:n>255&&(n=255),this.palette[s]=(a<<16)+(r<<8)+n}};shrink=()=>{this.cropW/=2,this.cropH/=2,this.cropW=Math.trunc(this.cropW),this.cropH=Math.trunc(this.cropH);const t=new Int8Array(this.cropW*this.cropH);let e=0;for(let i=0;i<this.height;i++)for(let s=0;s<this.width;s++)t[(s+this.cropX>>1)+(i+this.cropY>>1)*this.cropW]=this.pixels[e++];this.pixels=t,this.width=this.cropW,this.height=this.cropH,this.cropX=0,this.cropY=0};crop=()=>{if(this.width===this.cropW&&this.height===this.cropH)return;const t=new Int8Array(this.cropW*this.cropH);let e=0;for(let i=0;i<this.height;i++)for(let s=0;s<this.width;s++)t[s+this.cropX+(i+this.cropY)*this.cropW]=this.pixels[e++];this.pixels=t,this.width=this.cropW,this.height=this.cropH,this.cropX=0,this.cropY=0};copyImage=(t,e,i,s,a,r,n,h)=>{for(let o=0;o<e;o++){for(let e=0;e<t;e++){const a=e+o*t,h=i[s+a];0!==h&&(r[n+a]=this.palette[h])}s+=a,n+=h}}}class A{static lowMemory=!1;static reciprocal15=new Int32Array(512);static reciprocal16=new Int32Array(2048);static sin=new Int32Array(2048);static cos=new Int32Array(2048);static palette=new Uint32Array(65536);static textures=new Array(50);static textureCount=0;static lineOffset=new Int32Array;static centerX=0;static centerY=0;static jagged=!0;static clipX=!1;static alpha=0;static texelPool=null;static activeTexels=new Array(50);static poolSize=0;static cycle=0;static textureCycle=new Int32Array(50);static texturePalette=new Array(50);static opaque=!1;static textureTranslucent=new Array(50);static{for(let t=1;t<512;t++)this.reciprocal15[t]=Math.trunc(32768/t);for(let t=1;t<2048;t++)this.reciprocal16[t]=Math.trunc(65536/t);for(let t=0;t<2048;t++)this.sin[t]=Math.trunc(65536*Math.sin(.0030679615757712823*t)),this.cos[t]=Math.trunc(65536*Math.cos(.0030679615757712823*t))}static unload=()=>{};static init2D=()=>{this.lineOffset=new Int32Array(w.height);for(let t=0;t<w.height;t++)this.lineOffset[t]=w.width*t;this.centerX=Math.trunc(w.width/2),this.centerY=Math.trunc(w.height/2)};static init3D=(t,e)=>{this.lineOffset=new Int32Array(e);for(let i=0;i<e;i++)this.lineOffset[i]=t*i;this.centerX=Math.trunc(t/2),this.centerY=Math.trunc(e/2)};static clearTexels=()=>{this.texelPool=null;for(let t=0;t<50;t++)this.activeTexels[t]=null};static unpackTextures=t=>{this.textureCount=0;for(let e=0;e<50;e++)try{this.textures[e]=x.fromArchive(t,e.toString()),this.lowMemory&&128===this.textures[e].cropW?this.textures[e].shrink():this.textures[e].crop(),this.textureCount++}catch(t){}};static setBrightness=t=>{const e=t+.03*Math.random()-.015;let i=0;for(let t=0;t<512;t++){const s=Math.trunc(t/8)/64+.0078125,a=(7&t)/8+.0625;for(let t=0;t<128;t++){const r=t/128;let n=r,h=r,o=r;if(0!==a){let t;t=r<.5?r*(a+1):r+a-r*a;const e=2*r-t;let i=s+.3333333333333333;i>1&&i--;let l=s-.3333333333333333;l<0&&l++,n=6*i<1?e+6*(t-e)*i:2*i<1?t:3*i<2?e+(t-e)*(.6666666666666666-i)*6:e,h=6*s<1?e+6*(t-e)*s:2*s<1?t:3*s<2?e+(t-e)*(.6666666666666666-s)*6:e,o=6*l<1?e+6*(t-e)*l:2*l<1?t:3*l<2?e+(t-e)*(.6666666666666666-l)*6:e}const l=(Math.trunc(256*n)<<16)+(Math.trunc(256*h)<<8)+Math.trunc(256*o);this.palette[i++]=this.setGamma(l,e)}}for(let t=0;t<50;t++)if(this.textures[t]){const i=this.textures[t].palette;this.texturePalette[t]=new Int32Array(i.length);for(let s=0;s<i.length;s++){const a=this.texturePalette[t];a&&(a[s]=this.setGamma(i[s],e))}}for(let t=0;t<50;t++)this.pushTexture(t)};static setGamma=(t,e)=>{const i=(t>>16)/256,s=(t>>8&255)/256,a=(255&t)/256,r=Math.pow(i,e),n=Math.pow(s,e),h=Math.pow(a,e);return(Math.trunc(256*r)<<16)+(Math.trunc(256*n)<<8)+Math.trunc(256*h)};static initPool=t=>{if(!this.texelPool){this.poolSize=t,this.lowMemory?this.texelPool=new Array(this.poolSize).fill(null).map((()=>new Int32Array(16384))):this.texelPool=new Array(this.poolSize).fill(null).map((()=>new Int32Array(65536)));for(let t=0;t<50;t++)this.activeTexels[t]=null}};static fillGouraudTriangle=(t,e,i,s,a,r,n,h,o)=>{let l=0,c=0,d=0,f=0,u=0,p=0;if(a!==s&&(l=Math.trunc((e-t<<16)/(a-s)),f=Math.trunc((h-n<<15)/(a-s))),r!==a&&(c=Math.trunc((i-e<<16)/(r-a)),u=Math.trunc((o-h<<15)/(r-a))),r!==s&&(d=Math.trunc((t-i<<16)/(s-r)),p=Math.trunc((n-o<<15)/(s-r))),s<=a&&s<=r){if(s>=w.bottom)return;if(a>w.bottom&&(a=w.bottom),r>w.bottom&&(r=w.bottom),a<r){if(i=t<<=16,o=n<<=15,s<0&&(i-=d*s,t-=l*s,o-=p*s,n-=f*s,s=0),e<<=16,h<<=15,a<0&&(e-=c*a,h-=u*a,a=0),s!==a&&d<l||s===a&&d>c){for(r-=a,a-=s,s=this.lineOffset[s];--a>=0;s+=w.width)this.drawGouraudScanline(w.pixels,s,i>>16,t>>16,o>>7,n>>7),i+=d,t+=l,o+=p,n+=f;for(;--r>=0;)this.drawGouraudScanline(w.pixels,s,i>>16,e>>16,o>>7,h>>7),i+=d,e+=c,o+=p,h+=u,s+=w.width;return}for(r-=a,a-=s,s=this.lineOffset[s];--a>=0;s+=w.width)this.drawGouraudScanline(w.pixels,s,t>>16,i>>16,n>>7,o>>7),i+=d,t+=l,o+=p,n+=f;for(;--r>=0;)this.drawGouraudScanline(w.pixels,s,e>>16,i>>16,h>>7,o>>7),i+=d,e+=c,o+=p,h+=u,s+=w.width;return}if(e=t<<=16,h=n<<=15,s<0&&(e-=d*s,t-=l*s,h-=p*s,n-=f*s,s=0),i<<=16,o<<=15,r<0&&(i-=c*r,o-=u*r,r=0),s!==r&&d<l||s===r&&c>l){for(a-=r,r-=s,s=this.lineOffset[s];--r>=0;s+=w.width)this.drawGouraudScanline(w.pixels,s,e>>16,t>>16,h>>7,n>>7),e+=d,t+=l,h+=p,n+=f;for(;--a>=0;)this.drawGouraudScanline(w.pixels,s,i>>16,t>>16,o>>7,n>>7),i+=c,t+=l,o+=u,n+=f,s+=w.width;return}for(a-=r,r-=s,s=this.lineOffset[s];--r>=0;s+=w.width)this.drawGouraudScanline(w.pixels,s,t>>16,e>>16,n>>7,h>>7),e+=d,t+=l,h+=p,n+=f;for(;--a>=0;)this.drawGouraudScanline(w.pixels,s,t>>16,i>>16,n>>7,o>>7),i+=c,t+=l,o+=u,n+=f,s+=w.width}else if(a<=r){if(a>=w.bottom)return;if(r>w.bottom&&(r=w.bottom),s>w.bottom&&(s=w.bottom),r<s){if(t=e<<=16,n=h<<=15,a<0&&(t-=l*a,e-=c*a,n-=f*a,h-=u*a,a=0),i<<=16,o<<=15,r<0&&(i-=d*r,o-=p*r,r=0),a!==r&&l<c||a===r&&l>d){for(s-=r,r-=a,a=this.lineOffset[a];--r>=0;a+=w.width)this.drawGouraudScanline(w.pixels,a,t>>16,e>>16,n>>7,h>>7),t+=l,e+=c,n+=f,h+=u;for(;--s>=0;)this.drawGouraudScanline(w.pixels,a,t>>16,i>>16,n>>7,o>>7),t+=l,i+=d,n+=f,o+=p,a+=w.width;return}for(s-=r,r-=a,a=this.lineOffset[a];--r>=0;a+=w.width)this.drawGouraudScanline(w.pixels,a,e>>16,t>>16,h>>7,n>>7),t+=l,e+=c,n+=f,h+=u;for(;--s>=0;)this.drawGouraudScanline(w.pixels,a,i>>16,t>>16,o>>7,n>>7),t+=l,i+=d,n+=f,o+=p,a+=w.width;return}if(i=e<<=16,o=h<<=15,a<0&&(i-=l*a,e-=c*a,o-=f*a,h-=u*a,a=0),t<<=16,n<<=15,s<0&&(t-=d*s,n-=p*s,s=0),l<c){for(r-=s,s-=a,a=this.lineOffset[a];--s>=0;a+=w.width)this.drawGouraudScanline(w.pixels,a,i>>16,e>>16,o>>7,h>>7),i+=l,e+=c,o+=f,h+=u;for(;--r>=0;)this.drawGouraudScanline(w.pixels,a,t>>16,e>>16,n>>7,h>>7),t+=d,e+=c,n+=p,h+=u,a+=w.width;return}for(r-=s,s-=a,a=this.lineOffset[a];--s>=0;a+=w.width)this.drawGouraudScanline(w.pixels,a,e>>16,i>>16,h>>7,o>>7),i+=l,e+=c,o+=f,h+=u;for(;--r>=0;)this.drawGouraudScanline(w.pixels,a,e>>16,t>>16,h>>7,n>>7),t+=d,e+=c,n+=p,h+=u,a+=w.width}else if(!(r>=w.bottom))if(s>w.bottom&&(s=w.bottom),a>w.bottom&&(a=w.bottom),s<a){if(e=i<<=16,h=o<<=15,r<0&&(e-=c*r,i-=d*r,h-=u*r,o-=p*r,r=0),t<<=16,n<<=15,s<0&&(t-=l*s,n-=f*s,s=0),c<d){for(a-=s,s-=r,r=this.lineOffset[r];--s>=0;r+=w.width)this.drawGouraudScanline(w.pixels,r,e>>16,i>>16,h>>7,o>>7),e+=c,i+=d,h+=u,o+=p;for(;--a>=0;)this.drawGouraudScanline(w.pixels,r,e>>16,t>>16,h>>7,n>>7),e+=c,t+=l,h+=u,n+=f,r+=w.width;return}for(a-=s,s-=r,r=this.lineOffset[r];--s>=0;r+=w.width)this.drawGouraudScanline(w.pixels,r,i>>16,e>>16,o>>7,h>>7),e+=c,i+=d,h+=u,o+=p;for(;--a>=0;)this.drawGouraudScanline(w.pixels,r,t>>16,e>>16,n>>7,h>>7),e+=c,t+=l,h+=u,n+=f,r+=w.width}else if(t=i<<=16,n=o<<=15,r<0&&(t-=c*r,i-=d*r,n-=u*r,o-=p*r,r=0),e<<=16,h<<=15,a<0&&(e-=l*a,h-=f*a,a=0),c<d){for(s-=a,a-=r,r=this.lineOffset[r];--a>=0;r+=w.width)this.drawGouraudScanline(w.pixels,r,t>>16,i>>16,n>>7,o>>7),t+=c,i+=d,n+=u,o+=p;for(;--s>=0;)this.drawGouraudScanline(w.pixels,r,e>>16,i>>16,h>>7,o>>7),e+=l,i+=d,h+=f,o+=p,r+=w.width}else{for(s-=a,a-=r,r=this.lineOffset[r];--a>=0;r+=w.width)this.drawGouraudScanline(w.pixels,r,i>>16,t>>16,o>>7,n>>7),t+=c,i+=d,n+=u,o+=p;for(;--s>=0;)this.drawGouraudScanline(w.pixels,r,i>>16,e>>16,o>>7,h>>7),e+=l,i+=d,h+=f,o+=p,r+=w.width}};static drawGouraudScanline=(t,e,i,s,a,r)=>{let n=0,h=0;if(this.jagged){let o=0;if(this.clipX){if(o=s-i>3?Math.trunc((r-a)/(s-i)):0,s>w.right&&(s=w.right),i<0&&(a-=i*o,i=0),i>=s)return;e+=i,h=s-i>>2,o<<=2}else{if(i>=s)return;e+=i,h=s-i>>2,o=h>0?(r-a)*this.reciprocal15[h]>>15:0}if(0===this.alpha){for(;--h>=0;)n=this.palette[a>>8],a+=o,t[e++]=n,t[e++]=n,t[e++]=n,t[e++]=n;if(h=s-i&3,h>0){n=this.palette[a>>8];do{t[e++]=n}while(--h>0);return}}else{const r=this.alpha,l=256-this.alpha;for(;--h>=0;)n=this.palette[a>>8],a+=o,n=((16711935&n)*l>>8&16711935)+((65280&n)*l>>8&65280),t[e++]=n+((16711935&t[e])*r>>8&16711935)+((65280&t[e])*r>>8&65280),t[e++]=n+((16711935&t[e])*r>>8&16711935)+((65280&t[e])*r>>8&65280),t[e++]=n+((16711935&t[e])*r>>8&16711935)+((65280&t[e])*r>>8&65280),t[e++]=n+((16711935&t[e])*r>>8&16711935)+((65280&t[e])*r>>8&65280);if(h=s-i&3,h>0){n=this.palette[a>>8],n=((16711935&n)*l>>8&16711935)+((65280&n)*l>>8&65280);do{t[e++]=n+((16711935&t[e])*r>>8&16711935)+((65280&t[e])*r>>8&65280)}while(--h>0)}}return}if(i>=s)return;const o=Math.trunc((r-a)/(s-i));if(this.clipX&&(s>w.right&&(s=w.right),i<0&&(a-=i*o,i=0),i>=s))return;if(e+=i,h=s-i,0===this.alpha){do{t[e++]=this.palette[a>>8],a+=o}while(--h>0);return}const l=this.alpha,c=256-this.alpha;do{n=this.palette[a>>8],a+=o,n=((16711935&n)*c>>8&16711935)+((65280&n)*c>>8&65280),t[e++]=n+((16711935&t[e])*l>>8&16711935)+((65280&t[e])*l>>8&65280)}while(--h>0)};static fillTriangle=(t,e,i,s,a,r,n)=>{let h=0;a!==s&&(h=Math.trunc((e-t<<16)/(a-s)));let o=0;r!==a&&(o=Math.trunc((i-e<<16)/(r-a)));let l=0;if(r!==s&&(l=Math.trunc((t-i<<16)/(s-r))),s<=a&&s<=r){if(s<w.bottom)if(a>w.bottom&&(a=w.bottom),r>w.bottom&&(r=w.bottom),a<r)if(i=t<<=16,s<0&&(i-=l*s,t-=h*s,s=0),e<<=16,a<0&&(e-=o*a,a=0),s!==a&&l<h||s===a&&l>o)for(r-=a,a-=s,s=this.lineOffset[s];;){if(--a<0)for(;;){if(--r<0)return;this.drawScanline(i>>16,e>>16,w.pixels,s,n),i+=l,e+=o,s+=w.width}this.drawScanline(i>>16,t>>16,w.pixels,s,n),i+=l,t+=h,s+=w.width}else for(r-=a,a-=s,s=this.lineOffset[s];;){if(--a<0)for(;;){if(--r<0)return;this.drawScanline(e>>16,i>>16,w.pixels,s,n),i+=l,e+=o,s+=w.width}this.drawScanline(t>>16,i>>16,w.pixels,s,n),i+=l,t+=h,s+=w.width}else if(e=t<<=16,s<0&&(e-=l*s,t-=h*s,s=0),i<<=16,r<0&&(i-=o*r,r=0),s!==r&&l<h||s===r&&o>h)for(a-=r,r-=s,s=this.lineOffset[s];;){if(--r<0)for(;;){if(--a<0)return;this.drawScanline(i>>16,t>>16,w.pixels,s,n),i+=o,t+=h,s+=w.width}this.drawScanline(e>>16,t>>16,w.pixels,s,n),e+=l,t+=h,s+=w.width}else for(a-=r,r-=s,s=this.lineOffset[s];;){if(--r<0)for(;;){if(--a<0)return;this.drawScanline(t>>16,i>>16,w.pixels,s,n),i+=o,t+=h,s+=w.width}this.drawScanline(t>>16,e>>16,w.pixels,s,n),e+=l,t+=h,s+=w.width}}else if(a<=r){if(a<w.bottom)if(r>w.bottom&&(r=w.bottom),s>w.bottom&&(s=w.bottom),r<s)if(t=e<<=16,a<0&&(t-=h*a,e-=o*a,a=0),i<<=16,r<0&&(i-=l*r,r=0),a!==r&&h<o||a===r&&h>l)for(s-=r,r-=a,a=this.lineOffset[a];;){if(--r<0)for(;;){if(--s<0)return;this.drawScanline(t>>16,i>>16,w.pixels,a,n),t+=h,i+=l,a+=w.width}this.drawScanline(t>>16,e>>16,w.pixels,a,n),t+=h,e+=o,a+=w.width}else for(s-=r,r-=a,a=this.lineOffset[a];;){if(--r<0)for(;;){if(--s<0)return;this.drawScanline(i>>16,t>>16,w.pixels,a,n),t+=h,i+=l,a+=w.width}this.drawScanline(e>>16,t>>16,w.pixels,a,n),t+=h,e+=o,a+=w.width}else if(i=e<<=16,a<0&&(i-=h*a,e-=o*a,a=0),t<<=16,s<0&&(t-=l*s,s=0),h<o)for(r-=s,s-=a,a=this.lineOffset[a];;){if(--s<0)for(;;){if(--r<0)return;this.drawScanline(t>>16,e>>16,w.pixels,a,n),t+=l,e+=o,a+=w.width}this.drawScanline(i>>16,e>>16,w.pixels,a,n),i+=h,e+=o,a+=w.width}else for(r-=s,s-=a,a=this.lineOffset[a];;){if(--s<0)for(;;){if(--r<0)return;this.drawScanline(e>>16,t>>16,w.pixels,a,n),t+=l,e+=o,a+=w.width}this.drawScanline(e>>16,i>>16,w.pixels,a,n),i+=h,e+=o,a+=w.width}}else if(r<w.bottom)if(s>w.bottom&&(s=w.bottom),a>w.bottom&&(a=w.bottom),s<a)if(e=i<<=16,r<0&&(e-=o*r,i-=l*r,r=0),t<<=16,s<0&&(t-=h*s,s=0),o<l)for(a-=s,s-=r,r=this.lineOffset[r];;){if(--s<0)for(;;){if(--a<0)return;this.drawScanline(e>>16,t>>16,w.pixels,r,n),e+=o,t+=h,r+=w.width}this.drawScanline(e>>16,i>>16,w.pixels,r,n),e+=o,i+=l,r+=w.width}else for(a-=s,s-=r,r=this.lineOffset[r];;){if(--s<0)for(;;){if(--a<0)return;this.drawScanline(t>>16,e>>16,w.pixels,r,n),e+=o,t+=h,r+=w.width}this.drawScanline(i>>16,e>>16,w.pixels,r,n),e+=o,i+=l,r+=w.width}else if(t=i<<=16,r<0&&(t-=o*r,i-=l*r,r=0),e<<=16,a<0&&(e-=h*a,a=0),o<l)for(s-=a,a-=r,r=this.lineOffset[r];;){if(--a<0)for(;;){if(--s<0)return;this.drawScanline(e>>16,i>>16,w.pixels,r,n),e+=h,i+=l,r+=w.width}this.drawScanline(t>>16,i>>16,w.pixels,r,n),t+=o,i+=l,r+=w.width}else for(s-=a,a-=r,r=this.lineOffset[r];;){if(--a<0)for(;;){if(--s<0)return;this.drawScanline(i>>16,e>>16,w.pixels,r,n),e+=h,i+=l,r+=w.width}this.drawScanline(i>>16,t>>16,w.pixels,r,n),t+=o,i+=l,r+=w.width}};static fillTexturedTriangle=(t,e,i,s,a,r,n,h,o,l,c,d,f,u,p,m,g,y,C)=>{const b=this.getTexels(C);this.opaque=!this.textureTranslucent[C];const S=l-f,T=c-p,v=d-g,x=u-l,A=m-c,I=y-d;let O=x*c-A*l<<14;const _=A*d-I*c<<8,k=I*l-x*d<<5;let L=S*c-T*l<<14;const M=T*d-v*c<<8,E=v*l-S*d<<5;let R=T*x-S*A<<14;const B=v*A-T*I<<8,P=S*I-v*x<<5;let N=0,Y=0;a!==s&&(N=Math.trunc((e-t<<16)/(a-s)),Y=Math.trunc((h-n<<16)/(a-s)));let F=0,X=0;r!==a&&(F=Math.trunc((i-e<<16)/(r-a)),X=Math.trunc((o-h<<16)/(r-a)));let D=0,U=0;if(r!==s&&(D=Math.trunc((t-i<<16)/(s-r)),U=Math.trunc((n-o<<16)/(s-r))),s<=a&&s<=r){if(s<w.bottom)if(a>w.bottom&&(a=w.bottom),r>w.bottom&&(r=w.bottom),a<r){i=t<<=16,o=n<<=16,s<0&&(i-=D*s,t-=N*s,o-=U*s,n-=Y*s,s=0),e<<=16,h<<=16,a<0&&(e-=F*a,h-=X*a,a=0);const l=s-this.centerY;if(O+=k*l,L+=E*l,R+=P*l,s!==a&&D<N||s===a&&D>F)for(r-=a,a-=s,s=this.lineOffset[s];;){if(--a<0)for(;;){if(--r<0)return;this.drawTexturedScanline(i>>16,e>>16,w.pixels,s,b,0,0,O,L,R,_,M,B,o>>8,h>>8),i+=D,e+=F,o+=U,h+=X,s+=w.width,O+=k,L+=E,R+=P}this.drawTexturedScanline(i>>16,t>>16,w.pixels,s,b,0,0,O,L,R,_,M,B,o>>8,n>>8),i+=D,t+=N,o+=U,n+=Y,s+=w.width,O+=k,L+=E,R+=P}else for(r-=a,a-=s,s=this.lineOffset[s];;){if(--a<0)for(;;){if(--r<0)return;this.drawTexturedScanline(e>>16,i>>16,w.pixels,s,b,0,0,O,L,R,_,M,B,h>>8,o>>8),i+=D,e+=F,o+=U,h+=X,s+=w.width,O+=k,L+=E,R+=P}this.drawTexturedScanline(t>>16,i>>16,w.pixels,s,b,0,0,O,L,R,_,M,B,n>>8,o>>8),i+=D,t+=N,o+=U,n+=Y,s+=w.width,O+=k,L+=E,R+=P}}else{e=t<<=16,h=n<<=16,s<0&&(e-=D*s,t-=N*s,h-=U*s,n-=Y*s,s=0),i<<=16,o<<=16,r<0&&(i-=F*r,o-=X*r,r=0);const l=s-this.centerY;if(O+=k*l,L+=E*l,R+=P*l,(s===r||D>=N)&&(s!==r||F<=N))for(a-=r,r-=s,s=this.lineOffset[s];;){if(--r<0)for(;;){if(--a<0)return;this.drawTexturedScanline(t>>16,i>>16,w.pixels,s,b,0,0,O,L,R,_,M,B,n>>8,o>>8),i+=F,t+=N,o+=X,n+=Y,s+=w.width,O+=k,L+=E,R+=P}this.drawTexturedScanline(t>>16,e>>16,w.pixels,s,b,0,0,O,L,R,_,M,B,n>>8,h>>8),e+=D,t+=N,h+=U,n+=Y,s+=w.width,O+=k,L+=E,R+=P}else for(a-=r,r-=s,s=this.lineOffset[s];;){if(--r<0)for(;;){if(--a<0)return;this.drawTexturedScanline(i>>16,t>>16,w.pixels,s,b,0,0,O,L,R,_,M,B,o>>8,n>>8),i+=F,t+=N,o+=X,n+=Y,s+=w.width,O+=k,L+=E,R+=P}this.drawTexturedScanline(e>>16,t>>16,w.pixels,s,b,0,0,O,L,R,_,M,B,h>>8,n>>8),e+=D,t+=N,h+=U,n+=Y,s+=w.width,O+=k,L+=E,R+=P}}}else if(a<=r){if(a<w.bottom)if(r>w.bottom&&(r=w.bottom),s>w.bottom&&(s=w.bottom),r<s){t=e<<=16,n=h<<=16,a<0&&(t-=N*a,e-=F*a,n-=Y*a,h-=X*a,a=0),i<<=16,o<<=16,r<0&&(i-=D*r,o-=U*r,r=0);const l=a-this.centerY;if(O+=k*l,L+=E*l,R+=P*l,a!==r&&N<F||a===r&&N>D)for(s-=r,r-=a,a=this.lineOffset[a];;){if(--r<0)for(;;){if(--s<0)return;this.drawTexturedScanline(t>>16,i>>16,w.pixels,a,b,0,0,O,L,R,_,M,B,n>>8,o>>8),t+=N,i+=D,n+=Y,o+=U,a+=w.width,O+=k,L+=E,R+=P}this.drawTexturedScanline(t>>16,e>>16,w.pixels,a,b,0,0,O,L,R,_,M,B,n>>8,h>>8),t+=N,e+=F,n+=Y,h+=X,a+=w.width,O+=k,L+=E,R+=P}else for(s-=r,r-=a,a=this.lineOffset[a];;){if(--r<0)for(;;){if(--s<0)return;this.drawTexturedScanline(i>>16,t>>16,w.pixels,a,b,0,0,O,L,R,_,M,B,o>>8,n>>8),t+=N,i+=D,n+=Y,o+=U,a+=w.width,O+=k,L+=E,R+=P}this.drawTexturedScanline(e>>16,t>>16,w.pixels,a,b,0,0,O,L,R,_,M,B,h>>8,n>>8),t+=N,e+=F,n+=Y,h+=X,a+=w.width,O+=k,L+=E,R+=P}}else{i=e<<=16,o=h<<=16,a<0&&(i-=N*a,e-=F*a,o-=Y*a,h-=X*a,a=0),t<<=16,n<<=16,s<0&&(t-=D*s,n-=U*s,s=0);const l=a-this.centerY;if(O+=k*l,L+=E*l,R+=P*l,N<F)for(r-=s,s-=a,a=this.lineOffset[a];;){if(--s<0)for(;;){if(--r<0)return;this.drawTexturedScanline(t>>16,e>>16,w.pixels,a,b,0,0,O,L,R,_,M,B,n>>8,h>>8),t+=D,e+=F,n+=U,h+=X,a+=w.width,O+=k,L+=E,R+=P}this.drawTexturedScanline(i>>16,e>>16,w.pixels,a,b,0,0,O,L,R,_,M,B,o>>8,h>>8),i+=N,e+=F,o+=Y,h+=X,a+=w.width,O+=k,L+=E,R+=P}else for(r-=s,s-=a,a=this.lineOffset[a];;){if(--s<0)for(;;){if(--r<0)return;this.drawTexturedScanline(e>>16,t>>16,w.pixels,a,b,0,0,O,L,R,_,M,B,h>>8,n>>8),t+=D,e+=F,n+=U,h+=X,a+=w.width,O+=k,L+=E,R+=P}this.drawTexturedScanline(e>>16,i>>16,w.pixels,a,b,0,0,O,L,R,_,M,B,h>>8,o>>8),i+=N,e+=F,o+=Y,h+=X,a+=w.width,O+=k,L+=E,R+=P}}}else if(r<w.bottom)if(s>w.bottom&&(s=w.bottom),a>w.bottom&&(a=w.bottom),s<a){e=i<<=16,h=o<<=16,r<0&&(e-=F*r,i-=D*r,h-=X*r,o-=U*r,r=0),t<<=16,n<<=16,s<0&&(t-=N*s,n-=Y*s,s=0);const l=r-this.centerY;if(O+=k*l,L+=E*l,R+=P*l,F<D)for(a-=s,s-=r,r=this.lineOffset[r];;){if(--s<0)for(;;){if(--a<0)return;this.drawTexturedScanline(e>>16,t>>16,w.pixels,r,b,0,0,O,L,R,_,M,B,h>>8,n>>8),e+=F,t+=N,h+=X,n+=Y,r+=w.width,O+=k,L+=E,R+=P}this.drawTexturedScanline(e>>16,i>>16,w.pixels,r,b,0,0,O,L,R,_,M,B,h>>8,o>>8),e+=F,i+=D,h+=X,o+=U,r+=w.width,O+=k,L+=E,R+=P}else for(a-=s,s-=r,r=this.lineOffset[r];;){if(--s<0)for(;;){if(--a<0)return;this.drawTexturedScanline(t>>16,e>>16,w.pixels,r,b,0,0,O,L,R,_,M,B,n>>8,h>>8),e+=F,t+=N,h+=X,n+=Y,r+=w.width,O+=k,L+=E,R+=P}this.drawTexturedScanline(i>>16,e>>16,w.pixels,r,b,0,0,O,L,R,_,M,B,o>>8,h>>8),e+=F,i+=D,h+=X,o+=U,r+=w.width,O+=k,L+=E,R+=P}}else{t=i<<=16,n=o<<=16,r<0&&(t-=F*r,i-=D*r,n-=X*r,o-=U*r,r=0),e<<=16,h<<=16,a<0&&(e-=N*a,h-=Y*a,a=0);const l=r-this.centerY;if(O+=k*l,L+=E*l,R+=P*l,F<D)for(s-=a,a-=r,r=this.lineOffset[r];;){if(--a<0)for(;;){if(--s<0)return;this.drawTexturedScanline(e>>16,i>>16,w.pixels,r,b,0,0,O,L,R,_,M,B,h>>8,o>>8),e+=N,i+=D,h+=Y,o+=U,r+=w.width,O+=k,L+=E,R+=P}this.drawTexturedScanline(t>>16,i>>16,w.pixels,r,b,0,0,O,L,R,_,M,B,n>>8,o>>8),t+=F,i+=D,n+=X,o+=U,r+=w.width,O+=k,L+=E,R+=P}else for(s-=a,a-=r,r=this.lineOffset[r];;){if(--a<0)for(;;){if(--s<0)return;this.drawTexturedScanline(i>>16,e>>16,w.pixels,r,b,0,0,O,L,R,_,M,B,o>>8,h>>8),e+=N,i+=D,h+=Y,o+=U,r+=w.width,O+=k,L+=E,R+=P}this.drawTexturedScanline(i>>16,t>>16,w.pixels,r,b,0,0,O,L,R,_,M,B,o>>8,n>>8),t+=F,i+=D,n+=X,o+=U,r+=w.width,O+=k,L+=E,R+=P}}};static drawTexturedScanline=(t,e,i,s,a,r,n,h,o,l,c,d,f,u,p)=>{if(t>=e)return;let m,g,y,C,b,S,T,v,x;if(this.clipX){if(m=Math.trunc((p-u)/(e-t)),e>w.boundX&&(e=w.boundX),t<0&&(u-=t*m,t=0),t>=e)return;g=e-t>>3,m<<=12,u<<=9}else e-t>7?(g=e-t>>3,m=(p-u)*this.reciprocal15[g]>>6):(g=0,m=0),u<<=9;if(s+=t,this.lowMemory&&a)if(y=0,C=0,S=t-this.centerX,h+=(c>>3)*S,o+=(d>>3)*S,b=(l+=(f>>3)*S)>>12,0!==b&&(r=Math.trunc(h/b),n=Math.trunc(o/b),r<0?r=0:r>4032&&(r=4032)),h+=c,o+=d,b=(l+=f)>>12,0!==b&&(y=Math.trunc(h/b),C=Math.trunc(o/b),y<7?y=7:y>4032&&(y=4032)),T=y-r>>3,v=C-n>>3,r+=u>>3&786432,x=u>>23,this.opaque){for(;g-- >0;)i[s++]=a[(4032&n)+(r>>6)]>>>x,r+=T,n+=v,i[s++]=a[(4032&n)+(r>>6)]>>>x,r+=T,n+=v,i[s++]=a[(4032&n)+(r>>6)]>>>x,r+=T,n+=v,i[s++]=a[(4032&n)+(r>>6)]>>>x,r+=T,n+=v,i[s++]=a[(4032&n)+(r>>6)]>>>x,r+=T,n+=v,i[s++]=a[(4032&n)+(r>>6)]>>>x,r+=T,n+=v,i[s++]=a[(4032&n)+(r>>6)]>>>x,r+=T,n+=v,i[s++]=a[(4032&n)+(r>>6)]>>>x,r=y,n=C,h+=c,o+=d,b=(l+=f)>>12,0!==b&&(y=Math.trunc(h/b),C=Math.trunc(o/b),y<7?y=7:y>4032&&(y=4032)),T=y-r>>3,v=C-n>>3,r+=(u+=m)>>3&786432,x=u>>23;for(g=e-t&7;g-- >0;)i[s++]=a[(4032&n)+(r>>6)]>>>x,r+=T,n+=v}else{for(;g-- >0;){let t;0!=(t=a[(4032&n)+(r>>6)]>>>x)&&(i[s]=t),s+=1,0!=(t=a[(4032&(n+=v))+((r+=T)>>6)]>>>x)&&(i[s]=t),s++,0!=(t=a[(4032&(n+=v))+((r+=T)>>6)]>>>x)&&(i[s]=t),s++,0!=(t=a[(4032&(n+=v))+((r+=T)>>6)]>>>x)&&(i[s]=t),s++,0!=(t=a[(4032&(n+=v))+((r+=T)>>6)]>>>x)&&(i[s]=t),s++,0!=(t=a[(4032&(n+=v))+((r+=T)>>6)]>>>x)&&(i[s]=t),s++,0!=(t=a[(4032&(n+=v))+((r+=T)>>6)]>>>x)&&(i[s]=t),s++,0!=(t=a[(4032&(n+=v))+((r+=T)>>6)]>>>x)&&(i[s]=t),s+=1,r=y,n=C,h+=c,o+=d,b=(l+=f)>>12,0!==b&&(y=Math.trunc(h/b),C=Math.trunc(o/b),y<7?y=7:y>4032&&(y=4032)),T=y-r>>3,v=C-n>>3,r+=(u+=m)>>3&786432,x=u>>23}for(g=e-t&7;g-- >0;){let t;0!=(t=a[(4032&n)+(r>>6)]>>>x)&&(i[s]=t),s++,r+=T,n+=v}}else if(y=0,C=0,S=t-this.centerX,h+=(c>>3)*S,o+=(d>>3)*S,b=(l+=(f>>3)*S)>>14,0!==b&&(r=Math.trunc(h/b),n=Math.trunc(o/b),r<0?r=0:r>16256&&(r=16256)),h+=c,o+=d,b=(l+=f)>>14,0!==b&&(y=Math.trunc(h/b),C=Math.trunc(o/b),y<7?y=7:y>16256&&(y=16256)),T=y-r>>3,v=C-n>>3,r+=6291456&u,x=u>>23,this.opaque&&a){for(;g-- >0;)i[s++]=a[(16256&n)+(r>>7)]>>>x,r+=T,n+=v,i[s++]=a[(16256&n)+(r>>7)]>>>x,r+=T,n+=v,i[s++]=a[(16256&n)+(r>>7)]>>>x,r+=T,n+=v,i[s++]=a[(16256&n)+(r>>7)]>>>x,r+=T,n+=v,i[s++]=a[(16256&n)+(r>>7)]>>>x,r+=T,n+=v,i[s++]=a[(16256&n)+(r>>7)]>>>x,r+=T,n+=v,i[s++]=a[(16256&n)+(r>>7)]>>>x,r+=T,n+=v,i[s++]=a[(16256&n)+(r>>7)]>>>x,r=y,n=C,h+=c,o+=d,b=(l+=f)>>14,0!==b&&(y=Math.trunc(h/b),C=Math.trunc(o/b),y<7?y=7:y>16256&&(y=16256)),T=y-r>>3,v=C-n>>3,r+=6291456&(u+=m),x=u>>23;for(g=e-t&7;g-- >0;)i[s++]=a[(16256&n)+(r>>7)]>>>x,r+=T,n+=v}else{for(;g-- >0&&a;){let t;0!=(t=a[(16256&n)+(r>>7)]>>>x)&&(i[s]=t),s+=1,0!=(t=a[(16256&(n+=v))+((r+=T)>>7)]>>>x)&&(i[s]=t),s++,0!=(t=a[(16256&(n+=v))+((r+=T)>>7)]>>>x)&&(i[s]=t),s++,0!=(t=a[(16256&(n+=v))+((r+=T)>>7)]>>>x)&&(i[s]=t),s++,0!=(t=a[(16256&(n+=v))+((r+=T)>>7)]>>>x)&&(i[s]=t),s++,0!=(t=a[(16256&(n+=v))+((r+=T)>>7)]>>>x)&&(i[s]=t),s++,0!=(t=a[(16256&(n+=v))+((r+=T)>>7)]>>>x)&&(i[s]=t),s++,0!=(t=a[(16256&(n+=v))+((r+=T)>>7)]>>>x)&&(i[s]=t),s++,r=y,n=C,h+=c,o+=d,b=(l+=f)>>14,0!==b&&(y=Math.trunc(h/b),C=Math.trunc(o/b),y<7?y=7:y>16256&&(y=16256)),T=y-r>>3,v=C-n>>3,r+=6291456&(u+=m),x=u>>23}for(g=e-t&7;g-- >0&&a;){let t;0!=(t=a[(16256&n)+(r>>7)]>>>x)&&(i[s]=t),s++,r+=T,n+=v}}};static drawScanline=(t,e,i,s,a)=>{if(this.clipX&&(e>w.boundX&&(e=w.boundX),t<0&&(t=0)),t>=e)return;s+=t;let r=e-t>>2;if(0===this.alpha)for(;;){if(r--,r<0)for(r=e-t&3;;){if(r--,r<0)return;i[s++]=a}i[s++]=a,i[s++]=a,i[s++]=a,i[s++]=a}const n=this.alpha,h=256-this.alpha;for(a=((16711935&a)*h>>8&16711935)+((65280&a)*h>>8&65280);;){if(r--,r<0)for(r=e-t&3;;){if(r--,r<0)return;i[s++]=a+((16711935&i[s])*n>>8&16711935)+((65280&i[s])*n>>8&65280)}i[s++]=a+((16711935&i[s])*n>>8&16711935)+((65280&i[s])*n>>8&65280),i[s++]=a+((16711935&i[s])*n>>8&16711935)+((65280&i[s])*n>>8&65280),i[s++]=a+((16711935&i[s])*n>>8&16711935)+((65280&i[s])*n>>8&65280),i[s++]=a+((16711935&i[s])*n>>8&16711935)+((65280&i[s])*n>>8&65280)}};static pushTexture=t=>{this.activeTexels[t]&&this.texelPool&&(this.texelPool[this.poolSize++]=this.activeTexels[t],this.activeTexels[t]=null)};static getTexels=t=>{if(this.textureCycle[t]=this.cycle++,this.activeTexels[t])return this.activeTexels[t];let e;if(this.poolSize>0&&this.texelPool)e=this.texelPool[--this.poolSize],this.texelPool[this.poolSize]=null;else{let t=0,i=-1;for(let e=0;e<this.textureCount;e++)this.activeTexels[e]&&(this.textureCycle[e]<t||-1===i)&&(t=this.textureCycle[e],i=e);e=this.activeTexels[i],this.activeTexels[i]=null}this.activeTexels[t]=e;const i=this.textures[t],s=this.texturePalette[t];if(e&&s)if(this.lowMemory){this.textureTranslucent[t]=!1;for(let a=0;a<4096;a++){const r=e[a]=16316671&s[i.pixels[a]];0===r&&(this.textureTranslucent[t]=!0),e[a+4096]=r-(r>>>3)&16316671,e[a+8192]=r-(r>>>2)&16316671,e[a+12288]=r-(r>>>2)-(r>>>3)&16316671}}else{if(64===i.width)for(let t=0;t<128;t++)for(let a=0;a<128;a++)e[a+(t<<7)]=s[i.pixels[(a>>1)+(t>>1<<6)]];else for(let t=0;t<16384;t++)e[t]=s[i.pixels[t]];this.textureTranslucent[t]=!1;for(let i=0;i<16384;i++){e[i]&=16316671;const s=e[i];0===s&&(this.textureTranslucent[t]=!0),e[i+16384]=s-(s>>>3)&16316671,e[i+32768]=s-(s>>>2)&16316671,e[i+49152]=s-(s>>>2)-(s>>>3)&16316671}}return e}}class I{vertexCount=0;faceCount=0;texturedFaceCount=0;vertexFlagsOffset=-1;vertexXOffset=-1;vertexYOffset=-1;vertexZOffset=-1;vertexLabelsOffset=-1;faceVerticesOffset=-1;faceOrientationsOffset=-1;faceColorsOffset=-1;faceInfosOffset=-1;facePrioritiesOffset=0;faceAlphasOffset=-1;faceLabelsOffset=-1;faceTextureAxisOffset=-1}class O{x=0;y=0;z=0;w=0}class _ extends h{static metadata=null;static head=null;static face1=null;static face2=null;static face3=null;static face4=null;static face5=null;static point1=null;static point2=null;static point3=null;static point4=null;static point5=null;static vertex1=null;static vertex2=null;static axis=null;static faceClippedX=new Array(4096);static faceNearClipped=new Array(4096);static vertexScreenX=new Int32Array(4096);static vertexScreenY=new Int32Array(4096);static vertexScreenZ=new Int32Array(4096);static vertexViewSpaceX=new Int32Array(4096);static vertexViewSpaceY=new Int32Array(4096);static vertexViewSpaceZ=new Int32Array(4096);static tmpDepthFaceCount=new Int32Array(1500);static tmpDepthFaces=new Array(1500).fill(null).map((()=>new Int32Array(512)));static tmpPriorityFaceCount=new Int32Array(12);static tmpPriorityFaces=new Array(12).fill(null).map((()=>new Int32Array(2e3)));static tmpPriority10FaceDepth=new Int32Array(2e3);static tmpPriority11FaceDepth=new Int32Array(2e3);static tmpPriorityDepthSum=new Int32Array(12);static clippedX=new Int32Array(10);static clippedY=new Int32Array(10);static clippedColor=new Int32Array(10);static baseX=0;static baseY=0;static baseZ=0;static checkHover=!1;static mouseX=0;static mouseZ=0;static pickedCount=0;static pickedBitsets=new Int32Array(1e3);static unpack(t){try{_.head=new o(t.read("ob_head.dat")),_.face1=new o(t.read("ob_face1.dat")),_.face2=new o(t.read("ob_face2.dat")),_.face3=new o(t.read("ob_face3.dat")),_.face4=new o(t.read("ob_face4.dat")),_.face5=new o(t.read("ob_face5.dat")),_.point1=new o(t.read("ob_point1.dat")),_.point2=new o(t.read("ob_point2.dat")),_.point3=new o(t.read("ob_point3.dat")),_.point4=new o(t.read("ob_point4.dat")),_.point5=new o(t.read("ob_point5.dat")),_.vertex1=new o(t.read("ob_vertex1.dat")),_.vertex2=new o(t.read("ob_vertex2.dat")),_.axis=new o(t.read("ob_axis.dat")),_.head.pos=0,_.point1.pos=0,_.point2.pos=0,_.point3.pos=0,_.point4.pos=0,_.vertex1.pos=0,_.vertex2.pos=0;const e=_.head.g2;_.metadata=new Array(e+100);let i=0,s=0,a=0,r=0,n=0,h=0,l=0;for(let t=0;t<e;t++){const t=_.head.g2,e=new I;e.vertexCount=_.head.g2,e.faceCount=_.head.g2,e.texturedFaceCount=_.head.g1,e.vertexFlagsOffset=_.point1.pos,e.vertexXOffset=_.point2.pos,e.vertexYOffset=_.point3.pos,e.vertexZOffset=_.point4.pos,e.faceVerticesOffset=_.vertex1.pos,e.faceOrientationsOffset=_.vertex2.pos;const o=_.head.g1,c=_.head.g1,d=_.head.g1,f=_.head.g1,u=_.head.g1;for(let t=0;t<e.vertexCount;t++){const t=_.point1.g1;0!=(1&t)&&_.point2.gsmart,0!=(2&t)&&_.point3.gsmart,0!=(4&t)&&_.point4.gsmart}for(let t=0;t<e.faceCount;t++)1===_.vertex2.g1&&(_.vertex1.gsmart,_.vertex1.gsmart),_.vertex1.gsmart;e.faceColorsOffset=a,a+=2*e.faceCount,1===o&&(e.faceInfosOffset=r,r+=e.faceCount),255===c?(e.facePrioritiesOffset=n,n+=e.faceCount):e.facePrioritiesOffset=-c-1,1===d&&(e.faceAlphasOffset=h,h+=e.faceCount),1===f&&(e.faceLabelsOffset=l,l+=e.faceCount),1===u&&(e.vertexLabelsOffset=s,s+=e.vertexCount),e.faceTextureAxisOffset=i,i+=e.texturedFaceCount,_.metadata[t]=e}}catch(t){console.log("Error loading model index"),console.error(t)}}static unload(){_.metadata=null,_.head=null,_.face1=null,_.face2=null,_.face3=null,_.face4=null,_.face5=null,_.point1=null,_.point2=null,_.point3=null,_.point4=null,_.point5=null,_.vertex1=null,_.vertex2=null,_.axis=null,_.faceClippedX=null,_.faceNearClipped=null,_.vertexScreenX=null,_.vertexScreenY=null,_.vertexScreenZ=null,_.vertexViewSpaceX=null,_.vertexViewSpaceY=null,_.vertexViewSpaceZ=null,_.tmpDepthFaceCount=null,_.tmpDepthFaces=null,_.tmpPriorityFaceCount=null,_.tmpPriorityFaces=null,_.tmpPriority10FaceDepth=null,_.tmpPriority11FaceDepth=null,_.tmpPriorityDepthSum=null}static mulColorLightness(t,e,i){return 2==(2&i)?(e<0?e=0:e>127&&(e=127),127-e):((e=e*(127&t)>>7)<2?e=2:e>126&&(e=126),(65408&t)+e)}static modelCopyFaces=(t,e,i)=>{const s=t.vertexCount,a=t.faceCount,r=t.texturedFaceCount;let n,h,o,l,c;if(e){n=new Int32Array(s);for(let e=0;e<s;e++)n[e]=t.vertexY[e]}else n=t.vertexY;let d=null,f=null;if(i){h=new Int32Array(a),o=new Int32Array(a),l=new Int32Array(a);for(let e=0;e<a;e++)t.faceColorA&&(h[e]=t.faceColorA[e]),t.faceColorB&&(o[e]=t.faceColorB[e]),t.faceColorC&&(l[e]=t.faceColorC[e]);if(c=new Int32Array(a),t.faceInfo)for(let e=0;e<a;e++)c[e]=t.faceInfo[e];else for(let t=0;t<a;t++)c[t]=0;d=[];for(let e=0;e<s;e++){if(!t.vertexNormal)continue;const i=d[e]=new O,s=t.vertexNormal[e];i.x=s.x,i.y=s.y,i.z=s.z,i.w=s.w}f=t.vertexNormalOriginal}else h=t.faceColorA,o=t.faceColorB,l=t.faceColorC,c=t.faceInfo;return new _({vertexCount:s,vertexX:t.vertexX,vertexY:n,vertexZ:t.vertexZ,faceCount:a,faceVertexA:t.faceVertexA,faceVertexB:t.faceVertexB,faceVertexC:t.faceVertexC,faceColorA:h,faceColorB:o,faceColorC:l,faceInfo:c,facePriority:t.facePriority,faceAlpha:t.faceAlpha,faceColor:t.faceColor,priority:t.priority,texturedFaceCount:r,texturedVertexA:t.texturedVertexA,texturedVertexB:t.texturedVertexB,texturedVertexC:t.texturedVertexC,minX:t.minX,maxX:t.maxX,minZ:t.minZ,maxZ:t.maxZ,radius:t.radius,minY:t.minY,maxY:t.maxY,maxDepth:t.maxDepth,minDepth:t.minDepth,vertexNormal:d,vertexNormalOriginal:f})};static modelShareColored=(t,e,i,s)=>{const a=t.vertexCount,r=t.faceCount,n=t.texturedFaceCount;let h,o,l,c,d;if(s)h=t.vertexX,o=t.vertexY,l=t.vertexZ;else{h=new Int32Array(a),o=new Int32Array(a),l=new Int32Array(a);for(let e=0;e<a;e++)h[e]=t.vertexX[e],o[e]=t.vertexY[e],l[e]=t.vertexZ[e]}if(e)c=t.faceColor;else{c=new Int32Array(r);for(let e=0;e<r;e++)t.faceColor&&(c[e]=t.faceColor[e])}if(i)d=t.faceAlpha;else if(d=new Int32Array(r),t.faceAlpha)for(let e=0;e<r;e++)d[e]=t.faceAlpha[e];else for(let t=0;t<r;t++)d[t]=0;return new _({vertexCount:a,vertexX:h,vertexY:o,vertexZ:l,faceCount:r,faceVertexA:t.faceVertexA,faceVertexB:t.faceVertexB,faceVertexC:t.faceVertexC,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:t.faceInfo,facePriority:t.facePriority,faceAlpha:d,faceColor:c,priority:t.priority,texturedFaceCount:n,texturedVertexA:t.texturedVertexA,texturedVertexB:t.texturedVertexB,texturedVertexC:t.texturedVertexC,vertexLabel:t.vertexLabel,faceLabel:t.faceLabel})};static modelShareAlpha=(t,e)=>{const i=t.vertexCount,s=t.faceCount,a=t.texturedFaceCount,r=new Int32Array(i),n=new Int32Array(i),h=new Int32Array(i);for(let e=0;e<i;e++)r[e]=t.vertexX[e],n[e]=t.vertexY[e],h[e]=t.vertexZ[e];let o;if(e)o=t.faceAlpha;else if(o=new Int32Array(s),t.faceAlpha)for(let e=0;e<s;e++)o[e]=t.faceAlpha[e];else for(let t=0;t<s;t++)o[t]=0;return new _({vertexCount:i,vertexX:r,vertexY:n,vertexZ:h,faceCount:s,faceVertexA:t.faceVertexA,faceVertexB:t.faceVertexB,faceVertexC:t.faceVertexC,faceColorA:t.faceColorA,faceColorB:t.faceColorB,faceColorC:t.faceColorC,faceInfo:t.faceInfo,facePriority:t.facePriority,faceAlpha:o,faceColor:t.faceColor,priority:t.priority,texturedFaceCount:a,texturedVertexA:t.texturedVertexA,texturedVertexB:t.texturedVertexB,texturedVertexC:t.texturedVertexC,labelVertices:t.labelVertices,labelFaces:t.labelFaces})};static modelFromModelsBounds=(t,e)=>{let i=!1,s=!1,a=!1,r=!1,n=0,h=0,o=0,l=-1;for(let c=0;c<e;c++){const e=t[c];e&&(n+=e.vertexCount,h+=e.faceCount,o+=e.texturedFaceCount,i||=null!==e.faceInfo,e.facePriority?s=!0:(-1===l&&(l=e.priority),l!==e.priority&&(s=!0)),a||=null!==e.faceAlpha,r||=null!==e.faceColor)}const c=new Int32Array(n),d=new Int32Array(n),f=new Int32Array(n),u=new Int32Array(h),p=new Int32Array(h),m=new Int32Array(h),g=new Int32Array(h),w=new Int32Array(h),y=new Int32Array(h),C=new Int32Array(o),b=new Int32Array(o),S=new Int32Array(o);let T=null;i&&(T=new Int32Array(h));let v=null;s&&(v=new Int32Array(h));let x=null;a&&(x=new Int32Array(h));let A=null;r&&(A=new Int32Array(h)),n=0,h=0,o=0;for(let l=0;l<e;l++){const e=t[l];if(e){const t=n;for(let t=0;t<e.vertexCount;t++)c[n]=e.vertexX[t],d[n]=e.vertexY[t],f[n]=e.vertexZ[t],n++;for(let n=0;n<e.faceCount;n++)u[h]=e.faceVertexA[n]+t,p[h]=e.faceVertexB[n]+t,m[h]=e.faceVertexC[n]+t,e.faceColorA&&(g[h]=e.faceColorA[n]),e.faceColorB&&(w[h]=e.faceColorB[n]),e.faceColorC&&(y[h]=e.faceColorC[n]),i&&(e.faceInfo?T&&(T[h]=e.faceInfo[n]):T&&(T[h]=0)),s&&(e.facePriority?v&&(v[h]=e.facePriority[n]):v&&(v[h]=e.priority)),a&&(e.faceAlpha?x&&(x[h]=e.faceAlpha[n]):x&&(x[h]=0)),r&&e.faceColor&&A&&(A[h]=e.faceColor[n]),h++;for(let i=0;i<e.texturedFaceCount;i++)C[o]=e.texturedVertexA[i]+t,b[o]=e.texturedVertexB[i]+t,S[o]=e.texturedVertexC[i]+t,o++}}const I=new _({vertexCount:n,vertexX:c,vertexY:d,vertexZ:f,faceCount:h,faceVertexA:u,faceVertexB:p,faceVertexC:m,faceColorA:g,faceColorB:w,faceColorC:y,faceInfo:T,facePriority:v,faceAlpha:x,faceColor:A,priority:l,texturedFaceCount:o,texturedVertexA:C,texturedVertexB:b,texturedVertexC:S});return I.calculateBoundsCylinder(),I};static modelFromModels=(t,e)=>{let i=!1,s=!1,a=!1,r=!1,n=0,h=0,o=0,l=-1;for(let c=0;c<e;c++){const e=t[c];e&&(n+=e.vertexCount,h+=e.faceCount,o+=e.texturedFaceCount,i||=null!==e.faceInfo,e.facePriority?s=!0:(-1===l&&(l=e.priority),l!==e.priority&&(s=!0)),a||=null!==e.faceAlpha,r||=null!==e.faceLabel)}const c=new Int32Array(n),d=new Int32Array(n),f=new Int32Array(n),u=new Int32Array(n),p=new Int32Array(h),m=new Int32Array(h),g=new Int32Array(h),w=new Int32Array(o),y=new Int32Array(o),C=new Int32Array(o);let b=null;i&&(b=new Int32Array(h));let S=null;s&&(S=new Int32Array(h));let T=null;a&&(T=new Int32Array(h));let v=null;r&&(v=new Int32Array(h));const x=new Int32Array(h);n=0,h=0,o=0;const A=(t,e,i,s,a,r,n)=>{let h=-1;const o=t.vertexX[e],l=t.vertexY[e],c=t.vertexZ[e];for(let t=0;t<n;t++)if(o===i[t]&&l===s[t]&&c===a[t]){h=t;break}return-1===h&&(i[n]=o,s[n]=l,a[n]=c,r&&t.vertexLabel&&(r[n]=t.vertexLabel[e]),h=n++),{vertex:h,vertexCount:n}};for(let l=0;l<e;l++){const e=t[l];if(e){for(let t=0;t<e.faceCount;t++){i&&(e.faceInfo?b&&(b[h]=e.faceInfo[t]):b&&(b[h]=0)),s&&(e.facePriority?S&&(S[h]=e.facePriority[t]):S&&(S[h]=e.priority)),a&&(e.faceAlpha?T&&(T[h]=e.faceAlpha[t]):T&&(T[h]=0)),r&&e.faceLabel&&v&&(v[h]=e.faceLabel[t]),e.faceColor&&(x[h]=e.faceColor[t]);const o=A(e,e.faceVertexA[t],c,d,f,u,n);n=o.vertexCount;const l=A(e,e.faceVertexB[t],c,d,f,u,n);n=l.vertexCount;const w=A(e,e.faceVertexC[t],c,d,f,u,n);n=w.vertexCount,p[h]=o.vertex,m[h]=l.vertex,g[h]=w.vertex,h++}for(let t=0;t<e.texturedFaceCount;t++){const i=A(e,e.texturedVertexA[t],c,d,f,u,n);n=i.vertexCount;const s=A(e,e.texturedVertexB[t],c,d,f,u,n);n=s.vertexCount;const a=A(e,e.texturedVertexC[t],c,d,f,u,n);n=a.vertexCount,w[o]=i.vertex,y[o]=s.vertex,C[o]=a.vertex,o++}}}return new _({vertexCount:n,vertexX:c,vertexY:d,vertexZ:f,faceCount:h,faceVertexA:p,faceVertexB:m,faceVertexC:g,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:b,facePriority:S,faceAlpha:T,faceColor:x,priority:l,texturedFaceCount:o,texturedVertexA:w,texturedVertexB:y,texturedVertexC:C,vertexLabel:u,faceLabel:v})};static model=t=>{if(!(_.head&&_.face1&&_.face2&&_.face3&&_.face4&&_.face5&&_.point1&&_.point2&&_.point3&&_.point4&&_.point5&&_.vertex1&&_.vertex2&&_.axis))throw new Error("cant loading model!!!!!");if(!_.metadata)throw new Error("cant loading model metadata!!!!!");const e=_.metadata[t];if(void 0===e)throw console.log(`Error model:${t} not found!`),new Error("cant loading model metadata!!!!!");const i=e.vertexCount,s=e.faceCount,a=e.texturedFaceCount,r=new Int32Array(i),n=new Int32Array(i),h=new Int32Array(i),o=new Int32Array(s),l=new Int32Array(s),c=new Int32Array(s),d=new Int32Array(a),f=new Int32Array(a),u=new Int32Array(a);let p=null;e.vertexLabelsOffset>=0&&(p=new Int32Array(i));let m=null;e.faceInfosOffset>=0&&(m=new Int32Array(s));let g=null,w=0;e.facePrioritiesOffset>=0?g=new Int32Array(s):w=-e.facePrioritiesOffset-1;let y=null;e.faceAlphasOffset>=0&&(y=new Int32Array(s));let C=null;e.faceLabelsOffset>=0&&(C=new Int32Array(s));const b=new Int32Array(s);_.point1.pos=e.vertexFlagsOffset,_.point2.pos=e.vertexXOffset,_.point3.pos=e.vertexYOffset,_.point4.pos=e.vertexZOffset,_.point5.pos=e.vertexLabelsOffset;let S,T,v,x=0,A=0,I=0;for(let t=0;t<i;t++){const e=_.point1.g1;S=0,0!=(1&e)&&(S=_.point2.gsmart),T=0,0!=(2&e)&&(T=_.point3.gsmart),v=0,0!=(4&e)&&(v=_.point4.gsmart),r[t]=x+S,n[t]=A+T,h[t]=I+v,x=r[t],A=n[t],I=h[t],p&&(p[t]=_.point5.g1)}_.face1.pos=e.faceColorsOffset,_.face2.pos=e.faceInfosOffset,_.face3.pos=e.facePrioritiesOffset,_.face4.pos=e.faceAlphasOffset,_.face5.pos=e.faceLabelsOffset;for(let t=0;t<s;t++)b[t]=_.face1.g2,m&&(m[t]=_.face2.g1),g&&(g[t]=_.face3.g1),y&&(y[t]=_.face4.g1),C&&(C[t]=_.face5.g1);_.vertex1.pos=e.faceVerticesOffset,_.vertex2.pos=e.faceOrientationsOffset,S=0,T=0,v=0;let O=0;for(let t=0;t<s;t++){const e=_.vertex2.g1;if(1===e)S=_.vertex1.gsmart+O,O=S,T=_.vertex1.gsmart+O,O=T,v=_.vertex1.gsmart+O,O=v;else if(2===e)T=v,v=_.vertex1.gsmart+O,O=v;else if(3===e)S=v,v=_.vertex1.gsmart+O,O=v;else if(4===e){const t=S;S=T,T=t,v=_.vertex1.gsmart+O,O=v}o[t]=S,l[t]=T,c[t]=v}_.axis.pos=6*e.faceTextureAxisOffset;for(let t=0;t<a;t++)d[t]=_.axis.g2,f[t]=_.axis.g2,u[t]=_.axis.g2;return new _({vertexCount:i,vertexX:r,vertexY:n,vertexZ:h,faceCount:s,faceVertexA:o,faceVertexB:l,faceVertexC:c,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:m,facePriority:g,faceAlpha:y,faceColor:b,priority:w,texturedFaceCount:a,texturedVertexA:d,texturedVertexB:f,texturedVertexC:u,vertexLabel:p,faceLabel:C})};vertexCount;vertexX;vertexY;vertexZ;faceCount;faceVertexA;faceVertexB;faceVertexC;faceColorA;faceColorB;faceColorC;faceInfo;facePriority;faceAlpha;faceColor;priority;texturedFaceCount;texturedVertexA;texturedVertexB;texturedVertexC;minX;maxX;minZ;maxZ;radius;minY;maxY;maxDepth;minDepth;vertexLabel;faceLabel;labelVertices;labelFaces;vertexNormal;vertexNormalOriginal;objRaise=0;pickable=!1;constructor(t){super(),this.vertexCount=t.vertexCount,this.vertexX=t.vertexX,this.vertexY=t.vertexY,this.vertexZ=t.vertexZ,this.faceCount=t.faceCount,this.faceVertexA=t.faceVertexA,this.faceVertexB=t.faceVertexB,this.faceVertexC=t.faceVertexC,this.faceColorA=t.faceColorA,this.faceColorB=t.faceColorB,this.faceColorC=t.faceColorC,this.faceInfo=t.faceInfo,this.facePriority=t.facePriority,this.faceAlpha=t.faceAlpha,this.faceColor=t.faceColor,this.priority=t.priority,this.texturedFaceCount=t.texturedFaceCount,this.texturedVertexA=t.texturedVertexA,this.texturedVertexB=t.texturedVertexB,this.texturedVertexC=t.texturedVertexC,this.minX=t.minX??0,this.maxX=t.maxX??0,this.minZ=t.minZ??0,this.maxZ=t.maxZ??0,this.radius=t.radius??0,this.minY=t.minY??0,this.maxY=t.maxY??0,this.maxDepth=t.maxDepth??0,this.minDepth=t.minDepth??0,this.vertexLabel=t.vertexLabel??null,this.faceLabel=t.faceLabel??null,this.labelVertices=t.labelVertices??null,this.labelFaces=t.labelFaces??null,this.vertexNormal=t.vertexNormal??null,this.vertexNormalOriginal=t.vertexNormalOriginal??null}calculateBoundsCylinder=()=>{this.maxY=0,this.radius=0,this.minY=0;for(let t=0;t<this.vertexCount;t++){const e=this.vertexX[t],i=this.vertexY[t],s=this.vertexZ[t];-i>this.maxY&&(this.maxY=-i),i>this.minY&&(this.minY=i);const a=e*e+s*s;a>this.radius&&(this.radius=a)}this.radius=Math.trunc(Math.sqrt(this.radius)+.99),this.minDepth=Math.trunc(Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+.99),this.maxDepth=this.minDepth+Math.trunc(Math.sqrt(this.radius*this.radius+this.minY*this.minY)+.99)};calculateBoundsY=()=>{this.maxY=0,this.minY=0;for(let t=0;t<this.vertexCount;t++){const e=this.vertexY[t];-e>this.maxY&&(this.maxY=-e),e>this.minY&&(this.minY=e)}this.minDepth=Math.trunc(Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+.99),this.maxDepth=this.minDepth+Math.trunc(Math.sqrt(this.radius*this.radius+this.minY*this.minY)+.99)};createLabelReferences=()=>{if(this.vertexLabel){const t=new Array(256).fill(0);let e=0;for(let i=0;i<this.vertexCount;i++){const s=this.vertexLabel[i];t[s]++,s>e&&(e=s)}this.labelVertices=new Array(e+1);for(let i=0;i<=e;i++)this.labelVertices[i]=new Int32Array(t[i]),t[i]=0;let i=0;for(;i<this.vertexCount;){const e=this.vertexLabel[i];this.labelVertices[e][t[e]++]=i++}this.vertexLabel=null}if(this.faceLabel){const t=new Array(256).fill(0);let e=0;for(let i=0;i<this.faceCount;i++){const s=this.faceLabel[i];t[s]++,s>e&&(e=s)}this.labelFaces=new Array(e+1);for(let i=0;i<=e;i++)this.labelFaces[i]=new Int32Array(t[i]),t[i]=0;let i=0;for(;i<this.faceCount;){const e=this.faceLabel[i];this.labelFaces[e][t[e]++]=i++}this.faceLabel=null}};applyTransforms=(t,e,i)=>{if(-1!==t)if(i&&-1!==e){const s=c.instances[t],a=c.instances[e],r=s.base;_.baseX=0,_.baseY=0,_.baseZ=0;let n=0,h=i[n++];for(let t=0;t<s.length;t++){if(!s.bases)continue;const e=s.bases[t];for(;e>h;)h=i[n++];r&&r.types&&s.x&&s.y&&s.z&&r.labels&&(e!==h||0===r.types[e])&&this.applyTransform2(s.x[t],s.y[t],s.z[t],r.labels[e],r.types[e])}_.baseX=0,_.baseY=0,_.baseZ=0,n=0,h=i[n++];for(let t=0;t<a.length;t++){if(!a.bases)continue;const e=a.bases[t];for(;e>h;)h=i[n++];r&&r.types&&a.x&&a.y&&a.z&&r.labels&&(e===h||0===r.types[e])&&this.applyTransform2(a.x[t],a.y[t],a.z[t],r.labels[e],r.types[e])}}else this.applyTransform(t)};applyTransform=t=>{if(!this.labelVertices||-1===t||!c.instances[t])return;const e=c.instances[t],i=e.base;_.baseX=0,_.baseY=0,_.baseZ=0;for(let t=0;t<e.length;t++){if(!(e.bases&&e.x&&e.y&&e.z&&i&&i.labels&&i.types))continue;const s=e.bases[t];this.applyTransform2(e.x[t],e.y[t],e.z[t],i.labels[s],i.types[s])}};rotateY90=()=>{for(let t=0;t<this.vertexCount;t++){const e=this.vertexX[t];this.vertexX[t]=this.vertexZ[t],this.vertexZ[t]=-e}};rotateX=t=>{const e=A.sin[t],i=A.cos[t];for(let t=0;t<this.vertexCount;t++){const s=this.vertexY[t]*i-this.vertexZ[t]*e>>16;this.vertexZ[t]=this.vertexY[t]*e+this.vertexZ[t]*i>>16,this.vertexY[t]=s}};translate=(t,e,i)=>{for(let s=0;s<this.vertexCount;s++)this.vertexX[s]+=e,this.vertexY[s]+=t,this.vertexZ[s]+=i};recolor=(t,e)=>{if(this.faceColor)for(let i=0;i<this.faceCount;i++)this.faceColor[i]===t&&(this.faceColor[i]=e)};rotateY180=()=>{for(let t=0;t<this.vertexCount;t++)this.vertexZ[t]=-this.vertexZ[t];for(let t=0;t<this.faceCount;t++){const e=this.faceVertexA[t];this.faceVertexA[t]=this.faceVertexC[t],this.faceVertexC[t]=e}};scale=(t,e,i)=>{for(let s=0;s<this.vertexCount;s++)this.vertexX[s]=Math.trunc(this.vertexX[s]*t/128),this.vertexY[s]=Math.trunc(this.vertexY[s]*e/128),this.vertexZ[s]=Math.trunc(this.vertexZ[s]*i/128)};calculateNormals=(t,e,i,s,a,r)=>{const n=e*Math.trunc(Math.sqrt(i*i+s*s+a*a))>>8;if(this.faceColorA&&this.faceColorB&&this.faceColorC||(this.faceColorA=new Int32Array(this.faceCount),this.faceColorB=new Int32Array(this.faceCount),this.faceColorC=new Int32Array(this.faceCount)),!this.vertexNormal){this.vertexNormal=new Array(this.vertexCount);for(let t=0;t<this.vertexCount;t++)this.vertexNormal[t]=new O}for(let e=0;e<this.faceCount;e++){const r=this.faceVertexA[e],h=this.faceVertexB[e],o=this.faceVertexC[e],l=this.vertexX[h]-this.vertexX[r],c=this.vertexY[h]-this.vertexY[r],d=this.vertexZ[h]-this.vertexZ[r],f=this.vertexX[o]-this.vertexX[r],u=this.vertexY[o]-this.vertexY[r],p=this.vertexZ[o]-this.vertexZ[r];let m=c*p-u*d,g=d*f-p*l,w=l*u-f*c;for(;m>8192||g>8192||w>8192||m<-8192||g<-8192||w<-8192;)m>>=1,g>>=1,w>>=1;let y=Math.trunc(Math.sqrt(m*m+g*g+w*w));if(y<=0&&(y=1),m=Math.trunc(256*m/y),g=Math.trunc(256*g/y),w=Math.trunc(256*w/y),this.faceInfo&&0!=(1&this.faceInfo[e])){const r=t+Math.trunc((i*m+s*g+a*w)/(n+Math.trunc(n/2)));this.faceColor&&(this.faceColorA[e]=_.mulColorLightness(this.faceColor[e],r,this.faceInfo[e]))}else{let t=this.vertexNormal[r];t.x+=m,t.y+=g,t.z+=w,t.w++,t=this.vertexNormal[h],t.x+=m,t.y+=g,t.z+=w,t.w++,t=this.vertexNormal[o],t.x+=m,t.y+=g,t.z+=w,t.w++}}if(r)this.applyLighting(t,n,i,s,a);else{this.vertexNormalOriginal=new Array(this.vertexCount);for(let t=0;t<this.vertexCount;t++){const e=this.vertexNormal[t],i=new O;i.x=e.x,i.y=e.y,i.z=e.z,i.w=e.w,this.vertexNormalOriginal[t]=i}}r?this.calculateBoundsCylinder():this.calculateBoundsAABB()};applyLighting=(t,e,i,s,a)=>{for(let r=0;r<this.faceCount;r++){const n=this.faceVertexA[r],h=this.faceVertexB[r],o=this.faceVertexC[r];if(!this.faceInfo&&this.faceColor&&this.vertexNormal&&this.faceColorA&&this.faceColorB&&this.faceColorC){const l=this.faceColor[r];let c=this.vertexNormal[n],d=t+Math.trunc((i*c.x+s*c.y+a*c.z)/(e*c.w));this.faceColorA[r]=_.mulColorLightness(l,d,0),c=this.vertexNormal[h],d=t+Math.trunc((i*c.x+s*c.y+a*c.z)/(e*c.w)),this.faceColorB[r]=_.mulColorLightness(l,d,0),c=this.vertexNormal[o],d=t+Math.trunc((i*c.x+s*c.y+a*c.z)/(e*c.w)),this.faceColorC[r]=_.mulColorLightness(l,d,0)}else if(this.faceInfo&&0==(1&this.faceInfo[r])&&this.faceColor&&this.vertexNormal&&this.faceColorA&&this.faceColorB&&this.faceColorC){const l=this.faceColor[r],c=this.faceInfo[r];let d=this.vertexNormal[n],f=t+Math.trunc((i*d.x+s*d.y+a*d.z)/(e*d.w));this.faceColorA[r]=_.mulColorLightness(l,f,c),d=this.vertexNormal[h],f=t+Math.trunc((i*d.x+s*d.y+a*d.z)/(e*d.w)),this.faceColorB[r]=_.mulColorLightness(l,f,c),d=this.vertexNormal[o],f=t+Math.trunc((i*d.x+s*d.y+a*d.z)/(e*d.w)),this.faceColorC[r]=_.mulColorLightness(l,f,c)}}if(this.vertexNormal=null,this.vertexNormalOriginal=null,this.vertexLabel=null,this.faceLabel=null,this.faceInfo)for(let t=0;t<this.faceCount;t++)if(2==(2&this.faceInfo[t]))return;this.faceColor=null};drawSimple=(t,e,i,s,a,r,n)=>{const h=A.sin[t],o=A.cos[t],l=A.sin[e],c=A.cos[e],d=A.sin[i],f=A.cos[i],u=A.sin[s],p=A.cos[s],m=r*u+n*p>>16;for(let s=0;s<this.vertexCount;s++){let g,w=this.vertexX[s],y=this.vertexY[s],C=this.vertexZ[s];0!==i&&(g=y*d+w*f>>16,y=y*f-w*d>>16,w=g),0!==t&&(g=y*o-C*h>>16,C=y*h+C*o>>16,y=g),0!==e&&(g=C*l+w*c>>16,C=C*c-w*l>>16,w=g),w+=a,y+=r,C+=n,g=y*p-C*u>>16,C=y*u+C*p>>16,y=g,_.vertexScreenX&&_.vertexScreenY&&_.vertexScreenZ&&(_.vertexScreenX[s]=A.centerX+Math.trunc((w<<9)/C),_.vertexScreenY[s]=A.centerY+Math.trunc((y<<9)/C),_.vertexScreenZ[s]=C-m),this.texturedFaceCount>0&&_.vertexViewSpaceX&&_.vertexViewSpaceY&&_.vertexViewSpaceZ&&(_.vertexViewSpaceX[s]=w,_.vertexViewSpaceY[s]=y,_.vertexViewSpaceZ[s]=C)}this.draw2(!1,!1,0)};draw=(t,e,i,s,a,r,n,h,o)=>{const l=h*a-r*s>>16,c=n*e+l*i>>16,d=this.radius*i>>16,f=c+d;if(f<=50||c>=3500)return;const u=h*s+r*a>>16;let p=u-this.radius<<9;if(Math.trunc(p/f)>=w.centerX)return;let m=u+this.radius<<9;if(Math.trunc(m/f)<=-w.centerX)return;const g=n*i-l*e>>16,y=this.radius*e>>16;let C=g+y<<9;if(Math.trunc(C/f)<=-w.centerY)return;let b=g-(y+(this.maxY*i>>16))<<9;if(Math.trunc(b/f)>=w.centerY)return;let S=c-(d+(this.maxY*e>>16))<=50,T=!1;if(o>0&&_.checkHover){let t=c-d;t<=50&&(t=50),u>0?(p=Math.trunc(p/f),m=Math.trunc(m/t)):(m=Math.trunc(m/f),p=Math.trunc(p/t)),g>0?(b=Math.trunc(b/f),C=Math.trunc(C/t)):(C=Math.trunc(C/f),b=Math.trunc(b/t));const e=_.mouseX-A.centerX,i=_.mouseZ-A.centerY;e>p&&e<m&&i>b&&i<C&&(this.pickable?_.pickedBitsets[_.pickedCount++]=o:T=!0)}const v=A.centerX,x=A.centerY;let I=0,O=0;0!==t&&(I=A.sin[t],O=A.cos[t]);for(let o=0;o<this.vertexCount;o++){let l,d=this.vertexX[o],f=this.vertexY[o],u=this.vertexZ[o];0!==t&&(l=u*I+d*O>>16,u=u*O-d*I>>16,d=l),d+=r,f+=n,u+=h,l=u*s+d*a>>16,u=u*a-d*s>>16,d=l,l=f*i-u*e>>16,u=f*e+u*i>>16,_.vertexScreenZ&&(_.vertexScreenZ[o]=u-c),u>=50&&_.vertexScreenX&&_.vertexScreenY?(_.vertexScreenX[o]=v+Math.trunc((d<<9)/u),_.vertexScreenY[o]=x+Math.trunc((l<<9)/u)):_.vertexScreenX&&(_.vertexScreenX[o]=-5e3,S=!0),(S||this.texturedFaceCount>0)&&_.vertexViewSpaceX&&_.vertexViewSpaceY&&_.vertexViewSpaceZ&&(_.vertexViewSpaceX[o]=d,_.vertexViewSpaceY[o]=l,_.vertexViewSpaceZ[o]=u)}this.draw2(S,T,o)};draw2=(t,e,i)=>{for(let t=0;t<this.maxDepth;t++)_.tmpDepthFaceCount&&(_.tmpDepthFaceCount[t]=0);for(let s=0;s<this.faceCount;s++)if((!this.faceInfo||-1!==this.faceInfo[s])&&_.vertexScreenX){const a=this.faceVertexA[s],r=this.faceVertexB[s],n=this.faceVertexC[s],h=_.vertexScreenX[a],o=_.vertexScreenX[r],l=_.vertexScreenX[n];if(!t||-5e3!==h&&-5e3!==o&&-5e3!==l){if(_.vertexScreenY){e&&this.pointWithinTriangle(_.mouseX,_.mouseZ,_.vertexScreenY[a],_.vertexScreenY[r],_.vertexScreenY[n],h,o,l)&&(_.pickedBitsets[_.pickedCount++]=i,e=!1);const t=h-o,c=_.vertexScreenY[a]-_.vertexScreenY[r],d=l-o;if(t*(_.vertexScreenY[n]-_.vertexScreenY[r])-c*d<=0)continue;if(_.faceNearClipped&&(_.faceNearClipped[s]=!1),_.faceClippedX&&(_.faceClippedX[s]=h<0||o<0||l<0||h>w.boundX||o>w.boundX||l>w.boundX),_.vertexScreenZ&&_.tmpDepthFaces&&_.tmpDepthFaceCount){const t=Math.trunc((_.vertexScreenZ[a]+_.vertexScreenZ[r]+_.vertexScreenZ[n])/3)+this.minDepth;_.tmpDepthFaces[t][_.tmpDepthFaceCount[t]++]=s}}}else if(_.faceNearClipped&&(_.faceNearClipped[s]=!0),_.vertexScreenZ&&_.tmpDepthFaces&&_.tmpDepthFaceCount){const t=Math.trunc((_.vertexScreenZ[a]+_.vertexScreenZ[r]+_.vertexScreenZ[n])/3)+this.minDepth;_.tmpDepthFaces[t][_.tmpDepthFaceCount[t]++]=s}}if(!this.facePriority&&_.tmpDepthFaceCount){for(let t=this.maxDepth-1;t>=0;t--){const e=_.tmpDepthFaceCount[t];if(!(e<=0)&&_.tmpDepthFaces){const i=_.tmpDepthFaces[t];for(let t=0;t<e;t++)this.drawFace(i[t])}}return}for(let t=0;t<12;t++)_.tmpPriorityFaceCount&&_.tmpPriorityDepthSum&&(_.tmpPriorityFaceCount[t]=0,_.tmpPriorityDepthSum[t]=0);if(_.tmpDepthFaceCount)for(let t=this.maxDepth-1;t>=0;t--){const e=_.tmpDepthFaceCount[t];if(e>0&&_.tmpDepthFaces){const i=_.tmpDepthFaces[t];for(let s=0;s<e;s++)if(this.facePriority&&_.tmpPriorityFaceCount&&_.tmpPriorityFaces){const e=i[s],a=this.facePriority[e],r=_.tmpPriorityFaceCount[a]++;_.tmpPriorityFaces[a][r]=e,a<10&&_.tmpPriorityDepthSum?_.tmpPriorityDepthSum[a]+=t:10===a&&_.tmpPriority10FaceDepth?_.tmpPriority10FaceDepth[r]=t:_.tmpPriority11FaceDepth&&(_.tmpPriority11FaceDepth[r]=t)}}}let s=0;_.tmpPriorityFaceCount&&_.tmpPriorityDepthSum&&(_.tmpPriorityFaceCount[1]>0||_.tmpPriorityFaceCount[2]>0)&&(s=Math.trunc((_.tmpPriorityDepthSum[1]+_.tmpPriorityDepthSum[2])/(_.tmpPriorityFaceCount[1]+_.tmpPriorityFaceCount[2])));let a=0;_.tmpPriorityFaceCount&&_.tmpPriorityDepthSum&&(_.tmpPriorityFaceCount[3]>0||_.tmpPriorityFaceCount[4]>0)&&(a=Math.trunc((_.tmpPriorityDepthSum[3]+_.tmpPriorityDepthSum[4])/(_.tmpPriorityFaceCount[3]+_.tmpPriorityFaceCount[4])));let r=0;if(_.tmpPriorityFaceCount&&_.tmpPriorityDepthSum&&(_.tmpPriorityFaceCount[6]>0||_.tmpPriorityFaceCount[8]>0)&&(r=Math.trunc((_.tmpPriorityDepthSum[6]+_.tmpPriorityDepthSum[8])/(_.tmpPriorityFaceCount[6]+_.tmpPriorityFaceCount[8]))),_.tmpPriorityFaceCount&&_.tmpPriorityFaces){let t,e=0,i=_.tmpPriorityFaceCount[10],n=_.tmpPriorityFaces[10],h=_.tmpPriority10FaceDepth;e===i&&(e=0,i=_.tmpPriorityFaceCount[11],n=_.tmpPriorityFaces[11],h=_.tmpPriority11FaceDepth),t=e<i&&h?h[e]:-1e3;for(let o=0;o<10;o++){for(;0===o&&t>s;)this.drawFace(n[e++]),e===i&&n!==_.tmpPriorityFaces[11]&&(e=0,i=_.tmpPriorityFaceCount[11],n=_.tmpPriorityFaces[11],h=_.tmpPriority11FaceDepth),t=e<i&&h?h[e]:-1e3;for(;3===o&&t>a;)this.drawFace(n[e++]),e===i&&n!==_.tmpPriorityFaces[11]&&(e=0,i=_.tmpPriorityFaceCount[11],n=_.tmpPriorityFaces[11],h=_.tmpPriority11FaceDepth),t=e<i&&h?h[e]:-1e3;for(;5===o&&t>r;)this.drawFace(n[e++]),e===i&&n!==_.tmpPriorityFaces[11]&&(e=0,i=_.tmpPriorityFaceCount[11],n=_.tmpPriorityFaces[11],h=_.tmpPriority11FaceDepth),t=e<i&&h?h[e]:-1e3;const l=_.tmpPriorityFaceCount[o],c=_.tmpPriorityFaces[o];for(let t=0;t<l;t++)this.drawFace(c[t])}for(;-1e3!==t;)this.drawFace(n[e++]),e===i&&n!==_.tmpPriorityFaces[11]&&(e=0,n=_.tmpPriorityFaces[11],i=_.tmpPriorityFaceCount[11],h=_.tmpPriority11FaceDepth),t=e<i&&h?h[e]:-1e3}};drawFace=t=>{if(_.faceNearClipped&&_.faceNearClipped[t])return void this.drawNearClippedFace(t);const e=this.faceVertexA[t],i=this.faceVertexB[t],s=this.faceVertexC[t];let a;if(_.faceClippedX&&(A.clipX=_.faceClippedX[t]),this.faceAlpha?A.alpha=this.faceAlpha[t]:A.alpha=0,a=this.faceInfo?3&this.faceInfo[t]:0,0===a&&this.faceColorA&&this.faceColorB&&this.faceColorC&&_.vertexScreenX&&_.vertexScreenY)A.fillGouraudTriangle(_.vertexScreenX[e],_.vertexScreenX[i],_.vertexScreenX[s],_.vertexScreenY[e],_.vertexScreenY[i],_.vertexScreenY[s],this.faceColorA[t],this.faceColorB[t],this.faceColorC[t]);else if(1===a)this.faceColorA&&_.vertexScreenX&&_.vertexScreenY&&A.fillTriangle(_.vertexScreenX[e],_.vertexScreenX[i],_.vertexScreenX[s],_.vertexScreenY[e],_.vertexScreenY[i],_.vertexScreenY[s],A.palette[this.faceColorA[t]]);else if(2===a&&this.faceInfo&&this.faceColor&&this.faceColorA&&this.faceColorB&&this.faceColorC&&_.vertexScreenX&&_.vertexScreenY&&_.vertexViewSpaceX&&_.vertexViewSpaceY&&_.vertexViewSpaceZ){const a=this.faceInfo[t]>>2,r=this.texturedVertexA[a],n=this.texturedVertexB[a],h=this.texturedVertexC[a];A.fillTexturedTriangle(_.vertexScreenX[e],_.vertexScreenX[i],_.vertexScreenX[s],_.vertexScreenY[e],_.vertexScreenY[i],_.vertexScreenY[s],this.faceColorA[t],this.faceColorB[t],this.faceColorC[t],_.vertexViewSpaceX[r],_.vertexViewSpaceY[r],_.vertexViewSpaceZ[r],_.vertexViewSpaceX[n],_.vertexViewSpaceX[h],_.vertexViewSpaceY[n],_.vertexViewSpaceY[h],_.vertexViewSpaceZ[n],_.vertexViewSpaceZ[h],this.faceColor[t])}else if(3===a&&this.faceInfo&&this.faceColor&&this.faceColorA&&_.vertexScreenX&&_.vertexScreenY&&_.vertexViewSpaceX&&_.vertexViewSpaceY&&_.vertexViewSpaceZ){const a=this.faceInfo[t]>>2,r=this.texturedVertexA[a],n=this.texturedVertexB[a],h=this.texturedVertexC[a];A.fillTexturedTriangle(_.vertexScreenX[e],_.vertexScreenX[i],_.vertexScreenX[s],_.vertexScreenY[e],_.vertexScreenY[i],_.vertexScreenY[s],this.faceColorA[t],this.faceColorA[t],this.faceColorA[t],_.vertexViewSpaceX[r],_.vertexViewSpaceY[r],_.vertexViewSpaceZ[r],_.vertexViewSpaceX[n],_.vertexViewSpaceX[h],_.vertexViewSpaceY[n],_.vertexViewSpaceY[h],_.vertexViewSpaceZ[n],_.vertexViewSpaceZ[h],this.faceColor[t])}};drawNearClippedFace=t=>{let e=0;if(_.vertexViewSpaceZ){const i=A.centerX,s=A.centerY,a=this.faceVertexA[t],r=this.faceVertexB[t],n=this.faceVertexC[t],h=_.vertexViewSpaceZ[a],o=_.vertexViewSpaceZ[r],l=_.vertexViewSpaceZ[n];if(h>=50&&_.vertexScreenX&&_.vertexScreenY&&this.faceColorA)_.clippedX[e]=_.vertexScreenX[a],_.clippedY[e]=_.vertexScreenY[a],_.clippedColor[e++]=this.faceColorA[t];else if(_.vertexViewSpaceX&&_.vertexViewSpaceY&&this.faceColorA){const c=_.vertexViewSpaceX[a],d=_.vertexViewSpaceY[a],f=this.faceColorA[t];if(l>=50&&this.faceColorC){const a=(50-h)*A.reciprocal16[l-h];_.clippedX[e]=i+Math.trunc((c+((_.vertexViewSpaceX[n]-c)*a>>16)<<9)/50),_.clippedY[e]=s+Math.trunc((d+((_.vertexViewSpaceY[n]-d)*a>>16)<<9)/50),_.clippedColor[e++]=f+((this.faceColorC[t]-f)*a>>16)}if(o>=50&&this.faceColorB){const a=(50-h)*A.reciprocal16[o-h];_.clippedX[e]=i+Math.trunc((c+((_.vertexViewSpaceX[r]-c)*a>>16)<<9)/50),_.clippedY[e]=s+Math.trunc((d+((_.vertexViewSpaceY[r]-d)*a>>16)<<9)/50),_.clippedColor[e++]=f+((this.faceColorB[t]-f)*a>>16)}}if(o>=50&&_.vertexScreenX&&_.vertexScreenY&&this.faceColorB)_.clippedX[e]=_.vertexScreenX[r],_.clippedY[e]=_.vertexScreenY[r],_.clippedColor[e++]=this.faceColorB[t];else if(_.vertexViewSpaceX&&_.vertexViewSpaceY&&this.faceColorB){const c=_.vertexViewSpaceX[r],d=_.vertexViewSpaceY[r],f=this.faceColorB[t];if(h>=50&&this.faceColorA){const r=(50-o)*A.reciprocal16[h-o];_.clippedX[e]=i+Math.trunc((c+((_.vertexViewSpaceX[a]-c)*r>>16)<<9)/50),_.clippedY[e]=s+Math.trunc((d+((_.vertexViewSpaceY[a]-d)*r>>16)<<9)/50),_.clippedColor[e++]=f+((this.faceColorA[t]-f)*r>>16)}if(l>=50&&this.faceColorC){const a=(50-o)*A.reciprocal16[l-o];_.clippedX[e]=i+Math.trunc((c+((_.vertexViewSpaceX[n]-c)*a>>16)<<9)/50),_.clippedY[e]=s+Math.trunc((d+((_.vertexViewSpaceY[n]-d)*a>>16)<<9)/50),_.clippedColor[e++]=f+((this.faceColorC[t]-f)*a>>16)}}if(l>=50&&_.vertexScreenX&&_.vertexScreenY&&this.faceColorC)_.clippedX[e]=_.vertexScreenX[n],_.clippedY[e]=_.vertexScreenY[n],_.clippedColor[e++]=this.faceColorC[t];else if(_.vertexViewSpaceX&&_.vertexViewSpaceY&&this.faceColorC){const c=_.vertexViewSpaceX[n],d=_.vertexViewSpaceY[n],f=this.faceColorC[t];if(o>=50&&this.faceColorB){const a=(50-l)*A.reciprocal16[o-l];_.clippedX[e]=i+Math.trunc((c+((_.vertexViewSpaceX[r]-c)*a>>16)<<9)/50),_.clippedY[e]=s+Math.trunc((d+((_.vertexViewSpaceY[r]-d)*a>>16)<<9)/50),_.clippedColor[e++]=f+((this.faceColorB[t]-f)*a>>16)}if(h>=50&&this.faceColorA){const r=(50-l)*A.reciprocal16[h-l];_.clippedX[e]=i+Math.trunc((c+((_.vertexViewSpaceX[a]-c)*r>>16)<<9)/50),_.clippedY[e]=s+Math.trunc((d+((_.vertexViewSpaceY[a]-d)*r>>16)<<9)/50),_.clippedColor[e++]=f+((this.faceColorA[t]-f)*r>>16)}}}const i=_.clippedX[0],s=_.clippedX[1],a=_.clippedX[2],r=_.clippedY[0],n=_.clippedY[1],h=_.clippedY[2];if(!((i-s)*(h-n)-(r-n)*(a-s)<=0))if(A.clipX=!1,3===e){let e;if((i<0||s<0||a<0||i>w.boundX||s>w.boundX||a>w.boundX)&&(A.clipX=!0),e=this.faceInfo?3&this.faceInfo[t]:0,0===e)A.fillGouraudTriangle(i,s,a,r,n,h,_.clippedColor[0],_.clippedColor[1],_.clippedColor[2]);else if(1===e)this.faceColorA&&A.fillTriangle(i,s,a,r,n,h,A.palette[this.faceColorA[t]]);else if(2===e){if(this.faceInfo&&this.faceColor&&_.vertexViewSpaceX&&_.vertexViewSpaceY&&_.vertexViewSpaceZ){const e=this.faceInfo[t]>>2,o=this.texturedVertexA[e],l=this.texturedVertexB[e],c=this.texturedVertexC[e];A.fillTexturedTriangle(i,s,a,r,n,h,_.clippedColor[0],_.clippedColor[1],_.clippedColor[2],_.vertexViewSpaceX[o],_.vertexViewSpaceY[o],_.vertexViewSpaceZ[o],_.vertexViewSpaceX[l],_.vertexViewSpaceX[c],_.vertexViewSpaceY[l],_.vertexViewSpaceY[c],_.vertexViewSpaceZ[l],_.vertexViewSpaceZ[c],this.faceColor[t])}}else if(3===e&&this.faceInfo&&this.faceColor&&this.faceColorA&&_.vertexViewSpaceX&&_.vertexViewSpaceY&&_.vertexViewSpaceZ){const e=this.faceInfo[t]>>2,o=this.texturedVertexA[e],l=this.texturedVertexB[e],c=this.texturedVertexC[e];A.fillTexturedTriangle(i,s,a,r,n,h,this.faceColorA[t],this.faceColorA[t],this.faceColorA[t],_.vertexViewSpaceX[o],_.vertexViewSpaceY[o],_.vertexViewSpaceZ[o],_.vertexViewSpaceX[l],_.vertexViewSpaceX[c],_.vertexViewSpaceY[l],_.vertexViewSpaceY[c],_.vertexViewSpaceZ[l],_.vertexViewSpaceZ[c],this.faceColor[t])}}else if(4===e){let e;if((i<0||s<0||a<0||i>w.boundX||s>w.boundX||a>w.boundX||_.clippedX[3]<0||_.clippedX[3]>w.boundX)&&(A.clipX=!0),e=this.faceInfo?3&this.faceInfo[t]:0,0===e)A.fillGouraudTriangle(i,s,a,r,n,h,_.clippedColor[0],_.clippedColor[1],_.clippedColor[2]),A.fillGouraudTriangle(i,a,_.clippedX[3],r,h,_.clippedY[3],_.clippedColor[0],_.clippedColor[2],_.clippedColor[3]);else if(1===e&&this.faceColorA){const e=A.palette[this.faceColorA[t]];A.fillTriangle(i,s,a,r,n,h,e),A.fillTriangle(i,a,_.clippedX[3],r,h,_.clippedY[3],e)}if(2===e){if(this.faceInfo&&this.faceColor&&_.vertexViewSpaceX&&_.vertexViewSpaceY&&_.vertexViewSpaceZ){const e=this.faceInfo[t]>>2,o=this.texturedVertexA[e],l=this.texturedVertexB[e],c=this.texturedVertexC[e];A.fillTexturedTriangle(i,s,a,r,n,h,_.clippedColor[0],_.clippedColor[1],_.clippedColor[2],_.vertexViewSpaceX[o],_.vertexViewSpaceY[o],_.vertexViewSpaceZ[o],_.vertexViewSpaceX[l],_.vertexViewSpaceX[c],_.vertexViewSpaceY[l],_.vertexViewSpaceY[c],_.vertexViewSpaceZ[l],_.vertexViewSpaceZ[c],this.faceColor[t]),A.fillTexturedTriangle(i,a,_.clippedX[3],r,h,_.clippedY[3],_.clippedColor[0],_.clippedColor[2],_.clippedColor[3],_.vertexViewSpaceX[o],_.vertexViewSpaceY[o],_.vertexViewSpaceZ[o],_.vertexViewSpaceX[l],_.vertexViewSpaceX[c],_.vertexViewSpaceY[l],_.vertexViewSpaceY[c],_.vertexViewSpaceZ[l],_.vertexViewSpaceZ[c],this.faceColor[t])}}else if(3===e&&this.faceInfo&&this.faceColor&&this.faceColorA&&_.vertexViewSpaceX&&_.vertexViewSpaceY&&_.vertexViewSpaceZ){const e=this.faceInfo[t]>>2,o=this.texturedVertexA[e],l=this.texturedVertexB[e],c=this.texturedVertexC[e];A.fillTexturedTriangle(i,s,a,r,n,h,this.faceColorA[t],this.faceColorA[t],this.faceColorA[t],_.vertexViewSpaceX[o],_.vertexViewSpaceY[o],_.vertexViewSpaceZ[o],_.vertexViewSpaceX[l],_.vertexViewSpaceX[c],_.vertexViewSpaceY[l],_.vertexViewSpaceY[c],_.vertexViewSpaceZ[l],_.vertexViewSpaceZ[c],this.faceColor[t]),A.fillTexturedTriangle(i,a,_.clippedX[3],r,h,_.clippedY[3],this.faceColorA[t],this.faceColorA[t],this.faceColorA[t],_.vertexViewSpaceX[o],_.vertexViewSpaceY[o],_.vertexViewSpaceZ[o],_.vertexViewSpaceX[l],_.vertexViewSpaceX[c],_.vertexViewSpaceY[l],_.vertexViewSpaceY[c],_.vertexViewSpaceZ[l],_.vertexViewSpaceZ[c],this.faceColor[t])}}};applyTransform2=(t,e,i,s,a)=>{const r=s.length;if(0===a){let a=0;_.baseX=0,_.baseY=0,_.baseZ=0;for(let t=0;t<r;t++){if(!this.labelVertices)continue;const e=s[t];if(e<this.labelVertices.length){const t=this.labelVertices[e];for(let e=0;e<t.length;e++){const i=t[e];_.baseX+=this.vertexX[i],_.baseY+=this.vertexY[i],_.baseZ+=this.vertexZ[i],a++}}}a>0?(_.baseX=Math.trunc(_.baseX/a)+t,_.baseY=Math.trunc(_.baseY/a)+e,_.baseZ=Math.trunc(_.baseZ/a)+i):(_.baseX=t,_.baseY=e,_.baseZ=i)}else if(1===a)for(let a=0;a<r;a++){const r=s[a];if(!this.labelVertices||r>=this.labelVertices.length)continue;const n=this.labelVertices[r];for(let s=0;s<n.length;s++){const a=n[s];this.vertexX[a]+=t,this.vertexY[a]+=e,this.vertexZ[a]+=i}}else if(2===a)for(let a=0;a<r;a++){const r=s[a];if(!this.labelVertices||r>=this.labelVertices.length)continue;const n=this.labelVertices[r];for(let s=0;s<n.length;s++){const a=n[s];this.vertexX[a]-=_.baseX,this.vertexY[a]-=_.baseY,this.vertexZ[a]-=_.baseZ;const r=8*(255&t),h=8*(255&e),o=8*(255&i);let l,c;if(0!==o){l=A.sin[o],c=A.cos[o];const t=this.vertexY[a]*l+this.vertexX[a]*c>>16;this.vertexY[a]=this.vertexY[a]*c-this.vertexX[a]*l>>16,this.vertexX[a]=t}if(0!==r){l=A.sin[r],c=A.cos[r];const t=this.vertexY[a]*c-this.vertexZ[a]*l>>16;this.vertexZ[a]=this.vertexY[a]*l+this.vertexZ[a]*c>>16,this.vertexY[a]=t}if(0!==h){l=A.sin[h],c=A.cos[h];const t=this.vertexZ[a]*l+this.vertexX[a]*c>>16;this.vertexZ[a]=this.vertexZ[a]*c-this.vertexX[a]*l>>16,this.vertexX[a]=t}this.vertexX[a]+=_.baseX,this.vertexY[a]+=_.baseY,this.vertexZ[a]+=_.baseZ}}else if(3===a)for(let a=0;a<r;a++){const r=s[a];if(!this.labelVertices||r>=this.labelVertices.length)continue;const n=this.labelVertices[r];for(let s=0;s<n.length;s++){const a=n[s];this.vertexX[a]-=_.baseX,this.vertexY[a]-=_.baseY,this.vertexZ[a]-=_.baseZ,this.vertexX[a]=Math.trunc(this.vertexX[a]*t/128),this.vertexY[a]=Math.trunc(this.vertexY[a]*e/128),this.vertexZ[a]=Math.trunc(this.vertexZ[a]*i/128),this.vertexX[a]+=_.baseX,this.vertexY[a]+=_.baseY,this.vertexZ[a]+=_.baseZ}}else if(5===a&&this.labelFaces&&this.faceAlpha)for(let e=0;e<r;e++){const i=s[e];if(i>=this.labelFaces.length)continue;const a=this.labelFaces[i];for(let e=0;e<a.length;e++){const i=a[e];this.faceAlpha[i]+=8*t,this.faceAlpha[i]<0&&(this.faceAlpha[i]=0),this.faceAlpha[i]>255&&(this.faceAlpha[i]=255)}}};calculateBoundsAABB=()=>{this.maxY=0,this.radius=0,this.minY=0,this.minX=999999,this.maxX=-999999,this.maxZ=-99999,this.minZ=99999;for(let t=0;t<this.vertexCount;t++){const e=this.vertexX[t],i=this.vertexY[t],s=this.vertexZ[t];e<this.minX&&(this.minX=e),e>this.maxX&&(this.maxX=e),s<this.minZ&&(this.minZ=s),s>this.maxZ&&(this.maxZ=s),-i>this.maxY&&(this.maxY=-i),i>this.minY&&(this.minY=i);const a=e*e+s*s;a>this.radius&&(this.radius=a)}this.radius=Math.trunc(Math.sqrt(this.radius)),this.minDepth=Math.trunc(Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)),this.maxDepth=this.minDepth+Math.trunc(Math.sqrt(this.radius*this.radius+this.minY*this.minY))};pointWithinTriangle=(t,e,i,s,a,r,n,h)=>!(e<i&&e<s&&e<a||e>i&&e>s&&e>a||t<r&&t<n&&t<h||!(t<=r||t<=n||t<=h))}class k extends t{static count=0;static cache=null;static dat=null;static offsets=null;static cachePos=0;static membersWorld=!0;static modelCache=new p(50);static iconCache=new p(200);static unpack=(t,e)=>{this.membersWorld=e,this.dat=new o(t.read("obj.dat"));const i=new o(t.read("obj.idx"));this.count=i.g2,this.offsets=new Int32Array(this.count);let s=2;for(let t=0;t<this.count;t++)this.offsets[t]=s,s+=i.g2;this.cache=new Array(10);for(let t=0;t<10;t++)this.cache[t]=new k};static get=t=>{if(!this.cache||!this.offsets||!this.dat)throw new Error("ObjType not loaded!!!");for(let e=0;e<10;e++)if(this.cache[e].index===t)return this.cache[e];this.cachePos=(this.cachePos+1)%10;const e=this.cache[this.cachePos];return this.dat.pos=this.offsets[t],e.index=t,e.reset(),e.decodeType(t,this.dat),-1!==e.certtemplate&&e.toCertificate(),!this.membersWorld&&e.members&&(e.name="Members Object",e.desc="Login to a members' server to use this object.",e.ops=[],e.iops=[]),e};static unload=()=>{this.modelCache=null,this.iconCache=null,this.offsets=null,this.cache=null,this.dat=null};static getIcon=(t,e)=>{if(k.iconCache){let i=k.iconCache.get(t);if(i&&i.cropH!==e&&-1!==i.cropH&&(i.unlink(),i=null),i)return i}let i=k.get(t);if(i.countobj||(e=-1),i.countobj&&i.countco&&e>1){let t=-1;for(let s=0;s<10;s++)e>=i.countco[s]&&0!==i.countco[s]&&(t=i.countobj[s]);-1!==t&&(i=k.get(t))}const s=new v(32,32),a=A.centerX,r=A.centerY,n=A.lineOffset,h=w.pixels,o=w.width,l=w.height,c=w.left,d=w.right,f=w.top,u=w.bottom;A.jagged=!1,w.bind(s.pixels,32,32),w.fillRect(0,0,32,32,0),A.init2D();const p=i.getInterfaceModel(1),m=A.sin[i.xan2d]*i.zoom2d>>16,g=A.cos[i.xan2d]*i.zoom2d>>16;p.drawSimple(0,i.yan2d,i.zan2d,i.xan2d,i.xof2d,m+Math.trunc(p.maxY/2)+i.yof2d,g+i.yof2d);for(let t=31;t>=0;t--)for(let e=31;e>=0;e--)0===s.pixels[t+32*e]&&(t>0&&s.pixels[t+32*e-1]>1||e>0&&s.pixels[t+32*(e-1)]>1||t<31&&s.pixels[t+32*e+1]>1||e<31&&s.pixels[t+32*(e+1)]>1)&&(s.pixels[t+32*e]=1);for(let t=31;t>=0;t--)for(let e=31;e>=0;e--)0===s.pixels[t+32*e]&&t>0&&e>0&&s.pixels[t+32*(e-1)-1]>0&&(s.pixels[t+32*e]=3153952);if(-1!==i.certtemplate){const t=this.getIcon(i.certlink,10),e=t.cropW,s=t.cropH;t.cropW=32,t.cropH=32,t.crop(5,5,22,22),t.cropW=e,t.cropH=s}return k.iconCache?.put(t,s),w.bind(h,o,l),w.setBounds(c,f,d,u),A.centerX=a,A.centerY=r,A.lineOffset=n,A.jagged=!0,i.stackable?s.cropW=33:s.cropW=32,s.cropH=e,s};index=-1;model=0;name=null;desc=null;recol_s=null;recol_d=null;zoom2d=2e3;xan2d=0;yan2d=0;zan2d=0;xof2d=0;yof2d=0;code9=!1;code10=-1;stackable=!1;cost=1;members=!1;ops=null;iops=null;manwear=-1;manwear2=-1;manwearOffsetY=0;womanwear=-1;womanwear2=-1;womanwearOffsetY=0;manwear3=-1;womanwear3=-1;manhead=-1;manhead2=-1;womanhead=-1;womanhead2=-1;countobj=null;countco=null;certlink=-1;certtemplate=-1;decode=(t,e,i)=>{if(1===e)this.model=i.g2;else if(2===e)this.name=i.gjstr;else if(3===e)this.desc=i.gjstr;else if(4===e)this.zoom2d=i.g2;else if(5===e)this.xan2d=i.g2;else if(6===e)this.yan2d=i.g2;else if(7===e)this.xof2d=i.g2b,this.xof2d>32767&&(this.xof2d-=65536);else if(8===e)this.yof2d=i.g2b,this.yof2d>32767&&(this.yof2d-=65536);else if(9===e)this.code9=!0;else if(10===e)this.code10=i.g2;else if(11===e)this.stackable=!0;else if(12===e)this.cost=i.g4;else if(16===e)this.members=!0;else if(23===e)this.manwear=i.g2,this.manwearOffsetY=i.g1b;else if(24===e)this.manwear2=i.g2;else if(25===e)this.womanwear=i.g2,this.womanwearOffsetY=i.g1b;else if(26===e)this.womanwear2=i.g2;else if(e>=30&&e<35)this.ops||(this.ops=new Array(5)),this.ops[e-30]=i.gjstr,"hidden"===this.ops[e-30]&&(this.ops[e-30]=null);else if(e>=35&&e<40)this.iops||(this.iops=new Array(5)),this.iops[e-35]=i.gjstr;else if(40===e){const t=i.g1;this.recol_s=new Uint16Array(t),this.recol_d=new Uint16Array(t);for(let e=0;e<t;e++)this.recol_s[e]=i.g2,this.recol_d[e]=i.g2}else 78===e?this.manwear3=i.g2:79===e?this.womanwear3=i.g2:90===e?this.manhead=i.g2:91===e?this.womanhead=i.g2:92===e?this.manhead2=i.g2:93===e?this.womanhead2=i.g2:95===e?this.zan2d=i.g2:97===e?this.certlink=i.g2:98===e?this.certtemplate=i.g2:e>=100&&e<110&&(this.countobj&&this.countco||(this.countobj=new Uint16Array(10),this.countco=new Uint16Array(10)),this.countobj[e-100]=i.g2,this.countco[e-100]=i.g2)};getWornModel=t=>{let e=this.manwear;if(1===t&&(e=this.womanwear),-1===e)return null;let i=this.manwear2,s=this.manwear3;1===t&&(i=this.womanwear2,s=this.womanwear3);let a=_.model(e);if(-1!==i){const t=_.model(i);if(-1===s){const e=[a,t];a=_.modelFromModels(e,2)}else{const e=[a,t,_.model(s)];a=_.modelFromModels(e,3)}}if(0===t&&0!==this.manwearOffsetY&&a.translate(this.manwearOffsetY,0,0),1===t&&0!==this.womanwearOffsetY&&a.translate(this.womanwearOffsetY,0,0),this.recol_s&&this.recol_d)for(let t=0;t<this.recol_s.length;t++)a.recolor(this.recol_s[t],this.recol_d[t]);return a};getHeadModel=t=>{let e=this.manhead;if(1===t&&(e=this.womanhead),-1===e)return null;let i=this.manhead2;1===t&&(i=this.womanhead2);let s=_.model(e);if(-1!==i){const t=[s,_.model(i)];s=_.modelFromModels(t,2)}if(this.recol_s&&this.recol_d)for(let t=0;t<this.recol_s.length;t++)s.recolor(this.recol_s[t],this.recol_d[t]);return s};getInterfaceModel=t=>{if(this.countobj&&this.countco&&t>1){let e=-1;for(let i=0;i<10;i++)t>=this.countco[i]&&0!==this.countco[i]&&(e=this.countobj[i]);if(-1!==e)return k.get(e).getInterfaceModel(1)}if(k.modelCache){const t=k.modelCache.get(this.index);if(t)return t}const e=_.model(this.model);if(this.recol_s&&this.recol_d)for(let t=0;t<this.recol_s.length;t++)e.recolor(this.recol_s[t],this.recol_d[t]);return e.calculateNormals(64,768,-50,-10,-50,!0),e.pickable=!0,k.modelCache?.put(this.index,e),e};toCertificate=()=>{const t=k.get(this.certtemplate);this.model=t.model,this.zoom2d=t.zoom2d,this.xan2d=t.xan2d,this.yan2d=t.yan2d,this.zan2d=t.zan2d,this.xof2d=t.xof2d,this.yof2d=t.yof2d,this.recol_s=t.recol_s,this.recol_d=t.recol_d;const e=k.get(this.certlink);this.name=e.name,this.members=e.members,this.cost=e.cost;let i="a";const s=(e.name||"").toLowerCase().charAt(0);"a"!==s&&"e"!==s&&"i"!==s&&"o"!==s&&"u"!==s||(i="an"),this.desc=`Swap this note at any bank for ${i} ${e.name}.`,this.stackable=!0};reset=()=>{this.model=0,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.zoom2d=2e3,this.xan2d=0,this.yan2d=0,this.zan2d=0,this.xof2d=0,this.yof2d=0,this.code9=!1,this.code10=-1,this.stackable=!1,this.cost=1,this.members=!1,this.ops=[],this.iops=[],this.manwear=-1,this.manwear2=-1,this.manwearOffsetY=0,this.womanwear=-1,this.womanwear2=-1,this.womanwearOffsetY=0,this.manwear3=-1,this.womanwear3=-1,this.manhead=-1,this.manhead2=-1,this.womanhead=-1,this.womanhead2=-1,this.countobj=null,this.countco=null,this.certlink=-1,this.certtemplate=-1}}class L extends t{static count=0;static cache=null;static dat=null;static offsets=null;static cachePos=0;static modelCache=new p(30);static unpack=t=>{this.dat=new o(t.read("npc.dat"));const e=new o(t.read("npc.idx"));this.count=e.g2,this.offsets=new Int32Array(this.count);let i=2;for(let t=0;t<this.count;t++)this.offsets[t]=i,i+=e.g2;this.cache=new Array(20);for(let t=0;t<20;t++)this.cache[t]=new L};static get=t=>{if(!this.cache||!this.offsets||!this.dat)throw new Error("LocType not loaded!!!");for(let e=0;e<20;e++)if(this.cache[e].index===t)return this.cache[e];this.cachePos=(this.cachePos+1)%20;const e=this.cache[this.cachePos]=new L;return this.dat.pos=this.offsets[t],e.index=t,e.decodeType(t,this.dat),e};static unload=()=>{this.modelCache=null,this.offsets=null,this.cache=null,this.dat=null};index=-1;name=null;desc=null;size=1;models=null;heads=null;disposeAlpha=!1;readyanim=-1;walkanim=-1;walkanim_b=-1;walkanim_r=-1;walkanim_l=-1;hasalpha=!1;recol_s=null;recol_d=null;ops=[];code90=-1;code91=-1;code92=-1;visonmap=!0;vislevel=-1;resizeh=128;resizev=128;decode=(t,e,i)=>{if(1===e){const t=i.g1;this.models=new Uint16Array(t);for(let e=0;e<t;e++)this.models[e]=i.g2}else if(2===e)this.name=i.gjstr;else if(3===e)this.desc=i.gjstr;else if(12===e)this.size=i.g1b;else if(13===e)this.readyanim=i.g2;else if(14===e)this.walkanim=i.g2;else if(16===e)this.disposeAlpha=!0;else if(17===e)this.walkanim=i.g2,this.walkanim_b=i.g2,this.walkanim_r=i.g2,this.walkanim_l=i.g2;else if(e>=30&&e<40)this.ops[e-30]=i.gjstr,"hidden"===this.ops[e-30]&&(this.ops[e-30]=null);else if(40===e){const t=i.g1;this.recol_s=new Uint16Array(t),this.recol_d=new Uint16Array(t);for(let e=0;e<t;e++)this.recol_s[e]=i.g2,this.recol_d[e]=i.g2}else if(60===e){const t=i.g1;this.heads=new Uint16Array(t);for(let e=0;e<t;e++)this.heads[e]=i.g2}else 90===e?this.code90=i.g2:91===e?this.code91=i.g2:92===e?this.code92=i.g2:93===e?this.visonmap=!1:95===e?this.vislevel=i.g2:97===e?this.resizeh=i.g2:98===e&&(this.resizev=i.g2)};getSequencedModel=(t,e,i)=>{let s=null,a=null;if(L.modelCache&&(a=L.modelCache.get(this.index),!a&&this.models)){const t=[];for(let e=0;e<this.models.length;e++)t[e]=_.model(this.models[e]);if(a=1===t.length?t[0]:_.modelFromModels(t,t.length),this.recol_s&&this.recol_d)for(let t=0;t<this.recol_s.length;t++)a.recolor(this.recol_s[t],this.recol_d[t]);a.createLabelReferences(),a.calculateNormals(64,850,-30,-50,-30,!0),L.modelCache.put(this.index,a)}return a&&(s=_.modelShareAlpha(a,!this.disposeAlpha)),a?(s=_.modelShareAlpha(a,!this.disposeAlpha),-1!==t&&-1!==e?s.applyTransforms(t,e,i):-1!==t&&s.applyTransform(t),128===this.resizeh&&128===this.resizev||s.scale(this.resizeh,this.resizev,this.resizeh),s.calculateBoundsCylinder(),s.labelFaces=null,s.labelVertices=null,1===this.size&&(s.pickable=!0),s):null};getHeadModel=()=>{if(!this.heads)return null;const t=[];for(let e=0;e<this.heads.length;e++)t[e]=_.model(this.heads[e]);let e;if(e=1===t.length?t[0]:_.modelFromModels(t,t.length),this.recol_s&&this.recol_d)for(let t=0;t<this.recol_s.length;t++)e.recolor(this.recol_s[t],this.recol_d[t]);return e}}class M extends t{static count=0;static instances=[];static unpack=t=>{const e=new o(t.read("idk.dat"));this.count=e.g2;for(let t=0;t<this.count;t++)this.instances[t]=new M,this.instances[t].decodeType(t,e)};type=-1;models=null;heads=new Uint16Array(5).fill(-1);recol_s=new Uint16Array(6);recol_d=new Uint16Array(6);disable=!1;decode=(t,e,i)=>{if(1===e)this.type=i.g1;else if(2===e){const t=i.g1;this.models=new Uint16Array(t);for(let e=0;e<t;e++)this.models[e]=i.g2}else if(3===e)this.disable=!0;else if(e>=40&&e<50)this.recol_s[e-40]=i.g2;else if(e>=50&&e<60)this.recol_d[e-50]=i.g2;else{if(!(e>=60&&e<70))throw new Error(`Unrecognized idk config code: ${e}`);this.heads[e-60]=i.g2}};getModel=()=>{if(!this.models)return null;const t=[];for(let e=0;e<this.models.length;e++)t[e]=_.model(this.models[e]);let e;e=1===t.length?t[0]:_.modelFromModels(t,t.length);for(let t=0;t<6&&0!==this.recol_s[t];t++)e.recolor(this.recol_s[t],this.recol_d[t]);return e};getHeadModel=()=>{let t=0;const e=[];for(let i=0;i<5;i++)-1!==this.heads[i]&&(e[t++]=_.model(this.heads[i]));const i=_.modelFromModels(e,t);for(let t=0;t<6&&0!==this.recol_s[t];t++)i.recolor(this.recol_s[t],this.recol_d[t]);return i}}class E extends t{static count=0;static instances=[];static modelCache=new p(30);static unpack=t=>{const e=new o(t.read("spotanim.dat"));this.count=e.g2;for(let t=0;t<this.count;t++)this.instances[t]=new E,this.instances[t].index=t,this.instances[t].decodeType(t,e)};index=0;model=0;anim=-1;seq=null;disposeAlpha=!1;recol_s=new Uint16Array(6);recol_d=new Uint16Array(6);resizeh=128;resizev=128;orientation=0;ambient=0;contrast=0;decode=(t,e,i)=>{if(1===e)this.model=i.g2;else if(2===e)this.anim=i.g2,d.instances&&(this.seq=d.instances[this.anim]);else if(3===e)this.disposeAlpha=!0;else if(4===e)this.resizeh=i.g2;else if(5===e)this.resizev=i.g2;else if(6===e)this.orientation=i.g2;else if(7===e)this.ambient=i.g1;else if(8===e)this.contrast=i.g1;else if(e>=40&&e<50)this.recol_s[e-40]=i.g2;else{if(!(e>=50&&e<60))throw new Error(`Unrecognized spotanim config code: ${e}`);this.recol_d[e-50]=i.g2}};getModel=()=>{let t=E.modelCache?.get(this.index);if(t)return t;t=_.model(this.model);for(let e=0;e<6;e++)0!==this.recol_s[0]&&t.recolor(this.recol_s[e],this.recol_d[e]);return E.modelCache?.put(this.index,t),t}}class R extends t{static count=0;static instances=[];static code3=[];static code3Count=0;static unpack=t=>{const e=new o(t.read("varp.dat"));this.count=e.g2;for(let t=0;t<this.count;t++)this.instances[t]=new R,this.instances[t].decodeType(t,e)};code10=null;code1=0;code2=0;hasCode3=!1;code4=!0;clientcode=0;code7=0;code6=!1;code8=!1;decode(t,e,i){if(1===e)this.code1=i.g1;else if(2===e)this.code2=i.g1;else if(3===e)this.hasCode3=!0,R.code3[R.code3Count++]=t;else if(4===e)this.code4=!1;else if(5===e)this.clientcode=i.g2;else if(6===e)this.code6=!0;else if(7===e)this.code7=i.g4;else if(8===e)this.code8=!0;else{if(10!==e)throw new Error(`Error unrecognised config code: ${e}`);this.code10=i.gjstr}}}class B{static BASE37_LOOKUP=["_","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];static toBase37=t=>{t=t.trim();let e=0n;for(let i=0;i<t.length&&i<12;i++){const s=t.charCodeAt(i);e*=37n,s>=65&&s<=90?e+=BigInt(s+1-65):s>=97&&s<=122?e+=BigInt(s+1-97):s>=48&&s<=57&&(e+=BigInt(s+27-48))}return e};static fromBase37=t=>{if(t<0n||t>=6582952005840035281n)return"invalid_name";if(t%37n===0n)return"invalid_name";let e=0;const i=Array(12);for(;0n!==t;){const s=t;t/=37n,i[11-e++]=this.BASE37_LOOKUP[Number(s-37n*t)]}return i.slice(12-e).join("")};static toSentenceCase=t=>{const e=[...t.toLowerCase()];let i=!0;for(let t=0;t<e.length;t++){const s=e[t];i&&s>="a"&&s<="z"&&(e[t]=s.toUpperCase(),i=!1),"."!==s&&"!"!==s||(i=!0)}return e.join("")};static toAsterisks=t=>{let e="";for(let i=0;i<t.length;i++)e+="*";return e};static formatIPv4=t=>(t>>24&255)+"."+(t>>16&255)+"."+(t>>8&255)+"."+(255&t);static formatName=t=>{if(0===t.length)return t;const e=[...t];for(let t=0;t<e.length;t++)"_"===e[t]&&(e[t]=" ",t+1<e.length&&e[t+1]>="a"&&e[t+1]<="z"&&(e[t+1]=String.fromCharCode(e[t+1].charCodeAt(0)+"A".charCodeAt(0)-97)));return e[0]>="a"&&e[0]<="z"&&(e[0]=String.fromCharCode(e[0].charCodeAt(0)+"A".charCodeAt(0)-97)),e.join("")};static hashCode=t=>{const e=t.toUpperCase();let i=0;for(let t=0;t<e.length;t++)i=61*i+e.charCodeAt(t)-32,i=i+(i>>31)&2147483647;return Number(i)}}class P{static instances=[];static imageCache=null;static modelCache=null;static TYPE_LAYER=0;static TYPE_UNUSED=1;static TYPE_INV=2;static TYPE_RECT=3;static TYPE_TEXT=4;static TYPE_GRAPHIC=5;static TYPE_MODEL=6;static TYPE_INV_TEXT=7;static BUTTON_OK=1;static BUTTON_TARGET=2;static BUTTON_CLOSE=3;static BUTTON_TOGGLE=4;static BUTTON_SELECT=5;static BUTTON_CONTINUE=6;static CC_FRIENDS_START=1;static CC_FRIENDS_END=100;static CC_FRIENDS_UPDATE_START=101;static CC_FRIENDS_UPDATE_END=200;static CC_ADD_FRIEND=201;static CC_DEL_FRIEND=202;static CC_FRIENDS_SIZE=203;static CC_LOGOUT=205;static CC_CHANGE_HEAD_L=300;static CC_CHANGE_HEAD_R=301;static CC_CHANGE_JAW_L=302;static CC_CHANGE_JAW_R=303;static CC_CHANGE_TORSO_L=304;static CC_CHANGE_TORSO_R=305;static CC_CHANGE_ARMS_L=306;static CC_CHANGE_ARMS_R=307;static CC_CHANGE_HANDS_L=308;static CC_CHANGE_HANDS_R=309;static CC_CHANGE_LEGS_L=310;static CC_CHANGE_LEGS_R=311;static CC_CHANGE_FEET_L=312;static CC_CHANGE_FEET_R=313;static CC_RECOLOUR_HAIR_L=314;static CC_RECOLOUR_HAIR_R=315;static CC_RECOLOUR_TORSO_L=316;static CC_RECOLOUR_TORSO_R=317;static CC_RECOLOUR_LEGS_L=318;static CC_RECOLOUR_LEGS_R=319;static CC_RECOLOUR_FEET_L=320;static CC_RECOLOUR_FEET_R=321;static CC_RECOLOUR_SKIN_L=322;static CC_RECOLOUR_SKIN_R=323;static CC_SWITCH_TO_MALE=324;static CC_SWITCH_TO_FEMALE=325;static CC_ACCEPT_DESIGN=326;static CC_DESIGN_PREVIEW=327;static CC_IGNORES_START=401;static CC_IGNORES_END=500;static CC_ADD_IGNORE=501;static CC_DEL_IGNORE=502;static CC_IGNORES_SIZE=503;static CC_REPORT_INPUT=600;static CC_REPORT_RULE1=601;static CC_REPORT_RULE2=602;static CC_REPORT_RULE3=603;static CC_REPORT_RULE4=604;static CC_REPORT_RULE5=605;static CC_REPORT_RULE6=606;static CC_REPORT_RULE7=607;static CC_REPORT_RULE8=608;static CC_REPORT_RULE9=609;static CC_REPORT_RULE10=610;static CC_REPORT_RULE11=611;static CC_REPORT_RULE12=612;static CC_MOD_MUTE=613;static CC_LAST_LOGIN_INFO=650;static CC_UNREAD_MESSAGES=651;static CC_RECOVERY1=652;static CC_RECOVERY2=653;static CC_RECOVERY3=654;static CC_LAST_LOGIN_INFO2=655;static unpack=(t,e,i)=>{this.imageCache=new p(5e4),this.modelCache=new p(5e4);const s=new o(t.read("data"));let a=-1;for(s.pos+=2;s.pos<s.data.length;){let t=s.g2;65535===t&&(a=s.g2,t=s.g2);const r=this.instances[t]=new P;r.id=t,r.layer=a,r.type=s.g1,r.buttonType=s.g1,r.clientCode=s.g2,r.width=s.g2,r.height=s.g2,r.overLayer=s.g1,0===r.overLayer?r.overLayer=-1:r.overLayer=(r.overLayer-1<<8)+s.g1;const n=s.g1;if(n>0){r.scriptComparator=new Uint8Array(n),r.scriptOperand=new Uint16Array(n);for(let t=0;t<n;t++)r.scriptComparator[t]=s.g1,r.scriptOperand[t]=s.g2}const h=s.g1;if(h>0){r.scripts=new Array(h).fill(null);for(let t=0;t<h;t++){const e=s.g2,i=new Uint16Array(e);r.scripts[t]=i;for(let t=0;t<e;t++)i[t]=s.g2}}if(r.type===P.TYPE_LAYER){r.scroll=s.g2,r.hide=1===s.g1;const t=s.g1;r.childId=new Uint16Array(t),r.childX=new Int16Array(t),r.childY=new Int16Array(t);for(let e=0;e<t;e++)r.childId[e]=s.g2,r.childX[e]=s.g2b,r.childY[e]=s.g2b}if(r.type===P.TYPE_UNUSED&&(s.pos+=3),r.type===P.TYPE_INV){r.invSlotObjId=new Int32Array(r.width*r.height),r.invSlotObjCount=new Int32Array(r.width*r.height),r.draggable=1===s.g1,r.interactable=1===s.g1,r.usable=1===s.g1,r.marginX=s.g1,r.marginY=s.g1,r.invSlotOffsetX=new Int16Array(20),r.invSlotOffsetY=new Int16Array(20),r.invSlotSprite=new Array(20).fill(null);for(let t=0;t<20;t++)if(1===s.g1){r.invSlotOffsetX[t]=s.g2b,r.invSlotOffsetY[t]=s.g2b;const i=s.gjstr;if(i.length>0){const s=i.lastIndexOf(",");r.invSlotSprite[t]=this.getImage(e,i.substring(0,s),parseInt(i.substring(s+1),10))}}r.iops=new Array(5).fill(null);for(let t=0;t<5;t++){const e=s.gjstr;r.iops[t]=e,0===e.length&&(r.iops[t]=null)}}if(r.type===P.TYPE_RECT&&(r.fill=1===s.g1),r.type===P.TYPE_TEXT||r.type===P.TYPE_UNUSED){r.center=1===s.g1;const t=s.g1;i&&(r.font=i[t]),r.shadowed=1===s.g1}if(r.type===P.TYPE_TEXT&&(r.text=s.gjstr,r.activeText=s.gjstr),r.type!==P.TYPE_UNUSED&&r.type!==P.TYPE_RECT&&r.type!==P.TYPE_TEXT||(r.colour=s.g4),r.type!==P.TYPE_RECT&&r.type!==P.TYPE_TEXT||(r.activeColour=s.g4,r.overColour=s.g4),r.type===P.TYPE_GRAPHIC){const t=s.gjstr;if(t.length>0){const i=t.lastIndexOf(",");r.graphic=this.getImage(e,t.substring(0,i),parseInt(t.substring(i+1),10))}const i=s.gjstr;if(i.length>0){const t=i.lastIndexOf(",");r.activeGraphic=this.getImage(e,i.substring(0,t),parseInt(i.substring(t+1),10))}}if(r.type===P.TYPE_MODEL){const t=s.g1;0!==t&&(r.model=this.getModel((t-1<<8)+s.g1));const e=s.g1;0!==e&&(r.activeModel=this.getModel((e-1<<8)+s.g1)),r.anim=s.g1,0===r.anim?r.anim=-1:r.anim=(r.anim-1<<8)+s.g1,r.activeAnim=s.g1,0===r.activeAnim?r.activeAnim=-1:r.activeAnim=(r.activeAnim-1<<8)+s.g1,r.zoom=s.g2,r.xan=s.g2,r.yan=s.g2}if(r.type===P.TYPE_INV_TEXT){r.invSlotObjId=new Int32Array(r.width*r.height),r.invSlotObjCount=new Int32Array(r.width*r.height),r.center=1===s.g1;const t=s.g1;i&&(r.font=i[t]),r.shadowed=1===s.g1,r.colour=s.g4,r.marginX=s.g2b,r.marginY=s.g2b,r.interactable=1===s.g1,r.iops=new Array(5).fill(null);for(let t=0;t<5;t++){const e=s.gjstr;r.iops[t]=e,0===e.length&&(r.iops[t]=null)}}r.buttonType!==P.BUTTON_TARGET&&r.type!==P.TYPE_INV||(r.actionVerb=s.gjstr,r.action=s.gjstr,r.actionTarget=s.g2),r.buttonType!=P.BUTTON_OK&&r.buttonType!=P.BUTTON_TOGGLE&&r.buttonType!=P.BUTTON_SELECT&&r.buttonType!=P.BUTTON_CONTINUE||(r.option=s.gjstr,0==r.option.length&&(r.buttonType==P.BUTTON_OK?r.option="Ok":r.buttonType==P.BUTTON_TOGGLE||r.buttonType==P.BUTTON_SELECT?r.option="Select":r.buttonType==P.BUTTON_CONTINUE&&(r.option="Continue")))}this.imageCache=null,this.modelCache=null};static getImage=(t,e,i)=>{const s=B.hashCode(e)<<8|i;if(this.imageCache){const t=this.imageCache.get(s);if(t)return t}let a;try{a=v.fromArchive(t,e,i),this.imageCache?.put(s,a)}catch(t){return null}return a};static getModel=t=>{if(this.modelCache){const e=this.modelCache.get(t);if(e)return e}const e=_.model(t);return this.modelCache?.put(t,e),e};id=-1;layer=-1;type=-1;buttonType=-1;clientCode=0;width=0;height=0;overLayer=-1;scriptComparator=null;scriptOperand=null;scripts=null;scroll=0;hide=!1;draggable=!1;interactable=!1;usable=!1;marginX=0;marginY=0;invSlotOffsetX=null;invSlotOffsetY=null;invSlotSprite=null;iops=null;fill=!1;center=!1;font=null;shadowed=!1;text=null;activeText=null;colour=0;activeColour=0;overColour=0;graphic=null;activeGraphic=null;model=null;activeModel=null;anim=-1;activeAnim=-1;zoom=0;xan=0;yan=0;actionVerb=null;action=null;actionTarget=-1;option=null;childId=null;childX=null;childY=null;x=0;y=0;scrollPosition=0;invSlotObjId=null;invSlotObjCount=null;seqFrame=0;seqCycle=0;getModel=(t,e,i)=>{let s=this.model;if(i&&(s=this.activeModel),!s)return null;if(-1===t&&-1===e&&!s.faceColor)return s;const a=_.modelShareColored(s,!0,!0,!1);return-1===t&&-1===e||a.createLabelReferences(),-1!==t&&a.applyTransform(t),-1!==e&&a.applyTransform(e),a.calculateNormals(64,768,-50,-10,-50,!0),a}}class N{image;pixels;width;height;constructor(t,e){this.image=C.getImageData(0,0,t,e),this.pixels=new Int32Array(t*e),this.width=t,this.height=e,this.bind()}clear=()=>{this.pixels.fill(0)};bind=()=>{w.bind(this.pixels,this.width,this.height)};draw=(t,e)=>{this.#t(),C.putImageData(this.image,t,e)};#t=()=>{const t=this.image.data;for(let e=0;e<this.pixels.length;e++){const i=this.pixels[e],s=4*e;t[s]=i>>16&255,t[s+1]=i>>8&255,t[s+2]=i>>0&255,t[s+3]=255}}}class Y{seed;constructor(t){this.seed=(t^BigInt(25214903917))&BigInt((BigInt(1)<<BigInt(48))-BigInt(1))}setSeed=t=>{this.seed=(t^BigInt(25214903917))&BigInt((BigInt(1)<<BigInt(48))-BigInt(1))};nextInt=()=>this.next(32);next=t=>(this.seed=this.seed*BigInt(25214903917)+BigInt(11)&BigInt((BigInt(1)<<BigInt(48))-BigInt(1)),Number(this.seed)>>>48-t)}class F extends h{static CHARSET=[];static{const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!\"$%^&*()-_=+[{]};:'@#~,<.>/?\\| ";for(let e=0;e<256;e++){let i=t.indexOf(String.fromCharCode(e));-1===i&&(i=74),F.CHARSET[e]=i}}pixels=[];charWidth=[];charHeight=[];clipX=[];clipY=[];charSpace=[];drawWidth=[];fontHeight=-1;random=new Y(BigInt(Date.now()));static fromArchive=(t,e)=>{const i=new o(t.read(e+".dat")),s=new o(t.read("index.dat"));s.pos=i.g2+4;const a=s.g1;a>0&&(s.pos+=3*(a-1));const r=new F;for(let t=0;t<94;t++){r.clipX[t]=s.g1,r.clipY[t]=s.g1;const e=r.charWidth[t]=s.g2,a=r.charHeight[t]=s.g2,n=e*a;r.pixels[t]=new Int8Array(n);const h=s.g1;if(0===h)for(let s=0;s<e*a;s++)r.pixels[t][s]=i.g1;else if(1===h)for(let s=0;s<e;s++)for(let n=0;n<a;n++)r.pixels[t][s+n*e]=i.g1;a>r.fontHeight&&(r.fontHeight=a),r.clipX[t]=1,r.charSpace[t]=e+2;{let i=0;for(let s=Math.trunc(a/7);s<a;s++)i+=r.pixels[t][e+s*e];i<=Math.trunc(a/7)&&(r.charSpace[t]--,r.clipX[t]=0)}{let i=0;for(let s=Math.trunc(a/7);s<a;s++)i+=r.pixels[t][e+s*e-1];i<=Math.trunc(a/7)&&r.charSpace[t]--}}r.charSpace[94]=r.charSpace[8];for(let t=0;t<256;t++)r.drawWidth[t]=r.charSpace[F.CHARSET[t]];return r};draw=(t,e,i,s)=>{t=Math.trunc(t),e=Math.trunc(e);const a=i.length;e-=this.fontHeight;for(let r=0;r<a;r++){const a=F.CHARSET[i.charCodeAt(r)];94!==a&&this.copyCharacter(t+this.clipX[a],e+this.clipY[a],this.charWidth[a],this.charHeight[a],this.pixels[a],s),t+=this.charSpace[a]}};drawStringTaggable=(t,e,i,s,a)=>{t=Math.trunc(t),e=Math.trunc(e);const r=i.length;e-=this.fontHeight;for(let n=0;n<r;n++)if("@"===i.charAt(n)&&n+4<r&&"@"===i.charAt(n+4))s=this.evaluateTag(i.substring(n+1,n+4)),n+=4;else{const r=F.CHARSET[i.charCodeAt(n)];94!==r&&(a&&this.copyCharacter(t+this.clipX[r]+1,e+this.clipY[r]+1,this.charWidth[r],this.charHeight[r],this.pixels[r],0),this.copyCharacter(t+this.clipX[r],e+this.clipY[r],this.charWidth[r],this.charHeight[r],this.pixels[r],s)),t+=this.charSpace[r]}};stringWidth=t=>{const e=t.length;let i=0;for(let s=0;s<e;s++)"@"===t.charAt(s)&&s+4<e&&"@"===t.charAt(s+4)?s+=4:i+=this.drawWidth[t.charCodeAt(s)];return i};drawString=(t,e,i,s)=>{t=Math.trunc(t);const a=(e=Math.trunc(e))-this.fontHeight;for(let e=0;e<i.length;e++){const r=F.CHARSET[i.charCodeAt(e)];94!==r&&this.drawChar(this.pixels[r],t+this.clipX[r],a+this.clipY[r],this.charWidth[r],this.charHeight[r],s),t+=this.charSpace[r]}};drawStringTaggableCenter=(t,e,i,s,a)=>{t=Math.trunc(t),e=Math.trunc(e),this.drawStringTaggable(t-this.stringWidth(i)/2,e,i,s,a)};drawStringCenter=(t,e,i,s)=>{t=Math.trunc(t),e=Math.trunc(e),this.draw(t-this.stringWidth(i)/2,e,i,s)};drawStringTooltip=(t,e,i,s,a,r)=>{t=Math.trunc(t),e=Math.trunc(e),this.random.setSeed(BigInt(r));const n=192+(31&this.random.nextInt()),h=e-this.fontHeight;for(let e=0;e<i.length;e++)if("@"===i.charAt(e)&&e+4<i.length&&"@"===i.charAt(e+4))s=this.evaluateTag(i.substring(e+1,e+4)),e+=4;else{const r=F.CHARSET[i.charCodeAt(e)];94!==r&&(a&&this.drawCharAlpha(t+this.clipX[r]+1,h+this.clipY[r]+1,this.charWidth[r],this.charHeight[r],0,192,this.pixels[r]),this.drawCharAlpha(t+this.clipX[r],h+this.clipY[r],this.charWidth[r],this.charHeight[r],s,n,this.pixels[r])),t+=this.charSpace[r],0==(3&this.random.nextInt())&&t++}};drawRight=(t,e,i,s,a=!0)=>{t=Math.trunc(t),e=Math.trunc(e),a&&this.draw(t-this.stringWidth(i)+1,e+1,i,0),this.draw(t-this.stringWidth(i),e,i,s)};drawChar=(t,e,i,s,a,r)=>{e=Math.trunc(e),i=Math.trunc(i),s=Math.trunc(s),a=Math.trunc(a);let n=e+i*w.width,h=w.width-s,o=0,l=0;if(i<w.top){const t=w.top-i;a-=t,i=w.top,l+=t*s,n+=t*w.width}if(i+a>=w.bottom&&(a-=i+a+1-w.bottom),e<w.left){const t=w.left-e;s-=t,e=w.left,l+=t,n+=t,o+=t,h+=t}if(e+s>=w.right){const t=e+s+1-w.right;s-=t,o+=t,h+=t}s>0&&a>0&&this.drawMask(s,a,t,l,o,w.pixels,n,h,r)};drawCharAlpha=(t,e,i,s,a,r,n)=>{t=Math.trunc(t),e=Math.trunc(e),i=Math.trunc(i),s=Math.trunc(s);let h=t+e*w.width,o=w.width-i,l=0,c=0;if(e<w.top){const t=w.top-e;s-=t,e=w.top,c+=t*i,h+=t*w.width}if(e+s>=w.bottom&&(s-=e+s+1-w.bottom),t<w.left){const e=w.left-t;i-=e,t=w.left,c+=e,h+=e,l+=e,o+=e}if(t+i>=w.right){const e=t+i+1-w.right;i-=e,l+=e,o+=e}i>0&&s>0&&this.drawMaskAlpha(i,s,w.pixels,h,o,n,c,l,a,r)};drawMask=(t,e,i,s,a,r,n,h,o)=>{const l=-((t=Math.trunc(t))>>2);t=-(3&t);for(let c=-(e=Math.trunc(e));c<0;c++){for(let t=l;t<0;t++)0===i[s++]?n++:r[n++]=o,0===i[s++]?n++:r[n++]=o,0===i[s++]?n++:r[n++]=o,0===i[s++]?n++:r[n++]=o;for(let e=t;e<0;e++)0===i[s++]?n++:r[n++]=o;n+=h,s+=a}};drawMaskAlpha=(t,e,i,s,a,r,n,h,o,l)=>{t=Math.trunc(t);const c=((16711935&o)*l&4278255360)+((65280&o)*l&16711680)>>8,d=256-l;for(let o=-(e=Math.trunc(e));o<0;o++){for(let e=-t;e<0;e++)if(0===r[n++])s++;else{const t=i[s];i[s++]=(((16711935&t)*d&4278255360)+((65280&t)*d&16711680)>>8)+c}s+=a,n+=h}};copyCharacter=(t,e,i,s,a,r)=>{t=Math.trunc(t),e=Math.trunc(e),i=Math.trunc(i),s=Math.trunc(s);let n=t+e*w.width,h=0,o=w.width-i,l=0;if(e<w.top){const t=w.top-e;s-=t,e=w.top,h+=t*i,n+=t*w.width}if(e+s>w.bottom&&(s-=e+s+1-w.bottom),t<w.left){const e=w.left-t;i-=e,t=w.left,h+=e,n+=e,l+=e,o+=e}if(t+i>w.right){const e=t+i+1-w.right;i-=e,l+=e,o+=e}i>0&&s>0&&this.copyImageMasked(i,s,a,h,l,w.pixels,n,o,r)};copyImageMasked=(t,e,i,s,a,r,n,h,o)=>{for(let l=0;l<e;l++){for(let e=0;e<t;e++)0!==i[s++]?r[n++]=o:n++;s+=a,n+=h}};evaluateTag=t=>{switch(t){case"red":return 16711680;case"gre":return 65280;case"blu":return 255;case"yel":return 16776960;case"cya":return 65535;case"mag":return 16711935;case"whi":return 16777215;case"bla":default:return 0;case"lre":return 16748608;case"dre":return 8388608;case"dbl":return 128;case"or1":return 16756736;case"or2":return 16740352;case"or3":return 16723968;case"gr1":return 12648192;case"gr2":return 8453888;case"gr3":return 4259584}};split(t,e){if(0===t.length)return[t];const i=[];for(;t.length>0;){if(this.stringWidth(t)<=e&&-1===t.indexOf("|")){i.push(t);break}let s=t.length;for(let i=0;i<t.length;i++)if(" "===t[i]){if(this.stringWidth(t.substring(0,i))>e)break;s=i}else if("|"===t[i]){s=i;break}i.push(t.substring(0,s)),t=t.substring(s+1)}return i}}class X{static bz2=null;static state=null;static load=async t=>{const e=new WebAssembly.Module(t),i=await async function(t,e={}){const i={env:Object.assign(Object.create(globalThis),e.env||{},{abort(t,e,i,s){t=n(t>>>0),e=n(e>>>0),i>>>=0,s>>>=0,(()=>{throw Error(`${t} in ${e}:${i}:${s}`)})()}})},{exports:s}=await WebAssembly.instantiate(t,i),a=s.memory||e.env.memory,r=Object.setPrototypeOf({newBzip2State(){return(t=s.newBzip2State()>>>0)?{stream:l(Int8Array,b(t+0)),decompressed:l(Int8Array,b(t+4)),next_in:C(t+8),avail_in:C(t+12),total_in_lo32:C(t+16),total_in_hi32:C(t+20),next_out:C(t+24),avail_out:C(t+28),total_out_lo32:C(t+32),total_out_hi32:C(t+36),state_out_ch:y(t+40),state_out_len:C(t+44),blockRandomized:0!=y(t+48),bsBuff:C(t+52),bsLive:C(t+56),currBlockNo:C(t+60),origPtr:C(t+64),tPos:C(t+68),k0:C(t+72),c_nblock_used:C(t+76),nInUse:C(t+80),save_nblock:C(t+84),unzftab:d(C,2,b(t+88)),cftab:d(C,2,b(t+92)),cftabCopy:d(C,2,b(t+96)),inUse:d((t=>0!=y(t)),0,b(t+100)),inUse16:d((t=>0!=y(t)),0,b(t+104)),seqToUnseq:d(y,0,b(t+108)),mtfa:d(y,0,b(t+112)),mtfbase:d(C,2,b(t+116)),selector:d(y,0,b(t+120)),selectorMtf:d(y,0,b(t+124)),len:h((t=>d(y,0,b(t))),2,b(t+128)),limit:h((t=>d(C,2,b(t))),2,b(t+132)),base:h((t=>d(C,2,b(t))),2,b(t+136)),perm:h((t=>d(C,2,b(t))),2,b(t+140)),minLens:d(C,2,b(t+144))}:null;var t},read(t,e,i,a,r){e=function(t){if(t){const e=u.get(t);e?u.set(t,e+1):u.set(s.__pin(t),1)}return t}(c(Int8Array,6,0,e)||p()),r=function(t){if(null==t)return 0;const e=s.__pin(s.__new(148,5));return w(e+0,c(Int8Array,6,0,t.stream)||p()),w(e+4,c(Int8Array,6,0,t.decompressed)||p()),w(e+8,t.next_in),w(e+12,t.avail_in),w(e+16,t.total_in_lo32),w(e+20,t.total_in_hi32),w(e+24,t.next_out),w(e+28,t.avail_out),w(e+32,t.total_out_lo32),w(e+36,t.total_out_hi32),g(e+40,t.state_out_ch),w(e+44,t.state_out_len),g(e+48,t.blockRandomized?1:0),w(e+52,t.bsBuff),w(e+56,t.bsLive),w(e+60,t.currBlockNo),w(e+64,t.origPtr),w(e+68,t.tPos),w(e+72,t.k0),w(e+76,t.c_nblock_used),w(e+80,t.nInUse),w(e+84,t.save_nblock),w(e+88,f(w,4,2,t.unzftab,Int32Array)||p()),w(e+92,f(w,4,2,t.cftab,Int32Array)||p()),w(e+96,f(w,4,2,t.cftabCopy,Int32Array)||p()),w(e+100,f(g,7,0,t.inUse,Uint8Array)||p()),w(e+104,f(g,7,0,t.inUse16,Uint8Array)||p()),w(e+108,f(g,8,0,t.seqToUnseq,Uint8Array)||p()),w(e+112,f(g,8,0,t.mtfa,Uint8Array)||p()),w(e+116,f(w,4,2,t.mtfbase,Int32Array)||p()),w(e+120,f(g,8,0,t.selector,Uint8Array)||p()),w(e+124,f(g,8,0,t.selectorMtf,Uint8Array)||p()),w(e+128,o(((t,e)=>{w(t,f(g,8,0,e,Uint8Array)||p())}),9,2,t.len)||p()),w(e+132,o(((t,e)=>{w(t,f(w,4,2,e,Int32Array)||p())}),10,2,t.limit)||p()),w(e+136,o(((t,e)=>{w(t,f(w,4,2,e,Int32Array)||p())}),10,2,t.base)||p()),w(e+140,o(((t,e)=>{w(t,f(w,4,2,e,Int32Array)||p())}),10,2,t.perm)||p()),w(e+144,f(w,4,2,t.minLens,Int32Array)||p()),s.__unpin(e),e}(r)||p();try{return l(Int8Array,s.read(t,e,i,a,r)>>>0)}finally{!function(t){if(t){const e=u.get(t);if(1===e)s.__unpin(t),u.delete(t);else{if(!e)throw Error(`invalid refcount '${e}' for reference '${t}'`);u.set(t,e-1)}}}(e)}}},s);function n(t){if(!t)return null;const e=t+new Uint32Array(a.buffer)[t-4>>>2]>>>1,i=new Uint16Array(a.buffer);let s=t>>>1,r="";for(;e-s>1024;)r+=String.fromCharCode(...i.subarray(s,s+=1024));return r+String.fromCharCode(...i.subarray(s,e))}function h(t,e,i){if(!i)return null;const s=b(i+4),a=m.getUint32(i+12,!0),r=new Array(a);for(let i=0;i<a;++i)r[i]=t(s+(i<<e>>>0));return r}function o(t,e,i,a){if(null==a)return 0;const r=a.length,n=s.__pin(s.__new(r<<i,1))>>>0,h=s.__pin(s.__new(16,e))>>>0;w(h+0,n),m.setUint32(h+4,n,!0),m.setUint32(h+8,r<<i,!0),m.setUint32(h+12,r,!0);for(let e=0;e<r;++e)t(n+(e<<i>>>0),a[e]);return s.__unpin(n),s.__unpin(h),h}function l(t,e){return e?new t(a.buffer,b(e+4),m.getUint32(e+8,!0)/t.BYTES_PER_ELEMENT).slice():null}function c(t,e,i,r){if(null==r)return 0;const n=r.length,h=s.__pin(s.__new(n<<i,1))>>>0,o=s.__new(12,e)>>>0;return w(o+0,h),m.setUint32(o+4,h,!0),m.setUint32(o+8,n<<i,!0),new t(a.buffer,h,n).set(r),s.__unpin(h),o}function d(t,e,i){if(!i)return null;const s=b(i-4)>>>e,a=new Array(s);for(let r=0;r<s;++r)a[r]=t(i+(r<<e>>>0));return a}function f(t,e,i,r,n){if(null==r)return 0;const h=r.length,o=s.__pin(s.__new(h<<i,e))>>>0;if(n)new n(a.buffer,o,h).set(r);else for(let e=0;e<h;e++)t(o+(e<<i>>>0),r[e]);return s.__unpin(o),o}const u=new Map;function p(){throw TypeError("value must not be null")}let m=new DataView(a.buffer);function g(t,e){try{m.setUint8(t,e,!0)}catch{m=new DataView(a.buffer),m.setUint8(t,e,!0)}}function w(t,e){try{m.setUint32(t,e,!0)}catch{m=new DataView(a.buffer),m.setUint32(t,e,!0)}}function y(t){try{return m.getUint8(t,!0)}catch{return m=new DataView(a.buffer),m.getUint8(t,!0)}}function C(t){try{return m.getInt32(t,!0)}catch{return m=new DataView(a.buffer),m.getInt32(t,!0)}}function b(t){try{return m.getUint32(t,!0)}catch{return m=new DataView(a.buffer),m.getUint32(t,!0)}}return r}(e,{env:void 0});this.bz2=i,this.state=i.newBzip2State()};static decompressBz2=(t,e,i,s)=>{if(!this.bz2||!this.state)throw new Error("bz2 not found!!");return this.bz2.read(t,e,i,s,this.state)}}class D{static genHash=t=>{let e=0;t=t.toUpperCase();for(let i=0;i<t.length;i++)e=61*e+t.charCodeAt(i)-32|0;return e};buffer;compressedWhole;fileCount;fileHash;fileUnpackedSize;filePackedSize;fileOffset;fileUnpacked=[];constructor(t){let e=new o(new Uint8Array(t));const i=e.g3,s=e.g3;i===s?(this.buffer=t,this.compressedWhole=!1):(this.buffer=X.decompressBz2(i,t,s,6),e=new o(new Uint8Array(this.buffer)),this.compressedWhole=!0),this.fileCount=e.g2,this.fileHash=[],this.fileUnpackedSize=[],this.filePackedSize=[],this.fileOffset=[];let a=e.pos+10*this.fileCount;for(let t=0;t<this.fileCount;t++)this.fileHash.push(e.g4),this.fileUnpackedSize.push(e.g3),this.filePackedSize.push(e.g3),this.fileOffset.push(a),a+=this.filePackedSize[t]}read=t=>{const e=D.genHash(t),i=this.fileHash.indexOf(e);return-1===i?null:this.readIndex(i)};readIndex=t=>{if(t<0||t>=this.fileCount)return null;if(this.fileUnpacked[t])return this.fileUnpacked[t];const e=this.fileOffset[t],i=e+this.filePackedSize[t];if(this.compressedWhole){const s=Uint8Array.from(this.buffer.subarray(e,e+i));return this.fileUnpacked[t]=s,s}{const e=Uint8Array.from(X.decompressBz2(this.fileUnpackedSize[t],this.buffer,this.filePackedSize[t],this.fileOffset[t]));return this.fileUnpacked[t]=e,e}}}class U{static PERIOD=new Uint16Array(["d","o","t"].join("").split("").map((t=>t.charCodeAt(0))));static AMPERSAT=new Uint16Array(["(","a",")"].join("").split("").map((t=>t.charCodeAt(0))));static SLASH=new Uint16Array(["s","l","a","s","h"].join("").split("").map((t=>t.charCodeAt(0))));static whitelist=["cook","cook's","cooks","seeks","sheet"];static tlds=[];static tldTypes=[];static bads=[];static badCombinations=[];static domains=[];static fragments=[];static unpack=t=>{const e=new o(t.read("fragmentsenc.txt")),i=new o(t.read("badenc.txt")),s=new o(t.read("domainenc.txt")),a=new o(t.read("tldlist.txt"));this.read(i,s,e,a)};static filter=t=>{const e=[...t];this.format(e);const i=e.join("").trim(),s=i.toLowerCase(),a=[...s];this.filterTlds(a),this.filterBadWords(a),this.filterDomains(a),this.filterFragments(a);for(let t=0;t<this.whitelist.length;t++){let e=-1;for(;-1!==(e=s.indexOf(this.whitelist[t],e+1));){const i=[...this.whitelist[t]];for(let t=0;t<i.length;t++)a[t+e]=i[t]}}return this.replaceUppercases(a,[...i]),this.formatUppercases(a),a.join("").trim()};static read=(t,e,i,s)=>{this.readBadWords(t),this.readDomains(e),this.readFragments(i),this.readTld(s)};static readTld=t=>{const e=t.g4;for(let i=0;i<e;i++)this.tldTypes[i]=t.g1,this.tlds[i]=new Uint16Array(t.g1).map((()=>t.g1))};static readBadWords=t=>{const e=t.g4;for(let i=0;i<e;i++){this.bads[i]=new Uint16Array(t.g1).map((()=>t.g1));const e=new Array(t.g1).fill([]).map((()=>[t.g1b,t.g1b]));e.length>0&&(this.badCombinations[i]=e)}};static readDomains=t=>{const e=t.g4;for(let i=0;i<e;i++)this.domains[i]=new Uint16Array(t.g1).map((()=>t.g1))};static readFragments=t=>{const e=t.g4;for(let i=0;i<e;i++)this.fragments[i]=t.g2};static filterTlds=t=>{const e=[...t],i=[...t];this.filterBadCombinations(null,e,this.PERIOD),this.filterBadCombinations(null,i,this.SLASH);for(let s=0;s<this.tlds.length;s++)this.filterTld(i,this.tldTypes[s],t,this.tlds[s],e)};static filterBadWords=t=>{for(let e=0;e<2;e++)for(let e=this.bads.length-1;e>=0;e--)this.filterBadCombinations(this.badCombinations[e],t,this.bads[e])};static filterDomains=t=>{const e=[...t],i=[...t];this.filterBadCombinations(null,e,this.AMPERSAT),this.filterBadCombinations(null,i,this.PERIOD);for(let s=this.domains.length-1;s>=0;s--)this.filterDomain(i,e,this.domains[s],t)};static filterFragments=t=>{for(let e=0;e<t.length;){const i=this.indexOfNumber(t,e);if(-1===i)return;let s=!1;for(let a=e;a>=0&&a<i&&!s;a++)this.isSymbol(t[a])||this.isNotLowercaseAlpha(t[a])||(s=!0);let a=0;s&&(a=0),0===a&&(a=1,e=i);let r=0;for(let s=i;s<t.length&&s<e;s++)r=10*r+t[s].charCodeAt(0)-48;r<=255&&e-i<=8?a++:a=0,4===a&&(this.maskChars(i,e,t),a=0),e=this.indexOfNonNumber(e,t)}};static isBadFragment=t=>{if(this.isNumericalChars(t))return!0;const e=this.getInteger(t),i=this.fragments,s=i.length;if(e===i[0]||e===i[s-1])return!0;let a=0,r=s-1;for(;a<=r;){const t=Math.floor((a+r)/2);if(e===i[t])return!0;e<i[t]?r=t-1:a=t+1}return!1};static getInteger=t=>{if(t.length>6)return 0;let e=0;for(let i=0;i<t.length;i++){const s=t[t.length-i-1];if(this.isLowercaseAlpha(s))e=38*e+s.charCodeAt(0)+1-"a".charCodeAt(0);else if("'"===s)e=38*e+27;else if(this.isNumerical(s))e=38*e+s.charCodeAt(0)+28-"0".charCodeAt(0);else if("\0"!==s)return 0}return e};static indexOfNumber=(t,e)=>{for(let i=e;i<t.length&&i>=0;i++)if(this.isNumerical(t[i]))return i;return-1};static indexOfNonNumber=(t,e)=>{for(let i=t;i<e.length&&i>=0;i++)if(!this.isNumerical(e[i]))return i;return e.length};static getEmulatedDomainCharLen=(t,e,i)=>e===i||"o"===e&&"0"===i?1:"o"===e&&"("===i&&")"===t?2:"c"!==e||"("!==i&&"<"!==i&&"["!==i?"e"===e&&""===i||"s"===e&&"$"===i||"l"===e&&"i"===i?1:0:1;static filterDomain=(t,e,i,s)=>{const a=i.length,r=s.length;for(let n=0;n<=r-a;n++){const{matched:a,currentIndex:r}=this.findMatchingDomain(n,i,s);if(!a)continue;const h=this.prefixSymbolStatus(n,s,3,e,["@"]),o=this.suffixSymbolStatus(r-1,s,3,t,[".",","]);(h>2||o>2)&&this.maskChars(n,r,s)}};static findMatchingDomain=(t,e,i)=>{const s=e.length;let a=t,r=0;for(;a<i.length&&r<s;){const n=i[a],h=a+1<i.length?i[a+1]:"\0",o=this.getEmulatedDomainCharLen(h,String.fromCharCode(e[r]),n);if(o>0)a+=o,r++;else{if(0===r)break;const i=this.getEmulatedDomainCharLen(h,String.fromCharCode(e[r-1]),n);if(i>0)a+=i,1===r&&t++;else{if(r>=s||!this.isSymbol(n))break;a++}}}return{matched:r>=s,currentIndex:a}};static filterBadCombinations=(t,e,i)=>{if(!(i.length>e.length))for(let s=0;s<=e.length-i.length;s++){let a=s;const{currentIndex:r,badIndex:n,hasSymbol:h,hasNumber:o,hasDigit:l}=this.processBadCharacters(e,i,a);a=r;let c=e[a],d=a+1<e.length?e[a+1]:"\0";if(!(n>=i.length)||o&&l)continue;let f,u=!0;if(h){let t=!1,i=!1;if((s-1<0||this.isSymbol(e[s-1])&&"'"!==e[s-1])&&(t=!0),(a>=e.length||this.isSymbol(e[a])&&"'"!==e[a])&&(i=!0),!t||!i){let i=!1;for(f=s-2,t&&(f=s);!i&&f<a;){if(f>=0&&(!this.isSymbol(e[f])||"'"===e[f])){const t=[];let s;for(s=0;s<3&&f+s<e.length&&(!this.isSymbol(e[f+s])||"'"===e[f+s]);s++)t[s]=e[f+s];let a=!0;0===s&&(a=!1),s<3&&f-1>=0&&(!this.isSymbol(e[f-1])||"'"===e[f-1])&&(a=!1),a&&!this.isBadFragment(t)&&(i=!0)}f++}i||(u=!1)}}else{c=" ",s-1>=0&&(c=e[s-1]),d=" ",a<e.length&&(d=e[a]);const i=this.getIndex(c),r=this.getIndex(d);t&&this.comboMatches(i,t,r)&&(u=!1)}if(!u)continue;let p=0,m=0;for(let t=s;t<a;t++)this.isNumerical(e[t])?p++:this.isAlpha(e[t])&&m++;p<=m&&this.maskChars(s,a,e)}};static processBadCharacters=(t,e,i)=>{let s=i,a=0,r=0,n=!1,h=!1,o=!1;for(;s<t.length&&(!h||!o)&&!(s>=t.length||h&&o);){const l=t[s],c=s+1<t.length?t[s+1]:"\0";let d;if(a<e.length&&(d=this.getEmulatedBadCharLen(c,String.fromCharCode(e[a]),l))>0)1===d&&this.isNumerical(l)&&(h=!0),2===d&&(this.isNumerical(l)||this.isNumerical(c))&&(h=!0),s+=d,a++;else{if(0===a)break;let t;if((t=this.getEmulatedBadCharLen(c,String.fromCharCode(e[a-1]),l))>0)s+=t;else{if(a>=e.length||!this.isNotLowercaseAlpha(l))break;if(this.isSymbol(l)&&"'"!==l&&(n=!0),this.isNumerical(l)&&(o=!0),s++,r++,100*r/(s-i)>90)break}}}return{currentIndex:s,badIndex:a,hasSymbol:n,hasNumber:h,hasDigit:o}};static getEmulatedBadCharLen=(t,e,i)=>{if(e===i)return 1;if(e>="a"&&e<="m"){if("a"===e)return"4"!==i&&"@"!==i&&"^"!==i?"/"===i&&"\\"===t?2:0:1;if("b"===e)return"6"!==i&&"8"!==i?"1"===i&&"3"===t?2:0:1;if("c"===e)return"("!==i&&"<"!==i&&"{"!==i&&"["!==i?0:1;if("d"===e)return"["===i&&")"===t?2:0;if("e"===e)return"3"!==i&&""!==i?0:1;if("f"===e)return"p"===i&&"h"===t?2:""===i?1:0;if("g"===e)return"9"!==i&&"6"!==i?0:1;if("h"===e)return"#"===i?1:0;if("i"===e)return"y"!==i&&"l"!==i&&"j"!==i&&"1"!==i&&"!"!==i&&":"!==i&&";"!==i&&"|"!==i?0:1;if("j"===e)return 0;if("k"===e)return 0;if("l"===e)return"1"!==i&&"|"!==i&&"i"!==i?0:1;if("m"===e)return 0}if(e>="n"&&e<="z"){if("n"===e)return 0;if("o"===e)return"0"!==i&&"*"!==i?"("===i&&")"===t||"["===i&&"]"===t||"{"===i&&"}"===t||"<"===i&&">"===t?2:0:1;if("p"===e)return 0;if("q"===e)return 0;if("r"===e)return 0;if("s"===e)return"5"!==i&&"z"!==i&&"$"!==i&&"2"!==i?0:1;if("t"===e)return"7"!==i&&"+"!==i?0:1;if("u"===e)return"v"===i?1:"\\"===i&&"/"===t||"\\"===i&&"|"===t||"|"===i&&"/"===t?2:0;if("v"===e)return"\\"===i&&"/"===t||"\\"===i&&"|"===t||"|"===i&&"/"===t?2:0;if("w"===e)return"v"===i&&"v"===t?2:0;if("x"===e)return")"===i&&"("===t||"}"===i&&"{"===t||"]"===i&&"["===t||">"===i&&"<"===t?2:0;if("y"===e)return 0;if("z"===e)return 0}return e>="0"&&e<="9"?"0"===e?"o"===i||"O"===i?1:"("===i&&")"===t||"{"===i&&"}"===t||"["===i&&"]"===t?2:0:"1"===e&&"l"===i?1:0:","===e?"."===i?1:0:"."===e?","===i?1:0:"!"===e&&"i"===i?1:0};static comboMatches=(t,e,i)=>{let s=0,a=e.length-1;for(;s<=a;){const r=Math.floor((s+a)/2);if(e[r][0]===t&&e[r][1]===i)return!0;t<e[r][0]||t===e[r][0]&&i<e[r][1]?a=r-1:s=r+1}return!1};static getIndex=t=>this.isLowercaseAlpha(t)?t.charCodeAt(0)+1-"a".charCodeAt(0):"'"===t?28:this.isNumerical(t)?t.charCodeAt(0)+29-"0".charCodeAt(0):27;static filterTld=(t,e,i,s,a)=>{if(!(s.length>i.length))for(let r=0;r<=i.length-s.length;r++){const{currentIndex:n,tldIndex:h}=this.processTlds(i,s,r);if(h<s.length)continue;let o=!1;const l=this.prefixSymbolStatus(r,i,3,a,[",","."]),c=this.suffixSymbolStatus(n-1,i,5,t,["\\","/"]);if(1===e&&l>0&&c>0&&(o=!0),2===e&&(l>2&&c>0||l>0&&c>2)&&(o=!0),3===e&&l>0&&c>2&&(o=!0),!o)continue;let d,f=r,u=n-1,p=!1;if(l>2){if(4===l)for(p=!1,d=r-1;d>=0;d--)if(p){if("*"!==a[d])break;f=d}else"*"===a[d]&&(f=d,p=!0);for(p=!1,d=f-1;d>=0;d--)if(p){if(this.isSymbol(i[d]))break;f=d}else this.isSymbol(i[d])||(p=!0,f=d)}if(c>2){if(4===c)for(p=!1,d=u+1;d<i.length;d++)if(p){if("*"!==t[d])break;u=d}else"*"===t[d]&&(u=d,p=!0);for(p=!1,d=u+1;d<i.length;d++)if(p){if(this.isSymbol(i[d]))break;u=d}else this.isSymbol(i[d])||(p=!0,u=d)}this.maskChars(f,u+1,i)}};static processTlds=(t,e,i)=>{let s=0;for(;i<t.length&&s<e.length;){const a=t[i],r=i+1<t.length?t[i+1]:"\0";let n;if((n=this.getEmulatedDomainCharLen(r,String.fromCharCode(e[s]),a))>0)i+=n,s++;else{if(0===s)break;let t;if((t=this.getEmulatedDomainCharLen(r,String.fromCharCode(e[s-1]),a))>0)i+=t;else{if(!this.isSymbol(a))break;i++}}}return{currentIndex:i,tldIndex:s}};static isSymbol=t=>!this.isAlpha(t)&&!this.isNumerical(t);static isNotLowercaseAlpha=t=>!this.isLowercaseAlpha(t)||"v"===t||"x"===t||"j"===t||"q"===t||"z"===t;static isAlpha=t=>this.isLowercaseAlpha(t)||this.isUppercaseAlpha(t);static isNumerical=t=>t>="0"&&t<="9";static isLowercaseAlpha=t=>t>="a"&&t<="z";static isUppercaseAlpha=t=>t>="A"&&t<="Z";static isNumericalChars=t=>{for(let e=0;e<t.length;e++)if(!this.isNumerical(t[e])&&"\0"!==t[e])return!1;return!0};static maskChars=(t,e,i)=>{for(let s=t;s<e;s++)i[s]="*"};static maskedCountBackwards=(t,e)=>{let i=0;for(let s=e-1;s>=0&&this.isSymbol(t[s]);s--)"*"===t[s]&&i++;return i};static maskedCountForwards=(t,e)=>{let i=0;for(let s=e+1;s<t.length&&this.isSymbol(t[s]);s++)"*"===t[s]&&i++;return i};static maskedCharsStatus=(t,e,i,s,a)=>(a?this.maskedCountBackwards(e,i):this.maskedCountForwards(e,i))>=s?4:this.isSymbol(a?t[i-1]:t[i+1])?1:0;static prefixSymbolStatus=(t,e,i,s,a)=>{if(0===t)return 2;for(let i=t-1;i>=0&&this.isSymbol(e[i]);i--)if(a.includes(e[i]))return 3;return this.maskedCharsStatus(e,s,t,i,!0)};static suffixSymbolStatus=(t,e,i,s,a)=>{if(t+1===e.length)return 2;for(let i=t+1;i<e.length&&this.isSymbol(e[i]);i++)if(a.includes(e[i]))return 3;return this.maskedCharsStatus(e,s,t,i,!1)};static format=t=>{let e=0;for(let i=0;i<t.length;i++)this.isCharacterAllowed(t[i])?t[e]=t[i]:t[e]=" ",0!==e&&" "===t[e]&&" "===t[e-1]||e++;for(let i=e;i<t.length;i++)t[i]=" "};static isCharacterAllowed=t=>t>=" "&&t<=""||" "===t||"\n"===t||"\t"===t||""===t||""===t;static replaceUppercases=(t,e)=>{for(let i=0;i<e.length;i++)"*"!==t[i]&&this.isUppercaseAlpha(e[i])&&(t[i]=e[i])};static formatUppercases=t=>{let e=!0;for(let i=0;i<t.length;i++){const s=t[i];this.isAlpha(s)?e?this.isLowercaseAlpha(s)&&(e=!1):this.isUppercaseAlpha(s)&&(t[i]=String.fromCharCode(s.charCodeAt(0)+"a".charCodeAt(0)-65)):e=!0}}}const H={Backspace:{key:8,ch:8},Enter:{key:10,ch:10},Shift:{key:16,ch:65535},Escape:{key:27,ch:27},Tab:{key:9,ch:9},CapsLock:{key:20,ch:65535}," ":{key:32,ch:32},Control:{key:17,ch:65535},Alt:{key:18,ch:65535},Meta:{key:524,ch:65535},ArrowLeft:{key:37,ch:65535},ArrowRight:{key:39,ch:65535},ArrowUp:{key:38,ch:65535},ArrowDown:{key:40,ch:65535},Insert:{key:155,ch:65535},Home:{key:36,ch:65535},PageUp:{key:33,ch:65535},Delete:{key:127,ch:127},End:{key:35,ch:65535},PageDown:{key:34,ch:65535},"`":{key:192,ch:96},"~":{key:192,ch:126},"!":{key:49,ch:33},"@":{key:50,ch:64},"#":{key:51,ch:35},$:{key:52,ch:36},"%":{key:53,ch:37},"^":{key:54,ch:94},"&":{key:55,ch:38},"*":{key:56,ch:42},"(":{key:57,ch:40},")":{key:48,ch:41},"-":{key:45,ch:45},_:{key:45,ch:95},"=":{key:61,ch:61},"+":{key:61,ch:43},"[":{key:91,ch:91},"{":{key:91,ch:123},"]":{key:93,ch:93},"}":{key:93,ch:125},"\\":{key:92,ch:92},"|":{key:92,ch:124},";":{key:59,ch:59},":":{key:59,ch:58},"'":{key:222,ch:39},'"':{key:222,ch:34},",":{key:44,ch:44},"<":{key:44,ch:60},".":{key:46,ch:46},">":{key:46,ch:62},"/":{key:47,ch:47},"?":{key:47,ch:63},F1:{key:112,ch:65535},F2:{key:113,ch:65535},F3:{key:114,ch:65535},F4:{key:115,ch:65535},F5:{key:116,ch:65535},F6:{key:117,ch:65535},F7:{key:118,ch:65535},F8:{key:119,ch:65535},F9:{key:120,ch:65535},F10:{key:121,ch:65535},F11:{key:122,ch:65535},F12:{key:123,ch:65535},0:{key:48,ch:48},1:{key:49,ch:49},2:{key:50,ch:50},3:{key:51,ch:51},4:{key:52,ch:52},5:{key:53,ch:53},6:{key:54,ch:54},7:{key:55,ch:55},8:{key:56,ch:56},9:{key:57,ch:57},a:{key:65,ch:97},b:{key:66,ch:98},c:{key:67,ch:99},d:{key:68,ch:100},e:{key:69,ch:101},f:{key:70,ch:102},g:{key:71,ch:103},h:{key:72,ch:104},i:{key:73,ch:105},j:{key:74,ch:106},k:{key:75,ch:107},l:{key:76,ch:108},m:{key:77,ch:109},n:{key:78,ch:110},o:{key:79,ch:111},p:{key:80,ch:112},q:{key:81,ch:113},r:{key:82,ch:114},s:{key:83,ch:115},t:{key:84,ch:116},u:{key:85,ch:117},v:{key:86,ch:118},w:{key:87,ch:119},x:{key:88,ch:120},y:{key:89,ch:121},z:{key:90,ch:122},A:{key:65,ch:65},B:{key:66,ch:66},C:{key:67,ch:67},D:{key:68,ch:68},E:{key:69,ch:69},F:{key:70,ch:70},G:{key:71,ch:71},H:{key:72,ch:72},I:{key:73,ch:73},J:{key:74,ch:74},K:{key:75,ch:75},L:{key:76,ch:76},M:{key:77,ch:77},N:{key:78,ch:78},O:{key:79,ch:79},P:{key:80,ch:80},Q:{key:81,ch:81},R:{key:82,ch:82},S:{key:83,ch:83},T:{key:84,ch:84},U:{key:85,ch:85},V:{key:86,ch:86},W:{key:87,ch:87},X:{key:88,ch:88},Y:{key:89,ch:89},Z:{key:90,ch:90}},W=["Tab","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","ArrowLeft","ArrowRight","ArrowUp","ArrowDown"];class V{static enabled=!1;static outBuffer=null;static oldBuffer=null;static lastTime=0;static trackedCount=0;static lastMoveTime=0;static lastX=0;static lastY=0;static setEnabled=()=>{this.outBuffer=o.alloc(1),this.oldBuffer=null,this.lastTime=Date.now(),this.enabled=!0};static setDisabled=()=>{this.enabled=!1,this.outBuffer=null};static flush=()=>{let t=null;return this.oldBuffer&&this.enabled&&(t=this.oldBuffer),this.oldBuffer=null,t};static stop=()=>{let t=null;return this.outBuffer&&this.outBuffer.pos>0&&this.enabled&&(t=this.outBuffer),this.setDisabled(),t};static mousePressed=(t,e,i)=>{if(!(this.enabled&&t>=0&&t<789&&e>=0&&e<532))return;this.trackedCount++;const s=Date.now();let a=Math.trunc((s-this.lastTime)/10);a>250&&(a=250),this.lastTime=s,this.ensureCapacity(5),1===i?this.outBuffer?.p1(1):this.outBuffer?.p1(2),this.outBuffer?.p1(a),this.outBuffer?.p3(t+(e<<10))};static mouseReleased=t=>{if(!this.enabled)return;this.trackedCount++;const e=Date.now();let i=Math.trunc((e-this.lastTime)/10);i>250&&(i=250),this.lastTime=e,this.ensureCapacity(2),1===t?this.outBuffer?.p1(3):this.outBuffer?.p1(4),this.outBuffer?.p1(i)};static mouseMoved=(t,e)=>{if(!(this.enabled&&t>=0&&t<789&&e>=0&&e<532))return;const i=Date.now();if(i-this.lastMoveTime>=50){this.lastMoveTime=i,this.trackedCount++;let s=Math.trunc((i-this.lastTime)/10);s>250&&(s=250),this.lastTime=i,t-this.lastX<8&&t-this.lastX>=-8&&e-this.lastY<8&&e-this.lastY>=-8?(this.ensureCapacity(3),this.outBuffer?.p1(5),this.outBuffer?.p1(s),this.outBuffer?.p1(t+(e-this.lastY+8<<4)+8-this.lastX)):t-this.lastX<128&&t-this.lastX>=-128&&e-this.lastY<128&&e-this.lastY>=-128?(this.ensureCapacity(4),this.outBuffer?.p1(6),this.outBuffer?.p1(s),this.outBuffer?.p1(t+128-this.lastX),this.outBuffer?.p1(e+128-this.lastY)):(this.ensureCapacity(5),this.outBuffer?.p1(7),this.outBuffer?.p1(s),this.outBuffer?.p3(t+(e<<10))),this.lastX=t,this.lastY=e}};static keyPressed=t=>{if(!this.enabled)return;this.trackedCount++;const e=Date.now();let i=Math.trunc((e-this.lastTime)/10);i>250&&(i=250),this.lastTime=e,1e3===t?t=11:1001===t?t=12:1002===t?t=14:1003===t?t=15:t>=1008&&(t-=992),this.ensureCapacity(3),this.outBuffer?.p1(8),this.outBuffer?.p1(i),this.outBuffer?.p1(t)};static keyReleased=t=>{if(!this.enabled)return;this.trackedCount++;const e=Date.now();let i=Math.trunc((e-this.lastTime)/10);i>250&&(i=250),this.lastTime=e,1e3===t?t=11:1001===t?t=12:1002===t?t=14:1003===t?t=15:t>=1008&&(t-=992),this.ensureCapacity(3),this.outBuffer?.p1(9),this.outBuffer?.p1(i),this.outBuffer?.p1(t)};static focusGained=()=>{if(!this.enabled)return;this.trackedCount++;const t=Date.now();let e=Math.trunc((t-this.lastTime)/10);e>250&&(e=250),this.lastTime=t,this.ensureCapacity(2),this.outBuffer?.p1(10),this.outBuffer?.p1(e)};static focusLost=()=>{if(!this.enabled)return;this.trackedCount++;const t=Date.now();let e=Math.trunc((t-this.lastTime)/10);e>250&&(e=250),this.lastTime=t,this.ensureCapacity(2),this.outBuffer?.p1(11),this.outBuffer?.p1(e)};static mouseEntered=()=>{if(!this.enabled)return;this.trackedCount++;const t=Date.now();let e=Math.trunc((t-this.lastTime)/10);e>250&&(e=250),this.lastTime=t,this.ensureCapacity(2),this.outBuffer?.p1(12),this.outBuffer?.p1(e)};static mouseExited=()=>{if(!this.enabled)return;this.trackedCount++;const t=Date.now();let e=Math.trunc((t-this.lastTime)/10);e>250&&(e=250),this.lastTime=t,this.ensureCapacity(2),this.outBuffer?.p1(13),this.outBuffer?.p1(e)};static ensureCapacity=t=>{if(this.outBuffer&&this.outBuffer.pos+t>=500){const t=this.outBuffer;this.outBuffer=o.alloc(1),this.oldBuffer=t}}}class z{static getParameter(t){return new URLSearchParams(window.location.search).get(t)??""}static setParameter(t,e){const i=new URL(window.location.toString());i.searchParams.set(t,e),window.history.pushState(null,"",i.toString())}drawArea=null;state=0;deltime=20;mindel=1;otim=[];fps=0;fpos=0;frameTime=[];redrawScreen=!0;resizeToFit=!1;idleCycles=0;mouseButton=0;mouseX=0;mouseY=0;mouseClickButton=0;mouseClickX=0;mouseClickY=0;actionKey=[];keyQueue=[];keyQueueReadPos=0;keyQueueWritePos=0;constructor(t=!1){C.fillStyle="black",C.fillRect(0,0,y.width,y.height),this.resizeToFit=t,this.resizeToFit?this.resize(window.innerWidth,window.innerHeight):this.resize(y.width,y.height)}get width(){return y.width}get height(){return y.height}resize(t,e){y.width=t,y.height=e,this.drawArea=new N(t,e),A.init2D()}async run(){window.addEventListener("resize",(()=>{this.resizeToFit&&this.resize(window.innerWidth,window.innerHeight)}),!1),window.addEventListener("keydown",this.keyPressed),window.addEventListener("keyup",this.keyReleased),window.addEventListener("mousedown",this.mousePressed),window.addEventListener("mouseup",this.mouseReleased),window.addEventListener("mouseenter",this.mouseEntered),window.addEventListener("mouseleave",this.mouseExited),window.addEventListener("mousemove",this.mouseMoved),window.addEventListener("focusin",this.focusGained),window.addEventListener("focusout",this.focusLost),window.addEventListener("unload",this.unload),y.oncontextmenu=t=>{t.preventDefault()},await this.showProgress(0,"Loading..."),await this.load();for(let t=0;t<10;t++)this.otim[t]=Date.now();let t,i=0,s=256,a=1,r=0;for(;this.state>=0;){if(this.state>0&&(this.state--,0===this.state))return void this.shutdown();const n=s,h=a;s=300,a=1,t=Date.now();const o=this.otim[i];if(0===o?(s=n,a=h):t>o&&(s=Math.trunc(2560*this.deltime/(t-o))),s<25?s=25:s>256&&(s=256,a=Math.trunc(this.deltime-(t-o)/10)),this.otim[i]=t,i=(i+1)%10,a>1)for(let t=0;t<10;t++)0!==this.otim[t]&&(this.otim[t]+=a);for(a<this.mindel&&(a=this.mindel),await e(a);r<256;)await this.update(),this.mouseClickButton=0,this.keyQueueReadPos=this.keyQueueWritePos,r+=s;r&=255,this.deltime>0&&(this.fps=Math.trunc(1e3*s/(256*this.deltime)));const l=performance.now();this.redrawScreen&&this.refresh(),await this.draw(),this.frameTime[this.fpos]=(performance.now()-l)/1e3,this.fpos=(this.fpos+1)%this.frameTime.length}-1===this.state&&this.shutdown()}shutdown(){this.state=-2,this.unload()}setFramerate(t){this.deltime=Math.trunc(1e3/t)}start(){this.state>=0&&(this.state=0)}stop(){this.state>=0&&(this.state=Math.trunc(4e3/this.deltime))}destroy(){this.state=-1}async load(){}async update(){}unload(){}async draw(){}refresh(){}async showProgress(t,i){const s=this.width,a=this.height;this.redrawScreen&&(C.fillStyle="black",C.fillRect(0,0,s,a),this.redrawScreen=!1);const r=a/2-18;C.fillStyle="rgb(140, 17, 17)",C.rect(s/2-152,r,304,34),C.fillRect(s/2-150,r+2,3*t,30),C.fillStyle="black",C.fillRect(s/2-150+3*t,r+2,300-3*t,30),C.font="bold 13px helvetica, sans-serif",C.textAlign="center",C.fillStyle="white",C.fillText(i,s/2,r+22),await e(5)}keyPressed=t=>{const e=t.key;W.includes(e)&&t.preventDefault(),this.idleCycles=0;const i=H[e];if(!i)return void console.error(`Unhandled key ${e}`);const s=i.key;let a=i.ch;a<30&&(a=0),37===s?a=1:39===s?a=2:38===s?a=3:40===s?a=4:17===s?a=5:8===s||127===s?a=8:9===s?a=9:10===s?a=10:s>=112&&s<=123?a=s+1008-112:36===s?a=1e3:35===s?a=1001:33===s?a=1002:34===s&&(a=1003),a>0&&a<128&&(this.actionKey[a]=1),a>4&&(this.keyQueue[this.keyQueueWritePos]=a,this.keyQueueWritePos=this.keyQueueWritePos+1&127),V.enabled&&V.keyPressed(a)};keyReleased=t=>{const e=t.key;W.includes(e)&&t.preventDefault(),this.idleCycles=0;const i=H[e];if(!i)return void console.error(`Unhandled key ${e}`);const s=i.key;let a=i.ch;a<30&&(a=0),37===s?a=1:39===s?a=2:38===s?a=3:40===s?a=4:17===s?a=5:8===s||127===s?a=8:9===s?a=9:10===s?a=10:s>=112&&s<=123?a=s+1008-112:36===s?a=1e3:35===s?a=1001:33===s?a=1002:34===s&&(a=1003),a>0&&a<128&&(this.actionKey[a]=0),V.enabled&&V.keyReleased(a)};pollKey(){let t=-1;return this.keyQueueWritePos!==this.keyQueueReadPos&&(t=this.keyQueue[this.keyQueueReadPos],this.keyQueueReadPos=this.keyQueueReadPos+1&127),t}mousePressed=t=>{let e=t.x,i=t.y;const{top:s,left:a}=this.getInsets;e-=a,i-=s,e=Math.trunc(e),i=Math.trunc(i),this.idleCycles=0,this.mouseClickX=e,this.mouseClickY=i,2===t.buttons?(this.mouseClickButton=2,this.mouseButton=2):1===t.buttons&&(this.mouseClickButton=1,this.mouseButton=1),V.enabled};mouseReleased=t=>{this.idleCycles=0,this.mouseButton=0,V.enabled};mouseEntered=t=>{V.enabled&&V.mouseEntered()};mouseExited=t=>{V.enabled&&V.mouseExited()};mouseMoved=t=>{let e=t.x,i=t.y;const{top:s,left:a}=this.getInsets;e-=a,i-=s,e=Math.trunc(e),i=Math.trunc(i),this.idleCycles=0,this.mouseX=e,this.mouseY=i,V.enabled&&V.mouseMoved(e,i)};focusGained=t=>{this.redrawScreen=!0,this.refresh(),V.enabled&&V.focusGained()};focusLost=t=>{V.enabled&&V.focusLost()};get ms(){const t=this.frameTime.length;let e=0;for(let i=0;i<t;i++)e+=this.frameTime[i];return e/t}get getInsets(){const t=y.getBoundingClientRect(),e=window.getComputedStyle(y),i=parseFloat(e.paddingLeft||"0"),s=parseFloat(e.paddingTop||"0"),a=parseFloat(e.borderLeftWidth||"0"),r=parseFloat(e.borderTopWidth||"0"),n=t.left+a+i;return{top:t.top+r+s,left:n}}}var G;const Z=(G="file:///home/runner/work/Client2/Client2/src/js/vendor/tinymidipcm/tinymidipcm.mjs",function(t){var e,s,a=void 0!==(t=t||{})?t:{};a.ready=new Promise((function(t,i){e=t,s=i})),["_tsf_load_memory","_tsf_set_output","_tsf_channel_set_bank_preset","_tsf_set_max_voices","_tsf_channel_set_presetnumber","_tsf_reset","_tsf_close","_tml_load_memory","_midi_render","_malloc","_realloc","_free","_fflush","onRuntimeInitialized"].forEach((t=>{Object.getOwnPropertyDescriptor(a.ready,t)||Object.defineProperty(a.ready,t,{get:()=>Z("You are getting "+t+" on the Promise object, instead of the instance. Use .then() to get called back with the instance, see the MODULARIZE docs in src/settings.js"),set:()=>Z("You are setting "+t+" on the Promise object, instead of the instance. Use .then() to get called back with the instance, see the MODULARIZE docs in src/settings.js")})}));var r=Object.assign({},a),n=[],h="object"==typeof window,o="function"==typeof importScripts,l="object"==typeof process&&"object"==typeof process.versions&&"string"==typeof process.versions.node,c=!h&&!l&&!o;if(a.ENVIRONMENT)throw new Error("Module.ENVIRONMENT has been deprecated. To force the environment, use the ENVIRONMENT compile-time option (for example, -sENVIRONMENT=web or -sENVIRONMENT=node)");var d,f,u,p="";if(l){if("undefined"==typeof process||!process.release||"node"!==process.release.name)throw new Error("not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)");var m,g;p=o?require("path").dirname(p)+"/":__dirname+"/";var w=()=>{g||(m=require("fs"),g=require("path"))};d=(t,e)=>(w(),t=g.normalize(t),m.readFileSync(t,e?void 0:"utf8")),u=t=>{var e=d(t,!0);return e.buffer||(e=new Uint8Array(e)),R(e.buffer),e},f=(t,e,i)=>{w(),t=g.normalize(t),m.readFile(t,(function(t,s){t?i(t):e(s.buffer)}))},process.argv.length>1&&process.argv[1].replace(/\\/g,"/"),n=process.argv.slice(2),process.on("uncaughtException",(function(t){if(!(t instanceof st))throw t})),process.on("unhandledRejection",(function(t){throw t})),a.inspect=function(){return"[Emscripten Module object]"}}else if(c){if("object"==typeof process&&"function"==typeof require||"object"==typeof window||"function"==typeof importScripts)throw new Error("not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)");"undefined"!=typeof read&&(d=function(t){return read(t)}),u=function(t){let e;return"function"==typeof readbuffer?new Uint8Array(readbuffer(t)):(e=read(t,"binary"),R("object"==typeof e),e)},f=function(t,e,i){setTimeout((()=>e(u(t))),0)},"undefined"!=typeof scriptArgs?n=scriptArgs:void 0!==arguments&&(n=arguments),"undefined"!=typeof print&&("undefined"==typeof console&&(console={}),console.log=print,console.warn=console.error="undefined"!=typeof printErr?printErr:print)}else{if(!h&&!o)throw new Error("environment detection error");if(o?p=self.location.href:"undefined"!=typeof document&&document.currentScript&&(p=document.currentScript.src),G&&(p=G),p=0!==p.indexOf("blob:")?p.substr(0,p.replace(/[?#].*/,"").lastIndexOf("/")+1):"","object"!=typeof window&&"function"!=typeof importScripts)throw new Error("not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)");d=t=>{var e=new XMLHttpRequest;return e.open("GET",t,!1),e.send(null),e.responseText},o&&(u=t=>{var e=new XMLHttpRequest;return e.open("GET",t,!1),e.responseType="arraybuffer",e.send(null),new Uint8Array(e.response)}),f=(t,e,i)=>{var s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="arraybuffer",s.onload=()=>{200==s.status||0==s.status&&s.response?e(s.response):i()},s.onerror=i,s.send(null)}}a.print||console.log.bind(console);var y,C,b,S=a.printErr||console.warn.bind(console);function T(t,e){Object.getOwnPropertyDescriptor(a,t)||Object.defineProperty(a,t,{configurable:!0,get:function(){Z("Module."+t+" has been replaced with plain "+e+" (the initial value can be provided on Module, but after startup the value is only looked for on a local variable of that name)")}})}function v(t){return"FS_createPath"===t||"FS_createDataFile"===t||"FS_createPreloadedFile"===t||"FS_unlink"===t||"addRunDependency"===t||"FS_createLazyFile"===t||"FS_createDevice"===t||"removeRunDependency"===t}Object.assign(a,r),r=null,y="fetchSettings",Object.getOwnPropertyDescriptor(a,y)&&Z("`Module."+y+"` was supplied but `"+y+"` not included in INCOMING_MODULE_JS_API"),a.arguments&&(n=a.arguments),T("arguments","arguments_"),a.thisProgram&&a.thisProgram,T("thisProgram","thisProgram"),a.quit&&a.quit,T("quit","quit_"),R(void 0===a.memoryInitializerPrefixURL,"Module.memoryInitializerPrefixURL option was removed, use Module.locateFile instead"),R(void 0===a.pthreadMainPrefixURL,"Module.pthreadMainPrefixURL option was removed, use Module.locateFile instead"),R(void 0===a.cdInitializerPrefixURL,"Module.cdInitializerPrefixURL option was removed, use Module.locateFile instead"),R(void 0===a.filePackagePrefixURL,"Module.filePackagePrefixURL option was removed, use Module.locateFile instead"),R(void 0===a.read,"Module.read option was removed (modify read_ in JS)"),R(void 0===a.readAsync,"Module.readAsync option was removed (modify readAsync in JS)"),R(void 0===a.readBinary,"Module.readBinary option was removed (modify readBinary in JS)"),R(void 0===a.setWindowTitle,"Module.setWindowTitle option was removed (modify setWindowTitle in JS)"),R(void 0===a.TOTAL_MEMORY,"Module.TOTAL_MEMORY has been renamed Module.INITIAL_MEMORY"),T("read","read_"),T("readAsync","readAsync"),T("readBinary","readBinary"),T("setWindowTitle","setWindowTitle"),R(!c,"shell environment detected but not enabled at build time.  Add 'shell' to `-sENVIRONMENT` to enable."),a.wasmBinary&&(C=a.wasmBinary),T("wasmBinary","wasmBinary"),a.noExitRuntime,T("noExitRuntime","noExitRuntime"),"object"!=typeof WebAssembly&&Z("no native wasm support detected");var x,A,I,O,_,k,L,M,E=!1;function R(t,e){t||Z("Assertion failed"+(e?": "+e:""))}function B(t){x=t,a.HEAP8=A=new Int8Array(t),a.HEAP16=O=new Int16Array(t),a.HEAP32=_=new Int32Array(t),a.HEAPU8=I=new Uint8Array(t),a.HEAPU16=new Uint16Array(t),a.HEAPU32=k=new Uint32Array(t),a.HEAPF32=L=new Float32Array(t),a.HEAPF64=M=new Float64Array(t)}"undefined"!=typeof TextDecoder&&new TextDecoder("utf8");var P=5242880;a.TOTAL_STACK&&R(P===a.TOTAL_STACK,"the stack size can no longer be determined at runtime");var N=a.INITIAL_MEMORY||16777216;function Y(){if(!E){var t=ct(),e=k[t>>2],i=k[t+4>>2];34821223==e&&2310721022==i||Z("Stack overflow! Stack cookie has been overwritten at 0x"+t.toString(16)+", expected hex dwords 0x89BACDFE and 0x2135467, but received 0x"+i.toString(16)+" 0x"+e.toString(16)),1668509029!==k[0]&&Z("Runtime error: The application has corrupted its heap memory area (address zero)!")}}T("INITIAL_MEMORY","INITIAL_MEMORY"),R(N>=P,"INITIAL_MEMORY should be larger than TOTAL_STACK, was "+N+"! (TOTAL_STACK="+P+")"),R("undefined"!=typeof Int32Array&&"undefined"!=typeof Float64Array&&null!=Int32Array.prototype.subarray&&null!=Int32Array.prototype.set,"JS engine does not provide full typed array support"),R(!a.wasmMemory,"Use of `wasmMemory` detected.  Use -sIMPORTED_MEMORY to define wasmMemory externally"),R(16777216==N,"Detected runtime INITIAL_MEMORY setting.  Use -sIMPORTED_MEMORY to define wasmMemory dynamically"),function(){var t=new Int16Array(1),e=new Int8Array(t.buffer);if(t[0]=25459,115!==e[0]||99!==e[1])throw"Runtime error: expected the system to be little-endian! (Run with -sSUPPORT_BIG_ENDIAN to bypass)"}();var F=[],X=[],D=[],U=!1;R(Math.imul,"This browser does not support Math.imul(), build with LEGACY_VM_SUPPORT or POLYFILL_OLD_MATH_FUNCTIONS to add in a polyfill"),R(Math.fround,"This browser does not support Math.fround(), build with LEGACY_VM_SUPPORT or POLYFILL_OLD_MATH_FUNCTIONS to add in a polyfill"),R(Math.clz32,"This browser does not support Math.clz32(), build with LEGACY_VM_SUPPORT or POLYFILL_OLD_MATH_FUNCTIONS to add in a polyfill"),R(Math.trunc,"This browser does not support Math.trunc(), build with LEGACY_VM_SUPPORT or POLYFILL_OLD_MATH_FUNCTIONS to add in a polyfill");var H=0,W=null,V=null,z={};function Z(t){a.onAbort&&a.onAbort(t),S(t="Aborted("+t+")"),E=!0;var e=new WebAssembly.RuntimeError(t);throw s(e),e}var j={error:function(){Z("Filesystem support (FS) was not included. The problem is that you are using files from JS, but files were not used from C/C++, so filesystem support was not auto-included. You can force-include filesystem support with -sFORCE_FILESYSTEM")},init:function(){j.error()},createDataFile:function(){j.error()},createPreloadedFile:function(){j.error()},createLazyFile:function(){j.error()},open:function(){j.error()},mkdev:function(){j.error()},registerDevice:function(){j.error()},analyzePath:function(){j.error()},loadFilesFromDB:function(){j.error()},ErrnoError:function(){j.error()}};a.FS_createDataFile=j.createDataFile,a.FS_createPreloadedFile=j.createPreloadedFile;var q,K,$,J;function Q(t){return t.startsWith("data:application/octet-stream;base64,")}function tt(t){return t.startsWith("file://")}function et(t,e){return function(){var i=t,s=e;return e||(s=a.asm),R(U,"native function `"+i+"` called before runtime initialization"),s[t]||R(s[t],"exported native function `"+i+"` not found"),s[t].apply(null,arguments)}}function it(t){try{if(t==q&&C)return new Uint8Array(C);if(u)return u(t);throw"both async and sync fetching of the wasm failed"}catch(t){Z(t)}}function st(t){this.name="ExitStatus",this.message="Program terminated with exit("+t+")",this.status=t}function at(t){for(;t.length>0;)t.shift()(a)}function rt(t){rt.shown||(rt.shown={}),rt.shown[t]||(rt.shown[t]=1,l&&(t="warning: "+t),S(t))}function nt(t){try{return b.grow(t-x.byteLength+65535>>>16),B(b.buffer),1}catch(e){S("emscripten_realloc_buffer: Attempted to grow heap from "+x.byteLength+" bytes to "+t+" bytes, but got error: "+e)}}a.locateFile?Q(q="tinymidipcm.wasm")||(K=q,q=a.locateFile?a.locateFile(K,p):p+K):q=new URL(i(621),i.b).toString();var ht,ot={emscripten_memcpy_big:function(t,e,i){I.copyWithin(t,e,e+i)},emscripten_resize_heap:function(t){var e=I.length;R((t>>>=0)>e);var i,s=2147483648;if(t>s)return S("Cannot enlarge memory, asked to go up to "+t+" bytes, but the limit is "+s+" bytes!"),!1;for(var a=1;a<=4;a*=2){var r=e*(1+.2/a);r=Math.min(r,t+100663296);var n=Math.min(s,(i=Math.max(t,r))+(65536-i%65536)%65536);if(nt(n))return!0}return S("Failed to grow the heap from "+e+" bytes to "+n+" bytes, not enough memory!"),!1}},lt=(function(){var t,e={env:ot,wasi_snapshot_preview1:ot};function i(t,e){var i,s=t.exports;a.asm=s,R(b=a.asm.memory,"memory not found in wasm exports"),B(b.buffer),R(a.asm.__indirect_function_table,"table not found in wasm exports"),i=a.asm.__wasm_call_ctors,X.unshift(i),function(t){if(H--,a.monitorRunDependencies&&a.monitorRunDependencies(H),t?(R(z[t]),delete z[t]):S("warning: run dependency removed without ID"),0==H&&(null!==W&&(clearInterval(W),W=null),V)){var e=V;V=null,e()}}("wasm-instantiate")}t="wasm-instantiate",H++,a.monitorRunDependencies&&a.monitorRunDependencies(H),t?(R(!z[t]),z[t]=1,null===W&&"undefined"!=typeof setInterval&&(W=setInterval((function(){if(E)return clearInterval(W),void(W=null);var t=!1;for(var e in z)t||(t=!0,S("still waiting on run dependencies:")),S("dependency: "+e);t&&S("(end of list)")}),1e4))):S("warning: run dependency added without ID");var r=a;function n(t){R(a===r,"the Module object should not be replaced during async compilation - perhaps the order of HTML elements is wrong?"),r=null,i(t.instance)}function c(t){return function(){if(!C&&(h||o)){if("function"==typeof fetch&&!tt(q))return fetch(q,{credentials:"same-origin"}).then((function(t){if(!t.ok)throw"failed to load wasm binary file at '"+q+"'";return t.arrayBuffer()})).catch((function(){return it(q)}));if(f)return new Promise((function(t,e){f(q,(function(e){t(new Uint8Array(e))}),e)}))}return Promise.resolve().then((function(){return it(q)}))}().then((function(t){return WebAssembly.instantiate(t,e)})).then((function(t){return t})).then(t,(function(t){S("failed to asynchronously prepare wasm: "+t),tt(q)&&S("warning: Loading from a file URI ("+q+") is not supported in most browsers. See https://emscripten.org/docs/getting_started/FAQ.html#how-do-i-run-a-local-webserver-for-testing-why-does-my-program-stall-in-downloading-or-preparing"),Z(t)}))}if(a.instantiateWasm)try{return a.instantiateWasm(e,i)}catch(t){S("Module.instantiateWasm callback failed with error: "+t),s(t)}(C||"function"!=typeof WebAssembly.instantiateStreaming||Q(q)||tt(q)||l||"function"!=typeof fetch?c(n):fetch(q,{credentials:"same-origin"}).then((function(t){return WebAssembly.instantiateStreaming(t,e).then(n,(function(t){return S("wasm streaming compile failed: "+t),S("falling back to ArrayBuffer instantiation"),c(n)}))}))).catch(s)}(),a.___wasm_call_ctors=et("__wasm_call_ctors"),a._malloc=et("malloc"),a._free=et("free"),a._tsf_load_memory=et("tsf_load_memory"),a._tsf_close=et("tsf_close"),a._tsf_reset=et("tsf_reset"),a._tsf_set_output=et("tsf_set_output"),a._tsf_set_max_voices=et("tsf_set_max_voices"),a._realloc=et("realloc"),a._tsf_channel_set_presetnumber=et("tsf_channel_set_presetnumber"),a._tsf_channel_set_bank_preset=et("tsf_channel_set_bank_preset"),a._tml_load_memory=et("tml_load_memory"),a._midi_render=et("midi_render"),a.___errno_location=et("__errno_location"),a._fflush=et("fflush"),a._emscripten_stack_init=function(){return(lt=a._emscripten_stack_init=a.asm.emscripten_stack_init).apply(null,arguments)}),ct=(a._emscripten_stack_get_free=function(){return(a._emscripten_stack_get_free=a.asm.emscripten_stack_get_free).apply(null,arguments)},a._emscripten_stack_get_base=function(){return(a._emscripten_stack_get_base=a.asm.emscripten_stack_get_base).apply(null,arguments)},a._emscripten_stack_get_end=function(){return(ct=a._emscripten_stack_get_end=a.asm.emscripten_stack_get_end).apply(null,arguments)});function dt(t){function i(){ht||(ht=!0,a.calledRun=!0,E||(R(!U),U=!0,Y(),at(X),e(a),a.onRuntimeInitialized&&a.onRuntimeInitialized(),R(!a._main,'compiled without a main, but one is present. if you added it from JS, use Module["onRuntimeInitialized"]'),function(){if(Y(),a.postRun)for("function"==typeof a.postRun&&(a.postRun=[a.postRun]);a.postRun.length;)t=a.postRun.shift(),D.unshift(t);var t;at(D)}()))}var s;t=t||n,H>0||(lt(),R(0==(3&(s=ct()))),k[s>>2]=34821223,k[s+4>>2]=2310721022,k[0]=1668509029,function(){if(a.preRun)for("function"==typeof a.preRun&&(a.preRun=[a.preRun]);a.preRun.length;)t=a.preRun.shift(),F.unshift(t);var t;at(F)}(),H>0||(a.setStatus?(a.setStatus("Running..."),setTimeout((function(){setTimeout((function(){a.setStatus("")}),1),i()}),1)):i(),Y()))}if(a.stackSave=et("stackSave"),a.stackRestore=et("stackRestore"),a.stackAlloc=et("stackAlloc"),a.setValue=function(t,e,i="i8"){switch(i.endsWith("*")&&(i="*"),i){case"i1":case"i8":A[t>>0]=e;break;case"i16":O[t>>1]=e;break;case"i32":_[t>>2]=e;break;case"i64":J=[e>>>0,($=e,+Math.abs($)>=1?$>0?(0|Math.min(+Math.floor($/4294967296),4294967295))>>>0:~~+Math.ceil(($-+(~~$>>>0))/4294967296)>>>0:0)],_[t>>2]=J[0],_[t+4>>2]=J[1];break;case"float":L[t>>2]=e;break;case"double":M[t>>3]=e;break;case"*":k[t>>2]=e;break;default:Z("invalid type for setValue: "+i)}},a.getValue=function(t,e="i8"){switch(e.endsWith("*")&&(e="*"),e){case"i1":case"i8":return A[t>>0];case"i16":return O[t>>1];case"i32":case"i64":return _[t>>2];case"float":return L[t>>2];case"double":return M[t>>3];case"*":return k[t>>2];default:Z("invalid type for getValue: "+e)}return null},["run","UTF8ArrayToString","UTF8ToString","stringToUTF8Array","stringToUTF8","lengthBytesUTF8","addOnPreRun","addOnInit","addOnPreMain","addOnExit","addOnPostRun","addRunDependency","removeRunDependency","FS_createFolder","FS_createPath","FS_createDataFile","FS_createPreloadedFile","FS_createLazyFile","FS_createLink","FS_createDevice","FS_unlink","getLEB","getFunctionTables","alignFunctionTables","registerFunctions","prettyPrint","getCompilerSetting","print","printErr","callMain","abort","keepRuntimeAlive","wasmMemory","stackAlloc","stackSave","stackRestore","getTempRet0","setTempRet0","writeStackCookie","checkStackCookie","ptrToString","zeroMemory","stringToNewUTF8","exitJS","getHeapMax","emscripten_realloc_buffer","ENV","ERRNO_CODES","ERRNO_MESSAGES","setErrNo","inetPton4","inetNtop4","inetPton6","inetNtop6","readSockaddr","writeSockaddr","DNS","getHostByName","Protocols","Sockets","getRandomDevice","warnOnce","traverseStack","UNWIND_CACHE","convertPCtoSourceLocation","readAsmConstArgsArray","readAsmConstArgs","mainThreadEM_ASM","jstoi_q","jstoi_s","getExecutableName","listenOnce","autoResumeAudioContext","dynCallLegacy","getDynCaller","dynCall","handleException","runtimeKeepalivePush","runtimeKeepalivePop","callUserCallback","maybeExit","safeSetTimeout","asmjsMangle","asyncLoad","alignMemory","mmapAlloc","writeI53ToI64","writeI53ToI64Clamped","writeI53ToI64Signaling","writeI53ToU64Clamped","writeI53ToU64Signaling","readI53FromI64","readI53FromU64","convertI32PairToI53","convertI32PairToI53Checked","convertU32PairToI53","getCFunc","ccall","cwrap","uleb128Encode","sigToWasmTypes","generateFuncType","convertJsFunctionToWasm","freeTableIndexes","functionsInTableMap","getEmptyTableSlot","updateTableMap","addFunction","removeFunction","reallyNegative","unSign","strLen","reSign","formatString","PATH","PATH_FS","intArrayFromString","intArrayToString","AsciiToString","stringToAscii","UTF16Decoder","UTF16ToString","stringToUTF16","lengthBytesUTF16","UTF32ToString","stringToUTF32","lengthBytesUTF32","allocateUTF8","allocateUTF8OnStack","writeStringToMemory","writeArrayToMemory","writeAsciiToMemory","SYSCALLS","getSocketFromFD","getSocketAddress","JSEvents","registerKeyEventCallback","specialHTMLTargets","maybeCStringToJsString","findEventTarget","findCanvasEventTarget","getBoundingClientRect","fillMouseEventData","registerMouseEventCallback","registerWheelEventCallback","registerUiEventCallback","registerFocusEventCallback","fillDeviceOrientationEventData","registerDeviceOrientationEventCallback","fillDeviceMotionEventData","registerDeviceMotionEventCallback","screenOrientation","fillOrientationChangeEventData","registerOrientationChangeEventCallback","fillFullscreenChangeEventData","registerFullscreenChangeEventCallback","JSEvents_requestFullscreen","JSEvents_resizeCanvasForFullscreen","registerRestoreOldStyle","hideEverythingExceptGivenElement","restoreHiddenElements","setLetterbox","currentFullscreenStrategy","restoreOldWindowedStyle","softFullscreenResizeWebGLRenderTarget","doRequestFullscreen","fillPointerlockChangeEventData","registerPointerlockChangeEventCallback","registerPointerlockErrorEventCallback","requestPointerLock","fillVisibilityChangeEventData","registerVisibilityChangeEventCallback","registerTouchEventCallback","fillGamepadEventData","registerGamepadEventCallback","registerBeforeUnloadEventCallback","fillBatteryEventData","battery","registerBatteryEventCallback","setCanvasElementSize","getCanvasElementSize","demangle","demangleAll","jsStackTrace","stackTrace","ExitStatus","getEnvStrings","checkWasiClock","flush_NO_FILESYSTEM","dlopenMissingError","createDyncallWrapper","setImmediateWrapped","clearImmediateWrapped","polyfillSetImmediate","uncaughtExceptionCount","exceptionLast","exceptionCaught","ExceptionInfo","exception_addRef","exception_decRef","Browser","setMainLoop","wget","FS","MEMFS","TTY","PIPEFS","SOCKFS","_setNetworkCallback","tempFixedLengthArray","miniTempWebGLFloatBuffers","heapObjectForWebGLType","heapAccessShiftForWebGLHeap","GL","emscriptenWebGLGet","computeUnpackAlignedImageSize","emscriptenWebGLGetTexPixelData","emscriptenWebGLGetUniform","webglGetUniformLocation","webglPrepareUniformLocationsBeforeFirstUse","webglGetLeftBracePos","emscriptenWebGLGetVertexAttrib","writeGLArray","AL","SDL_unicode","SDL_ttfContext","SDL_audio","SDL","SDL_gfx","GLUT","EGL","GLFW_Window","GLFW","GLEW","IDBStore","runAndAbortIfError","ALLOC_NORMAL","ALLOC_STACK","allocate"].forEach((function(t){Object.getOwnPropertyDescriptor(a,t)||Object.defineProperty(a,t,{configurable:!0,get:function(){var e="'"+t+"' was not exported. add it to EXPORTED_RUNTIME_METHODS (see the FAQ)";v(t)&&(e+=". Alternatively, forcing filesystem support (-sFORCE_FILESYSTEM) can export this for you"),Z(e)}})})),["ptrToString","zeroMemory","stringToNewUTF8","exitJS","setErrNo","inetPton4","inetNtop4","inetPton6","inetNtop6","readSockaddr","writeSockaddr","getHostByName","getRandomDevice","traverseStack","convertPCtoSourceLocation","readAsmConstArgs","mainThreadEM_ASM","jstoi_q","jstoi_s","getExecutableName","listenOnce","autoResumeAudioContext","dynCallLegacy","getDynCaller","dynCall","runtimeKeepalivePush","runtimeKeepalivePop","callUserCallback","maybeExit","safeSetTimeout","asmjsMangle","asyncLoad","alignMemory","mmapAlloc","writeI53ToI64","writeI53ToI64Clamped","writeI53ToI64Signaling","writeI53ToU64Clamped","writeI53ToU64Signaling","readI53FromI64","readI53FromU64","convertI32PairToI53","convertI32PairToI53Checked","convertU32PairToI53","getCFunc","ccall","cwrap","uleb128Encode","sigToWasmTypes","generateFuncType","convertJsFunctionToWasm","getEmptyTableSlot","updateTableMap","addFunction","removeFunction","reallyNegative","unSign","strLen","reSign","formatString","intArrayFromString","intArrayToString","AsciiToString","stringToAscii","UTF16ToString","stringToUTF16","lengthBytesUTF16","UTF32ToString","stringToUTF32","lengthBytesUTF32","allocateUTF8","allocateUTF8OnStack","writeStringToMemory","writeAsciiToMemory","getSocketFromFD","getSocketAddress","registerKeyEventCallback","maybeCStringToJsString","findEventTarget","findCanvasEventTarget","getBoundingClientRect","fillMouseEventData","registerMouseEventCallback","registerWheelEventCallback","registerUiEventCallback","registerFocusEventCallback","fillDeviceOrientationEventData","registerDeviceOrientationEventCallback","fillDeviceMotionEventData","registerDeviceMotionEventCallback","screenOrientation","fillOrientationChangeEventData","registerOrientationChangeEventCallback","fillFullscreenChangeEventData","registerFullscreenChangeEventCallback","JSEvents_requestFullscreen","JSEvents_resizeCanvasForFullscreen","registerRestoreOldStyle","hideEverythingExceptGivenElement","restoreHiddenElements","setLetterbox","softFullscreenResizeWebGLRenderTarget","doRequestFullscreen","fillPointerlockChangeEventData","registerPointerlockChangeEventCallback","registerPointerlockErrorEventCallback","requestPointerLock","fillVisibilityChangeEventData","registerVisibilityChangeEventCallback","registerTouchEventCallback","fillGamepadEventData","registerGamepadEventCallback","registerBeforeUnloadEventCallback","fillBatteryEventData","battery","registerBatteryEventCallback","setCanvasElementSize","getCanvasElementSize","getEnvStrings","checkWasiClock","flush_NO_FILESYSTEM","createDyncallWrapper","setImmediateWrapped","clearImmediateWrapped","polyfillSetImmediate","ExceptionInfo","exception_addRef","exception_decRef","setMainLoop","_setNetworkCallback","heapObjectForWebGLType","heapAccessShiftForWebGLHeap","emscriptenWebGLGet","computeUnpackAlignedImageSize","emscriptenWebGLGetTexPixelData","emscriptenWebGLGetUniform","webglGetUniformLocation","webglPrepareUniformLocationsBeforeFirstUse","webglGetLeftBracePos","emscriptenWebGLGetVertexAttrib","writeGLArray","SDL_unicode","SDL_ttfContext","SDL_audio","GLFW_Window","runAndAbortIfError","ALLOC_NORMAL","ALLOC_STACK","allocate"].forEach((function(t){"undefined"==typeof globalThis||Object.getOwnPropertyDescriptor(globalThis,t)||Object.defineProperty(globalThis,t,{configurable:!0,get:function(){var e="`"+t+"` is a library symbol and not included by default; add it to your library.js __deps or to DEFAULT_LIBRARY_FUNCS_TO_INCLUDE on the command line";v(t)&&(e+=". Alternatively, forcing filesystem support (-sFORCE_FILESYSTEM) can export this for you"),rt(e)}})})),V=function t(){ht||dt(),ht||(V=t)},a.preInit)for("function"==typeof a.preInit&&(a.preInit=[a.preInit]);a.preInit.length>0;)a.preInit.pop()();return dt(),t.ready}),j=class{constructor(t={}){this.wasmModule=void 0,this.soundfontBufferPtr=0,this.soundfontPtr=0,this.midiBufferPtr=0,this.renderInterval=t.renderInterval||100,this.sampleRate=t.sampleRate||44100,this.channels=t.channels||2,this.gain=t.gain||0,t.bufferSize?this.bufferSize=t.bufferSize:this.setBufferDuration(1),this.onPCMData=t.onPCMData||(()=>{}),this.onRenderEnd=t.onRenderEnd||(()=>{}),this.renderTimer=void 0,this.test=0}async init(){if(!this.wasmModule){if("undefined"!=typeof process){const{dirname:t}=await import("path"),{createRequire:e}=await import("module");globalThis.__dirname=t("file:///home/runner/work/Client2/Client2/src/js/vendor/tinymidipcm/index.js"),globalThis.require=e("file:///home/runner/work/Client2/Client2/src/js/vendor/tinymidipcm/index.js")}this.wasmModule=await Z(),this.pcmBufferPtr=this.wasmModule._malloc(this.bufferSize),this.msecsPtr=this.wasmModule._malloc(8)}}setBufferDuration(t){this.bufferSize=4*this.sampleRate*this.channels*t}ensureInitialized(){if(!this.wasmModule)throw new Error(`${this.constructor.name} not initalized. call .init()`)}setSoundfont(t){this.ensureInitialized();const{_malloc:e,_free:i,_tsf_load_memory:s,_tsf_set_output:a,_tsf_channel_set_bank_preset:r,_tsf_set_max_voices:n,_tsf_channel_set_presetnumber:h}=this.wasmModule;i(this.soundfontBufferPtr),this.soundfontBufferPtr=e(t.length),this.wasmModule.HEAPU8.set(t,this.soundfontBufferPtr),this.soundfontPtr=s(this.soundfontBufferPtr,t.length),a(this.soundfontPtr,2===this.channels?0:2,this.sampleRate,this.gain)}getPCMBuffer(){this.ensureInitialized();const t=new Uint8Array(this.bufferSize);return t.set(this.wasmModule.HEAPU8.subarray(this.pcmBufferPtr,this.pcmBufferPtr+this.bufferSize)),t}getMIDIMessagePtr(t){const{_malloc:e,_free:i,_tml_load_memory:s}=this.wasmModule;return i(this.midiBufferPtr),this.midiBufferPtr=e(t.length),this.wasmModule.HEAPU8.set(t,this.midiBufferPtr),s(this.midiBufferPtr,t.length)}renderMIDIMessage(t){const{_midi_render:e}=this.wasmModule;return e(this.soundfontPtr,t,this.channels,this.sampleRate,this.pcmBufferPtr,this.bufferSize,this.msecsPtr)}render(t){if(this.ensureInitialized(),!this.soundfontPtr)throw new Error("no soundfont buffer set. call .setSoundfont");window.clearTimeout(this.renderTimer);const{setValue:e,getValue:i}=this.wasmModule;e(this.msecsPtr,0,"double"),this.wasmModule._tsf_reset(this.soundfontPtr),this.wasmModule._tsf_channel_set_bank_preset(this.soundfontPtr,9,128,0),t[0]==="R".charCodeAt(0)&&(t=t.slice(20));let s=this.getMIDIMessagePtr(t);const a=()=>{s=this.renderMIDIMessage(s);const t=this.getPCMBuffer();this.onPCMData(t),s?this.renderTimer=setTimeout(a,this.renderInterval):this.onRenderEnd(i(this.msecsPtr,"double"))};this.renderTimer=setTimeout(a,16)}};!function(){window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext&&(window.audioContext=new window.AudioContext);var t=function(e){if(window.audioContext){var i=window.audioContext.createBuffer(1,1,22050),s=window.audioContext.createBufferSource();s.buffer=i,s.connect(window.audioContext.destination),s.start?s.start(0):s.play?s.play(0):s.noteOn&&s.noteOn(0)}document.removeEventListener("touchstart",t),document.removeEventListener("touchend",t),document.removeEventListener("click",t)};document.addEventListener("touchstart",t),document.addEventListener("touchend",t),document.addEventListener("click",t)}(),(async()=>{let t=0,e=null,i=new Float32Array,s=window.audioContext.createGain();s.gain.value=.1,s.connect(window.audioContext.destination);let a=0,r=window.audioContext.currentTime,n=[];const h=new j({renderInterval:30,onPCMData:t=>{let e=new Float32Array(t.buffer),s=new Float32Array(i.length+e.length);s.set(i,0),s.set(e,i.length),i=s},onRenderEnd:e=>{t=Math.floor(a+Math.floor(e/1e3))},bufferSize:102400});await h.init();const o=await fetch("./SCC1_Florestan.sf2"),l=new Uint8Array(await o.arrayBuffer());function c(){if(!window.audioContext||!i.length)return;let a=window.audioContext.createBufferSource();a.onended=function(i){const s=Math.floor(window.audioContext.currentTime);t>0&&Math.abs(s-t)<=2&&(t=0,e&&window._tinyMidiPlay(e,-1))};const h=i.length/2,o=window.audioContext.createBuffer(2,h,44100);for(let t=0;t<2;t++){const e=o.getChannelData(t);let s=t;for(let t=0;t<h;t++)e[t]=i[s],s+=2}r<window.audioContext.currentTime&&(r=window.audioContext.currentTime),a.buffer=o,a.connect(s),a.start(r),n.push(a),r+=o.duration,i=new Float32Array}let d;h.setSoundfont(l),window._tinyMidiStop=async()=>{if(d&&clearInterval(d),e=null,i=new Float32Array,n.length){let t=s.gain.value;s.gain.value=0,n.forEach((t=>{t.stop(window.audioContext.currentTime)})),n=[],s.gain.value=t}},window._tinyMidiVolume=(t=1)=>{s.gain.value=t},window._tinyMidiPlay=async(t,i=1)=>{t&&(await window._tinyMidiStop(),-1!=i&&window._tinyMidiVolume(i),e=t,a=window.audioContext.currentTime,r=window.audioContext.currentTime,d=setInterval(c,250),h.render(t))}})();class q{start=0;end=0;form=0;length=0;shapeDelta=null;shapePeak=null;threshold=0;position=0;delta=0;amplitude=0;ticks=0;read=t=>{this.form=t.g1,this.start=t.g4,this.end=t.g4,this.length=t.g1,this.shapeDelta=new Uint16Array(this.length),this.shapePeak=new Uint16Array(this.length);for(let e=0;e<this.length;e++)this.shapeDelta[e]=t.g2,this.shapePeak[e]=t.g2};reset=()=>{this.threshold=0,this.position=0,this.delta=0,this.amplitude=0,this.ticks=0};evaluate=t=>(this.ticks>=this.threshold&&this.shapePeak&&this.shapeDelta&&(this.amplitude=this.shapePeak[this.position++]<<15,this.position>=this.length&&(this.position=this.length-1),this.threshold=Math.trunc(this.shapeDelta[this.position]/65536)*t,this.threshold>this.ticks&&(this.delta=Math.trunc(((this.shapePeak[this.position]<<15)-this.amplitude)/(this.threshold-this.ticks)))),this.amplitude+=this.delta,this.ticks++,this.amplitude-this.delta>>15)}class K{static buffer=[];static noise=[];static sin=[];static tmpPhases=new Array(5);static tmpDelays=new Array(5);static tmpVolumes=new Array(5);static tmpSemitones=new Array(5);static tmpStarts=new Array(5);frequencyBase=null;amplitudeBase=null;frequencyModRate=null;frequencyModRange=null;amplitudeModRate=null;amplitudeModRange=null;release=null;attack=null;harmonicVolume=new Array(5);harmonicSemitone=new Array(5);harmonicDelay=new Array(5);start=0;length=500;reverbVolume=100;reverbDelay=0;static init=()=>{for(let t=0;t<32768;t++)Math.random()>.5?this.noise[t]=1:this.noise[t]=-1;for(let t=0;t<32768;t++)this.sin[1]=Math.trunc(16384*Math.sin(t/5215.1903));this.buffer=new Array(220500)};generate=(t,e)=>{for(let e=0;e<t;e++)K.buffer[e]=0;if(e<10)return K.buffer;const i=Math.trunc(t/e);this.frequencyBase?.reset(),this.amplitudeBase?.reset();let s=0,a=0,r=0;this.frequencyModRate&&this.frequencyModRange&&(this.frequencyModRate.reset(),this.frequencyModRange.reset(),s=Math.trunc(32.768*(this.frequencyModRate.end-this.frequencyModRate.start)/i),a=Math.trunc(32.768*this.frequencyModRate.start/i));let n=0,h=0,o=0;this.amplitudeModRate&&this.amplitudeModRange&&(this.amplitudeModRate.reset(),this.amplitudeModRange.reset(),n=Math.trunc(32.768*(this.amplitudeModRate.end-this.amplitudeModRate.start)/i),h=Math.trunc(32.768*this.amplitudeModRate.start/i));for(let t=0;t<5;t++)this.frequencyBase&&0!==this.harmonicVolume[t]&&(K.tmpPhases[t]=0,K.tmpDelays[t]=this.harmonicDelay[t]*i,K.tmpVolumes[t]=Math.trunc((this.harmonicVolume[t]<<14)/100),K.tmpSemitones[t]=32.768*(this.frequencyBase.end-this.frequencyBase.start)*Math.trunc(Math.pow(1.0057929410678534,this.harmonicSemitone[t]))/i,K.tmpStarts[t]=Math.trunc(32.768*this.frequencyBase.start/i));if(this.frequencyBase&&this.amplitudeBase)for(let e=0;e<t;e++){let i=this.frequencyBase.evaluate(t),l=this.amplitudeBase.evaluate(t);if(this.frequencyModRate&&this.frequencyModRange){const e=this.frequencyModRate.evaluate(t),n=this.frequencyModRange.evaluate(t);i+=this.generate2(n,r,this.frequencyModRate.form)>>1,r+=(e*s>>16)+a}if(this.amplitudeModRate&&this.amplitudeModRange){const e=this.amplitudeModRate.evaluate(t),i=this.amplitudeModRange.evaluate(t);l=l*(32768+(this.generate2(i,o,this.amplitudeModRate.form)>>1))>>15,o+=(e*n>>16)+h}for(let s=0;s<5;s++)if(0!==this.harmonicVolume[s]){const a=e+K.tmpDelays[s];a<t&&(K.buffer[a]+=this.generate2(l*K.tmpVolumes[s]>>15,K.tmpPhases[s],this.frequencyBase.form),K.tmpPhases[s]+=(i*K.tmpSemitones[s]>>16)+K.tmpStarts[s])}}if(this.release&&this.attack){this.release.reset(),this.attack.reset();let e=0,i=!0;for(let s=0;s<t;s++){const a=this.release.evaluate(t),r=this.attack.evaluate(t);let n;n=i?this.release.start+((this.release.end-this.release.start)*a>>8):this.release.start+((this.release.end-this.release.start)*r>>8),e+=256,e>=n&&(e=0,i=!i),i&&(K.buffer[s]=0)}}if(this.reverbDelay>0&&this.reverbVolume>0){const e=this.reverbDelay*i;for(let i=e;i<t;i++)K.buffer[i]+=Math.trunc(K.buffer[i-e]*this.reverbVolume/100)}for(let e=0;e<t;e++)K.buffer[e]<-32768&&(K.buffer[e]=-32768),K.buffer[e]>32767&&(K.buffer[e]=32767);return K.buffer};generate2=(t,e,i)=>1===i?(32767&e)<16384?t:-t:2===i?K.sin[32767&e]*t>>14:3===i?((32767&e)*t>>14)-t:4===i?K.noise[32767&Math.trunc(e/2607)]*t:0;read=t=>{this.frequencyBase=new q,this.frequencyBase.read(t),this.amplitudeBase=new q,this.amplitudeBase.read(t),0!==t.g1&&(t.pos--,this.frequencyModRate=new q,this.frequencyModRate.read(t),this.frequencyModRange=new q,this.frequencyModRange.read(t)),0!==t.g1&&(t.pos--,this.amplitudeModRate=new q,this.amplitudeModRate.read(t),this.amplitudeModRange=new q,this.amplitudeModRange.read(t)),0!==t.g1&&(t.pos--,this.release=new q,this.release.read(t),this.attack=new q,this.attack.read(t));for(let e=0;e<10;e++){const i=t.gsmarts;if(0===i)break;this.harmonicVolume[e]=i,this.harmonicSemitone[e]=t.gsmart,this.harmonicDelay[e]=t.gsmarts}this.reverbDelay=t.gsmarts,this.reverbVolume=t.gsmarts,this.length=t.g2,this.start=t.g2}}class ${static delays=new Array(1e3);static waveBytes=null;static waveBuffer=null;static tracks=new Array(1e3);tones=new Array(10);loopBegin=0;loopEnd=0;static unpack=t=>{const e=new o(t.read("sounds.dat"));for(this.waveBytes=new Uint8Array(441e3),this.waveBuffer=new o(this.waveBytes),K.init();;){const t=e.g2;if(65535===t)break;this.tracks[t]=new $,this.tracks[t].read(e),this.delays[t]=this.tracks[t].trim()}};static generate=(t,e)=>this.tracks[t]?this.tracks[t].getWave(e):null;read=t=>{for(let e=0;e<10;e++)0!==t.g1&&(t.pos--,this.tones[e]=new K,this.tones[e].read(t));this.loopBegin=t.g2,this.loopEnd=t.g2};trim=()=>{let t=9999999;for(let e=0;e<10;e++)this.tones[e]&&Math.trunc(this.tones[e].start/20)<t&&(t=Math.trunc(this.tones[e].start/20));if(this.loopBegin<this.loopEnd&&Math.trunc(this.loopBegin/20)<t&&(t=Math.trunc(this.loopBegin/20)),9999999===t||0===t)return 0;for(let e=0;e<10;e++)this.tones[e]&&(this.tones[e].start-=20*t);return this.loopBegin<this.loopEnd&&(this.loopBegin-=20*t,this.loopEnd-=20*t),t};getWave=t=>{const e=this.generate(t);return $.waveBuffer?.p4(1380533830),$.waveBuffer?.ip4(e+36),$.waveBuffer?.p4(1463899717),$.waveBuffer?.p4(1718449184),$.waveBuffer?.ip4(16),$.waveBuffer?.ip2(1),$.waveBuffer?.ip2(1),$.waveBuffer?.ip4(22050),$.waveBuffer?.ip4(22050),$.waveBuffer?.ip2(1),$.waveBuffer?.ip2(8),$.waveBuffer?.p4(1684108385),$.waveBuffer?.ip4(e),$.waveBuffer&&($.waveBuffer.pos+=e),$.waveBuffer};generate=t=>{let e=0;for(let t=0;t<10;t++)this.tones[t]&&this.tones[t].length+this.tones[t].start>e&&(e=this.tones[t].length+this.tones[t].start);if(0===e)return 0;let i=Math.trunc(22050*e/1e3),s=Math.trunc(22050*this.loopBegin/1e3),a=Math.trunc(22050*this.loopEnd/1e3);(s<0||a<0||a>i||s>=a)&&(t=0);let r=i+(a-s)*(t-1);for(let t=44;t<r+44;t++)$.waveBytes&&($.waveBytes[t]=-128);for(let t=0;t<10;t++)if(this.tones[t]){const e=Math.trunc(22050*this.tones[t].length/1e3),i=Math.trunc(22050*this.tones[t].start/1e3),s=this.tones[t].generate(e,this.tones[t].length);for(let t=0;t<e;t++)$.waveBytes&&($.waveBytes[t+i+44]+=s[t]>>8)}if(t>1){s+=44,a+=44,i+=44,r+=44;const e=r-i;for(let t=i-1;t>=a;t--)$.waveBytes&&($.waveBytes[t+e]=$.waveBytes[t]);for(let e=1;e<t;e++){const t=(a-s)*e;for(let e=s;e<a;e++)$.waveBytes&&($.waveBytes[e+t]=$.waveBytes[e])}r-=44}return r}}class J{static visibilityMatrix=[];static viewportLeft=0;static viewportTop=0;static viewportRight=0;static viewportBottom=0;static viewportCenterX=0;static viewportCenterY=0;static sinEyePitch=0;static cosEyePitch=0;static sinEyeYaw=0;static cosEyeYaw=0;static{this.visibilityMatrix=new Array(8);for(let t=0;t<8;t++){this.visibilityMatrix[t]=new Array(32);for(let e=0;e<32;e++){this.visibilityMatrix[t][e]=new Array(51);for(let i=0;i<51;i++)this.visibilityMatrix[t][e][i]=new Array(51).fill(!1)}}}static init=(t,e,i,s,a)=>{this.viewportLeft=0,this.viewportTop=0,this.viewportRight=t,this.viewportBottom=e,this.viewportCenterX=t/2,this.viewportCenterY=e/2;const r=new Array(9);for(let t=0;t<9;t++){r[t]=new Array(32);for(let e=0;e<32;e++){r[t][e]=new Array(53);for(let i=0;i<53;i++)r[t][e][i]=new Array(53).fill(!1)}}for(let t=128;t<=384;t+=32)for(let e=0;e<2048;e+=64){this.sinEyePitch=A.sin[t],this.cosEyePitch=A.cos[t],this.sinEyeYaw=A.sin[e],this.cosEyeYaw=A.cos[e];const n=(t-128)/32,h=e/64;for(let t=-26;t<=26;t++)for(let e=-26;e<=26;e++){const o=128*t,l=128*e;let c=!1;for(let t=-i;t<=s;t+=128)if(this.testPoint(o,l,a[n]+t)){c=!0;break}r[n][h][t+25+1][e+25+1]=c}}for(let t=0;t<8;t++)for(let e=0;e<32;e++)for(let i=-25;i<25;i++)for(let s=-25;s<25;s++){let a=!1;t:for(let n=-1;n<=1;n++)for(let h=-1;h<=1;h++){if(r[t][e][i+n+25+1][s+h+25+1]){a=!0;break t}if(r[t][(e+1)%31][i+n+25+1][s+h+25+1]){a=!0;break t}if(r[t+1][e][i+n+25+1][s+h+25+1]){a=!0;break t}if(r[t+1][(e+1)%31][i+n+25+1][s+h+25+1]){a=!0;break t}}this.visibilityMatrix[t][e][i+25][s+25]=a}};static unload=()=>{};reset=()=>{};static testPoint=(t,e,i)=>{const s=e*this.sinEyeYaw+t*this.cosEyeYaw>>16,a=e*this.cosEyeYaw-t*this.sinEyeYaw>>16,r=i*this.sinEyePitch+a*this.cosEyePitch>>16,n=i*this.cosEyePitch-a*this.sinEyePitch>>16;if(r<50||r>3500)return!1;const h=this.viewportCenterX+Math.trunc((s<<9)/r),o=this.viewportCenterY+Math.trunc((n<<9)/r);return h>=this.viewportLeft&&h<=this.viewportRight&&o>=this.viewportTop&&o<=this.viewportBottom}}class Q{socket;queue=[];buffer=void 0;remaining=0;offset=0;static openSocket=async t=>await new Promise(((e,i)=>{const s=t.host.startsWith("https")?"wss":"ws",a=t.host.substring(t.host.indexOf("//")+2),r=new WebSocket(`${s}://${a}:${t.port}`,"binary");r.binaryType="arraybuffer",r.addEventListener("open",(()=>{console.log("connection open!"),e(r)})),r.addEventListener("error",(()=>{console.log("connection error!"),i(r)}))}));constructor(t){t.onmessage=this.onmessage,t.onclose=this.onclose,t.onerror=this.onerror,this.socket=t}get host(){return this.socket.url.split("/")[2]}get port(){return parseInt(this.socket.url.split(":")[2],10)}get available(){return this.remaining}write=(t,e,i)=>{if(this.socket.readyState!==WebSocket.OPEN)throw new Error("Socket is not able to write!");const s=new Uint8Array(e);a(t,i,s,0,e),this.socket.send(s)};read=async()=>{if(this.socket.readyState!==WebSocket.OPEN&&this.remaining<1)throw new Error("Socket is not able to read!");if(this.remaining<1)return await e(5),this.read();if(this.buffer||(this.buffer=this.queue.shift(),this.buffer&&(this.offset=0)),!this.buffer)return this.read();const t=255&this.buffer[this.offset];return this.offset++,this.remaining--,this.offset===this.buffer.length&&(this.buffer=void 0),t};readBytes=async(t,i,s)=>{if(this.socket.readyState!==WebSocket.OPEN&&this.remaining<1)throw new Error("Socket is not able to read!");if(this.remaining<1)return await e(5),this.readBytes(t,i,s);for(let e=0;e<s;e++)t[i+e]=await this.read();return s};close=()=>{this.socket.readyState===WebSocket.OPEN&&this.socket.close()};clear=()=>{this.socket.readyState===WebSocket.OPEN&&this.socket.close(),this.queue.length=0,this.remaining=0,this.buffer=void 0,this.offset=0};onmessage=t=>{console.log("connection message!");const e=new Int8Array(t.data);this.remaining+=e.length,this.queue.push(e)};onclose=t=>{console.log("connection close!")};onerror=t=>{console.log("connection error!")}}class tt{static CLIENTPROT_SCRAMBLED=[95,218,67,50,253,222,194,60,101,128,8,251,92,111,24,33,223,66,232,59,227,113,153,105,126,98,167,102,177,238,62,190,147,23,150,151,156,144,193,155,81,0,198,22,137,210,179,16,168,170,32,181,248,141,58,87,208,106,180,191,221,241,40,176,196,154,65,145,230,78,30,161,188,41,14,129,18,199,47,247,225,34,51,10,159,75,12,56,61,31,39,91,46,242,134,5,122,123,209,228,104,195,21,3,11,44,107,172,6,186,110,215,205,103,27,185,124,77,252,117,86,115,127,207,52,79,43,97,219,116,169,7,118,162,108,36,20,233,88,135,80,19,42,237,57,152,71,9,250,17,4,119,234,130,26,200,189,163,254,245,197,171,220,235,140,244,184,94,211,231,99,246,121,212,112,204,63,148,83,178,1,255,131,13,183,142,236,45,55,35,243,136,37,85,100,160,38,224,146,174,82,48,109,132,125,90,143,138,240,173,165,164,192,175,29,74,28,114,213,73,64,206,76,139,96,2,229,15,93,25,239,202,49,70,214,201,72,203,68,89,69,157,216,217,249,120,226,84,149,187,54,53,158,166,182,133,0];static SERVERPROT_SIZES=[0,-2,4,6,-1,0,0,2,0,0,0,0,5,4,2,2,0,0,0,0,2,-2,2,14,0,6,3,0,4,0,0,0,3,0,0,0,0,0,0,0,0,-1,4,2,6,0,6,0,0,3,7,0,0,0,-1,0,0,0,0,4,0,0,0,0,0,0,0,0,1,15,0,0,0,0,6,0,2,0,0,0,2,0,0,0,1,0,0,4,0,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,-2,0,0,2,0,0,0,2,9,0,0,0,0,0,4,0,0,0,3,7,9,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,3,2,0,0,0,0,0,0,6,0,0,0,0,0,0,0,0,-2,2,0,0,0,0,0,6,0,0,0,2,0,2,0,0,0,-2,0,0,4,0,0,0,0,6,0,0,-2,-2,0,0,0,0,0,0,-2,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0]}class et{count=0;rsl=new Int32Array(256);mem=new Int32Array(256);a=0;b=0;c=0;constructor(t){for(let e=0;e<t.length;e++)this.rsl[e]=t[e];this.init()}get nextInt(){return 0==this.count--&&(this.isaac(),this.count=255),this.rsl[this.count]}init=()=>{let t=2654435769,e=2654435769,i=2654435769,s=2654435769,a=2654435769,r=2654435769,n=2654435769,h=2654435769;for(let o=0;o<4;o++)t^=e<<11,s+=t,e+=i,e^=i>>>2,a+=e,i+=s,i^=s<<8,r+=i,s+=a,s^=a>>>16,n+=s,a+=r,a^=r<<10,h+=a,r+=n,r^=n>>>4,t+=r,n+=h,n^=h<<8,e+=n,h+=t,h^=t>>>9,i+=h,t+=e;for(let o=0;o<256;o+=8)t+=this.rsl[o],e+=this.rsl[o+1],i+=this.rsl[o+2],s+=this.rsl[o+3],a+=this.rsl[o+4],r+=this.rsl[o+5],n+=this.rsl[o+6],h+=this.rsl[o+7],t^=e<<11,s+=t,e+=i,e^=i>>>2,a+=e,i+=s,i^=s<<8,r+=i,s+=a,s^=a>>>16,n+=s,a+=r,a^=r<<10,h+=a,r+=n,r^=n>>>4,t+=r,n+=h,n^=h<<8,e+=n,h+=t,h^=t>>>9,i+=h,t+=e,this.mem[o]=t,this.mem[o+1]=e,this.mem[o+2]=i,this.mem[o+3]=s,this.mem[o+4]=a,this.mem[o+5]=r,this.mem[o+6]=n,this.mem[o+7]=h;for(let o=0;o<256;o+=8)t+=this.mem[o],e+=this.mem[o+1],i+=this.mem[o+2],s+=this.mem[o+3],a+=this.mem[o+4],r+=this.mem[o+5],n+=this.mem[o+6],h+=this.mem[o+7],t^=e<<11,s+=t,e+=i,e^=i>>>2,a+=e,i+=s,i^=s<<8,r+=i,s+=a,s^=a>>>16,n+=s,a+=r,a^=r<<10,h+=a,r+=n,r^=n>>>4,t+=r,n+=h,n^=h<<8,e+=n,h+=t,h^=t>>>9,i+=h,t+=e,this.mem[o]=t,this.mem[o+1]=e,this.mem[o+2]=i,this.mem[o+3]=s,this.mem[o+4]=a,this.mem[o+5]=r,this.mem[o+6]=n,this.mem[o+7]=h;this.isaac(),this.count=256};isaac=()=>{this.c++,this.b+=this.c;for(let t=0;t<256;t++){const e=this.mem[t],i=3&t;let s;0===i?this.a^=this.a<<13:1===i?this.a^=this.a>>>6:2===i?this.a^=this.a<<2:3===i&&(this.a^=this.a>>>16),this.a+=this.mem[t+128&255],this.mem[t]=s=this.mem[e>>>2&255]+this.a+this.b,this.rsl[t]=this.b=this.mem[s>>>8>>>2&255]+e}}}class it{db;constructor(t){t.onerror=this.onerror,t.onclose=this.onclose,this.db=t}static openDatabase=async()=>await new Promise(((t,e)=>{const i=indexedDB.open("lostcity",1);i.onsuccess=e=>{const i=e.target;console.log("database success!"),t(i.result)},i.onupgradeneeded=t=>{t.target.result.createObjectStore("cache")},i.onerror=t=>{const i=t.target;console.error("database error!: ",i.error),e(i.result)}}));cacheload=async t=>await new Promise((e=>{const i=this.db.transaction("cache","readonly").objectStore("cache").get(t);i.onsuccess=()=>{console.log("cacheload successful!"),e(i.result)},i.onerror=t=>{console.error("cacheload error!:",t),e(void 0)}}));cachesave=async(t,e)=>await new Promise(((i,s)=>{if(e.length>2e6)return void s();const a=this.db.transaction("cache","readwrite").objectStore("cache").put(e,t);a.onsuccess=()=>{console.log("cachesave successful!"),i()},a.onerror=t=>{console.error("cachesave error!:",t),s()}}));onclose=t=>{console.log("database close!")};onerror=t=>{console.log("database error!")};genHash=t=>{const e=t.trim();let i=0;for(let t=0;t<e.length&&t<12;t++){const s=e.charAt(t);i*=37,s>="A"&&s<="Z"?i+=s.charCodeAt(0)+1-65:s>="a"&&s<="z"?i+=s.charCodeAt(0)+1-97:s>="0"&&s<="9"&&(i+=s.charCodeAt(0)+27-48)}return i}}class st{static OPEN=0;static WALL_NORTH_WEST=1;static WALL_NORTH=2;static WALL_NORTH_EAST=4;static WALL_EAST=8;static WALL_SOUTH_EAST=st.WALL_NORTH_WEST<<4;static WALL_SOUTH=st.WALL_NORTH<<4;static WALL_SOUTH_WEST=st.WALL_NORTH_EAST<<4;static WALL_WEST=st.WALL_EAST<<4;static LOC=256;static WALL_NORTH_WEST_PROJ_BLOCKER=512;static WALL_NORTH_PROJ_BLOCKER=1024;static WALL_NORTH_EAST_PROJ_BLOCKER=2048;static WALL_EAST_PROJ_BLOCKER=4096;static WALL_SOUTH_EAST_PROJ_BLOCKER=st.WALL_NORTH_WEST_PROJ_BLOCKER<<4;static WALL_SOUTH_PROJ_BLOCKER=st.WALL_NORTH_PROJ_BLOCKER<<4;static WALL_SOUTH_WEST_PROJ_BLOCKER=st.WALL_NORTH_EAST_PROJ_BLOCKER<<4;static WALL_WEST_PROJ_BLOCKER=st.WALL_EAST_PROJ_BLOCKER<<4;static LOC_PROJ_BLOCKER=st.LOC<<9;static FLOOR_DECORATION=524288;static FLOOR=2097152;static FLOOR_BLOCKED=st.FLOOR|st.FLOOR_DECORATION;static WALK_BLOCKED=st.LOC|st.FLOOR_BLOCKED;static BLOCK_SOUTH=st.WALL_NORTH|st.WALK_BLOCKED;static BLOCK_WEST=st.WALL_EAST|st.WALK_BLOCKED;static BLOCK_SOUTH_WEST=st.WALL_NORTH|st.WALL_NORTH_EAST|st.BLOCK_WEST;static BLOCK_NORTH=st.WALL_SOUTH|st.WALK_BLOCKED;static BLOCK_NORTH_WEST=st.WALL_EAST|st.WALL_SOUTH_EAST|st.BLOCK_NORTH;static BLOCK_EAST=st.WALL_WEST|st.WALK_BLOCKED;static BLOCK_SOUTH_EAST=st.WALL_NORTH_WEST|st.WALL_NORTH|st.BLOCK_EAST;static BLOCK_NORTH_EAST=st.WALL_SOUTH|st.WALL_SOUTH_WEST|st.BLOCK_EAST;static BOUNDS=16777215}var at;!function(t){t[t.WEST=0]="WEST",t[t.NORTH=1]="NORTH",t[t.EAST=2]="EAST",t[t.SOUTH=3]="SOUTH"}(at||(at={}));const rt=at;var nt;!function(t){t[t.WALL_STRAIGHT=0]="WALL_STRAIGHT",t[t.WALL_DIAGONAL_CORNER=1]="WALL_DIAGONAL_CORNER",t[t.WALL_L=2]="WALL_L",t[t.WALL_SQUARE_CORNER=3]="WALL_SQUARE_CORNER",t[t.WALLDECOR_STRAIGHT_NOOFFSET=4]="WALLDECOR_STRAIGHT_NOOFFSET",t[t.WALLDECOR_STRAIGHT_OFFSET=5]="WALLDECOR_STRAIGHT_OFFSET",t[t.WALLDECOR_DIAGONAL_OFFSET=6]="WALLDECOR_DIAGONAL_OFFSET",t[t.WALLDECOR_DIAGONAL_NOOFFSET=7]="WALLDECOR_DIAGONAL_NOOFFSET",t[t.WALLDECOR_DIAGONAL_BOTH=8]="WALLDECOR_DIAGONAL_BOTH",t[t.WALL_DIAGONAL=9]="WALL_DIAGONAL",t[t.CENTREPIECE_STRAIGHT=10]="CENTREPIECE_STRAIGHT",t[t.CENTREPIECE_DIAGONAL=11]="CENTREPIECE_DIAGONAL",t[t.ROOF_STRAIGHT=12]="ROOF_STRAIGHT",t[t.ROOF_DIAGONAL_WITH_ROOFEDGE=13]="ROOF_DIAGONAL_WITH_ROOFEDGE",t[t.ROOF_DIAGONAL=14]="ROOF_DIAGONAL",t[t.ROOF_L_CONCAVE=15]="ROOF_L_CONCAVE",t[t.ROOF_L_CONVEX=16]="ROOF_L_CONVEX",t[t.ROOF_FLAT=17]="ROOF_FLAT",t[t.ROOFEDGE_STRAIGHT=18]="ROOFEDGE_STRAIGHT",t[t.ROOFEDGE_DIAGONAL_CORNER=19]="ROOFEDGE_DIAGONAL_CORNER",t[t.ROOFEDGE_L=20]="ROOFEDGE_L",t[t.ROOFEDGE_SQUARE_CORNER=21]="ROOFEDGE_SQUARE_CORNER",t[t.GROUND_DECOR=22]="GROUND_DECOR"}(nt||(nt={}));const ht=nt;class ot{static NORTH=1;static EAST=2;static SOUTH=4;static WEST=8;static SOUTH_WEST=ot.WEST|ot.SOUTH;static NORTH_WEST=ot.WEST|ot.NORTH;static SOUTH_EAST=ot.EAST|ot.SOUTH;static NORTH_EAST=ot.EAST|ot.NORTH}class lt{static SIZE=104;static index=(t,e)=>t*lt.SIZE+e;offsetX;offsetZ;sizeX;sizeZ;flags;constructor(){this.offsetX=0,this.offsetZ=0,this.sizeX=lt.SIZE,this.sizeZ=lt.SIZE,this.flags=new Int32Array(this.sizeX*this.sizeZ),this.reset()}reset=()=>{for(let t=0;t<this.sizeX;t++)for(let e=0;e<this.sizeZ;e++){const i=lt.index(t,e);0===t||0===e||t===this.sizeX-1||e===this.sizeZ-1?this.flags[i]=st.BOUNDS:this.flags[i]=st.OPEN}};addFloor=(t,e)=>{this.flags[lt.index(t-this.offsetX,e-this.offsetZ)]|=st.FLOOR};removeFloor=(t,e)=>{this.flags[lt.index(t-this.offsetX,e-this.offsetZ)]&=~st.FLOOR};addLoc=(t,e,i,s,a,r)=>{let n=st.LOC;r&&(n|=st.LOC_PROJ_BLOCKER);const h=t-this.offsetX,o=e-this.offsetZ;if(a===rt.NORTH||a===rt.SOUTH){const t=i;i=s,s=t}for(let t=h;t<h+i;t++)if(t>=0&&t<this.sizeX)for(let e=o;e<o+s;e++)e>=0&&e<this.sizeZ&&this.add(t,e,n)};removeLoc=(t,e,i,s,a,r)=>{let n=st.LOC;r&&(n|=st.LOC_PROJ_BLOCKER);const h=t-this.offsetX,o=e-this.offsetZ;if(a===rt.NORTH||a===rt.SOUTH){const t=i;i=s,s=t}for(let t=h;t<h+i;t++)if(t>=0&&t<this.sizeX)for(let e=o;e<o+s;e++)e>=0&&e<this.sizeZ&&this.remove(t,e,n)};addWall=(t,e,i,s,a)=>{const r=t-this.offsetX,n=e-this.offsetZ,h=a?st.WALL_WEST_PROJ_BLOCKER:st.WALL_WEST,o=a?st.WALL_EAST_PROJ_BLOCKER:st.WALL_EAST,l=a?st.WALL_NORTH_PROJ_BLOCKER:st.WALL_NORTH,c=a?st.WALL_SOUTH_PROJ_BLOCKER:st.WALL_SOUTH,d=a?st.WALL_NORTH_WEST_PROJ_BLOCKER:st.WALL_NORTH_WEST,f=a?st.WALL_SOUTH_EAST_PROJ_BLOCKER:st.WALL_SOUTH_EAST,u=a?st.WALL_NORTH_EAST_PROJ_BLOCKER:st.WALL_NORTH_EAST,p=a?st.WALL_SOUTH_WEST_PROJ_BLOCKER:st.WALL_SOUTH_WEST;i===ht.WALL_STRAIGHT?s===rt.WEST?(this.add(r,n,h),this.add(r-1,n,o)):s===rt.NORTH?(this.add(r,n,l),this.add(r,n+1,c)):s===rt.EAST?(this.add(r,n,o),this.add(r+1,n,h)):s===rt.SOUTH&&(this.add(r,n,c),this.add(r,n-1,l)):i===ht.WALL_DIAGONAL_CORNER||i===ht.WALL_SQUARE_CORNER?s===rt.WEST?(this.add(r,n,d),this.add(r-1,n+1,f)):s===rt.NORTH?(this.add(r,n,u),this.add(r+1,n+1,p)):s===rt.EAST?(this.add(r,n,f),this.add(r+1,n-1,d)):s===rt.SOUTH&&(this.add(r,n,p),this.add(r-1,n-1,u)):i===ht.WALL_L&&(s===rt.WEST?(this.add(r,n,l|h),this.add(r-1,n,o),this.add(r,n+1,c)):s===rt.NORTH?(this.add(r,n,l|o),this.add(r,n+1,c),this.add(r+1,n,h)):s===rt.EAST?(this.add(r,n,c|o),this.add(r+1,n,h),this.add(r,n-1,l)):s===rt.SOUTH&&(this.add(r,n,c|h),this.add(r,n-1,l),this.add(r-1,n,o))),a&&this.addWall(t,e,i,s,!1)};removeWall=(t,e,i,s,a)=>{const r=t-this.offsetX,n=e-this.offsetZ,h=a?st.WALL_WEST_PROJ_BLOCKER:st.WALL_WEST,o=a?st.WALL_EAST_PROJ_BLOCKER:st.WALL_EAST,l=a?st.WALL_NORTH_PROJ_BLOCKER:st.WALL_NORTH,c=a?st.WALL_SOUTH_PROJ_BLOCKER:st.WALL_SOUTH,d=a?st.WALL_NORTH_WEST_PROJ_BLOCKER:st.WALL_NORTH_WEST,f=a?st.WALL_SOUTH_EAST_PROJ_BLOCKER:st.WALL_SOUTH_EAST,u=a?st.WALL_NORTH_EAST_PROJ_BLOCKER:st.WALL_NORTH_EAST,p=a?st.WALL_SOUTH_WEST_PROJ_BLOCKER:st.WALL_SOUTH_WEST;i===ht.WALL_STRAIGHT?s===rt.WEST?(this.remove(r,n,h),this.remove(r-1,n,o)):s===rt.NORTH?(this.remove(r,n,l),this.remove(r,n+1,c)):s===rt.EAST?(this.remove(r,n,o),this.remove(r+1,n,h)):s===rt.SOUTH&&(this.remove(r,n,c),this.remove(r,n-1,l)):i===ht.WALL_DIAGONAL_CORNER||i===ht.WALL_SQUARE_CORNER?s===rt.WEST?(this.remove(r,n,d),this.remove(r-1,n+1,f)):s===rt.NORTH?(this.remove(r,n,u),this.remove(r+1,n+1,p)):s===rt.EAST?(this.remove(r,n,f),this.remove(r+1,n-1,d)):s===rt.SOUTH&&(this.remove(r,n,p),this.remove(r-1,n-1,u)):i===ht.WALL_L&&(s===rt.WEST?(this.remove(r,n,l|h),this.remove(r-1,n,o),this.remove(r,n+1,c)):s===rt.NORTH?(this.remove(r,n,l|o),this.remove(r,n+1,c),this.remove(r+1,n,h)):s===rt.EAST?(this.remove(r,n,c|o),this.remove(r+1,n,h),this.remove(r,n-1,l)):s===rt.SOUTH&&(this.remove(r,n,c|h),this.remove(r,n-1,l),this.remove(r-1,n,o))),a&&this.removeWall(t,e,i,s,!1)};reachedWall=(t,e,i,s,a,r)=>{if(t===i&&e===s)return!0;const n=t-this.offsetX,h=e-this.offsetZ,o=i-this.offsetX,l=s-this.offsetZ,c=lt.index(n,h);if(a===ht.WALL_STRAIGHT){if(r===rt.WEST){if(n===o-1&&h===l)return!0;if(n===o&&h===l+1&&(this.flags[c]&st.BLOCK_NORTH)===st.OPEN)return!0;if(n===o&&h===l-1&&(this.flags[c]&st.BLOCK_SOUTH)===st.OPEN)return!0}else if(r===rt.NORTH){if(n===o&&h===l+1)return!0;if(n===o-1&&h===l&&(this.flags[c]&st.BLOCK_WEST)===st.OPEN)return!0;if(n===o+1&&h===l&&(this.flags[c]&st.BLOCK_EAST)===st.OPEN)return!0}else if(r===rt.EAST){if(n===o+1&&h===l)return!0;if(n===o&&h===l+1&&(this.flags[c]&st.BLOCK_NORTH)===st.OPEN)return!0;if(n===o&&h===l-1&&(this.flags[c]&st.BLOCK_SOUTH)===st.OPEN)return!0}else if(r===rt.SOUTH){if(n===o&&h===l-1)return!0;if(n===o-1&&h===l&&(this.flags[c]&st.BLOCK_WEST)===st.OPEN)return!0;if(n===o+1&&h===l&&(this.flags[c]&st.BLOCK_EAST)===st.OPEN)return!0}}else if(a===ht.WALL_L){if(r===rt.WEST){if(n===o-1&&h===l)return!0;if(n===o&&h===l+1)return!0;if(n===o+1&&h===l&&(this.flags[c]&st.BLOCK_EAST)===st.OPEN)return!0;if(n===o&&h===l-1&&(this.flags[c]&st.BLOCK_SOUTH)===st.OPEN)return!0}else if(r===rt.NORTH){if(n===o-1&&h===l&&(this.flags[c]&st.BLOCK_WEST)===st.OPEN)return!0;if(n===o&&h===l+1)return!0;if(n===o+1&&h===l)return!0;if(n===o&&h===l-1&&(this.flags[c]&st.BLOCK_SOUTH)===st.OPEN)return!0}else if(r===rt.EAST){if(n===o-1&&h===l&&(this.flags[c]&st.BLOCK_WEST)===st.OPEN)return!0;if(n===o&&h===l+1&&(this.flags[c]&st.BLOCK_NORTH)===st.OPEN)return!0;if(n===o+1&&h===l)return!0;if(n===o&&h===l-1)return!0}else if(r===rt.SOUTH){if(n===o-1&&h===l)return!0;if(n===o&&h===l+1&&(this.flags[c]&st.BLOCK_NORTH)===st.OPEN)return!0;if(n===o+1&&h===l&&(this.flags[c]&st.BLOCK_EAST)===st.OPEN)return!0;if(n===o&&h===l-1)return!0}}else if(a===ht.WALL_DIAGONAL){if(n===o&&h===l+1&&(this.flags[c]&st.WALL_SOUTH)===st.OPEN)return!0;if(n===o&&h===l-1&&(this.flags[c]&st.WALL_NORTH)===st.OPEN)return!0;if(n===o-1&&h===l&&(this.flags[c]&st.WALL_EAST)===st.OPEN)return!0;if(n===o+1&&h===l&&(this.flags[c]&st.WALL_WEST)===st.OPEN)return!0}return!1};reachedWallDecoration=(t,e,i,s,a,r)=>{if(t===i&&e===s)return!0;const n=t-this.offsetX,h=e-this.offsetZ,o=i-this.offsetX,l=s-this.offsetZ,c=lt.index(n,h);if(a===ht.WALLDECOR_DIAGONAL_OFFSET||a===ht.WALLDECOR_DIAGONAL_NOOFFSET){if(a===ht.WALLDECOR_DIAGONAL_NOOFFSET&&(r=r+2&3),r===rt.WEST){if(n===o+1&&h===l&&(this.flags[c]&st.WALL_WEST)===st.OPEN)return!0;if(n===o&&h===l-1&&(this.flags[c]&st.WALL_NORTH)===st.OPEN)return!0}else if(r===rt.NORTH){if(n===o-1&&h===l&&(this.flags[c]&st.WALL_EAST)===st.OPEN)return!0;if(n===o&&h===l-1&&(this.flags[c]&st.WALL_NORTH)===st.OPEN)return!0}else if(r===rt.EAST){if(n===o-1&&h===l&&(this.flags[c]&st.WALL_EAST)===st.OPEN)return!0;if(n===o&&h===l+1&&(this.flags[c]&st.WALL_SOUTH)===st.OPEN)return!0}else if(r===rt.SOUTH){if(n===o+1&&h===l&&(this.flags[c]&st.WALL_WEST)===st.OPEN)return!0;if(n===o&&h===l+1&&(this.flags[c]&st.WALL_SOUTH)===st.OPEN)return!0}}else if(a===ht.WALLDECOR_DIAGONAL_BOTH){if(n===o&&h===l+1&&(this.flags[c]&st.WALL_SOUTH)===st.OPEN)return!0;if(n===o&&h===l-1&&(this.flags[c]&st.WALL_NORTH)===st.OPEN)return!0;if(n===o-1&&h===l&&(this.flags[c]&st.WALL_EAST)===st.OPEN)return!0;if(n===o+1&&h===l&&(this.flags[c]&st.WALL_WEST)===st.OPEN)return!0}return!1};reachedLoc=(t,e,i,s,a,r,n)=>{const h=i+a-1,o=s+r-1,l=lt.index(t-this.offsetX,e-this.offsetZ);return t>=i&&t<=h&&e>=s&&e<=o||t===i-1&&e>=s&&e<=o&&(this.flags[l]&st.WALL_EAST)===st.OPEN&&(n&ot.WEST)===st.OPEN||t===h+1&&e>=s&&e<=o&&(this.flags[l]&st.WALL_WEST)===st.OPEN&&(n&ot.EAST)===st.OPEN||e===s-1&&t>=i&&t<=h&&(this.flags[l]&st.WALL_NORTH)===st.OPEN&&(n&ot.SOUTH)===st.OPEN||e===o+1&&t>=i&&t<=h&&(this.flags[l]&st.WALL_SOUTH)===st.OPEN&&(n&ot.NORTH)===st.OPEN};add=(t,e,i)=>{this.flags[lt.index(t,e)]|=i};remove=(t,e,i)=>{this.flags[lt.index(t,e)]&=st.BOUNDS-i}}class ct extends r{}class dt extends ct{x=0;z=0;yaw=0;seqStretches=!1;size=1;seqStandId=-1;seqTurnId=-1;seqWalkId=-1;seqTurnAroundId=-1;seqTurnLeftId=-1;seqTurnRightId=-1;seqRunId=-1;chat=null;chatTimer=100;chatColor=0;chatStyle=0;damage=0;damageType=0;combatCycle=-1e3;health=0;totalHealth=0;targetId=-1;targetTileX=0;targetTileZ=0;secondarySeqId=-1;secondarySeqFrame=0;secondarySeqCycle=0;primarySeqId=-1;primarySeqFrame=0;primarySeqCycle=0;primarySeqDelay=0;primarySeqLoop=0;spotanimId=-1;spotanimFrame=0;spotanimCycle=0;spotanimLastCycle=0;spotanimOffset=0;forceMoveStartSceneTileX=0;forceMoveEndSceneTileX=0;forceMoveStartSceneTileZ=0;forceMoveEndSceneTileZ=0;forceMoveEndCycle=0;forceMoveStartCycle=0;forceMoveFaceDirection=0;cycle=0;height=0;dstYaw=0;pathLength=0;pathTileX=new Int32Array(10);pathTileZ=new Int32Array(10);pathRunning=new Array(10).fill(!1);seqTrigger=0;lastMask=-1;lastMaskCycle=-1;lastFaceX=-1;lastFaceZ=-1;move=(t,e,i)=>{if(-1!==this.primarySeqId&&d.instances[this.primarySeqId].priority<=1&&(this.primarySeqId=-1),!t){const t=e-this.pathTileX[0],s=i-this.pathTileZ[0];if(t>=-8&&t<=8&&s>=-8&&s<=8){this.pathLength<9&&this.pathLength++;for(let t=this.pathLength;t>0;t--)this.pathTileX[t]=this.pathTileX[t-1],this.pathTileZ[t]=this.pathTileZ[t-1],this.pathRunning[t]=this.pathRunning[t-1];return this.pathTileX[0]=e,this.pathTileZ[0]=i,void(this.pathRunning[0]=!1)}}this.pathLength=0,this.seqTrigger=0,this.pathTileX[0]=e,this.pathTileZ[0]=i,this.x=128*this.pathTileX[0]+64*this.size,this.z=128*this.pathTileZ[0]+64*this.size};step=(t,e)=>{let i=this.pathTileX[0],s=this.pathTileZ[0];0===e?(i--,s++):1===e?s++:2===e?(i++,s++):3===e?i--:4===e?i++:5===e?(i--,s--):6===e?s--:7===e&&(i++,s--),-1!==this.primarySeqId&&d.instances[this.primarySeqId].priority<=1&&(this.primarySeqId=-1),this.pathLength<9&&this.pathLength++;for(let t=this.pathLength;t>0;t--)this.pathTileX[t]=this.pathTileX[t-1],this.pathTileZ[t]=this.pathTileZ[t-1],this.pathRunning[t]=this.pathRunning[t-1];this.pathTileX[0]=i,this.pathTileZ[0]=s,this.pathRunning[0]=t}}class ft extends dt{static DESIGN_HAIR_COLOR=[9104,10275,7595,3610,7975,8526,918,38802,24466,10145,58654,5027,1457,16565,34991,25486];static DESIGN_BODY_COLOR=[[6798,107,10283,16,4797,7744,5799,4634,33697,22433,2983,54193],[8741,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003,25239],[25238,8742,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003],[4626,11146,6439,12,4758,10270],[4550,4537,5681,5673,5790,6806,8076,4574]];static modelCache=new p(200);name=null;visible=!1;gender=0;headicons=0;appearances=new Uint16Array(12);colors=new Uint16Array(5);combatLevel=0;appearanceHashcode=0;y=0;locStartCycle=0;locStopCycle=0;locOffsetX=0;locOffsetY=0;locOffsetZ=0;locModel=null;minTileX=0;minTileZ=0;maxTileX=0;maxTileZ=0;lowMemory=!1;draw(t){if(!this.visible)return null;let e=this.getSequencedModel();if(this.height=e.maxY,e.pickable=!0,this.lowMemory)return e;if(-1!==this.spotanimId&&-1!==this.spotanimFrame){const t=E.instances[this.spotanimId],i=_.modelShareColored(t.getModel(),!0,!t.disposeAlpha,!1);i.translate(-this.spotanimOffset,0,0),i.createLabelReferences(),t.seq&&t.seq.frames&&i.applyTransform(t.seq.frames[this.spotanimFrame]),i.labelFaces=null,i.labelVertices=null,128===t.resizeh&&128===t.resizev||i.scale(t.resizeh,t.resizev,t.resizeh),i.calculateNormals(t.ambient+64,t.contrast+850,-30,-50,-30,!0);const s=[e,i];e=_.modelFromModelsBounds(s,2)}if(this.locModel&&(t>=this.locStopCycle&&(this.locModel=null),t>=this.locStartCycle&&t<this.locStopCycle)){const t=this.locModel;if(t){t.translate(this.locOffsetY-this.y,this.locOffsetX-this.x,this.locOffsetZ-this.z),512===this.dstYaw?(t.rotateY90(),t.rotateY90(),t.rotateY90()):1024===this.dstYaw?(t.rotateY90(),t.rotateY90()):1536===this.dstYaw&&t.rotateY90();const i=[e,t];e=_.modelFromModelsBounds(i,2),512===this.dstYaw?t.rotateY90():1024===this.dstYaw?(t.rotateY90(),t.rotateY90()):1536===this.dstYaw&&(t.rotateY90(),t.rotateY90(),t.rotateY90()),t.translate(this.y-this.locOffsetY,this.x-this.locOffsetX,this.z-this.locOffsetZ)}}return e.pickable=!0,e}isVisible=()=>this.visible;read=t=>{t.pos=0,this.gender=t.g1,this.headicons=t.g1;for(let e=0;e<12;e++){const i=t.g1;this.appearances[e]=0===i?0:(i<<8)+t.g1}for(let e=0;e<5;e++){let i=t.g1;(i<0||i>=ft.DESIGN_BODY_COLOR[e].length)&&(i=0),this.colors[e]=i}this.seqStandId=t.g2,65535===this.seqStandId&&(this.seqStandId=-1),this.seqTurnId=t.g2,65535===this.seqTurnId&&(this.seqTurnId=-1),this.seqWalkId=t.g2,65535===this.seqWalkId&&(this.seqWalkId=-1),this.seqTurnAroundId=t.g2,65535===this.seqTurnAroundId&&(this.seqTurnAroundId=-1),this.seqTurnLeftId=t.g2,65535===this.seqTurnLeftId&&(this.seqTurnLeftId=-1),this.seqTurnRightId=t.g2,65535===this.seqTurnRightId&&(this.seqTurnRightId=-1),this.seqRunId=t.g2,65535===this.seqRunId&&(this.seqRunId=-1),this.name=B.formatName(B.fromBase37(t.g8)),this.combatLevel=t.g1,this.visible=!0,this.appearanceHashcode=0;for(let t=0;t<12;t++)this.appearanceHashcode<<=4,this.appearances[t]>=256&&(this.appearanceHashcode+=this.appearances[t]-256);this.appearances[0]>=256&&(this.appearanceHashcode+=this.appearances[0]-256>>4),this.appearances[1]>=256&&(this.appearanceHashcode+=this.appearances[1]-256>>8);for(let t=0;t<5;t++)this.appearanceHashcode<<=3,this.appearanceHashcode+=this.colors[t];this.appearanceHashcode<<=1,this.appearanceHashcode+=this.gender};getHeadModel=()=>{if(!this.visible)return null;const t=[];let e=0;for(let i=0;i<12;i++){const s=this.appearances[i];if(s>=256&&s<512&&(t[e++]=M.instances[s-256].getHeadModel()),s>=512){const i=k.get(s-512).getHeadModel(this.gender);i&&(t[e++]=i)}}const i=_.modelFromModels(t,e);for(let t=0;t<5;t++)0!==this.colors[t]&&(i.recolor(ft.DESIGN_BODY_COLOR[t][0],ft.DESIGN_BODY_COLOR[t][this.colors[t]]),1===t&&i.recolor(ft.DESIGN_HAIR_COLOR[0],ft.DESIGN_HAIR_COLOR[this.colors[t]]));return i};getSequencedModel=()=>{let t=this.appearanceHashcode,e=-1,i=-1,s=-1,a=-1;if(this.primarySeqId>=0&&0===this.primarySeqDelay){const r=d.instances[this.primarySeqId];if(r.frames&&(e=r.frames[this.primarySeqFrame]),this.secondarySeqId>=0&&this.secondarySeqId!==this.seqStandId){const t=d.instances[this.secondarySeqId].frames;t&&(i=t[this.secondarySeqFrame])}r.mainhand>=0&&(s=r.mainhand,t+=s-this.appearances[5]<<8),r.offhand>=0&&(a=r.offhand,t+=a-this.appearances[3]<<16)}else if(this.secondarySeqId>=0){const t=d.instances[this.secondarySeqId].frames;t&&(e=t[this.secondarySeqFrame])}let r=ft.modelCache?.get(t);if(!r){const e=[];let i=0;for(let t=0;t<12;t++){let r=this.appearances[t];if(a>=0&&3===t&&(r=a),s>=0&&5===t&&(r=s),r>=256&&r<512){const t=M.instances[r-256].getModel();t&&(e[i++]=t)}if(r>=512){const t=k.get(r-512).getWornModel(this.gender);t&&(e[i++]=t)}}r=_.modelFromModels(e,i);for(let t=0;t<5;t++)0!==this.colors[t]&&(r.recolor(ft.DESIGN_BODY_COLOR[t][0],ft.DESIGN_BODY_COLOR[t][this.colors[t]]),1===t&&r.recolor(ft.DESIGN_HAIR_COLOR[0],ft.DESIGN_HAIR_COLOR[this.colors[t]]));r.createLabelReferences(),r.calculateNormals(64,850,-30,-50,-30,!0),ft.modelCache?.put(t,r)}if(this.lowMemory)return r;const n=_.modelShareAlpha(r,!0);return-1!==e&&-1!==i?n.applyTransforms(e,i,d.instances[this.primarySeqId].labelGroups):-1!==e&&n.applyTransform(e),n.calculateBoundsCylinder(),n.labelFaces=null,n.labelVertices=null,n}}class ut extends dt{type=null;draw=()=>{if(!this.type)return null;if(-1===this.spotanimId||-1===this.spotanimFrame)return this.getSequencedModel();const t=this.getSequencedModel();if(!t)return null;const e=E.instances[this.spotanimId],i=_.modelShareColored(e.getModel(),!0,!e.disposeAlpha,!1);i.translate(-this.spotanimOffset,0,0),i.createLabelReferences(),e.seq&&e.seq.frames&&i.applyTransform(e.seq.frames[this.spotanimFrame]),i.labelFaces=null,i.labelVertices=null,128===e.resizeh&&128===e.resizev||i.scale(e.resizeh,e.resizev,e.resizeh),i.calculateNormals(64+e.ambient,850+e.contrast,-30,-50,-30,!0);const s=[t,i],a=_.modelFromModelsBounds(s,2);return 1===this.type.size&&(a.pickable=!0),a};isVisible=()=>null!==this.type;getSequencedModel=()=>{if(!this.type)return null;if(this.primarySeqId>=0&&0===this.primarySeqDelay){const t=d.instances[this.primarySeqId].frames;if(t){const e=t[this.primarySeqFrame];let i=-1;if(this.secondarySeqId>=0&&this.secondarySeqId!==this.seqStandId){const t=d.instances[this.secondarySeqId].frames;t&&(i=t[this.secondarySeqFrame])}return this.type.getSequencedModel(e,i,d.instances[this.primarySeqId].labelGroups)}}let t=-1;if(this.secondarySeqId>=0){const e=d.instances[this.secondarySeqId].frames;e&&(t=e[this.secondarySeqFrame])}const e=this.type.getSequencedModel(t,-1,null);return e?(this.height=e.maxY,e):null}}class pt{static TABLE=[" ","e","t","a","o","i","h","n","s","r","d","l","u","m","w","c","y","f","g","p","b","v","k","x","j","q","z","0","1","2","3","4","5","6","7","8","9"," ","!","?",".",",",":",";","(",")","-","&","*","\\","'","@","#","+","=","","$","%",'"',"[","]"];static charBuffer=[];static unpack=(t,e)=>{let i,s=0,a=-1;for(let r=0;r<e&&s<100;r++){const e=t.g1;i=e>>4&15,-1!==a?(this.charBuffer[s++]=this.TABLE[(a<<4)+i-195],a=-1):i<13?this.charBuffer[s++]=this.TABLE[i]:a=i,i=15&e,-1!==a?(this.charBuffer[s++]=this.TABLE[(a<<4)+i-195],a=-1):i<13?this.charBuffer[s++]=this.TABLE[i]:a=i}let r=!0;for(let t=0;t<s;t++){const e=this.charBuffer[t];r&&e>="a"&&e<="z"&&(this.charBuffer[t]=e.toUpperCase(),r=!1),"."!==e&&"!"!==e||(r=!0)}return this.charBuffer.slice(0,s).join("")};static pack=(t,e)=>{e.length>80&&(e=e.substring(0,80)),e=e.toLowerCase();let i=-1;for(let s=0;s<e.length;s++){const a=e.charAt(s);let r=0;for(let t=0;t<this.TABLE.length;t++)if(a===this.TABLE[t]){r=t;break}r>12&&(r+=195),-1===i?r<13?i=r:t.p1(r):r<13?(t.p1((i<<4)+r),i=-1):(t.p1((i<<4)+(r>>4)),i=15&r)}-1!==i&&t.p1(i<<4)}}class mt{static levelBuilt=0}class gt extends z{static HOST="https://w2.225.2004scape.org";static PORT=43599;static CHARSET="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!\"$%^&*()-_=+[{]};:'@#~,<.>/?\\| ";static EXPONENT=58778699976184461502525193738213253649000149147835990136706041084440742975821n;static MODULUS=7162900525229798032761816791230527296329313291232324290237849263501208207972894053929065636522363163621000728841182238772712427862772219676577293600221789n;static MEMBERS=!0;static LOW_MEMORY=!1;static updateCounter=0;static update2Counter=0;static sidebarInputCounter=0;static opHeld1Counter=0;static opLoc4Counter=0;static opNpc5Counter=0;static drawCounter=0;static opHeld4Counter=0;static opLoc5Counter=0;static opNpc3Counter=0;static opHeld9Counter=0;static opPlayer2Counter=0;static updatePlayersCounter=0;static ifButton5Counter=0;static updateLocCounter=0;static nodeId=0;SCROLLBAR_TRACK=2301979;SCROLLBAR_GRIP_FOREGROUND=5063219;SCROLLBAR_GRIP_HIGHLIGHT=7759444;SCROLLBAR_GRIP_LOWLIGHT=3353893;MAX_PLAYER_COUNT=2048;LOCAL_PLAYER_INDEX=2047;alreadyStarted=!1;errorStarted=!1;errorLoading=!1;errorHost=!1;db=null;loopCycle=0;ingame=!1;archiveChecksums=[];stream=null;in=o.alloc(1);out=o.alloc(1);loginout=o.alloc(1);serverSeed=0n;idleNetCycles=0;idleTimeout=0;systemUpdateTimer=0;randomIn=null;packetType=0;packetSize=0;lastPacketType0=0;lastPacketType1=0;lastPacketType2=0;titleArchive=null;configArchive=null;interfaceArchive=null;modelsArchive=null;texturesArchive=null;wordencArchive=null;soundsArchive=null;mediaArchive=null;redrawTitleBackground=!0;titleScreenState=0;titleLoginField=0;imageTitle2=null;imageTitle3=null;imageTitle4=null;imageTitle0=null;imageTitle1=null;imageTitle5=null;imageTitle6=null;imageTitle7=null;imageTitle8=null;imageTitlebox=null;imageTitlebutton=null;loginMessage0="";loginMessage1="";username="";password="";fontPlain11=null;fontPlain12=null;fontBold12=null;fontQuill8=null;imageRunes=[];flameActive=!1;imageFlamesLeft=null;imageFlamesRight=null;flameBuffer1=null;flameBuffer0=null;flameBuffer3=null;flameBuffer2=null;flameGradient=null;flameGradient0=null;flameGradient1=null;flameGradient2=null;flameLineOffset=new Int32Array(256);flameCycle0=0;flameGradientCycle0=0;flameGradientCycle1=0;flamesInterval=null;areaSidebar=null;areaMapback=null;areaViewport=null;areaChatback=null;areaBackbase1=null;areaBackbase2=null;areaBackhmid1=null;areaBackleft1=null;areaBackleft2=null;areaBackright1=null;areaBackright2=null;areaBacktop1=null;areaBacktop2=null;areaBackvmid1=null;areaBackvmid2=null;areaBackvmid3=null;areaBackhmid2=null;areaChatbackOffsets=null;areaSidebarOffsets=null;areaViewportOffsets=null;compassMaskLineOffsets=new Uint16Array(33);compassMaskLineLengths=new Uint16Array(33);minimapMaskLineOffsets=new Uint16Array(151);minimapMaskLineLengths=new Uint16Array(151);imageInvback=null;imageChatback=null;imageMapback=null;imageBackbase1=null;imageBackbase2=null;imageBackhmid1=null;imageSideicons=[];imageCompass=null;imageMapscene=[];imageMapfunction=[];imageHitmarks=[];imageHeadicons=[];imageMapflag=null;imageCrosses=[];imageMapdot0=null;imageMapdot1=null;imageMapdot2=null;imageMapdot3=null;imageScrollbar0=null;imageScrollbar1=null;imageRedstone1=null;imageRedstone2=null;imageRedstone3=null;imageRedstone1h=null;imageRedstone2h=null;imageRedstone1v=null;imageRedstone2v=null;imageRedstone3v=null;imageRedstone1hv=null;imageRedstone2hv=null;genderButtonImage0=null;genderButtonImage1=null;activeMapFunctions=new Array(1e3).fill(null);redrawSidebar=!1;redrawChatback=!1;redrawSideicons=!1;redrawPrivacySettings=!1;viewportInterfaceId=-1;dragCycles=0;crossMode=0;crossCycle=0;crossX=0;crossY=0;overrideChat=0;menuVisible=!1;menuArea=0;menuX=0;menuY=0;menuWidth=0;menuHeight=0;menuSize=0;menuOption=[];sidebarInterfaceId=-1;chatInterfaceId=-1;chatInterface=new P;chatScrollHeight=78;chatScrollOffset=0;ignoreCount=0;ignoreName37=[];hintType=0;hintNpc=0;hintOffsetX=0;hintOffsetZ=0;hintPlayer=0;hintTileX=0;hintTileZ=0;hintHeight=0;skillExperience=[];skillLevel=[];skillBaseLevel=[];levelExperience=[];modalMessage=null;flashingTab=-1;selectedTab=3;tabInterfaceId=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];publicChatSetting=0;privateChatSetting=0;tradeChatSetting=0;scrollGrabbed=!1;scrollInputPadding=0;showSocialInput=!1;socialMessage="";socialInput="";socialAction=0;chatbackInput="";chatbackInputOpen=!1;stickyChatInterfaceId=-1;messageText=new Array(100).fill(null);messageSender=new Array(100).fill(null);messageType=new Int32Array(100);splitPrivateChat=0;chatTyped="";viewportHoveredInterfaceIndex=0;sidebarHoveredInterfaceIndex=0;chatHoveredInterfaceIndex=0;objDragInterfaceId=0;objDragSlot=0;objDragArea=0;objGrabX=0;objGrabY=0;objDragCycles=0;objGrabThreshold=!1;objSelected=0;objSelectedSlot=0;objSelectedInterface=0;objInterface=0;objSelectedName=null;selectedArea=0;selectedItem=0;selectedInterface=0;selectedCycle=0;pressedContinueOption=!1;awaitingLogin=!1;varps=[];varCache=[];spellSelected=0;activeSpellId=0;activeSpellFlags=0;spellCaption=null;mouseButtonsOption=0;menuAction=new Int32Array(500);menuParamA=new Int32Array(500);menuParamB=new Int32Array(500);menuParamC=new Int32Array(500);hoveredSlotParentId=0;hoveredSlot=0;lastHoveredInterfaceId=0;reportAbuseInput="";reportAbuseMuteOption=!1;reportAbuseInterfaceID=-1;lastAddress=0;daysSinceLastLogin=0;daysSinceRecoveriesChanged=0;unreadMessages=0;scene=null;sceneState=0;sceneDelta=0;sceneCycle=0;flagSceneTileX=0;flagSceneTileZ=0;cutscene=!1;cameraOffsetCycle=0;cameraAnticheatOffsetX=0;cameraAnticheatOffsetZ=0;cameraAnticheatAngle=0;cameraOffsetXModifier=2;cameraOffsetZModifier=2;cameraOffsetYawModifier=1;cameraModifierCycle=new Int32Array(5);cameraModifierEnabled=new Array(5).fill(!1);cameraModifierJitter=new Int32Array(5);cameraModifierWobbleScale=new Int32Array(5);cameraModifierWobbleSpeed=new Int32Array(5);cameraX=0;cameraY=0;cameraZ=0;cameraPitch=0;cameraYaw=0;cameraPitchClamp=0;minimapOffsetCycle=0;minimapAnticheatAngle=0;minimapZoom=0;minimapZoomModifier=1;minimapAngleModifier=2;minimapLevel=-1;baseX=0;baseZ=0;sceneCenterZoneX=0;sceneCenterZoneZ=0;sceneBaseTileX=0;sceneBaseTileZ=0;sceneMapLandData=null;sceneMapLocData=null;sceneMapIndex=null;mapLastBaseX=0;mapLastBaseZ=0;textureBuffer=new Int8Array(16384);levelCollisionMap=new Array(4).fill(null);currentLevel=0;cameraMovedWrite=0;orbitCameraPitch=128;orbitCameraYaw=0;orbitCameraYawVelocity=0;orbitCameraPitchVelocity=0;players=new Array(this.MAX_PLAYER_COUNT).fill(null);playerCount=0;playerIds=new Int32Array(this.MAX_PLAYER_COUNT);entityUpdateCount=0;entityRemovalCount=0;entityUpdateIds=new Int32Array(this.MAX_PLAYER_COUNT);entityRemovalIds=new Int32Array(1e3);playerAppearanceBuffer=new Array(this.MAX_PLAYER_COUNT).fill(null);npcs=new Array(8192).fill(null);npcCount=0;npcIds=new Int32Array(8192);projectiles=new n;spotanims=new n;locList=new n;temporaryLocs=new n;levelObjStacks=new Array(4).fill(null).map((()=>new Array(104).fill(null).map((()=>new Array(104).fill(null)))));spawnedLocations=new n;bfsStepX=new Int32Array(4e3);bfsStepZ=new Int32Array(4e3);bfsDirection=new Int32Array(10816);bfsCost=new Int32Array(10816);tryMoveNearest=0;localPlayer=null;energy=0;inMultizone=0;localPid=-1;weightCarried=0;heartbeatTimer=0;wildernessLevel=0;worldLocationState=0;rights=!1;designGenderMale=!0;updateDesignModel=!1;designIdentikits=new Int32Array(7);designColors=new Int32Array(5);friendCount=0;chatCount=0;chatX=new Int32Array(50);chatY=new Int32Array(50);chatHeight=new Int32Array(50);chatWidth=new Int32Array(50);chatColors=new Int32Array(50);chatStyles=new Int32Array(50);chatTimers=new Int32Array(50);chats=new Array(50).fill(null);friendName=new Array(100).fill(null);friendName37=new BigInt64Array(100);friendWorld=new Int32Array(100);socialName37=null;waveCount=0;waveEnabled=!0;waveIds=new Int32Array(50);waveLoops=new Int32Array(50);waveDelay=new Int32Array(50);lastWaveId=-1;lastWaveLength=0;lastWaveStartTime=0n;nextMusicDelay=0;midiActive=!0;currentMidi=null;midiCrc=0;midiSize=0;load=async()=>{if(this.alreadyStarted)this.errorStarted=!0;else{this.alreadyStarted=!0;try{await this.showProgress(10,"Connecting to fileserver"),await X.load(await(await fetch("bz2.wasm")).arrayBuffer()),this.db=new it(await it.openDatabase());const t=new o(new Uint8Array(await s(`${gt.HOST}/crc`)));for(let e=0;e<9;e++)this.archiveChecksums[e]=t.g4;await this.setMidi("scape_main",12345678);const e=await this.loadArchive("title","title screen",this.archiveChecksums[1],10);this.titleArchive=e,this.fontPlain11=F.fromArchive(e,"p11"),this.fontPlain12=F.fromArchive(e,"p12"),this.fontBold12=F.fromArchive(e,"b12"),this.fontQuill8=F.fromArchive(e,"q8"),await this.loadTitleBackground(),this.loadTitleImages();const i=await this.loadArchive("config","config",this.archiveChecksums[2],15),a=await this.loadArchive("interface","interface",this.archiveChecksums[3],20),r=await this.loadArchive("media","2d graphics",this.archiveChecksums[4],30),n=await this.loadArchive("models","3d graphics",this.archiveChecksums[5],40),h=await this.loadArchive("textures","textures",this.archiveChecksums[6],60),f=await this.loadArchive("wordenc","chat system",this.archiveChecksums[7],65),u=await this.loadArchive("sounds","sound effects",this.archiveChecksums[8],70);this.configArchive=i,this.interfaceArchive=a,this.mediaArchive=r,this.modelsArchive=n,this.texturesArchive=h,this.wordencArchive=f,this.soundsArchive=u,await this.showProgress(75,"Unpacking media"),this.imageInvback=x.fromArchive(r,"invback",0),this.imageChatback=x.fromArchive(r,"chatback",0),this.imageMapback=x.fromArchive(r,"mapback",0),this.imageBackbase1=x.fromArchive(r,"backbase1",0),this.imageBackbase2=x.fromArchive(r,"backbase2",0),this.imageBackhmid1=x.fromArchive(r,"backhmid1",0);for(let t=0;t<13;t++)this.imageSideicons[t]=x.fromArchive(r,"sideicons",t);this.imageCompass=v.fromArchive(r,"compass",0);try{for(let t=0;t<50;t++)this.imageMapscene[t]=x.fromArchive(r,"mapscene",t)}catch(t){}try{for(let t=0;t<50;t++)this.imageMapfunction[t]=v.fromArchive(r,"mapfunction",t)}catch(t){}try{for(let t=0;t<20;t++)this.imageHitmarks[t]=v.fromArchive(r,"hitmarks",t)}catch(t){}try{for(let t=0;t<20;t++)this.imageHeadicons[t]=v.fromArchive(r,"headicons",t)}catch(t){}this.imageMapflag=v.fromArchive(r,"mapflag",0);for(let t=0;t<8;t++)this.imageCrosses[t]=v.fromArchive(r,"cross",t);this.imageMapdot0=v.fromArchive(r,"mapdots",0),this.imageMapdot1=v.fromArchive(r,"mapdots",1),this.imageMapdot2=v.fromArchive(r,"mapdots",2),this.imageMapdot3=v.fromArchive(r,"mapdots",3),this.imageScrollbar0=x.fromArchive(r,"scrollbar",0),this.imageScrollbar1=x.fromArchive(r,"scrollbar",1),this.imageRedstone1=x.fromArchive(r,"redstone1",0),this.imageRedstone2=x.fromArchive(r,"redstone2",0),this.imageRedstone3=x.fromArchive(r,"redstone3",0),this.imageRedstone1h=x.fromArchive(r,"redstone1",0),this.imageRedstone1h?.flipHorizontally(),this.imageRedstone2h=x.fromArchive(r,"redstone2",0),this.imageRedstone2h?.flipHorizontally(),this.imageRedstone1v=x.fromArchive(r,"redstone1",0),this.imageRedstone1v?.flipVertically(),this.imageRedstone2v=x.fromArchive(r,"redstone2",0),this.imageRedstone2v?.flipVertically(),this.imageRedstone3v=x.fromArchive(r,"redstone3",0),this.imageRedstone3v?.flipVertically(),this.imageRedstone1hv=x.fromArchive(r,"redstone1",0),this.imageRedstone1hv?.flipHorizontally(),this.imageRedstone1hv?.flipVertically(),this.imageRedstone2hv=x.fromArchive(r,"redstone2",0),this.imageRedstone2hv?.flipHorizontally(),this.imageRedstone2hv?.flipVertically();const p=v.fromArchive(r,"backleft1",0);this.areaBackleft1=new N(p.width,p.height),p.blitOpaque(0,0);const w=v.fromArchive(r,"backleft2",0);this.areaBackleft2=new N(w.width,w.height),w.blitOpaque(0,0);const y=v.fromArchive(r,"backright1",0);this.areaBackright1=new N(y.width,y.height),y.blitOpaque(0,0);const C=v.fromArchive(r,"backright2",0);this.areaBackright2=new N(C.width,C.height),C.blitOpaque(0,0);const b=v.fromArchive(r,"backtop1",0);this.areaBacktop1=new N(b.width,b.height),b.blitOpaque(0,0);const S=v.fromArchive(r,"backtop2",0);this.areaBacktop2=new N(S.width,S.height),S.blitOpaque(0,0);const T=v.fromArchive(r,"backvmid1",0);this.areaBackvmid1=new N(T.width,T.height),T.blitOpaque(0,0);const I=v.fromArchive(r,"backvmid2",0);this.areaBackvmid2=new N(I.width,I.height),I.blitOpaque(0,0);const O=v.fromArchive(r,"backvmid3",0);this.areaBackvmid3=new N(O.width,O.height),O.blitOpaque(0,0);const B=v.fromArchive(r,"backhmid2",0);this.areaBackhmid2=new N(B.width,B.height),B.blitOpaque(0,0);const Y=Math.trunc(21*Math.random())-10,D=Math.trunc(21*Math.random())-10,H=Math.trunc(21*Math.random())-10,W=Math.trunc(41*Math.random())-20;for(let t=0;t<50;t++)this.imageMapfunction[t]&&this.imageMapfunction[t].translate(Y+W,D+W,H+W),this.imageMapscene[t]&&this.imageMapscene[t].translate(Y+W,D+W,H+W);await this.showProgress(80,"Unpacking textures"),A.unpackTextures(h),A.setBrightness(.8),A.initPool(20),await this.showProgress(83,"Unpacking models"),_.unpack(n),l.unpack(n),c.unpack(n),await this.showProgress(86,"Unpacking config"),d.unpack(i),m.unpack(i),g.unpack(i),k.unpack(i,gt.MEMBERS),L.unpack(i),M.unpack(i),E.unpack(i),R.unpack(i),gt.LOW_MEMORY||(await this.showProgress(90,"Unpacking sounds"),$.unpack(u)),await this.showProgress(92,"Unpacking interfaces"),P.unpack(a,r,[this.fontPlain11,this.fontPlain12,this.fontBold12,this.fontQuill8]),await this.showProgress(97,"Preparing game engine");for(let t=0;t<33;t++){let e=999,i=0;for(let s=0;s<35;s++)if(0===this.imageMapback.pixels[s+t*this.imageMapback.width])999===e&&(e=s);else if(999!==e){i=s;break}this.compassMaskLineOffsets[t]=e,this.compassMaskLineLengths[t]=i-e}for(let t=9;t<160;t++){let e=999,i=0;for(let s=10;s<168;s++)if(0===this.imageMapback.pixels[s+t*this.imageMapback.width]&&(s>34||t>34))999===e&&(e=s);else if(999!==e){i=s;break}this.minimapMaskLineOffsets[t-9]=e-21,this.minimapMaskLineLengths[t-9]=i-e}A.init3D(479,96),this.areaChatbackOffsets=A.lineOffset,A.init3D(190,261),this.areaSidebarOffsets=A.lineOffset,A.init3D(512,334),this.areaViewportOffsets=A.lineOffset;const V=new Int32Array(9);for(let t=0;t<9;t++){const e=32*t+128+15,i=3*e+600,s=A.sin[e];V[t]=i*s>>16}J.init(512,334,500,800,V),U.unpack(f),this.initializeLevelExperience()}catch(t){console.error(t),this.errorLoading=!0}}};update=async()=>{this.errorStarted||this.errorLoading||this.errorHost||(this.loopCycle++,this.ingame?await this.updateGame():await this.updateTitleScreen())};draw=async()=>{this.errorStarted||this.errorLoading||this.errorHost?this.drawError():(this.ingame?this.drawGame():await this.drawTitleScreen(),this.dragCycles=0)};refresh=()=>{this.redrawTitleBackground=!0};showProgress=async(t,i)=>{console.log(`${t}%: ${i}`),await this.loadTitle(),this.titleArchive?(this.imageTitle4?.bind(),this.fontBold12?.drawStringCenter(180,54,"RuneScape is loading - please wait...",16777215),w.drawRect(28,62,304,34,9179409),w.drawRect(29,63,302,32,0),w.fillRect(30,64,3*t,30,9179409),w.fillRect(30+3*t,64,300-3*t,30,0),this.fontBold12?.drawStringCenter(180,85,i,16777215),this.imageTitle4?.draw(214,186),this.redrawTitleBackground&&(this.redrawTitleBackground=!1,this.flameActive||(this.imageTitle0?.draw(0,0),this.imageTitle1?.draw(661,0)),this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(214,386),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(574,265),this.imageTitle7?.draw(128,186),this.imageTitle8?.draw(574,186)),await e(5)):await super.showProgress(t,i)};unload=()=>{try{this.stream&&this.stream.close()}catch(t){}this.stream=null,this.sceneMapIndex=null,this.sceneMapLandData=null,this.sceneMapLocData=null,this.scene=null,this.areaSidebar=null,this.areaMapback=null,this.areaViewport=null,this.areaChatback=null,this.areaBackbase1=null,this.areaBackbase2=null,this.areaBackhmid1=null,this.areaBackleft1=null,this.areaBackleft2=null,this.areaBackright1=null,this.areaBackright2=null,this.areaBacktop1=null,this.areaBacktop2=null,this.areaBackvmid1=null,this.areaBackvmid2=null,this.areaBackvmid3=null,this.areaBackhmid2=null,this.imageInvback=null,this.imageMapback=null,this.imageChatback=null,this.imageBackbase1=null,this.imageBackbase2=null,this.imageBackhmid1=null,this.imageRedstone1=null,this.imageRedstone2=null,this.imageRedstone3=null,this.imageRedstone1h=null,this.imageRedstone2h=null,this.imageRedstone1v=null,this.imageRedstone2v=null,this.imageRedstone3v=null,this.imageRedstone1hv=null,this.imageRedstone2hv=null,this.imageCompass=null,this.imageMapdot0=null,this.imageMapdot1=null,this.imageMapdot2=null,this.imageMapdot3=null,this.imageTitle0=null,this.imageTitle1=null,this.imageTitle2=null,this.imageTitle3=null,this.imageTitle4=null,this.imageTitle5=null,this.imageTitle6=null,this.imageTitle7=null,this.imageTitle8=null,this.unloadTitle(),m.unload(),L.unload(),k.unload(),g.instances=[],M.instances=[],P.instances=[],d.instances=[],E.instances=[],E.modelCache=null,R.instances=[],this.drawArea=null,ft.modelCache=null,A.unload(),J.unload(),_.unload(),l.instances=[],c.instances=[]};runFlames=()=>{this.flameActive&&(this.updateFlames(),this.updateFlames(),this.drawFlames())};loadTitle=async()=>{this.imageTitle2||(this.drawArea=null,this.areaChatback=null,this.areaMapback=null,this.areaSidebar=null,this.areaViewport=null,this.areaBackbase1=null,this.areaBackbase2=null,this.areaBackhmid1=null,this.imageTitle0=new N(128,265),w.clear(),this.imageTitle1=new N(128,265),w.clear(),this.imageTitle2=new N(533,186),w.clear(),this.imageTitle3=new N(360,146),w.clear(),this.imageTitle4=new N(360,200),w.clear(),this.imageTitle5=new N(214,267),w.clear(),this.imageTitle6=new N(215,267),w.clear(),this.imageTitle7=new N(86,79),w.clear(),this.imageTitle8=new N(87,79),w.clear(),this.titleArchive&&(await this.loadTitleBackground(),this.loadTitleImages()),this.redrawTitleBackground=!0)};loadTitleBackground=async()=>{if(!this.titleArchive)return;const t=await v.fromJpeg(this.titleArchive,"title");this.imageTitle0?.bind(),t.blitOpaque(0,0),this.imageTitle1?.bind(),t.blitOpaque(-661,0),this.imageTitle2?.bind(),t.blitOpaque(-128,0),this.imageTitle3?.bind(),t.blitOpaque(-214,-386),this.imageTitle4?.bind(),t.blitOpaque(-214,-186),this.imageTitle5?.bind(),t.blitOpaque(0,-265),this.imageTitle6?.bind(),t.blitOpaque(-128,-186),this.imageTitle7?.bind(),t.blitOpaque(-128,-186),this.imageTitle8?.bind(),t.blitOpaque(-574,-186),t.flipHorizontally(),this.imageTitle0?.bind(),t.blitOpaque(394,0),this.imageTitle1?.bind(),t.blitOpaque(-267,0),this.imageTitle2?.bind(),t.blitOpaque(266,0),this.imageTitle3?.bind(),t.blitOpaque(180,-386),this.imageTitle4?.bind(),t.blitOpaque(180,-186),this.imageTitle5?.bind(),t.blitOpaque(394,-265),this.imageTitle6?.bind(),t.blitOpaque(-180,-265),this.imageTitle7?.bind(),t.blitOpaque(212,-186),this.imageTitle8?.bind(),t.blitOpaque(-180,-186);const e=v.fromArchive(this.titleArchive,"logo");this.imageTitle2?.bind(),e.draw(this.width/2-e.width/2-128,18)};updateFlameBuffer=t=>{if(this.flameBuffer0&&this.flameBuffer1){for(let t=0;t<this.flameBuffer0.length;t++)this.flameBuffer0[t]=0;for(let t=0;t<5e3;t++){const t=Math.trunc(128*Math.random()*256);this.flameBuffer0[t]=256*Math.random()}for(let t=0;t<20;t++){for(let t=1;t<255;t++)for(let e=1;e<127;e++){const i=e+(t<<7);this.flameBuffer1[i]=Math.trunc((this.flameBuffer0[i-1]+this.flameBuffer0[i+1]+this.flameBuffer0[i-128]+this.flameBuffer0[i+128])/4)}const t=this.flameBuffer0;this.flameBuffer0=this.flameBuffer1,this.flameBuffer1=t}if(t){let e=0;for(let i=0;i<t.height;i++)for(let s=0;s<t.width;s++)if(0!==t.pixels[e++]){const e=s+t.cropX+16+(i+t.cropY+16<<7);this.flameBuffer0[e]=0}}}};loadTitleImages=()=>{if(this.titleArchive){this.imageTitlebox=x.fromArchive(this.titleArchive,"titlebox"),this.imageTitlebutton=x.fromArchive(this.titleArchive,"titlebutton");for(let t=0;t<12;t++)this.imageRunes[t]=x.fromArchive(this.titleArchive,"runes",t);this.imageFlamesLeft=new v(128,265),this.imageFlamesRight=new v(128,265),this.imageTitle0&&a(this.imageTitle0.pixels,0,this.imageFlamesLeft.pixels,0,33920),this.imageTitle1&&a(this.imageTitle1.pixels,0,this.imageFlamesRight.pixels,0,33920),this.flameGradient0=new Int32Array(256);for(let t=0;t<64;t++)this.flameGradient0[t]=262144*t;for(let t=0;t<64;t++)this.flameGradient0[t+64]=1024*t+16711680;for(let t=0;t<64;t++)this.flameGradient0[t+128]=4*t+16776960;for(let t=0;t<64;t++)this.flameGradient0[t+192]=16777215;this.flameGradient1=new Int32Array(256);for(let t=0;t<64;t++)this.flameGradient1[t]=1024*t;for(let t=0;t<64;t++)this.flameGradient1[t+64]=4*t+65280;for(let t=0;t<64;t++)this.flameGradient1[t+128]=262144*t+65535;for(let t=0;t<64;t++)this.flameGradient1[t+192]=16777215;this.flameGradient2=new Int32Array(256);for(let t=0;t<64;t++)this.flameGradient2[t]=4*t;for(let t=0;t<64;t++)this.flameGradient2[t+64]=262144*t+255;for(let t=0;t<64;t++)this.flameGradient2[t+128]=1024*t+16711935;for(let t=0;t<64;t++)this.flameGradient2[t+192]=16777215;this.flameGradient=new Int32Array(256),this.flameBuffer0=new Int32Array(32768),this.flameBuffer1=new Int32Array(32768),this.updateFlameBuffer(null),this.flameBuffer3=new Int32Array(32768),this.flameBuffer2=new Int32Array(32768),this.showProgress(10,"Connecting to fileserver").then((()=>{this.flameActive||(this.flameActive=!0,this.flamesInterval=setInterval(this.runFlames,35))}))}};updateTitleScreen=async()=>{if(0===this.titleScreenState){let t=this.width/2-80,e=this.height/2+20;e+=20,1===this.mouseClickButton&&this.mouseClickX>=t-75&&this.mouseClickX<=t+75&&this.mouseClickY>=e-20&&this.mouseClickY<=e+20&&(this.titleScreenState=3,this.titleLoginField=0),t=this.width/2+80,1===this.mouseClickButton&&this.mouseClickX>=t-75&&this.mouseClickX<=t+75&&this.mouseClickY>=e-20&&this.mouseClickY<=e+20&&(this.loginMessage0="",this.loginMessage1="Enter your username & password.",this.titleScreenState=2,this.titleLoginField=0)}else if(2===this.titleScreenState){let t=this.height/2-40;t+=30,t+=25,1===this.mouseClickButton&&this.mouseClickY>=t-15&&this.mouseClickY<t&&(this.titleLoginField=0),t+=15,1===this.mouseClickButton&&this.mouseClickY>=t-15&&this.mouseClickY<t&&(this.titleLoginField=1);let e=this.width/2-80,i=this.height/2+50;for(i+=20,1===this.mouseClickButton&&this.mouseClickX>=e-75&&this.mouseClickX<=e+75&&this.mouseClickY>=i-20&&this.mouseClickY<=i+20&&await this.login(this.username,this.password,!1),e=this.width/2+80,1===this.mouseClickButton&&this.mouseClickX>=e-75&&this.mouseClickX<=e+75&&this.mouseClickY>=i-20&&this.mouseClickY<=i+20&&(this.titleScreenState=0,this.username="",this.password="");;){const t=this.pollKey();if(-1===t)return;let e=!1;for(let i=0;i<gt.CHARSET.length;i++)if(String.fromCharCode(t)===gt.CHARSET.charAt(i)){e=!0;break}0===this.titleLoginField?(8===t&&this.username.length>0&&(this.username=this.username.substring(0,this.username.length-1)),9!==t&&10!==t&&13!==t||(this.titleLoginField=1),e&&(this.username=this.username+String.fromCharCode(t)),this.username.length>12&&(this.username=this.username.substring(0,12))):1===this.titleLoginField&&(8===t&&this.password.length>0&&(this.password=this.password.substring(0,this.password.length-1)),9!==t&&10!==t&&13!==t||(this.titleLoginField=0),e&&(this.password=this.password+String.fromCharCode(t)),this.password.length>20&&(this.password=this.password.substring(0,20)))}}else if(3===this.titleScreenState){const t=this.width/2;let e=this.height/2+50;e+=20,1===this.mouseClickButton&&this.mouseClickX>=t-75&&this.mouseClickX<=t+75&&this.mouseClickY>=e-20&&this.mouseClickY<=e+20&&(this.titleScreenState=0)}};drawTitleScreen=async()=>{if(await this.loadTitle(),this.imageTitle4?.bind(),this.imageTitlebox?.draw(0,0),0===this.titleScreenState){let t=180,e=80;this.fontBold12?.drawStringTaggableCenter(t,e,"Welcome to RuneScape",4294967040,!0),t=100,e=120,this.imageTitlebutton?.draw(t-73,e-20),this.fontBold12?.drawStringTaggableCenter(t,e+5,"New user",4294967295,!0),t=260,this.imageTitlebutton?.draw(t-73,e-20),this.fontBold12?.drawStringTaggableCenter(t,e+5,"Existing User",4294967295,!0)}else if(2===this.titleScreenState){let t=100,e=60;this.loginMessage0.length>0?(this.fontBold12?.drawStringTaggableCenter(180,e-15,this.loginMessage0,16776960,!0),this.fontBold12?.drawStringTaggableCenter(180,e,this.loginMessage1,16776960,!0),e+=30):(this.fontBold12?.drawStringTaggableCenter(180,e-7,this.loginMessage1,16776960,!0),e+=30),this.fontBold12?.drawStringTaggable(90,e,`Username: ${this.username}${0===this.titleLoginField&&this.loopCycle%40<20?"@yel@|":""}`,16777215,!0),e+=15,this.fontBold12?.drawStringTaggable(92,e,`Password: ${B.toAsterisks(this.password)}${1===this.titleLoginField&&this.loopCycle%40<20?"@yel@|":""}`,16777215,!0),e=150,this.imageTitlebutton?.draw(t-73,e-20),this.fontBold12?.drawStringTaggableCenter(t,e+5,"Login",16777215,!0),t=260,this.imageTitlebutton?.draw(t-73,e-20),this.fontBold12?.drawStringTaggableCenter(t,e+5,"Cancel",16777215,!0)}else if(3===this.titleScreenState){this.fontBold12?.drawStringTaggableCenter(180,16776960,"Create a free account",40,!0);const t=180;let e=65;this.fontBold12?.drawStringTaggableCenter(180,e,"To create a new account you need to",16777215,!0),e+=15,this.fontBold12?.drawStringTaggableCenter(180,e,"go back to the main RuneScape webpage",16777215,!0),e+=15,this.fontBold12?.drawStringTaggableCenter(180,e,"and choose the red 'create account'",16777215,!0),e+=15,this.fontBold12?.drawStringTaggableCenter(180,e,"button at the top right of that page.",16777215,!0),e=150,this.imageTitlebutton?.draw(t-73,e-20),this.fontBold12?.drawStringTaggableCenter(t,e+5,"Cancel",16777215,!0)}this.imageTitle4?.draw(214,186),this.redrawTitleBackground&&(this.redrawTitleBackground=!1,this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(214,386),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(574,265),this.imageTitle7?.draw(128,186),this.imageTitle8?.draw(574,186))};login=async(t,i,s)=>{try{s||(this.loginMessage0="",this.loginMessage1="Connecting to server...",await this.drawTitleScreen()),this.stream=new Q(await Q.openSocket({host:gt.HOST,port:gt.PORT})),await(this.stream?.readBytes(this.in.data,0,8)),this.in.pos=0,this.serverSeed=this.in.g8;const a=new Int32Array([Math.floor(99999999*Math.random()),Math.floor(99999999*Math.random()),Number(this.serverSeed>>BigInt(32)),Number(this.serverSeed&BigInt(4294967295))]);this.out.pos=0,this.out.p1(10),this.out.p4(a[0]),this.out.p4(a[1]),this.out.p4(a[2]),this.out.p4(a[3]),this.out.p4(0),this.out.pjstr(t),this.out.pjstr(i),this.out.rsaenc(gt.MODULUS,gt.EXPONENT),this.loginout.pos=0,s?this.loginout.p1(18):this.loginout.p1(16),this.loginout.p1(this.out.pos+36+1+1),this.loginout.p1(225),this.loginout.p1(gt.LOW_MEMORY?1:0);for(let t=0;t<9;t++)this.loginout.p4(this.archiveChecksums[t]);this.loginout.pdata(this.out.data,this.out.pos,0),this.out.random=new et(a);for(let t=0;t<4;t++)a[t]+=50;this.randomIn=new et(a),this.stream?.write(this.loginout.data,this.loginout.pos,0);const r=await this.stream.read();if(console.log(`Login reply was: ${r}`),1===r)return await e(2e3),void await this.login(t,i,s);if(2===r||18===r){this.rights=18===r,V.setDisabled(),this.ingame=!0,this.out.pos=0,this.in.pos=0,this.packetType=-1,this.lastPacketType0=-1,this.lastPacketType1=-1,this.lastPacketType2=-1,this.packetSize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.idleTimeout=0,this.hintType=0,this.menuSize=0,this.menuVisible=!1,this.idleCycles=0;for(let t=0;t<100;t++)this.messageText[t]=null;this.objSelected=0,this.spellSelected=0,this.sceneState=0,this.waveCount=0,this.cameraAnticheatOffsetX=Math.trunc(100*Math.random())-50,this.cameraAnticheatOffsetZ=Math.trunc(110*Math.random())-55,this.cameraAnticheatAngle=Math.trunc(80*Math.random())-40,this.minimapAnticheatAngle=Math.trunc(120*Math.random())-60,this.minimapZoom=Math.trunc(30*Math.random())-20,this.orbitCameraYaw=Math.trunc(20*Math.random())-10&2047,this.minimapLevel=-1,this.flagSceneTileX=0,this.flagSceneTileZ=0,this.playerCount=0,this.npcCount=0;for(let t=0;t<this.MAX_PLAYER_COUNT;t++)this.players[t]=null,this.playerAppearanceBuffer[t]=null;for(let t=0;t<8192;t++)this.npcs[t]=null;return this.localPlayer=this.players[this.LOCAL_PLAYER_INDEX]=new ft,this.projectiles.clear(),this.spotanims.clear(),this.temporaryLocs.clear(),this.friendCount=0,this.stickyChatInterfaceId=-1,this.chatInterfaceId=-1,this.viewportInterfaceId=-1,this.sidebarInterfaceId=-1,this.pressedContinueOption=!1,this.selectedTab=3,this.chatbackInputOpen=!1,this.menuVisible=!1,this.showSocialInput=!1,this.modalMessage=null,this.inMultizone=0,this.flashingTab=-1,gt.opLoc4Counter=0,gt.opNpc3Counter=0,gt.opHeld4Counter=0,gt.opNpc5Counter=0,gt.opHeld1Counter=0,gt.opLoc5Counter=0,gt.ifButton5Counter=0,gt.opPlayer2Counter=0,gt.opHeld9Counter=0,void this.prepareGameScreen()}if(3===r)return this.loginMessage0="",void(this.loginMessage1="Invalid username or password.");if(4===r)return this.loginMessage0="Your account has been disabled.",void(this.loginMessage1="Please check your message-centre for details.");if(5===r)return this.loginMessage0="Your account is already logged in.",void(this.loginMessage1="Try again in 60 secs...");if(6===r)return this.loginMessage0="RuneScape has been updated!",void(this.loginMessage1="Please reload this page.");if(7===r)return this.loginMessage0="This world is full.",void(this.loginMessage1="Please use a different world.");if(8===r)return this.loginMessage0="Unable to connect.",void(this.loginMessage1="Login server offline.");if(9===r)return this.loginMessage0="Login limit exceeded.",void(this.loginMessage1="Too many connections from your address.");if(10===r)return this.loginMessage0="Unable to connect.",void(this.loginMessage1="Bad session id.");if(11===r)return this.loginMessage1="Login server rejected session.",void(this.loginMessage1="Please try again.");if(12===r)return this.loginMessage0="You need a members account to login to this world.",void(this.loginMessage1="Please subscribe, or use a different world.");if(13===r)return this.loginMessage0="Could not complete login.",void(this.loginMessage1="Please try using a different world.");if(14===r)return this.loginMessage0="The server is being updated.",void(this.loginMessage1="Please wait 1 minute and try again.");if(15===r)return this.ingame=!0,this.out.pos=0,this.in.pos=0,this.packetType=-1,this.lastPacketType0=-1,this.lastPacketType1=-1,this.lastPacketType2=-1,this.packetSize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.menuSize=0,void(this.menuVisible=!1);if(16===r)return this.loginMessage0="Login attempts exceeded.",void(this.loginMessage1="Please wait 1 minute and try again.");17===r&&(this.loginMessage0="You are standing in a members-only area.",this.loginMessage1="To play on this world move to a free area first")}catch(t){console.log(t),this.loginMessage0="",this.loginMessage1="Error connecting to server."}};updateGame=async()=>{this.systemUpdateTimer>1&&this.systemUpdateTimer--,this.idleTimeout>0&&this.idleTimeout--;for(let t=0;t<5&&await this.read();t++);if(this.ingame){const t=V.flush();if(t&&(this.out.p1isaac(81),this.out.p2(t.pos),this.out.pdata(t.data,t.pos,0),t.release()),this.idleNetCycles++,this.idleNetCycles>750&&await this.tryReconnect(),(1===this.actionKey[1]||1===this.actionKey[2]||1===this.actionKey[3]||1===this.actionKey[4])&&this.cameraMovedWrite++>5&&(this.cameraMovedWrite=0,this.out.p1isaac(189),this.out.p2(this.orbitCameraPitch),this.out.p2(this.orbitCameraYaw),this.out.p1(this.minimapAnticheatAngle),this.out.p1(this.minimapZoom)),this.sceneDelta++,0!==this.crossMode&&(this.crossCycle+=20,this.crossCycle>=400&&(this.crossMode=0)),0!==this.selectedArea&&(this.selectedCycle++,this.selectedCycle>=15&&(2===this.selectedArea&&(this.redrawSidebar=!0),3===this.selectedArea&&(this.redrawChatback=!0),this.selectedArea=0)),0!==this.objDragArea&&(this.objDragCycles++,(this.mouseX>this.objGrabX+5||this.mouseX<this.objGrabX-5||this.mouseY>this.objGrabY+5||this.mouseY<this.objGrabY-5)&&(this.objGrabThreshold=!0),0===this.mouseButton)){if(2===this.objDragArea&&(this.redrawSidebar=!0),3===this.objDragArea&&(this.redrawChatback=!0),this.objDragArea=0,this.objGrabThreshold&&this.objDragCycles>=5){if(this.hoveredSlotParentId=-1,this.handleInput(),this.hoveredSlotParentId===this.objDragInterfaceId&&this.hoveredSlot!==this.objDragSlot){const t=P.instances[this.objDragInterfaceId];if(t.invSlotObjId){const e=t.invSlotObjId[this.hoveredSlot];t.invSlotObjId[this.hoveredSlot]=t.invSlotObjId[this.objDragSlot],t.invSlotObjId[this.objDragSlot]=e}if(t.invSlotObjCount){const e=t.invSlotObjCount[this.hoveredSlot];t.invSlotObjCount[this.hoveredSlot]=t.invSlotObjCount[this.objDragSlot],t.invSlotObjCount[this.objDragSlot]=e}this.out.p1isaac(159),this.out.p2(this.objDragInterfaceId),this.out.p2(this.objDragSlot),this.out.p2(this.hoveredSlot)}}else(1===this.mouseButtonsOption||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2?this.showContextMenu():this.menuSize>0&&this.useMenuOption(this.menuSize-1);this.selectedCycle=10,this.mouseClickButton=0}gt.updateCounter++,gt.updateCounter>127&&(gt.updateCounter=0,this.out.p1isaac(215),this.out.p3(4991788)),1===this.mouseClickButton&&this.modalMessage&&(this.modalMessage=null,this.redrawChatback=!0,this.mouseClickButton=0),this.handleMouseInput(),this.handleTabInput(),this.handleChatSettingsInput(),1!==this.mouseButton&&1!==this.mouseClickButton||this.dragCycles++,this.sceneState,2===this.sceneState&&this.cutscene;for(let t=0;t<5;t++)this.cameraModifierCycle[t]++;if(this.handleInputKey(),this.idleCycles++,this.idleCycles>4500&&(this.idleTimeout=250,this.idleCycles-=500,this.out.p1isaac(70)),this.cameraOffsetCycle++,this.cameraOffsetCycle>500){this.cameraOffsetCycle=0;const t=Math.trunc(8*Math.random());1==(1&t)&&(this.cameraAnticheatOffsetX+=this.cameraOffsetXModifier),2==(2&t)&&(this.cameraAnticheatOffsetZ+=this.cameraOffsetZModifier),4==(4&t)&&(this.cameraAnticheatAngle+=this.cameraOffsetYawModifier)}if(this.cameraAnticheatOffsetX<-50&&(this.cameraOffsetXModifier=2),this.cameraAnticheatOffsetX>50&&(this.cameraOffsetXModifier=-2),this.cameraAnticheatOffsetZ<-55&&(this.cameraOffsetZModifier=2),this.cameraAnticheatOffsetZ>55&&(this.cameraOffsetZModifier=-2),this.cameraAnticheatAngle<-40&&(this.cameraOffsetYawModifier=1),this.cameraAnticheatAngle>40&&(this.cameraOffsetYawModifier=-1),this.minimapOffsetCycle++,this.minimapOffsetCycle>500){this.minimapOffsetCycle=0;const t=Math.trunc(8*Math.random());1==(1&t)&&(this.minimapAnticheatAngle+=this.minimapAngleModifier),2==(2&t)&&(this.minimapZoom+=this.minimapZoomModifier)}this.minimapAnticheatAngle<-60&&(this.minimapAngleModifier=2),this.minimapAnticheatAngle>60&&(this.minimapAngleModifier=-2),this.minimapZoom<-20&&(this.minimapZoomModifier=1),this.minimapZoom>10&&(this.minimapZoomModifier=-1),gt.update2Counter++,gt.update2Counter>110&&(gt.update2Counter=0,this.out.p1isaac(236),this.out.p4(0)),this.heartbeatTimer++,this.heartbeatTimer>50&&this.out.p1isaac(108);try{this.stream&&this.out.pos>0&&(this.stream.write(this.out.data,this.out.pos,0),this.out.pos=0,this.heartbeatTimer=0)}catch(t){console.log(t),await this.tryReconnect()}}};drawGame=()=>{this.redrawTitleBackground&&(this.redrawTitleBackground=!1,this.areaBackleft1?.draw(0,11),this.areaBackleft2?.draw(0,375),this.areaBackright1?.draw(729,5),this.areaBackright2?.draw(752,231),this.areaBacktop1?.draw(0,0),this.areaBacktop2?.draw(561,0),this.areaBackvmid1?.draw(520,11),this.areaBackvmid2?.draw(520,231),this.areaBackvmid3?.draw(501,375),this.areaBackhmid2?.draw(0,345),this.redrawSidebar=!0,this.redrawChatback=!0,this.redrawSideicons=!0,this.redrawPrivacySettings=!0,2!==this.sceneState&&(this.areaViewport?.draw(8,11),this.areaMapback?.draw(561,5))),2===this.sceneState&&this.drawScene(),this.menuVisible&&1===this.menuArea&&(this.redrawSidebar=!0);let t=!1;if(-1!==this.sidebarInterfaceId&&(t=this.updateInterfaceAnimation(this.sidebarInterfaceId,this.sceneDelta),t&&(this.redrawSidebar=!0)),2===this.selectedArea&&(this.redrawSidebar=!0),2===this.objDragArea&&(this.redrawSidebar=!0),this.redrawSidebar&&(this.drawSidebar(),this.redrawSidebar=!1),-1===this.chatInterfaceId){this.chatInterface.scrollPosition=this.chatScrollHeight-this.chatScrollOffset-77,this.mouseX>453&&this.mouseX<565&&this.mouseY>350&&this.handleScrollInput(this.mouseX-22,this.mouseY-375,this.chatScrollHeight,77,!1,463,0,this.chatInterface);let t=this.chatScrollHeight-this.chatInterface.scrollPosition-77;t<0&&(t=0),t>this.chatScrollHeight-77&&(t=this.chatScrollHeight-77),this.chatScrollOffset!==t&&(this.chatScrollOffset=t,this.redrawChatback=!0)}-1!==this.chatInterfaceId&&(t=this.updateInterfaceAnimation(this.chatInterfaceId,this.sceneDelta),t&&(this.redrawChatback=!0)),3===this.selectedArea&&(this.redrawChatback=!0),3===this.objDragArea&&(this.redrawChatback=!0),this.modalMessage&&(this.redrawChatback=!0),this.menuVisible&&2===this.menuArea&&(this.redrawChatback=!0),this.redrawChatback&&(this.drawChatback(),this.redrawChatback=!1),2===this.sceneState&&(this.drawMinimap(),this.areaMapback?.draw(561,5)),-1!==this.flashingTab&&(this.redrawSideicons=!0),this.redrawSideicons&&(-1!==this.flashingTab&&this.flashingTab===this.selectedTab&&(this.flashingTab=-1,this.out.p1isaac(175),this.out.p1(this.selectedTab)),this.redrawSideicons=!1,this.areaBackhmid1?.bind(),this.imageBackhmid1?.draw(0,0),-1===this.sidebarInterfaceId&&(-1!==this.tabInterfaceId[this.selectedTab]&&(0===this.selectedTab?this.imageRedstone1?.draw(29,30):1===this.selectedTab?this.imageRedstone2?.draw(59,29):2===this.selectedTab?this.imageRedstone2?.draw(87,29):3===this.selectedTab?this.imageRedstone3?.draw(115,29):4===this.selectedTab?this.imageRedstone2h?.draw(156,29):5===this.selectedTab?this.imageRedstone2h?.draw(184,29):6===this.selectedTab&&this.imageRedstone1h?.draw(212,30)),-1!==this.tabInterfaceId[0]&&(0!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[0].draw(35,34),-1!==this.tabInterfaceId[1]&&(1!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[1].draw(59,32),-1!==this.tabInterfaceId[2]&&(2!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[2].draw(86,32),-1!==this.tabInterfaceId[3]&&(3!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[3].draw(121,33),-1!==this.tabInterfaceId[4]&&(4!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[4].draw(157,34),-1!==this.tabInterfaceId[5]&&(5!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[5].draw(185,32),-1!==this.tabInterfaceId[6]&&(6!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[6].draw(212,34)),this.areaBackhmid1?.draw(520,165),this.areaBackbase2?.bind(),this.imageBackbase2?.draw(0,0),-1===this.sidebarInterfaceId&&(-1!==this.tabInterfaceId[this.selectedTab]&&(7===this.selectedTab?this.imageRedstone1v?.draw(49,0):8===this.selectedTab?this.imageRedstone2v?.draw(81,0):9===this.selectedTab?this.imageRedstone2v?.draw(108,0):10===this.selectedTab?this.imageRedstone3v?.draw(136,1):11===this.selectedTab?this.imageRedstone2hv?.draw(178,0):12===this.selectedTab?this.imageRedstone2hv?.draw(205,0):13===this.selectedTab&&this.imageRedstone1hv?.draw(233,0)),-1!==this.tabInterfaceId[8]&&(8!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[7].draw(80,2),-1!==this.tabInterfaceId[9]&&(9!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[8].draw(107,3),-1!==this.tabInterfaceId[10]&&(10!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[9].draw(142,4),-1!==this.tabInterfaceId[11]&&(11!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[10].draw(179,2),-1!==this.tabInterfaceId[12]&&(12!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[11].draw(206,2),-1!==this.tabInterfaceId[13]&&(13!==this.flashingTab||this.loopCycle%20<10)&&this.imageSideicons[12].draw(230,2)),this.areaBackbase2?.draw(501,492),this.areaViewport?.bind()),this.redrawPrivacySettings&&(this.redrawPrivacySettings=!1,this.areaBackbase1?.bind(),this.imageBackbase1?.draw(0,0),this.fontPlain12?.drawStringTaggableCenter(57,33,"Public chat",16777215,!0),0===this.publicChatSetting&&this.fontPlain12?.drawStringTaggableCenter(57,46,"On",65280,!0),1===this.publicChatSetting&&this.fontPlain12?.drawStringTaggableCenter(57,46,"Friends",16776960,!0),2===this.publicChatSetting&&this.fontPlain12?.drawStringTaggableCenter(57,46,"Off",16711680,!0),3===this.publicChatSetting&&this.fontPlain12?.drawStringTaggableCenter(57,46,"Hide",65535,!0),this.fontPlain12?.drawStringTaggableCenter(186,33,"Private chat",16777215,!0),0===this.privateChatSetting&&this.fontPlain12?.drawStringTaggableCenter(186,46,"On",65280,!0),1===this.privateChatSetting&&this.fontPlain12?.drawStringTaggableCenter(186,46,"Friends",16776960,!0),2===this.privateChatSetting&&this.fontPlain12?.drawStringTaggableCenter(186,46,"Off",16711680,!0),this.fontPlain12?.drawStringTaggableCenter(326,33,"Trade/duel",16777215,!0),0===this.tradeChatSetting&&this.fontPlain12?.drawStringTaggableCenter(326,46,"On",65280,!0),1===this.tradeChatSetting&&this.fontPlain12?.drawStringTaggableCenter(326,46,"Friends",16776960,!0),2===this.tradeChatSetting&&this.fontPlain12?.drawStringTaggableCenter(326,46,"Off",16711680,!0),this.fontPlain12?.drawStringTaggableCenter(462,38,"Report abuse",16777215,!0),this.areaBackbase1?.draw(0,471),this.areaViewport?.bind()),this.sceneDelta=0};drawScene=()=>{if(this.sceneCycle++,!this.cutscene){let t=this.orbitCameraPitch;if(this.cameraPitchClamp/256>t&&(t=Math.trunc(this.cameraPitchClamp/256)),this.cameraModifierEnabled[4]&&this.cameraModifierWobbleScale[4]+128>t&&(t=this.cameraModifierWobbleScale[4]+128),this.orbitCameraYaw,this.cameraAnticheatAngle,gt.drawCounter++,gt.drawCounter>1802){gt.drawCounter=0,this.out.p1isaac(146),this.out.p1(0);const t=this.out.pos;this.out.p2(29711),this.out.p1(70),this.out.p1(Math.trunc(256*Math.random())),this.out.p1(242),this.out.p1(186),this.out.p1(39),this.out.p1(61),0===Math.trunc(2*Math.random())&&this.out.p1(13),0===Math.trunc(2*Math.random())&&this.out.p2(57856),this.out.p2(Math.trunc(65536*Math.random())),this.out.psize1(this.out.pos-t)}}const t=this.cameraX,e=this.cameraY,i=this.cameraZ,s=this.cameraPitch,a=this.cameraYaw;let r;for(let t=0;t<5;t++)this.cameraModifierEnabled[t]&&(r=Math.trunc(Math.random()*(2*this.cameraModifierJitter[t]+1)-this.cameraModifierJitter[t]+Math.sin(this.cameraModifierCycle[t]*(this.cameraModifierWobbleSpeed[t]/100))*this.cameraModifierWobbleScale[t]),0==t&&(this.cameraX+=r),1==t&&(this.cameraY+=r),2==t&&(this.cameraZ+=r),3==t&&(this.cameraYaw=this.cameraYaw+r&2047),4==t&&(this.cameraPitch+=r,this.cameraPitch<128&&(this.cameraPitch=128),this.cameraPitch>383&&(this.cameraPitch=383)));r=A.cycle,_.checkHover=!0,_.pickedCount=0,_.mouseX=this.mouseX-8,_.mouseZ=this.mouseY-11,w.clear(),this.drawDebug(),this.updateTextures(r),this.draw3DEntityElements(),this.areaViewport?.draw(8,11),this.cameraX=t,this.cameraY=e,this.cameraZ=i,this.cameraPitch=s,this.cameraYaw=a};drawDebug=()=>{let t=20;this.fontPlain11?.drawRight(507,t,`FPS: ${this.fps}`,16776960,!0),t+=13,this.fontPlain11?.drawRight(507,t,`Speed: ${this.ms.toFixed(4)} ms`,16776960,!0),t+=13,this.fontPlain11?.drawRight(507,t,`Rate: ${this.deltime} ms`,16776960,!0)};clearCaches=()=>{m.modelCacheStatic?.clear(),m.modelCacheDynamic?.clear(),L.modelCache?.clear(),k.modelCache?.clear(),k.iconCache?.clear(),ft.modelCache?.clear(),E.modelCache?.clear()};draw3DEntityElements=()=>{if(1===this.crossMode&&this.imageCrosses[Math.trunc(this.crossCycle/100)].draw(this.crossX-8-8,this.crossY-8-11),2===this.crossMode&&this.imageCrosses[Math.trunc(this.crossCycle/100)+4].draw(this.crossX-8-8,this.crossY-8-11),-1!==this.viewportInterfaceId&&(this.updateInterfaceAnimation(this.viewportInterfaceId,this.sceneDelta),this.drawInterface(P.instances[this.viewportInterfaceId],0,0,0)),this.menuVisible?0===this.menuArea&&this.drawMenu():(this.handleInput(),this.drawTooltip()),1===this.inMultizone&&(this.wildernessLevel>0||1===this.worldLocationState?this.imageHeadicons[1].draw(472,258):this.imageHeadicons[1].draw(472,296)),this.wildernessLevel>0&&(this.imageHeadicons[0].draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Level: "+this.wildernessLevel,16776960)),1===this.worldLocationState&&(this.imageHeadicons[6].draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Arena",16776960)),0!==this.systemUpdateTimer){let t=Math.trunc(this.systemUpdateTimer/50);const e=Math.trunc(t/60);t%=60,t<10?this.fontPlain12?.drawString(4,329,"System update in: "+e+":0"+t,16776960):this.fontPlain12?.drawString(4,329,"System update in: "+e+":"+t,16776960)}};drawSidebar=()=>{this.areaSidebar?.bind(),this.areaSidebarOffsets&&(A.lineOffset=this.areaSidebarOffsets),this.imageInvback?.draw(0,0),-1!==this.sidebarInterfaceId?this.drawInterface(P.instances[this.sidebarInterfaceId],0,0,0):-1!==this.tabInterfaceId[this.selectedTab]&&this.drawInterface(P.instances[this.tabInterfaceId[this.selectedTab]],0,0,0),this.menuVisible&&1===this.menuArea&&this.drawMenu(),this.areaSidebar?.draw(562,231),this.areaViewport?.bind(),this.areaViewportOffsets&&(A.lineOffset=this.areaViewportOffsets)};drawChatback=()=>{if(this.areaChatback?.bind(),this.areaChatbackOffsets&&(A.lineOffset=this.areaChatbackOffsets),this.imageChatback?.draw(0,0),this.showSocialInput)this.fontBold12?.drawStringCenter(239,40,this.socialMessage,0),this.fontBold12?.drawStringCenter(239,60,this.socialInput+"*",128);else if(this.chatbackInputOpen)this.fontBold12?.drawStringCenter(239,40,"Enter amount:",0),this.fontBold12?.drawStringCenter(239,60,this.chatbackInput+"*",128);else if(this.modalMessage)this.fontBold12?.drawStringCenter(239,40,this.modalMessage,0),this.fontBold12?.drawStringCenter(239,60,"Click to continue",128);else if(-1!==this.chatInterfaceId)this.drawInterface(P.instances[this.chatInterfaceId],0,0,0);else if(-1===this.stickyChatInterfaceId){const t=this.fontPlain12;let e=0;w.setBounds(0,0,463,77);for(let i=0;i<100;i++){const s=this.messageSender[i],a=this.messageText[i];if(!a||null===s)continue;const r=this.messageType[i],n=this.chatScrollOffset+70-14*e;0===r&&(n>0&&n<110&&t?.drawString(4,n,a,0),e++),1===r&&(n>0&&n<110&&(t?.drawString(4,n,this.messageSender[i]+":",16777215),t?.drawString(t.stringWidth(s)+12,n,a,255)),e++),2===r&&(0===this.publicChatSetting||1===this.publicChatSetting&&this.isFriend(s))&&(n>0&&n<110&&(t?.drawString(4,n,this.messageSender[i]+":",0),t?.drawString(t.stringWidth(s)+12,n,a,255)),e++),3!==r&&7!==r||0!==this.splitPrivateChat||!(7===r||0===this.privateChatSetting||1===this.privateChatSetting&&this.isFriend(s))||(n>0&&n<110&&(t?.drawString(4,n,"From "+this.messageSender[i]+":",0),t?.drawString(t.stringWidth("From "+this.messageSender[i])+12,n,a,8388608)),e++),4===r&&(0===this.tradeChatSetting||1===this.tradeChatSetting&&this.isFriend(s))&&(n>0&&n<110&&t?.drawString(4,n,this.messageSender[i]+" "+this.messageText[i],8388736),e++),5===r&&0===this.splitPrivateChat&&this.privateChatSetting<2&&(n>0&&n<110&&t?.drawString(4,n,a,8388608),e++),6===r&&0===this.splitPrivateChat&&this.privateChatSetting<2&&(n>0&&n<110&&(t?.drawString(4,n,"To "+this.messageSender[i]+":",0),t?.drawString(t.stringWidth("To "+this.messageSender[i])+12,n,a,8388608)),e++),8===r&&(0===this.tradeChatSetting||1===this.tradeChatSetting&&this.isFriend(s))&&(n>0&&n<110&&t?.drawString(4,n,this.messageSender[i]+" "+this.messageText[i],13350793),e++)}w.resetBounds(),this.chatScrollHeight=14*e+7,this.chatScrollHeight<78&&(this.chatScrollHeight=78),this.drawScrollbar(463,0,this.chatScrollHeight-this.chatScrollOffset-77,this.chatScrollHeight,77),t?.drawString(4,90,B.formatName(this.username)+":",0),t?.drawString(t.stringWidth(this.username+": ")+6,90,this.chatTyped+"*",255),w.drawHorizontalLine(0,77,0,479)}else this.drawInterface(P.instances[this.stickyChatInterfaceId],0,0,0);this.menuVisible&&2===this.menuArea&&this.drawMenu(),this.areaChatback?.draw(22,375),this.areaViewport?.bind(),this.areaViewportOffsets&&(A.lineOffset=this.areaViewportOffsets)};drawScrollbar=(t,e,i,s,a)=>{this.imageScrollbar0?.draw(t,e),this.imageScrollbar1?.draw(t,e+a-16),w.fillRect(t,e+16,16,a-32,this.SCROLLBAR_TRACK);let r=Math.trunc((a-32)*a/s);r<8&&(r=8);const n=Math.trunc((a-r-32)*i/(s-a));w.fillRect(t,e+n+16,16,r,this.SCROLLBAR_GRIP_FOREGROUND),w.drawVerticalLine(t,e+n+16,this.SCROLLBAR_GRIP_HIGHLIGHT,r),w.drawVerticalLine(t+1,e+n+16,this.SCROLLBAR_GRIP_HIGHLIGHT,r),w.drawHorizontalLine(t,e+n+16,this.SCROLLBAR_GRIP_HIGHLIGHT,16),w.drawHorizontalLine(t,e+n+17,this.SCROLLBAR_GRIP_HIGHLIGHT,16),w.drawVerticalLine(t+15,e+n+16,this.SCROLLBAR_GRIP_LOWLIGHT,r),w.drawVerticalLine(t+14,e+n+17,this.SCROLLBAR_GRIP_LOWLIGHT,r-1),w.drawHorizontalLine(t,e+n+r+15,this.SCROLLBAR_GRIP_LOWLIGHT,16),w.drawHorizontalLine(t+1,e+n+r+14,this.SCROLLBAR_GRIP_LOWLIGHT,15)};drawInterface=(t,e,i,s)=>{if(0!==t.type||!t.childId||t.hide&&this.viewportHoveredInterfaceIndex!==t.id&&this.sidebarHoveredInterfaceIndex!==t.id&&this.chatHoveredInterfaceIndex!==t.id)return;const a=w.left,r=w.top,n=w.right,h=w.bottom;w.setBounds(e,i,e+t.width,i+t.height);const o=t.childId.length;for(let a=0;a<o;a++){if(!t.childX||!t.childY)continue;let r=t.childX[a]+e,n=t.childY[a]+i-s;const h=P.instances[t.childId[a]];if(r+=h.x,n+=h.y,h.clientCode>0&&this.updateInterfaceContent(h),0===h.type)h.scrollPosition>h.scroll-h.height&&(h.scrollPosition=h.scroll-h.height),h.scrollPosition<0&&(h.scrollPosition=0),this.drawInterface(h,r,n,h.scrollPosition),h.scroll>h.height&&this.drawScrollbar(r+h.width,n,h.scrollPosition,h.scroll,h.height);else if(2===h.type){let t=0;for(let e=0;e<h.height;e++)for(let i=0;i<h.width;i++){if(!(h.invSlotOffsetX&&h.invSlotOffsetY&&h.invSlotObjId&&h.invSlotObjCount))continue;let s=r+i*(h.marginX+32),a=n+e*(h.marginY+32);if(t<20&&(s+=h.invSlotOffsetX[t],a+=h.invSlotOffsetY[t]),h.invSlotObjId[t]>0){let e=0,i=0;const r=h.invSlotObjId[t]-1;if(s>=-32&&s<=512&&a>=-32&&a<=334||0!==this.objDragArea&&this.objDragSlot===t){const n=k.getIcon(r,h.invSlotObjCount[t]);if(0!==this.objDragArea&&this.objDragSlot===t&&this.objDragInterfaceId===h.id?(e=this.mouseX-this.objGrabX,i=this.mouseY-this.objGrabY,e<5&&e>-5&&(e=0),i<5&&i>-5&&(i=0),this.objDragCycles<5&&(e=0,i=0),n.drawAlpha(128,s+e,a+i)):0!==this.selectedArea&&this.selectedItem===t&&this.selectedInterface===h.id?n.drawAlpha(128,s,a):n.draw(s,a),33===n.cropW||1!==h.invSlotObjCount[t]){const r=h.invSlotObjCount[t];this.fontPlain11?.drawString(s+e+1,a+10+i,this.formatObjCount(r),0),this.fontPlain11?.drawString(s+e,a+9+i,this.formatObjCount(r),16776960)}}}else if(h.invSlotSprite&&t<20){const e=h.invSlotSprite[t];e?.draw(s,a)}t++}}else if(3===h.type)h.fill?w.fillRect(r,n,h.width,h.height,h.colour):w.drawRect(r,n,h.width,h.height,h.colour);else if(4===h.type){const t=h.font;let e=h.colour,i=h.text;if(this.chatHoveredInterfaceIndex!==h.id&&this.sidebarHoveredInterfaceIndex!==h.id&&this.viewportHoveredInterfaceIndex!==h.id||0===h.overColour||(e=h.overColour),this.executeInterfaceScript(h)&&(e=h.activeColour,h.activeText&&h.activeText.length>0&&(i=h.activeText)),h.buttonType===P.BUTTON_CONTINUE&&this.pressedContinueOption&&(i="Please wait...",e=h.colour),!t||!i)continue;for(let s=n+t.fontHeight;i.length>0;s+=t.fontHeight){if(-1!==i.indexOf("%")){for(;;){const t=i.indexOf("%1");if(-1===t)break;i=i.substring(0,t)+this.getIntString(this.executeClientscript1(h,0))+i.substring(t+2)}for(;;){const t=i.indexOf("%2");if(-1===t)break;i=i.substring(0,t)+this.getIntString(this.executeClientscript1(h,1))+i.substring(t+2)}for(;;){const t=i.indexOf("%3");if(-1===t)break;i=i.substring(0,t)+this.getIntString(this.executeClientscript1(h,2))+i.substring(t+2)}for(;;){const t=i.indexOf("%4");if(-1===t)break;i=i.substring(0,t)+this.getIntString(this.executeClientscript1(h,3))+i.substring(t+2)}for(;;){const t=i.indexOf("%5");if(-1===t)break;i=i.substring(0,t)+this.getIntString(this.executeClientscript1(h,4))+i.substring(t+2)}}const a=i.indexOf("\\n");let n;-1!==a?(n=i.substring(0,a),i=i.substring(a+2)):(n=i,i=""),h.center?t.drawStringTaggableCenter(r+Math.trunc(h.width/2),s,n,e,h.shadowed):t.drawStringTaggable(r,s,n,e,h.shadowed)}}else if(5===h.type){let t;t=this.executeInterfaceScript(h)?h.activeGraphic:h.graphic,t?.draw(r,n)}else if(6===h.type){const t=A.centerX,e=A.centerY;A.centerX=r+Math.trunc(h.width/2),A.centerY=n+Math.trunc(h.height/2);const i=A.sin[h.xan]*h.zoom>>16,s=A.cos[h.xan]*h.zoom>>16,a=this.executeInterfaceScript(h);let o;o=a?h.activeAnim:h.anim;let l=null;if(-1===o)l=h.getModel(-1,-1,a);else{const t=d.instances[o];t.frames&&t.iframes&&(l=h.getModel(t.frames[h.seqFrame],t.iframes[h.seqFrame],a))}l&&l.drawSimple(0,h.yan,0,h.xan,0,i,s),A.centerX=t,A.centerY=e}else if(7===h.type){const t=h.font;if(!t||!h.invSlotObjId||!h.invSlotObjCount)continue;let e=0;for(let i=0;i<h.height;i++)for(let s=0;s<h.width;s++){if(h.invSlotObjId[e]>0){const a=k.get(h.invSlotObjId[e]-1);let o=a.name;if((a.stackable||1!==h.invSlotObjCount[e])&&(o=o+" x"+this.formatObjCountTagged(h.invSlotObjCount[e])),!o)continue;const l=r+s*(h.marginX+115),c=n+i*(h.marginY+12);h.center?t.drawStringTaggableCenter(l+Math.trunc(h.width/2),c,o,h.colour,h.shadowed):t.drawStringTaggable(l,c,o,h.colour,h.shadowed)}e++}}}w.setBounds(a,r,n,h)};drawMinimap=()=>{this.areaMapback?.bind(),w.fillRect(93,82,3,3,16777215),this.areaViewport?.bind()};drawTooltip=()=>{if(this.menuSize<2&&0===this.objSelected&&0===this.spellSelected)return;let t;t=1===this.objSelected&&this.menuSize<2?"Use "+this.objSelectedName+" with...":1===this.spellSelected&&this.menuSize<2?this.spellCaption+"...":this.menuOption[this.menuSize-1],this.menuSize>2&&(t=t+"@whi@ / "+(this.menuSize-2)+" more options"),this.fontBold12?.drawStringTooltip(4,15,t,16777215,!0,Math.trunc(this.loopCycle/1e3))};drawMenu=()=>{const t=this.menuX,e=this.menuY,i=this.menuWidth,s=this.menuHeight,a=6116423;w.fillRect(t,e,i,s,a),w.fillRect(t+1,e+1,i-2,16,0),w.drawRect(t+1,e+18,i-2,s-19,0),this.fontBold12?.drawString(t+3,e+14,"Choose Option",a);let r=this.mouseX,n=this.mouseY;0===this.menuArea&&(r-=8,n-=11),1===this.menuArea&&(r-=562,n-=231),2===this.menuArea&&(r-=22,n-=375);for(let s=0;s<this.menuSize;s++){const a=e+15*(this.menuSize-1-s)+31;let h=16777215;r>t&&r<t+i&&n>a-13&&n<a+3&&(h=16776960),this.fontBold12?.drawStringTaggable(t+3,a,this.menuOption[s],h,!0)}};updateInterfaceAnimation=(t,e)=>{let i=!1;const s=P.instances[t];if(!s.childId)return!1;for(let t=0;t<s.childId.length&&-1!==s.childId[t];t++){const a=P.instances[s.childId[t]];if(1===a.type&&(i||=this.updateInterfaceAnimation(a.id,e)),6===a.type&&(-1!==a.anim||-1!==a.activeAnim)){let t;if(t=this.executeInterfaceScript(a)?a.activeAnim:a.anim,-1!==t){const s=d.instances[t];if(a.seqCycle+=e,s.delay)for(;a.seqCycle>s.delay[a.seqFrame];)a.seqCycle-=s.delay[a.seqFrame]+1,a.seqFrame++,a.seqFrame>=s.frameCount&&(a.seqFrame-=s.replayoff,(a.seqFrame<0||a.seqFrame>=s.frameCount)&&(a.seqFrame=0)),i=!0}}}return i};handleMouseInput=()=>{if(0!==this.objDragArea)return;let t=this.mouseClickButton;if(1===this.spellSelected&&this.mouseClickX>=520&&this.mouseClickY>=165&&this.mouseClickX<=788&&this.mouseClickY<=230&&(t=0),this.menuVisible){if(1!==t){let t=this.mouseX,e=this.mouseY;0===this.menuArea?(t-=8,e-=11):1===this.menuArea?(t-=562,e-=231):2===this.menuArea&&(t-=22,e-=375),(t<this.menuX-10||t>this.menuX+this.menuWidth+10||e<this.menuY-10||e>this.menuY+this.menuHeight+10)&&(this.menuVisible=!1,1===this.menuArea&&(this.redrawSidebar=!0),2===this.menuArea&&(this.redrawChatback=!0))}if(1===t){const t=this.menuX,e=this.menuY,i=this.menuWidth;let s=this.mouseClickX,a=this.mouseClickY;0===this.menuArea?(s-=8,a-=11):1===this.menuArea?(s-=562,a-=231):2===this.menuArea&&(s-=22,a-=375);let r=-1;for(let n=0;n<this.menuSize;n++){const h=e+15*(this.menuSize-1-n)+31;s>t&&s<t+i&&a>h-13&&a<h+3&&(r=n)}-1!==r&&this.useMenuOption(r),this.menuVisible=!1,1===this.menuArea?this.redrawSidebar=!0:2===this.menuArea&&(this.redrawChatback=!0)}}else{if(1===t&&this.menuSize>0){const t=this.menuAction[this.menuSize-1];if(602===t||596===t||22===t||892===t||415===t||405===t||38===t||422===t||478===t||347===t||188===t){const t=this.menuParamB[this.menuSize-1],e=this.menuParamC[this.menuSize-1];if(P.instances[e].draggable)return this.objGrabThreshold=!1,this.objDragCycles=0,this.objDragInterfaceId=e,this.objDragSlot=t,this.objDragArea=2,this.objGrabX=this.mouseClickX,this.objGrabY=this.mouseClickY,P.instances[e].layer===this.viewportInterfaceId&&(this.objDragArea=1),void(P.instances[e].layer===this.chatInterfaceId&&(this.objDragArea=3))}}if(1===t&&(1===this.mouseButtonsOption||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2&&(t=2),1===t&&this.menuSize>0&&this.useMenuOption(this.menuSize-1),2!==t||this.menuSize<=0)return;this.showContextMenu()}};isAddFriendOption=t=>{if(t<0)return!1;let e=this.menuAction[t];return e>=2e3&&(e-=2e3),406===e};useMenuOption=t=>{if(t<0)return;this.chatbackInputOpen&&(this.chatbackInputOpen=!1,this.redrawChatback=!0);let e=this.menuAction[t];const i=this.menuParamA[t],s=this.menuParamB[t],a=this.menuParamC[t];if(e>=2e3&&(e-=2e3),903===e||363===e);else if(450===e&&this.interactWithLoc(75,s,a,i))this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface);else if(405===e||38===e||422===e||478===e||347===e);else if(728===e||542===e||6===e||963===e||245===e);else if(217===e);else if(1175===e);else if(285===e)this.interactWithLoc(245,s,a,i);else if(881===e)this.out.p1isaac(130),this.out.p2(i),this.out.p2(s),this.out.p2(a),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface),this.selectedCycle=0,this.selectedInterface=a,this.selectedItem=s,this.selectedArea=2,P.instances[a].layer===this.viewportInterfaceId&&(this.selectedArea=1),P.instances[a].layer===this.chatInterfaceId&&(this.selectedArea=3);else if(391===e)this.out.p1isaac(48),this.out.p2(i),this.out.p2(s),this.out.p2(a),this.out.p2(this.activeSpellId),this.selectedCycle=0,this.selectedInterface=a,this.selectedItem=s,this.selectedArea=2,P.instances[a].layer===this.viewportInterfaceId&&(this.selectedArea=1),P.instances[a].layer===this.chatInterfaceId&&(this.selectedArea=3);else if(660===e);else{if(188===e)return this.objSelected=1,this.objSelectedSlot=s,this.objSelectedInterface=a,this.objInterface=i,this.objSelectedName=k.get(i).name,void(this.spellSelected=0);if(44===e)this.pressedContinueOption||(this.out.p1isaac(235),this.out.p2(a),this.pressedContinueOption=!0);else if(1773===e){const t=k.get(i);let e;e=a>=1e5?a+" x "+t.name:t.desc?t.desc:"It's a "+t.name+".",this.addMessage(0,e,"")}else if(900===e);else if(1373===e||1544===e||151===e||1101===e);else if(265===e);else if(679===e);else if(55===e)this.interactWithLoc(9,s,a,i)&&this.out.p2(this.activeSpellId);else if(224===e||993===e||99===e||746===e||877===e);else if(1607===e);else if(504===e)this.interactWithLoc(172,s,a,i);else{if(930===e){const t=P.instances[a];this.spellSelected=1,this.activeSpellId=a,this.activeSpellFlags=t.actionTarget,this.objSelected=0;let e=t.actionVerb;e&&-1!==e.indexOf(" ")&&(e=e.substring(0,e.indexOf(" ")));let i=t.actionVerb;return i&&-1!==i.indexOf(" ")&&(i=i.substring(i.indexOf(" ")+1)),this.spellCaption=e+" "+t.action+" "+i,void(16===this.activeSpellFlags&&(this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0))}if(951===e){const t=P.instances[a];let e=!0;t.clientCode>0&&(e=this.handleInterfaceAction(t)),e&&(this.out.p1isaac(155),this.out.p2(a))}else if(602===e||596===e||22===e||892===e||415===e);else if(581===e);else if(965===e);else if(1501===e);else if(364===e)this.interactWithLoc(96,s,a,i);else if(1102===e){const t=k.get(i);let e;e=t.desc?t.desc:"It's a "+t.name+".",this.addMessage(0,e,"")}else if(960===e){this.out.p1isaac(155),this.out.p2(a);const t=P.instances[a];if(t.scripts&&t.scripts[0]&&5===t.scripts[0][0]){const e=t.scripts[0][1];t.scriptOperand&&this.varps[e]!==t.scriptOperand[0]&&(this.varps[e]=t.scriptOperand[0],this.updateVarp(e),this.redrawSidebar=!0)}}else if(34===e){const e=this.menuOption[t],i=e.indexOf("@whi@");if(-1!=i){this.closeInterfaces(),this.reportAbuseInput=e.substring(i+5).trim(),this.reportAbuseMuteOption=!1;for(let t=0;t<P.instances.length;t++)if(null!=P.instances[t]&&P.instances[t].clientCode==P.CC_REPORT_INPUT){this.reportAbuseInterfaceID=this.viewportInterfaceId=P.instances[t].layer;break}}}else if(947===e)this.closeInterfaces();else if(367===e);else if(465===e){this.out.p1isaac(155),this.out.p2(a);const t=P.instances[a];if(t.scripts&&t.scripts[0]&&5===t.scripts[0][0]){const e=t.scripts[0][1];this.varps[e]=1-this.varps[e],this.updateVarp(e),this.redrawSidebar=!0}}}}this.objSelected=0,this.spellSelected=0};handleInterfaceAction=t=>{const e=t.clientCode;return e===P.CC_ADD_FRIEND&&(this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=1,this.socialMessage="Enter name of friend to add to list"),e===P.CC_DEL_FRIEND&&(this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=2,this.socialMessage="Enter name of friend to delete from list"),e===P.CC_LOGOUT?(this.idleTimeout=250,!0):(e===P.CC_ADD_IGNORE&&(this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=4,this.socialMessage="Enter name of player to add to list"),e===P.CC_DEL_IGNORE&&(this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=5,this.socialMessage="Enter name of player to delete from list"),e>=P.CC_CHANGE_HEAD_L&&P.CC_CHANGE_FEET_R,e>=P.CC_RECOLOUR_HAIR_L&&P.CC_RECOLOUR_SKIN_R,P.CC_SWITCH_TO_MALE,P.CC_SWITCH_TO_FEMALE,e===P.CC_ACCEPT_DESIGN||(e===P.CC_MOD_MUTE&&(this.reportAbuseMuteOption=!this.reportAbuseMuteOption),e>=P.CC_REPORT_RULE1&&e<=P.CC_REPORT_RULE12&&(this.closeInterfaces(),this.reportAbuseInput.length>0&&(this.out.p1isaac(190),this.out.p8(B.toBase37(this.reportAbuseInput)),this.out.p1(e-601),this.out.p1(this.reportAbuseMuteOption?1:0))),!1))};interactWithLoc=(t,e,i,s)=>!1;handleTabInput=()=>{1===this.mouseClickButton&&(this.mouseClickX>=549&&this.mouseClickX<=583&&this.mouseClickY>=195&&this.mouseClickY<231&&-1!==this.tabInterfaceId[0]?(this.redrawSidebar=!0,this.selectedTab=0,this.redrawSideicons=!0):this.mouseClickX>=579&&this.mouseClickX<=609&&this.mouseClickY>=194&&this.mouseClickY<231&&-1!==this.tabInterfaceId[1]?(this.redrawSidebar=!0,this.selectedTab=1,this.redrawSideicons=!0):this.mouseClickX>=607&&this.mouseClickX<=637&&this.mouseClickY>=194&&this.mouseClickY<231&&-1!==this.tabInterfaceId[2]?(this.redrawSidebar=!0,this.selectedTab=2,this.redrawSideicons=!0):this.mouseClickX>=635&&this.mouseClickX<=679&&this.mouseClickY>=194&&this.mouseClickY<229&&-1!==this.tabInterfaceId[3]?(this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0):this.mouseClickX>=676&&this.mouseClickX<=706&&this.mouseClickY>=194&&this.mouseClickY<231&&-1!==this.tabInterfaceId[4]?(this.redrawSidebar=!0,this.selectedTab=4,this.redrawSideicons=!0):this.mouseClickX>=704&&this.mouseClickX<=734&&this.mouseClickY>=194&&this.mouseClickY<231&&-1!==this.tabInterfaceId[5]?(this.redrawSidebar=!0,this.selectedTab=5,this.redrawSideicons=!0):this.mouseClickX>=732&&this.mouseClickX<=766&&this.mouseClickY>=195&&this.mouseClickY<231&&-1!==this.tabInterfaceId[6]?(this.redrawSidebar=!0,this.selectedTab=6,this.redrawSideicons=!0):this.mouseClickX>=550&&this.mouseClickX<=584&&this.mouseClickY>=492&&this.mouseClickY<528&&-1!==this.tabInterfaceId[7]?(this.redrawSidebar=!0,this.selectedTab=7,this.redrawSideicons=!0):this.mouseClickX>=582&&this.mouseClickX<=612&&this.mouseClickY>=492&&this.mouseClickY<529&&-1!==this.tabInterfaceId[8]?(this.redrawSidebar=!0,this.selectedTab=8,this.redrawSideicons=!0):this.mouseClickX>=609&&this.mouseClickX<=639&&this.mouseClickY>=492&&this.mouseClickY<529&&-1!==this.tabInterfaceId[9]?(this.redrawSidebar=!0,this.selectedTab=9,this.redrawSideicons=!0):this.mouseClickX>=637&&this.mouseClickX<=681&&this.mouseClickY>=493&&this.mouseClickY<528&&-1!==this.tabInterfaceId[10]?(this.redrawSidebar=!0,this.selectedTab=10,this.redrawSideicons=!0):this.mouseClickX>=679&&this.mouseClickX<=709&&this.mouseClickY>=492&&this.mouseClickY<529&&-1!==this.tabInterfaceId[11]?(this.redrawSidebar=!0,this.selectedTab=11,this.redrawSideicons=!0):this.mouseClickX>=706&&this.mouseClickX<=736&&this.mouseClickY>=492&&this.mouseClickY<529&&-1!==this.tabInterfaceId[12]?(this.redrawSidebar=!0,this.selectedTab=12,this.redrawSideicons=!0):this.mouseClickX>=734&&this.mouseClickX<=768&&this.mouseClickY>=492&&this.mouseClickY<528&&-1!==this.tabInterfaceId[13]&&(this.redrawSidebar=!0,this.selectedTab=13,this.redrawSideicons=!0),gt.sidebarInputCounter++,gt.sidebarInputCounter>150&&(gt.sidebarInputCounter=0,this.out.p1isaac(233),this.out.p1(43)))};handleInputKey=async()=>{for(;;){let t;do{for(;;){if(t=this.pollKey(),-1==t)return;if(-1!=this.viewportInterfaceId&&this.viewportInterfaceId==this.reportAbuseInterfaceID){8==t&&this.reportAbuseInput.length>0&&(this.reportAbuseInput=this.reportAbuseInput.substring(0,this.reportAbuseInput.length-1));break}if(this.showSocialInput){if(t>=32&&t<=122&&this.socialInput.length<80&&(this.socialInput=this.socialInput+String.fromCharCode(t),this.redrawChatback=!0),8==t&&this.socialInput.length>0&&(this.socialInput=this.socialInput.substring(0,this.socialInput.length-1),this.redrawChatback=!0),13==t||10==t){let t;if(this.showSocialInput=!1,this.redrawChatback=!0,1==this.socialAction&&(t=B.toBase37(this.socialInput),this.addFriend(t)),2==this.socialAction&&this.friendCount>0&&(t=B.toBase37(this.socialInput),this.removeFriend(t)),3==this.socialAction&&this.socialInput.length>0&&this.socialName37){this.out.p1isaac(148),this.out.p1(0);const t=this.out.pos;this.out.p8(this.socialName37),pt.pack(this.out,this.socialInput),this.out.psize1(this.out.pos-t),this.socialInput=B.toSentenceCase(this.socialInput),this.socialInput=U.filter(this.socialInput),this.addMessage(6,this.socialInput,B.formatName(B.fromBase37(this.socialName37))),2==this.privateChatSetting&&(this.privateChatSetting=1,this.redrawPrivacySettings=!0,this.out.p1isaac(244),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting))}4==this.socialAction&&this.ignoreCount<100&&(t=B.toBase37(this.socialInput),this.addIgnore(t)),5==this.socialAction&&this.ignoreCount>0&&(t=B.toBase37(this.socialInput),this.removeIgnore(t))}}else if(this.chatbackInputOpen){if(t>=48&&t<=57&&this.chatbackInput.length<10&&(this.chatbackInput=this.chatbackInput+String.fromCharCode(t),this.redrawChatback=!0),8==t&&this.chatbackInput.length>0&&(this.chatbackInput=this.chatbackInput.substring(0,this.chatbackInput.length-1),this.redrawChatback=!0),13==t||10==t){if(this.chatbackInput.length>0){let t=0;try{t=parseInt(this.chatbackInput,10)}catch(t){}this.out.p1isaac(237),this.out.p4(t)}this.chatbackInputOpen=!1,this.redrawChatback=!0}}else if(-1==this.chatInterfaceId&&(t>=32&&t<=122&&this.chatTyped.length<80&&(this.chatTyped=this.chatTyped+String.fromCharCode(t),this.redrawChatback=!0),8==t&&this.chatTyped.length>0&&(this.chatTyped=this.chatTyped.substring(0,this.chatTyped.length-1),this.redrawChatback=!0),(13==t||10==t)&&this.chatTyped.length>0)){if("::clientdrop"===this.chatTyped)await this.tryReconnect();else if("::noclip"===this.chatTyped)for(let t=0;t<4;t++)for(let e=1;e<103;e++)for(let i=1;i<103;i++){const s=this.levelCollisionMap[t];s&&(s.flags[lt.index(e,i)]=0)}if(this.chatTyped.startsWith("::"))this.out.p1isaac(4),this.out.p1(this.chatTyped.length-1),this.out.pjstr(this.chatTyped.substring(2));else{let t=0;this.chatTyped.startsWith("yellow:")?(t=0,this.chatTyped=this.chatTyped.substring(7)):this.chatTyped.startsWith("red:")?(t=1,this.chatTyped=this.chatTyped.substring(4)):this.chatTyped.startsWith("green:")?(t=2,this.chatTyped=this.chatTyped.substring(6)):this.chatTyped.startsWith("cyan:")?(t=3,this.chatTyped=this.chatTyped.substring(5)):this.chatTyped.startsWith("purple:")?(t=4,this.chatTyped=this.chatTyped.substring(7)):this.chatTyped.startsWith("white:")?(t=5,this.chatTyped=this.chatTyped.substring(6)):this.chatTyped.startsWith("flash1:")?(t=6,this.chatTyped=this.chatTyped.substring(7)):this.chatTyped.startsWith("flash2:")?(t=7,this.chatTyped=this.chatTyped.substring(7)):this.chatTyped.startsWith("flash3:")?(t=8,this.chatTyped=this.chatTyped.substring(7)):this.chatTyped.startsWith("glow1:")?(t=9,this.chatTyped=this.chatTyped.substring(6)):this.chatTyped.startsWith("glow2:")?(t=10,this.chatTyped=this.chatTyped.substring(6)):this.chatTyped.startsWith("glow3:")&&(t=11,this.chatTyped=this.chatTyped.substring(6));let e=0;this.chatTyped.startsWith("wave:")&&(e=1,this.chatTyped=this.chatTyped.substring(5)),this.chatTyped.startsWith("scroll:")&&(e=2,this.chatTyped=this.chatTyped.substring(7)),this.out.p1isaac(158),this.out.p1(0);const i=this.out.pos;this.out.p1(t),this.out.p1(e),pt.pack(this.out,this.chatTyped),this.out.psize1(this.out.pos-i),this.chatTyped=B.toSentenceCase(this.chatTyped),this.chatTyped=U.filter(this.chatTyped),this.localPlayer&&this.localPlayer.name&&(this.localPlayer.chat=this.chatTyped,this.localPlayer.chatColor=t,this.localPlayer.chatStyle=e,this.localPlayer.chatTimer=150,this.addMessage(2,this.localPlayer.chat,this.localPlayer.name)),2==this.publicChatSetting&&(this.publicChatSetting=3,this.redrawPrivacySettings=!0,this.out.p1isaac(244),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting))}this.chatTyped="",this.redrawChatback=!0}}}while((t<97||t>122)&&(t<65||t>90)&&(t<48||t>57)&&32!=t);this.reportAbuseInput.length<12&&(this.reportAbuseInput=this.reportAbuseInput+String.fromCharCode(t))}};handleChatSettingsInput=()=>{if(1===this.mouseClickButton)if(this.mouseClickX>=8&&this.mouseClickX<=108&&this.mouseClickY>=490&&this.mouseClickY<=522)this.publicChatSetting=(this.publicChatSetting+1)%4,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(244),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting);else if(this.mouseClickX>=137&&this.mouseClickX<=237&&this.mouseClickY>=490&&this.mouseClickY<=522)this.privateChatSetting=(this.privateChatSetting+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(244),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting);else if(this.mouseClickX>=275&&this.mouseClickX<=375&&this.mouseClickY>=490&&this.mouseClickY<=522)this.tradeChatSetting=(this.tradeChatSetting+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(244),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting);else if(this.mouseClickX>=416&&this.mouseClickX<=516&&this.mouseClickY>=490&&this.mouseClickY<=522){this.closeInterfaces(),this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let t=0;t<P.instances.length;t++)if(P.instances[t]&&600===P.instances[t].clientCode)return void(this.reportAbuseInterfaceID=this.viewportInterfaceId=P.instances[t].layer)}};handleScrollInput=(t,e,i,s,a,r,n,h)=>{if(this.scrollGrabbed?this.scrollInputPadding=32:this.scrollInputPadding=0,this.scrollGrabbed=!1,t>=r&&t<r+16&&e>=n&&e<n+16)h.scrollPosition-=4*this.dragCycles,a&&(this.redrawSidebar=!0);else if(t>=r&&t<r+16&&e>=n+s-16&&e<n+s)h.scrollPosition+=4*this.dragCycles,a&&(this.redrawSidebar=!0);else if(t>=r-this.scrollInputPadding&&t<r+this.scrollInputPadding+16&&e>=n+16&&e<n+s-16&&this.dragCycles>0){let t=Math.trunc((s-32)*s/i);t<8&&(t=8);const r=e-n-Math.trunc(t/2)-16,o=s-t-32;h.scrollPosition=Math.trunc((i-s)*r/o),a&&(this.redrawSidebar=!0),this.scrollGrabbed=!0}};prepareGameScreen=()=>{this.areaChatback||(this.unloadTitle(),this.drawArea=null,this.imageTitle2=null,this.imageTitle3=null,this.imageTitle4=null,this.imageTitle0=null,this.imageTitle1=null,this.imageTitle5=null,this.imageTitle6=null,this.imageTitle7=null,this.imageTitle8=null,this.areaChatback=new N(479,96),this.areaMapback=new N(168,160),w.clear(),this.imageMapback?.draw(0,0),this.areaSidebar=new N(190,261),this.areaViewport=new N(512,334),w.clear(),this.areaBackbase1=new N(501,61),this.areaBackbase2=new N(288,40),this.areaBackhmid1=new N(269,66),this.redrawTitleBackground=!0)};isFriend=t=>!1;addFriend=t=>{if(0n==t)return;if(this.friendCount>=100)return void this.addMessage(0,"Your friends list is full. Max of 100 hit","");const e=B.formatName(B.fromBase37(t));for(let i=0;i<this.friendCount;i++)if(this.friendName37[i]==t)return void this.addMessage(0,e+" is already on your friend list","");for(let i=0;i<this.ignoreCount;i++)if(this.ignoreName37[i]==t)return void this.addMessage(0,"Please remove "+e+" from your ignore list first","");this.localPlayer&&this.localPlayer.name&&e!==this.localPlayer.name&&(this.friendName[this.friendCount]=e,this.friendName37[this.friendCount]=t,this.friendWorld[this.friendCount]=0,this.friendCount++,this.redrawSidebar=!0,this.out.p1isaac(118),this.out.p8(t))};removeFriend=t=>{if(0n!=t)for(let e=0;e<this.friendCount;e++)if(this.friendName37[e]==t){this.friendCount--,this.redrawSidebar=!0;for(let t=e;t<this.friendCount;t++)this.friendName[t]=this.friendName[t+1],this.friendWorld[t]=this.friendWorld[t+1],this.friendName37[t]=this.friendName37[t+1];return this.out.p1isaac(11),void this.out.p8(t)}};addIgnore=t=>{if(0n==t)return;if(this.ignoreCount>=100)return void this.addMessage(0,"Your ignore list is full. Max of 100 hit","");const e=B.formatName(B.fromBase37(t));for(let i=0;i<this.ignoreCount;i++)if(this.ignoreName37[i]==t)return void this.addMessage(0,e+" is already on your ignore list","");for(let i=0;i<this.friendCount;i++)if(this.friendName37[i]==t)return void this.addMessage(0,"Please remove "+e+" from your friend list first","");this.ignoreName37[this.ignoreCount++]=t,this.redrawSidebar=!0,this.out.p1isaac(79),this.out.p8(t)};removeIgnore=t=>{if(0n!=t)for(let e=0;e<this.ignoreCount;e++)if(this.ignoreName37[e]==t){this.ignoreCount--,this.redrawSidebar=!0;for(let t=e;t<this.ignoreCount;t++)this.ignoreName37[t]=this.ignoreName37[t+1];return this.out.p1isaac(171),void this.out.p8(t)}};getIntString=t=>t<999999999?String(t):"*";formatObjCountTagged=t=>{let e=String(t);for(let t=e.length-3;t>0;t-=3)e=e.substring(0,t)+","+e.substring(t);return e.length>8?e="@gre@"+e.substring(0,e.length-8)+" million @whi@("+e+")":e.length>4&&(e="@cya@"+e.substring(0,e.length-4)+"K @whi@("+e+")")," "+e};formatObjCount=t=>t<1e5?String(t):t<1e7?Math.floor(t/1e3)+"K":Math.floor(t/1e6)+"M";closeInterfaces=()=>{this.out.p1isaac(231),-1!==this.sidebarInterfaceId&&(this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.pressedContinueOption=!1,this.redrawSideicons=!0),-1!==this.chatInterfaceId&&(this.chatInterfaceId=-1,this.redrawChatback=!0,this.pressedContinueOption=!1),this.viewportInterfaceId=-1};executeClientscript1=(t,e)=>{if(!t.scripts||e>=t.scripts.length)return-2;try{const i=t.scripts[e];if(!i)return-1;let s=0,a=0;for(;;){const t=i[a++];if(0===t)return s;if(1===t)s+=this.skillLevel[i[a++]];else if(2===t)s+=this.skillBaseLevel[i[a++]];else if(3===t)s+=this.skillExperience[i[a++]];else if(4===t){const t=P.instances[i[a++]],e=i[a++]+1;if(t.invSlotObjId&&t.invSlotObjCount)for(let i=0;i<t.invSlotObjId.length;i++)t.invSlotObjId[i]===e&&(s+=t.invSlotObjCount[i]);else s+=0}else if(5===t)s+=this.varps[i[a++]];else if(6===t)s+=this.levelExperience[this.skillBaseLevel[i[a++]]-1];else if(7===t)s+=Math.trunc(100*this.varps[i[a++]]/46875);else if(8===t)s+=this.localPlayer?.combatLevel||0;else if(9===t)for(let t=0;t<19;t++)18===t&&(t=20),s+=this.skillBaseLevel[t];else if(10===t){const t=P.instances[i[a++]],e=i[a++]+1;for(let i=0;i<t.invSlotObjId.length;i++)if(t.invSlotObjId[i]===e){s+=999999999;break}}else if(11===t)s+=this.energy;else if(12===t)s+=this.weightCarried;else if(13===t){s+=0==(this.varps[i[a++]]&1<<i[a++])?0:1}}}catch(t){return-1}};executeInterfaceScript=t=>{if(!t.scriptComparator)return!1;for(let e=0;e<t.scriptComparator.length;e++){const i=this.executeClientscript1(t,e);if(!t.scriptOperand)return!1;const s=t.scriptOperand[e];if(2===t.scriptComparator[e]){if(i>=s)return!1}else if(3===t.scriptComparator[e]){if(i<=s)return!1}else if(4===t.scriptComparator[e]){if(i===s)return!1}else if(i!==s)return!1}return!0};updateInterfaceContent=t=>{let e=t.clientCode;if(e>=P.CC_FRIENDS_START&&e<=P.CC_FRIENDS_END)e--,e>=this.friendCount?(t.text="",t.buttonType=0):(t.text=this.friendName[e],t.buttonType=1);else if(e>=P.CC_FRIENDS_UPDATE_START&&e<=P.CC_FRIENDS_UPDATE_END)e-=P.CC_FRIENDS_UPDATE_START,e>=this.friendCount?(t.text="",t.buttonType=0):(0==this.friendWorld[e]?t.text="@red@Offline":this.friendWorld[e]==gt.nodeId?t.text="@gre@World-"+(this.friendWorld[e]-9):t.text="@yel@World-"+(this.friendWorld[e]-9),t.buttonType=1);else if(e==P.CC_FRIENDS_SIZE)t.scroll=15*this.friendCount+20,t.scroll<=t.height&&(t.scroll=t.height+1);else if(e>=P.CC_IGNORES_START&&e<=P.CC_IGNORES_END)e-=P.CC_IGNORES_START,e>=this.ignoreCount?(t.text="",t.buttonType=0):(t.text=B.formatName(B.fromBase37(this.ignoreName37[e])),t.buttonType=1);else if(e==P.CC_IGNORES_SIZE)t.scroll=15*this.ignoreCount+20,t.scroll<=t.height&&(t.scroll=t.height+1);else if(e==P.CC_DESIGN_PREVIEW){if(t.xan=150,t.yan=2047&Math.trunc(256*Math.sin(this.loopCycle/40)),this.updateDesignModel){this.updateDesignModel=!1;const e=[];let i=0;for(let t=0;t<7;t++){const s=this.designIdentikits[t];if(s>=0){const t=M.instances[s].getModel();t&&(e[i++]=t)}}const s=_.modelFromModels(e,i);for(let t=0;t<5;t++)0!=this.designColors[t]&&(s.recolor(ft.DESIGN_BODY_COLOR[t][0],ft.DESIGN_BODY_COLOR[t][this.designColors[t]]),1==t&&s.recolor(ft.DESIGN_HAIR_COLOR[0],ft.DESIGN_HAIR_COLOR[this.designColors[t]]));if(this.localPlayer){const e=d.instances[this.localPlayer.seqStandId].frames;e&&(s.createLabelReferences(),s.applyTransform(e[0]),s.calculateNormals(64,850,-30,-50,-30,!0),t.model=s)}}}else if(e==P.CC_SWITCH_TO_MALE)null==this.genderButtonImage0&&(this.genderButtonImage0=t.graphic,this.genderButtonImage1=t.activeGraphic),this.designGenderMale?t.graphic=this.genderButtonImage1:t.graphic=this.genderButtonImage0;else if(e==P.CC_SWITCH_TO_FEMALE)null==this.genderButtonImage0&&(this.genderButtonImage0=t.graphic,this.genderButtonImage1=t.activeGraphic),this.designGenderMale?t.graphic=this.genderButtonImage0:t.graphic=this.genderButtonImage1;else if(e==P.CC_REPORT_INPUT)t.text=this.reportAbuseInput,this.loopCycle%20<10?t.text=t.text+"|":t.text=t.text+" ";else if(e==P.CC_MOD_MUTE)this.rights?this.reportAbuseMuteOption?(t.colour=16711680,t.text="Moderator option: Mute player for 48 hours: <ON>"):(t.colour=16777215,t.text="Moderator option: Mute player for 48 hours: <OFF>"):t.text="";else if(e==P.CC_LAST_LOGIN_INFO||e==P.CC_LAST_LOGIN_INFO2)if(0==this.lastAddress)t.text="";else{let e;e=0==this.daysSinceLastLogin?"earlier today":1==this.daysSinceLastLogin?"yesterday":this.daysSinceLastLogin+" days ago",t.text="You last logged in "+e+" from: "+B.formatIPv4(this.lastAddress)}else if(e==P.CC_UNREAD_MESSAGES)0==this.unreadMessages&&(t.text="0 unread messages",t.colour=16776960),1==this.unreadMessages&&(t.text="1 unread message",t.colour=65280),this.unreadMessages>1&&(t.text=this.unreadMessages+" unread messages",t.colour=65280);else if(e==P.CC_RECOVERY1)if(201==this.daysSinceRecoveriesChanged)t.text="";else if(200==this.daysSinceRecoveriesChanged)t.text="You have not yet set any password recovery questions.";else{let e;e=0==this.daysSinceRecoveriesChanged?"Earlier today":1==this.daysSinceRecoveriesChanged?"Yesterday":this.daysSinceRecoveriesChanged+" days ago",t.text=e+" you changed your recovery questions"}else e==P.CC_RECOVERY2?201==this.daysSinceRecoveriesChanged?t.text="":200==this.daysSinceRecoveriesChanged?t.text="We strongly recommend you do so now to secure your account.":t.text="If you do not remember making this change then cancel it immediately":e==P.CC_RECOVERY3&&(201==this.daysSinceRecoveriesChanged?t.text="":(this.daysSinceRecoveriesChanged,t.text="Do this from the 'account management' area on our front webpage"))};tryReconnect=async()=>{if(this.idleTimeout>0)this.logout();else{this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,144,"Connection lost",0),this.fontPlain12?.drawStringCenter(256,143,"Connection lost",16777215),this.fontPlain12?.drawStringCenter(257,159,"Please wait - attempting to reestablish",0),this.fontPlain12?.drawStringCenter(256,158,"Please wait - attempting to reestablish",16777215),this.areaViewport?.draw(8,11),this.flagSceneTileX=0;const t=this.stream;this.ingame=!1,await this.login(this.username,this.password,!0),this.ingame||this.logout(),t?.close()}};logout=()=>{this.stream&&this.stream.close(),this.stream=null,this.ingame=!1,this.titleScreenState=0,this.username="",this.password="",V.setDisabled(),this.clearCaches(),this.scene?.reset();for(let t=0;t<4;t++)this.levelCollisionMap[t]?.reset();this.currentMidi=null,this.nextMusicDelay=0};read=async()=>{if(!this.stream)return!1;try{let t=this.stream.available;if(0===t)return!1;if(-1===this.packetType&&(await this.stream.readBytes(this.in.data,0,1),this.packetType=255&this.in.data[0],this.randomIn&&(this.packetType=this.packetType-this.randomIn.nextInt&255),this.packetSize=tt.SERVERPROT_SIZES[this.packetType],t--),-1===this.packetSize){if(t<=0)return!1;await this.stream.readBytes(this.in.data,0,1),this.packetSize=255&this.in.data[0],t--}if(-2===this.packetSize){if(t<=1)return!1;await this.stream.readBytes(this.in.data,0,2),this.in.pos=0,this.packetSize=this.in.g2,t-=2}if(t<this.packetSize)return!1;if(this.in.pos=0,await this.stream.readBytes(this.in.data,0,this.packetSize),this.idleNetCycles=0,this.lastPacketType2=this.lastPacketType1,this.lastPacketType1=this.lastPacketType0,this.lastPacketType0=this.packetType,console.log(`Incoming packet: ${this.packetType}`),150===this.packetType){const t=this.in.g2,e=this.in.g1b;return this.varCache[t]=e,this.varps[t]!==e&&(this.varps[t]=e,this.updateVarp(t),this.redrawSidebar=!0,-1!==this.stickyChatInterfaceId&&(this.redrawChatback=!0)),this.packetType=-1,!0}if(152===this.packetType){const t=this.in.g8;return this.in.g1,B.formatName(B.fromBase37(t)),this.packetType=-1,!0}if(43===this.packetType)return this.systemUpdateTimer=30*this.in.g2,this.packetType=-1,!0;if(80===this.packetType){const t=this.in.g1,e=this.in.g1;let i=-1;if(this.sceneMapIndex)for(let s=0;s<this.sceneMapIndex.length;s++)this.sceneMapIndex[s]===(t<<8)+e&&(i=s);if(-1!==i){const s=this.sceneMapLandData;if(s){const a=s[i];-1!==i&&a&&(this.db?.cachesave(`m${t}_${e}`,a),this.sceneState=1)}}return this.packetType=-1,!0}if(1===this.packetType)return this.readNpcInfo(this.in,this.packetSize),this.packetType=-1,!0;if(237===this.packetType){const t=this.in.g2,e=this.in.g2;if(this.sceneCenterZoneX===t&&this.sceneCenterZoneZ===e&&0!==this.sceneState)return this.packetType=-1,!0;this.sceneCenterZoneX=t,this.sceneCenterZoneZ=e,this.sceneBaseTileX=8*(this.sceneCenterZoneX-6),this.sceneBaseTileZ=8*(this.sceneCenterZoneZ-6),this.sceneState=1,this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",0),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",16777215),this.areaViewport?.draw(8,11);const i=Math.trunc((this.packetSize-2)/10);this.sceneMapLandData=new Array(i),this.sceneMapLocData=new Array(i),this.sceneMapIndex=new Int32Array(i),this.out.p1isaac(150),this.out.p1(0);let s=0;for(let t=0;t<i;t++){const e=this.in.g1,i=this.in.g1,a=this.in.g4,r=this.in.g4;let n;this.sceneMapIndex[t]=(e<<8)+i,0!==a&&(n=await(this.db?.cacheload(`m${e}_${i}`)),n&&o.crc32(n)!==a&&(n=void 0),n?this.sceneMapLandData[t]=n:(this.sceneState=0,this.out.p1(0),this.out.p1(e),this.out.p1(i),s+=3)),0!==r&&(n=await(this.db?.cacheload(`l${e}_${i}`)),n&&o.crc32(n)!==r&&(n=void 0),n?this.sceneMapLocData[t]=n:(this.sceneState=0,this.out.p1(1),this.out.p1(e),this.out.p1(i),s+=3))}this.out.psize1(s),this.areaViewport?.bind(),0==this.sceneState&&(this.fontPlain12?.drawStringCenter(257,166,"Map area updated since last visit, so load will take longer this time only",0),this.fontPlain12?.drawStringCenter(256,165,"Map area updated since last visit, so load will take longer this time only",16777215)),this.areaViewport?.draw(8,11);const a=this.sceneBaseTileX-this.mapLastBaseX,r=this.sceneBaseTileZ-this.mapLastBaseZ;this.mapLastBaseX=this.sceneBaseTileX,this.mapLastBaseZ=this.sceneBaseTileZ;for(let t=0;t<8192;t++){const e=this.npcs[t];if(e){for(let t=0;t<10;t++)e.pathTileX[t]-=a,e.pathTileZ[t]-=r;e.x-=128*a,e.z-=128*r}}for(let t=0;t<this.MAX_PLAYER_COUNT;t++){const e=this.players[t];if(e){for(let t=0;t<10;t++)e.pathTileX[t]-=a,e.pathTileZ[t]-=r;e.x-=128*a,e.z-=128*r}}let n=0,h=104,l=1;a<0&&(n=103,h=-1,l=-1);let c=0,d=104,f=1;r<0&&(c=103,d=-1,f=-1);for(let t=n;t!=h;t+=l)for(let e=c;e!=d;e+=f){const i=t+a,s=e+r;for(let a=0;a<4;a++)this.levelObjStacks[a][t][e]=i>=0&&s>=0&&i<104&&s<104?this.levelObjStacks[a][i][s]:null}for(let t=this.spawnedLocations.peekFront();null!=t;t=this.spawnedLocations.prev())t.x-=a,t.z-=r,(t.x<0||t.z<0||t.x>=104||t.z>=104)&&t.unlink();return 0!=this.flagSceneTileX&&(this.flagSceneTileX-=a,this.flagSceneTileZ-=r),this.cutscene=!1,this.packetType=-1,!0}if(197===this.packetType){const t=this.in.g2;return P.instances[t].model=this.localPlayer?.getHeadModel()||null,this.packetType=-1,!0}if(25===this.packetType)return this.hintType=this.in.g1,1===this.hintType&&(this.hintNpc=this.in.g2),this.hintType>=2&&this.hintType<=6&&(2===this.hintType&&(this.hintOffsetX=64,this.hintOffsetZ=64),3===this.hintType&&(this.hintOffsetX=0,this.hintOffsetZ=64),4===this.hintType&&(this.hintOffsetX=128,this.hintOffsetZ=64),5===this.hintType&&(this.hintOffsetX=64,this.hintOffsetZ=0),6===this.hintType&&(this.hintOffsetX=64,this.hintOffsetZ=128),this.hintType=2,this.hintTileX=this.in.g2,this.hintTileZ=this.in.g2,this.hintHeight=this.in.g1),10===this.hintType&&(this.hintPlayer=this.in.g2),this.packetType=-1,!0;if(54===this.packetType){const t=this.in.gjstr,e=this.in.g4,i=this.in.g4;return t!==this.currentMidi&&this.midiActive&&!gt.LOW_MEMORY&&await this.setMidi(t,e),this.currentMidi=t,this.midiCrc=e,this.midiSize=i,this.nextMusicDelay=0,this.packetType=-1,!0}if(142===this.packetType)return this.logout(),this.packetType=-1,!1;if(20===this.packetType){const t=this.in.g1,e=this.in.g1;let i=-1;if(this.sceneMapIndex)for(let s=0;s<this.sceneMapIndex.length;s++)this.sceneMapIndex[s]===(t<<8)+e&&(i=s);if(-1!==i){const s=this.sceneMapLocData;if(s){const a=s[i];-1!==i&&a&&(this.db?.cachesave(`l${t}_${e}`,a),this.sceneState=1)}}return this.packetType=-1,!0}if(19===this.packetType)return this.flagSceneTileX=0,this.packetType=-1,!0;if(139===this.packetType)return this.localPid=this.in.g2,this.packetType=-1,!0;if(151===this.packetType||23===this.packetType||50===this.packetType||191===this.packetType||69===this.packetType||49===this.packetType||223===this.packetType||42===this.packetType||76===this.packetType||59===this.packetType)return this.packetType=-1,!0;if(28===this.packetType){const t=this.in.g2,e=this.in.g2;return-1!==this.chatInterfaceId&&(this.chatInterfaceId=-1,this.redrawChatback=!0),this.chatbackInputOpen&&(this.chatbackInputOpen=!1,this.redrawChatback=!0),this.viewportInterfaceId=t,this.sidebarInterfaceId=e,this.redrawSidebar=!0,this.redrawSideicons=!0,this.pressedContinueOption=!1,this.packetType=-1,!0}if(175===this.packetType){const t=this.in.g2,e=this.in.g4;return this.varCache[t]=e,this.varps[t]!==e&&(this.varps[t]=e,this.updateVarp(t),this.redrawSidebar=!0,-1!==this.stickyChatInterfaceId&&(this.redrawChatback=!0)),this.packetType=-1,!0}if(146===this.packetType){const t=this.in.g2;return P.instances[t].anim=this.in.g2,this.packetType=-1,!0}if(167===this.packetType){let t=this.in.g2;const e=this.in.g1;return 65535===t&&(t=-1),this.tabInterfaceId[e]=t,this.redrawSidebar=!0,this.redrawSideicons=!0,this.packetType=-1,!0}if(220===this.packetType){const t=this.in.g1,e=this.in.g1,i=this.in.g2,s=this.in.g2;let a=-1;if(this.sceneMapIndex)for(let i=0;i<this.sceneMapIndex.length;i++)this.sceneMapIndex[i]===(t<<8)+e&&(a=i);if(-1!==a&&this.sceneMapLocData){this.sceneMapLocData[a]&&this.sceneMapLocData[a]?.length===s||(this.sceneMapLocData[a]=new Int8Array(s));const t=this.sceneMapLocData[a];t&&this.in.gdata(this.packetSize-6,i,t)}return this.packetType=-1,!0}if(133===this.packetType){const t=V.stop();return t&&(this.out.p1isaac(81),this.out.p2(t.pos),this.out.pdata(t.data,t.pos,0),t.release()),this.packetType=-1,!0}if(98===this.packetType){this.redrawSidebar=!0;const t=this.in.g2,e=P.instances[t],i=this.in.g1;if(e.invSlotObjId&&e.invSlotObjCount){for(let t=0;t<i;t++){e.invSlotObjId[t]=this.in.g2;let i=this.in.g1;255===i&&(i=this.in.g4),e.invSlotObjCount[t]=i}for(let t=i;t<e.invSlotObjId.length;t++)e.invSlotObjId[t]=0,e.invSlotObjCount[t]=0}else for(let t=0;t<i;t++)this.in.g2,255===this.in.g1&&this.in.g4;return this.packetType=-1,!0}if(226===this.packetType)return V.setEnabled(),this.packetType=-1,!0;if(243===this.packetType)return this.showSocialInput=!1,this.chatbackInputOpen=!0,this.chatbackInput="",this.redrawChatback=!0,this.packetType=-1,!0;if(15===this.packetType){const t=P.instances[this.in.g2];if(t.invSlotObjId)for(let e=0;e<t.invSlotObjId.length;e++)t.invSlotObjId[e]=-1,t.invSlotObjId[e]=0;return this.packetType=-1,!0}if(140===this.packetType){if(this.lastAddress=this.in.g4,this.daysSinceLastLogin=this.in.g2,this.daysSinceRecoveriesChanged=this.in.g1,this.unreadMessages=this.in.g2,0!==this.lastAddress&&-1===this.viewportInterfaceId){this.closeInterfaces();let t=650;201!==this.daysSinceRecoveriesChanged&&(t=655),this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let e=0;e<P.instances.length;e++)if(P.instances[e]&&P.instances[e].clientCode===t){this.viewportInterfaceId=P.instances[e].layer;break}}return this.packetType=-1,!0}if(126===this.packetType)return this.flashingTab=this.in.g1,this.flashingTab===this.selectedTab&&(3===this.flashingTab?this.selectedTab=1:this.selectedTab=3,this.redrawSidebar=!0),this.packetType=-1,!0;if(212===this.packetType)return this.packetType=-1,!0;if(254===this.packetType)return this.inMultizone=this.in.g1,this.packetType=-1,!0;if(12===this.packetType){const t=this.in.g2,e=this.in.g1,i=this.in.g2;return this.waveEnabled&&!gt.LOW_MEMORY&&this.waveCount<50&&(this.waveIds[this.waveCount]=t,this.waveLoops[this.waveCount]=e,this.waveDelay[this.waveCount]=i+$.delays[t],this.waveCount++),this.packetType=-1,!0}if(204===this.packetType){const t=this.in.g2,e=this.in.g2,i=L.get(e);return P.instances[t].model=i.getHeadModel(),this.packetType=-1,!0}if(7===this.packetType)return this.baseX=this.in.g1,this.baseZ=this.in.g1,this.packetType=-1,!0;if(103===this.packetType){const t=this.in.g2,e=this.in.g2,i=this.in.g2,s=P.instances[t].model;return s?.recolor(e,i),this.packetType=-1,!0}if(32===this.packetType)return this.publicChatSetting=this.in.g1,this.privateChatSetting=this.in.g1,this.tradeChatSetting=this.in.g1,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.packetType=-1,!0;if(195===this.packetType){const t=this.in.g2;return this.resetInterfaceAnimation(t),-1!==this.chatInterfaceId&&(this.chatInterfaceId=-1,this.redrawChatback=!0),this.chatbackInputOpen&&(this.chatbackInputOpen=!1,this.redrawChatback=!0),this.sidebarInterfaceId=t,this.redrawSidebar=!0,this.redrawSideicons=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.packetType=-1,!0}if(14===this.packetType){const t=this.in.g2;return this.resetInterfaceAnimation(t),-1!==this.sidebarInterfaceId&&(this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0),this.chatInterfaceId=t,this.redrawChatback=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.packetType=-1,!0}if(209===this.packetType){const t=this.in.g2,e=this.in.g2b,i=this.in.g2b,s=P.instances[t];return s.x=e,s.y=i,this.packetType=-1,!0}if(3===this.packetType)return this.cutscene=!0,this.packetType=-1,!0;if(135===this.packetType){this.baseX=this.in.g1,this.baseZ=this.in.g1;for(let t=this.baseX;t<this.baseX+8;t++)for(let t=this.baseZ;t<this.baseZ+8;t++);return this.packetType=-1,!0}if(132===this.packetType){const t=this.in.g1,e=this.in.g1,i=this.in.g2,s=this.in.g2;let a=-1;if(this.sceneMapIndex)for(let i=0;i<this.sceneMapIndex.length;i++)this.sceneMapIndex[i]===(t<<8)+e&&(a=i);if(-1!==a&&this.sceneMapLandData){this.sceneMapLandData[a]&&this.sceneMapLandData[a]?.length===s||(this.sceneMapLandData[a]=new Int8Array(s));const t=this.sceneMapLandData[a];t&&this.in.gdata(this.packetSize-6,i,t)}return this.packetType=-1,!0}if(41===this.packetType)return this.in.g8,this.in.g4,this.in.g1,this.packetType=-1,!0;if(193===this.packetType){for(let t=0;t<this.varps.length;t++)this.varps[t]!==this.varCache[t]&&(this.varps[t]=this.varCache[t],this.updateVarp(t),this.redrawSidebar=!0);return this.packetType=-1,!0}if(87===this.packetType){const t=this.in.g2,e=this.in.g2;return P.instances[t].model=_.model(e),this.packetType=-1,!0}if(185===this.packetType)return this.stickyChatInterfaceId=this.in.g2b,this.redrawChatback=!0,this.packetType=-1,!0;if(68===this.packetType)return 12===this.selectedTab&&(this.redrawSidebar=!0),this.energy=this.in.g1,this.packetType=-1,!0;if(74===this.packetType)return this.cutscene=!0,this.packetType=-1,!0;if(84===this.packetType)return this.selectedTab=this.in.g1,this.redrawSidebar=!0,this.redrawSideicons=!0,this.packetType=-1,!0;if(4===this.packetType){const t=this.in.gjstr;let e;if(t.endsWith(":tradereq:")){const i=t.substring(0,t.indexOf(":"));e=B.toBase37(i);let s=!1;for(let t=0;t<this.ignoreCount;t++)if(this.ignoreName37[t]===e){s=!0;break}s||0!==this.overrideChat||this.addMessage(4,"wishes to trade with you.",i)}else if(t.endsWith(":duelreq:")){const i=t.substring(0,t.indexOf(":"));e=B.toBase37(i);let s=!1;for(let t=0;t<this.ignoreCount;t++)if(this.ignoreName37[t]===e){s=!0;break}s||0!==this.overrideChat||this.addMessage(8,"wishes to duel with you.",i)}else this.addMessage(0,t,"");return this.packetType=-1,!0}if(46===this.packetType){const t=this.in.g2,e=this.in.g2,i=this.in.g2,s=k.get(e);return P.instances[t].model=s.getInterfaceModel(50),P.instances[t].xan=s.xan2d,P.instances[t].yan=s.yan2d,P.instances[t].zoom=Math.trunc(100*s.zoom2d/i),this.packetType=-1,!0}if(168===this.packetType){const t=this.in.g2;return this.resetInterfaceAnimation(t),-1!==this.sidebarInterfaceId&&(this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0),-1!==this.chatInterfaceId&&(this.chatInterfaceId=-1,this.redrawChatback=!0),this.chatbackInputOpen&&(this.chatbackInputOpen=!1,this.redrawChatback=!0),this.viewportInterfaceId=t,this.pressedContinueOption=!1,this.packetType=-1,!0}if(2===this.packetType){const t=this.in.g2,e=this.in.g2,i=e>>10&31,s=e>>5&31,a=31&e;return P.instances[t].colour=(i<<19)+(s<<11)+(a<<3),this.packetType=-1,!0}if(136===this.packetType){for(let t=0;t<this.players.length;t++){const e=this.players[t];e&&(e.primarySeqId=-1)}for(let t=0;t<this.npcs.length;t++){const e=this.npcs[t];e&&(e.primarySeqId=-1)}return this.packetType=-1,!0}if(26===this.packetType){const t=this.in.g2;return P.instances[t].hide=1===this.in.g1,this.packetType=-1,!0}if(21===this.packetType){this.ignoreCount=Math.trunc(this.packetSize/8);for(let t=0;t<this.ignoreCount;t++)this.ignoreName37[t]=this.in.g8;return this.packetType=-1,!0}if(239===this.packetType){this.cutscene=!1;for(let t=0;t<5;t++)this.cameraModifierEnabled[t]=!1;return this.packetType=-1,!0}if(129===this.packetType)return-1!==this.sidebarInterfaceId&&(this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0),-1!==this.chatInterfaceId&&(this.chatInterfaceId=-1,this.redrawChatback=!0),this.chatbackInputOpen&&(this.chatbackInputOpen=!1,this.redrawChatback=!0),this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.packetType=-1,!0;if(201===this.packetType){const t=this.in.g2;return P.instances[t].text=this.in.gjstr,P.instances[t].layer===this.tabInterfaceId[this.selectedTab]&&(this.redrawSidebar=!0),this.packetType=-1,!0}if(44===this.packetType){this.redrawSidebar=!0;const t=this.in.g1,e=this.in.g4,i=this.in.g1;this.skillExperience[t]=e,this.skillLevel[t]=i,this.skillBaseLevel[t]=1;for(let i=0;i<98;i++)e>=this.levelExperience[i]&&(this.skillBaseLevel[t]=i+2);return this.packetType=-1,!0}if(162===this.packetType){for(this.baseX=this.in.g1,this.baseZ=this.in.g1;this.in.pos<this.packetSize;)this.in.g1;return this.packetType=-1,!0}if(22===this.packetType)return 12===this.selectedTab&&(this.redrawSidebar=!0),this.weightCarried=this.in.g2b,this.packetType=-1,!0;if(13===this.packetType){const t=this.in.g1,e=this.in.g1,i=this.in.g1,s=this.in.g1;return this.cameraModifierEnabled[t]=!0,this.cameraModifierJitter[t]=e,this.cameraModifierWobbleScale[t]=i,this.cameraModifierWobbleSpeed[t]=s,this.cameraModifierCycle[t]=0,this.packetType=-1,!0}if(213===this.packetType){this.redrawSidebar=!0;const t=this.in.g2,e=P.instances[t];for(;this.in.pos<this.packetSize;){const t=this.in.g1,i=this.in.g2;let s=this.in.g1;255===s&&(s=this.in.g4),e.invSlotObjId&&e.invSlotObjCount&&t>=0&&t<e.invSlotObjId.length&&(e.invSlotObjId[t]=i,e.invSlotObjCount[t]=s)}return this.packetType=-1,!0}if(184===this.packetType)return this.readPlayerInfo(this.in,this.packetSize),1===this.sceneState&&(this.sceneState=2,mt.levelBuilt=this.currentLevel,this.buildScene()),gt.LOW_MEMORY&&2===this.sceneState&&mt.levelBuilt!==this.currentLevel&&(this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",0),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",16777215),this.areaViewport?.draw(8,11),mt.levelBuilt=this.currentLevel,this.buildScene()),this.currentLevel!==this.minimapLevel&&2===this.sceneState&&(this.minimapLevel=this.currentLevel,this.createMinimap(this.currentLevel)),this.packetType=-1,!0;this.logout()}catch(t){console.log(t),await this.tryReconnect()}return!0};buildScene=()=>{try{this.minimapLevel=-1,this.temporaryLocs.clear(),this.locList.clear(),this.spotanims.clear(),this.projectiles.clear(),A.clearTexels(),this.clearCaches(),this.scene?.reset();for(let t=0;t<4;t++)this.levelCollisionMap[t]?.reset();this.areaViewport?.bind()}catch(t){}m.modelCacheStatic?.clear(),A.initPool(20)};createMinimap=t=>{};resetInterfaceAnimation=t=>{const e=P.instances[t];if(e.childId)for(let t=0;t<e.childId.length&&-1!==e.childId[t];t++){const i=P.instances[e.childId[t]];1===i.type&&this.resetInterfaceAnimation(i.id),i.seqFrame=0,i.seqCycle=0}};initializeLevelExperience=()=>{let t=0;for(let e=0;e<99;e++){const i=e+1;t+=Math.trunc(i+300*Math.pow(2,i/7)),this.levelExperience[e]=Math.trunc(t/4)}};addMessage=(t,e,i)=>{console.log(`${t}, ${e}, ${i}, ${this.stickyChatInterfaceId}`),0===t&&-1!==this.stickyChatInterfaceId&&(this.modalMessage=e,this.mouseClickButton=0),-1===this.chatInterfaceId&&(this.redrawChatback=!0);for(let t=99;t>0;t--)this.messageType[t]=this.messageType[t-1],this.messageSender[t]=this.messageSender[t-1],this.messageText[t]=this.messageText[t-1];this.messageType[0]=t,this.messageSender[0]=i,this.messageText[0]=e};updateVarp=t=>{const e=R.instances[t].clientcode;if(0!==e){const i=this.varps[t];1===e&&(1===i&&A.setBrightness(.9),2===i&&A.setBrightness(.8),3===i&&A.setBrightness(.7),4===i&&A.setBrightness(.6),k.iconCache?.clear(),this.redrawTitleBackground=!0),5===e&&(this.mouseButtonsOption=i),8===e&&(this.splitPrivateChat=i,this.redrawChatback=!0)}};handleChatMouseInput=(t,e)=>{};handleInterfaceInput=(t,e,i,s,a,r)=>{if(0!==t.type||!t.childId||t.hide||e<s||i<a||e>s+t.width||i>a+t.height||!t.childX||!t.childY)return;const n=t.childId.length;for(let h=0;h<n;h++){let n=t.childX[h]+s,o=t.childY[h]+a-r;const l=P.instances[t.childId[h]];if(n+=l.x,o+=l.y,(l.overLayer>=0||0!==l.overColour)&&e>=n&&i>=o&&e<n+l.width&&i<o+l.height&&(l.overLayer>=0?this.lastHoveredInterfaceId=l.overLayer:this.lastHoveredInterfaceId=l.id),0===l.type)this.handleInterfaceInput(l,e,i,n,o,l.scrollPosition),l.scroll>l.height&&this.handleScrollInput(e,i,l.scroll,l.height,!0,n+l.width,o,l);else if(2===l.type){let t=0;for(let s=0;s<l.height;s++)for(let a=0;a<l.width;a++){let r=n+a*(l.marginX+32),h=o+s*(l.marginY+32);if(t<20&&l.invSlotOffsetX&&l.invSlotOffsetY&&(r+=l.invSlotOffsetX[t],h+=l.invSlotOffsetY[t]),e<r||i<h||e>=r+32||i>=h+32){t++;continue}if(this.hoveredSlot=t,this.hoveredSlotParentId=l.id,!l.invSlotObjId||l.invSlotObjId[t]<=0){t++;continue}const c=k.get(l.invSlotObjId[t]-1);if(1===this.objSelected&&l.interactable)l.id===this.objSelectedInterface&&t===this.objSelectedSlot||(this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+c.name,this.menuAction[this.menuSize]=881,this.menuParamA[this.menuSize]=c.index,this.menuParamB[this.menuSize]=t,this.menuParamC[this.menuSize]=l.id,this.menuSize++);else if(1===this.spellSelected&&l.interactable)16==(16&this.activeSpellFlags)&&(this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+c.name,this.menuAction[this.menuSize]=391,this.menuParamA[this.menuSize]=c.index,this.menuParamB[this.menuSize]=t,this.menuParamC[this.menuSize]=l.id,this.menuSize++);else{if(l.interactable)for(let e=4;e>=3;e--)c.iops&&c.iops[e]?(this.menuOption[this.menuSize]=c.iops[e]+" @lre@"+c.name,3===e?this.menuAction[this.menuSize]=478:4===e&&(this.menuAction[this.menuSize]=347),this.menuParamA[this.menuSize]=c.index,this.menuParamB[this.menuSize]=t,this.menuParamC[this.menuSize]=l.id,this.menuSize++):4===e&&(this.menuOption[this.menuSize]="Drop @lre@"+c.name,this.menuAction[this.menuSize]=347,this.menuParamA[this.menuSize]=c.index,this.menuParamB[this.menuSize]=t,this.menuParamC[this.menuSize]=l.id,this.menuSize++);if(l.usable&&(this.menuOption[this.menuSize]="Use @lre@"+c.name,this.menuAction[this.menuSize]=188,this.menuParamA[this.menuSize]=c.index,this.menuParamB[this.menuSize]=t,this.menuParamC[this.menuSize]=l.id,this.menuSize++),l.interactable&&c.iops)for(let e=2;e>=0;e--)c.iops[e]&&(this.menuOption[this.menuSize]=c.iops[e]+" @lre@"+c.name,0===e?this.menuAction[this.menuSize]=405:1===e?this.menuAction[this.menuSize]=38:2===e&&(this.menuAction[this.menuSize]=422),this.menuParamA[this.menuSize]=c.index,this.menuParamB[this.menuSize]=t,this.menuParamC[this.menuSize]=l.id,this.menuSize++);if(l.iops)for(let e=4;e>=0;e--)l.iops[e]&&(this.menuOption[this.menuSize]=l.iops[e]+" @lre@"+c.name,0===e?this.menuAction[this.menuSize]=602:1===e?this.menuAction[this.menuSize]=596:2===e?this.menuAction[this.menuSize]=22:3===e?this.menuAction[this.menuSize]=892:4===e&&(this.menuAction[this.menuSize]=415),this.menuParamA[this.menuSize]=c.index,this.menuParamB[this.menuSize]=t,this.menuParamC[this.menuSize]=l.id,this.menuSize++);this.menuOption[this.menuSize]="Examine @lre@"+c.name,this.menuAction[this.menuSize]=1773,this.menuParamA[this.menuSize]=c.index,l.invSlotObjCount&&(this.menuParamC[this.menuSize]=l.invSlotObjCount[t]),this.menuSize++}t++}}else if(e>=n&&i>=o&&e<n+l.width&&i<o+l.height)if(l.buttonType===P.BUTTON_OK){let t=!1;0!==l.clientCode&&(t=this.handleSocialMenuOption(l)),!t&&l.option&&(this.menuOption[this.menuSize]=l.option,this.menuAction[this.menuSize]=951,this.menuParamC[this.menuSize]=l.id,this.menuSize++)}else if(l.buttonType===P.BUTTON_TARGET&&0===this.spellSelected){let t=l.actionVerb;t&&-1!==t.indexOf(" ")&&(t=t.substring(0,t.indexOf(" "))),this.menuOption[this.menuSize]=t+" @gre@"+l.action,this.menuAction[this.menuSize]=930,this.menuParamC[this.menuSize]=l.id,this.menuSize++}else l.buttonType===P.BUTTON_CLOSE?(this.menuOption[this.menuSize]="Close",this.menuAction[this.menuSize]=947,this.menuParamC[this.menuSize]=l.id,this.menuSize++):l.buttonType===P.BUTTON_TOGGLE&&l.option?(this.menuOption[this.menuSize]=l.option,this.menuAction[this.menuSize]=465,this.menuParamC[this.menuSize]=l.id,this.menuSize++):l.buttonType===P.BUTTON_SELECT&&l.option?(this.menuOption[this.menuSize]=l.option,this.menuAction[this.menuSize]=960,this.menuParamC[this.menuSize]=l.id,this.menuSize++):l.buttonType===P.BUTTON_CONTINUE&&!this.pressedContinueOption&&l.option&&(this.menuOption[this.menuSize]=l.option,this.menuAction[this.menuSize]=44,this.menuParamC[this.menuSize]=l.id,this.menuSize++)}};handleSocialMenuOption=t=>{let e=t.clientCode;return e>=P.CC_FRIENDS_START&&e<=P.CC_FRIENDS_UPDATE_END?(e>=P.CC_FRIENDS_UPDATE_START?e-=P.CC_FRIENDS_UPDATE_START:e--,this.menuOption[this.menuSize]="Remove @whi@"+this.friendName[e],this.menuAction[this.menuSize]=557,this.menuSize++,this.menuOption[this.menuSize]="Message @whi@"+this.friendName[e],this.menuAction[this.menuSize]=679,this.menuSize++,!0):e>=P.CC_IGNORES_START&&e<=P.CC_IGNORES_END&&(this.menuOption[this.menuSize]="Remove @whi@"+t.text,this.menuAction[this.menuSize]=556,this.menuSize++,!0)};handleViewportOptions=()=>{0===this.objSelected&&0===this.spellSelected&&(this.menuOption[this.menuSize]="Walk here",this.menuAction[this.menuSize]=660,this.menuParamB[this.menuSize]=this.mouseX,this.menuParamC[this.menuSize]=this.mouseY,this.menuSize++)};handleInput=()=>{if(0===this.objDragArea){this.menuOption[0]="Cancel",this.menuAction[0]=1252,this.menuSize=1,this.lastHoveredInterfaceId=0,this.mouseX>8&&this.mouseY>11&&this.mouseX<520&&this.mouseY<345&&(-1===this.viewportInterfaceId?this.handleViewportOptions():this.handleInterfaceInput(P.instances[this.viewportInterfaceId],this.mouseX,this.mouseY,8,11,0)),this.lastHoveredInterfaceId!==this.viewportHoveredInterfaceIndex&&(this.viewportHoveredInterfaceIndex=this.lastHoveredInterfaceId),this.lastHoveredInterfaceId=0,this.mouseX>562&&this.mouseY>231&&this.mouseX<752&&this.mouseY<492&&(-1!==this.sidebarInterfaceId?this.handleInterfaceInput(P.instances[this.sidebarInterfaceId],this.mouseX,this.mouseY,562,231,0):-1!==this.tabInterfaceId[this.selectedTab]&&this.handleInterfaceInput(P.instances[this.tabInterfaceId[this.selectedTab]],this.mouseX,this.mouseY,562,231,0)),this.lastHoveredInterfaceId!==this.sidebarHoveredInterfaceIndex&&(this.redrawSidebar=!0,this.sidebarHoveredInterfaceIndex=this.lastHoveredInterfaceId),this.lastHoveredInterfaceId=0,this.mouseX>22&&this.mouseY>375&&this.mouseX<431&&this.mouseY<471&&(-1===this.chatInterfaceId?this.handleChatMouseInput(this.mouseX-22,this.mouseY-375):this.handleInterfaceInput(P.instances[this.chatInterfaceId],this.mouseX,this.mouseY,22,375,0)),-1!==this.chatInterfaceId&&this.lastHoveredInterfaceId!==this.chatHoveredInterfaceIndex&&(this.redrawChatback=!0,this.chatHoveredInterfaceIndex=this.lastHoveredInterfaceId);let t=!1;for(;!t;){t=!0;for(let e=0;e<this.menuSize-1;e++)if(this.menuAction[e]<1e3&&this.menuAction[e+1]>1e3){const i=this.menuOption[e];this.menuOption[e]=this.menuOption[e+1],this.menuOption[e+1]=i;const s=this.menuAction[e];this.menuAction[e]=this.menuAction[e+1],this.menuAction[e+1]=s;const a=this.menuParamB[e];this.menuParamB[e]=this.menuParamB[e+1],this.menuParamB[e+1]=a;const r=this.menuParamC[e];this.menuParamC[e]=this.menuParamC[e+1],this.menuParamC[e+1]=r;const n=this.menuParamA[e];this.menuParamA[e]=this.menuParamA[e+1],this.menuParamA[e+1]=n,t=!1}}}};showContextMenu=()=>{let t=0;if(this.fontBold12){let e;t=this.fontBold12.stringWidth("Choose Option");for(let i=0;i<this.menuSize;i++)e=this.fontBold12.stringWidth(this.menuOption[i]),e>t&&(t=e)}t+=8;const e=15*this.menuSize+21;let i,s;this.mouseClickX>8&&this.mouseClickY>11&&this.mouseClickX<520&&this.mouseClickY<345&&(i=this.mouseClickX-Math.trunc(t/2)-8,i+t>512?i=512-t:i<0&&(i=0),s=this.mouseClickY-11,s+e>334?s=334-e:s<0&&(s=0),this.menuVisible=!0,this.menuArea=0,this.menuX=i,this.menuY=s,this.menuWidth=t,this.menuHeight=15*this.menuSize+22),this.mouseClickX>562&&this.mouseClickY>231&&this.mouseClickX<752&&this.mouseClickY<492&&(i=this.mouseClickX-Math.trunc(t/2)-562,i<0?i=0:i+t>190&&(i=190-t),s=this.mouseClickY-231,s<0?s=0:s+e>261&&(s=261-e),this.menuVisible=!0,this.menuArea=1,this.menuX=i,this.menuY=s,this.menuWidth=t,this.menuHeight=15*this.menuSize+22),this.mouseClickX>22&&this.mouseClickY>375&&this.mouseClickX<501&&this.mouseClickY<471&&(i=this.mouseClickX-Math.trunc(t/2)-22,i<0?i=0:i+t>479&&(i=479-t),s=this.mouseClickY-375,s<0?s=0:s+e>96&&(s=96-e),this.menuVisible=!0,this.menuArea=2,this.menuX=i,this.menuY=s,this.menuWidth=t,this.menuHeight=15*this.menuSize+22)};tryMove=(t,e,i,s,a,r,n,h,o,l,c)=>{const d=this.levelCollisionMap[this.currentLevel];if(!d)return!1;for(let t=0;t<104;t++)for(let e=0;e<104;e++){const i=lt.index(t,e);this.bfsDirection[i]=0,this.bfsCost[i]=99999999}let f=t,u=e;const p=lt.index(t,e);this.bfsDirection[p]=99,this.bfsCost[p]=0;let m=0,g=0;this.bfsStepX[m]=t,this.bfsStepZ[m++]=e;let w=!1,y=this.bfsStepX.length;const C=d.flags;for(;g!==m;){if(f=this.bfsStepX[g],u=this.bfsStepZ[g],g=(g+1)%y,f===i&&u===s){w=!0;break}if(0!==o){if((o<5||10===o)&&d.reachedWall(f,u,i,s,o-1,h)){w=!0;break}if(o<10&&d.reachedWallDecoration(f,u,i,s,o-1,h)){w=!0;break}}if(0!==r&&0!==n&&d.reachedLoc(f,u,i,s,r,n,l)){w=!0;break}const t=this.bfsCost[lt.index(f,u)]+1;let e=lt.index(f-1,u);f>0&&0===this.bfsDirection[e]&&0==(C[e]&st.BLOCK_WEST)&&(this.bfsStepX[m]=f-1,this.bfsStepZ[m]=u,m=(m+1)%y,this.bfsDirection[e]=2,this.bfsCost[e]=t),e=lt.index(f+1,u),f<103&&0===this.bfsDirection[e]&&0==(C[e]&st.BLOCK_EAST)&&(this.bfsStepX[m]=f+1,this.bfsStepZ[m]=u,m=(m+1)%y,this.bfsDirection[e]=8,this.bfsCost[e]=t),e=lt.index(f,u-1),u>0&&0===this.bfsDirection[e]&&0==(C[e]&st.BLOCK_SOUTH)&&(this.bfsStepX[m]=f,this.bfsStepZ[m]=u-1,m=(m+1)%y,this.bfsDirection[e]=1,this.bfsCost[e]=t),e=lt.index(f,u+1),u<103&&0===this.bfsDirection[e]&&0==(C[e]&st.BLOCK_NORTH)&&(this.bfsStepX[m]=f,this.bfsStepZ[m]=u+1,m=(m+1)%y,this.bfsDirection[e]=4,this.bfsCost[e]=t),e=lt.index(f-1,u-1),f>0&&u>0&&0===this.bfsDirection[e]&&0==(C[e]&st.BLOCK_SOUTH_WEST)&&0==(C[lt.index(f-1,u)]&st.BLOCK_WEST)&&0==(C[lt.index(f,u-1)]&st.BLOCK_SOUTH)&&(this.bfsStepX[m]=f-1,this.bfsStepZ[m]=u-1,m=(m+1)%y,this.bfsDirection[e]=3,this.bfsCost[e]=t),e=lt.index(f+1,u-1),f<103&&u>0&&0===this.bfsDirection[e]&&0==(C[e]&st.BLOCK_SOUTH_EAST)&&0==(C[lt.index(f+1,u)]&st.BLOCK_EAST)&&0==(C[lt.index(f,u-1)]&st.BLOCK_SOUTH)&&(this.bfsStepX[m]=f+1,this.bfsStepZ[m]=u-1,m=(m+1)%y,this.bfsDirection[e]=9,this.bfsCost[e]=t),e=lt.index(f-1,u+1),f>0&&u<103&&0===this.bfsDirection[e]&&0==(C[e]&st.BLOCK_NORTH_WEST)&&0==(C[lt.index(f-1,u)]&st.BLOCK_WEST)&&0==(C[lt.index(f,u+1)]&st.BLOCK_NORTH)&&(this.bfsStepX[m]=f-1,this.bfsStepZ[m]=u+1,m=(m+1)%y,this.bfsDirection[e]=6,this.bfsCost[e]=t),e=lt.index(f+1,u+1),f<103&&u<103&&0===this.bfsDirection[e]&&0==(C[e]&st.BLOCK_NORTH_EAST)&&0==(C[lt.index(f+1,u)]&st.BLOCK_EAST)&&0==(C[lt.index(f,u+1)]&st.BLOCK_NORTH)&&(this.bfsStepX[m]=f+1,this.bfsStepZ[m]=u+1,m=(m+1)%y,this.bfsDirection[e]=12,this.bfsCost[e]=t)}if(this.tryMoveNearest=0,!w){if(c){let t=100;for(let e=1;e<2;e++){for(let a=i-e;a<=i+e;a++)for(let i=s-e;i<=s+e;i++){const e=lt.index(a,i);a>=0&&i>=0&&a<104&&i<104&&this.bfsCost[e]<t&&(t=this.bfsCost[e],f=a,u=i,this.tryMoveNearest=1,w=!0)}if(w)break}}if(!w)return!1}g=0,this.bfsStepX[g]=f,this.bfsStepZ[g++]=u;let b=this.bfsDirection[lt.index(f,u)],S=b;for(;f!==t||u!==e;)S!==b&&(b=S,this.bfsStepX[g]=f,this.bfsStepZ[g++]=u),0!=(2&S)?f++:0!=(8&S)&&f--,0!=(1&S)?u++:0!=(4&S)&&u--,S=this.bfsDirection[lt.index(f,u)];if(g>0){y=Math.min(g,25),g--;const t=this.bfsStepX[g],e=this.bfsStepZ[g];0===a?(this.out.p1isaac(181),this.out.p1(y+y+3)):1===a?(this.out.p1isaac(165),this.out.p1(y+y+3+14)):2===a&&(this.out.p1isaac(93),this.out.p1(y+y+3)),1===this.actionKey[5]?this.out.p1(1):this.out.p1(0),this.out.p2(t+this.sceneBaseTileX),this.out.p2(e+this.sceneBaseTileZ),this.flagSceneTileX=this.bfsStepX[0],this.flagSceneTileZ=this.bfsStepZ[0];for(let i=1;i<y;i++)g--,this.out.p1(this.bfsStepX[g]-t),this.out.p1(this.bfsStepZ[g]-e);return!0}return 1!==a};readPlayerInfo=(t,e)=>{this.entityRemovalCount=0,this.entityUpdateCount=0,this.readLocalPlayer(t,e),this.readPlayers(t,e),this.readNewPlayers(t,e),this.readPlayerUpdates(t,e);for(let t=0;t<this.entityRemovalCount;t++){const e=this.entityRemovalIds[t],i=this.players[e];i&&i.cycle!=this.loopCycle&&(this.players[e]=null)}if(t.pos!=e)throw new Error(`eek! Error packet size mismatch in getplayer pos:${t.pos} psize:${e}`);for(let t=0;t<this.playerCount;t++)if(null==this.players[this.playerIds[t]])throw new Error(`eek! ${this.username} null entry in pl list - pos:${t} size:${this.playerCount}`)};readLocalPlayer=(t,e)=>{if(t.bits(),0!=t.gBit(1)){const e=t.gBit(2);if(0==e)this.entityUpdateIds[this.entityUpdateCount++]=this.LOCAL_PLAYER_INDEX;else if(1==e){const e=t.gBit(3);this.localPlayer?.step(!1,e),1==t.gBit(1)&&(this.entityUpdateIds[this.entityUpdateCount++]=this.LOCAL_PLAYER_INDEX)}else if(2==e){const e=t.gBit(3);this.localPlayer?.step(!0,e);const i=t.gBit(3);this.localPlayer?.step(!0,i),1==t.gBit(1)&&(this.entityUpdateIds[this.entityUpdateCount++]=this.LOCAL_PLAYER_INDEX)}else if(3==e){this.currentLevel=t.gBit(2);const e=t.gBit(7),i=t.gBit(7),s=t.gBit(1);this.localPlayer?.move(1==s,e,i),1==t.gBit(1)&&(this.entityUpdateIds[this.entityUpdateCount++]=this.LOCAL_PLAYER_INDEX)}}};readPlayers=(t,e)=>{const i=t.gBit(8);if(i<this.playerCount)for(let t=i;t<this.playerCount;t++)this.entityRemovalIds[this.entityRemovalCount++]=this.playerIds[t];if(i>this.playerCount)throw new Error(`eek! ${this.username} Too many players`);this.playerCount=0;for(let e=0;e<i;e++){const i=this.playerIds[e],s=this.players[i];if(0==t.gBit(1))this.playerIds[this.playerCount++]=i,s&&(s.cycle=this.loopCycle);else{const e=t.gBit(2);if(0==e)this.playerIds[this.playerCount++]=i,s&&(s.cycle=this.loopCycle),this.entityUpdateIds[this.entityUpdateCount++]=i;else if(1==e){this.playerIds[this.playerCount++]=i,s&&(s.cycle=this.loopCycle);const e=t.gBit(3);s?.step(!1,e),1==t.gBit(1)&&(this.entityUpdateIds[this.entityUpdateCount++]=i)}else if(2==e){this.playerIds[this.playerCount++]=i,s&&(s.cycle=this.loopCycle);const e=t.gBit(3);s?.step(!0,e);const a=t.gBit(3);s?.step(!0,a),1==t.gBit(1)&&(this.entityUpdateIds[this.entityUpdateCount++]=i)}else 3==e&&(this.entityRemovalIds[this.entityRemovalCount++]=i)}}};readNewPlayers=(t,e)=>{let i;for(;t.bitPos+10<8*e&&(i=t.gBit(11),2047!=i);){if(null==this.players[i]){this.players[i]=new ft;const t=this.playerAppearanceBuffer[i];t&&this.players[i]?.read(t)}this.playerIds[this.playerCount++]=i;const e=this.players[i];e&&(e.cycle=this.loopCycle);let s=t.gBit(5);s>15&&(s-=32);let a=t.gBit(5);a>15&&(a-=32);const r=t.gBit(1);this.localPlayer&&e?.move(1==r,this.localPlayer.pathTileX[0]+s,this.localPlayer.pathTileZ[0]+a),1==t.gBit(1)&&(this.entityUpdateIds[this.entityUpdateCount++]=i)}t.bytes()};readPlayerUpdates=(t,e)=>{for(let e=0;e<this.entityUpdateCount;e++){const i=this.entityUpdateIds[e],s=this.players[i];if(!s)continue;let a=t.g1;128==(128&a)&&(a+=t.g1<<8),this.readPlayerUpdatesBlocks(s,i,a,t)}};readPlayerUpdatesBlocks=(t,e,i,s)=>{if(t.lastMask=i,t.lastMaskCycle=this.loopCycle,1==(1&i)){const i=s.g1,a=new Uint8Array(i),r=new o(a);s.gdata(i,0,a),this.playerAppearanceBuffer[e]=r,t.read(r)}if(2==(2&i)){let e=s.g2;65535==e&&(e=-1),e==t.primarySeqId&&(t.primarySeqLoop=0);const i=s.g1;(-1==e||-1==t.primarySeqId||d.instances[e].priority>d.instances[t.primarySeqId].priority||0==d.instances[t.primarySeqId].priority)&&(t.primarySeqId=e,t.primarySeqFrame=0,t.primarySeqCycle=0,t.primarySeqDelay=i,t.primarySeqLoop=0)}if(4==(4&i)&&(t.targetId=s.g2,65535==t.targetId&&(t.targetId=-1)),8==(8&i)&&(t.chat=s.gjstr,t.chatColor=0,t.chatStyle=0,t.chatTimer=150,t.name&&this.addMessage(2,t.chat,t.name)),16==(16&i)&&(t.damage=s.g1,t.damageType=s.g1,t.combatCycle=this.loopCycle+400,t.health=s.g1,t.totalHealth=s.g1),32==(32&i)&&(t.targetTileX=s.g2,t.targetTileZ=s.g2,t.lastFaceX=t.targetTileX,t.lastFaceZ=t.targetTileZ),64==(64&i)){const e=s.g2,i=s.g1,a=s.g1,r=s.pos;if(null!=t.name){const r=B.toBase37(t.name);let n=!1;if(i<=1)for(let t=0;t<this.ignoreCount;t++)if(this.ignoreName37[t]==r){n=!0;break}if(!n&&0==this.overrideChat)try{const r=pt.unpack(s,a),n=U.filter(r);t.chat=n,t.chatColor=e>>8,t.chatStyle=255&e,t.chatTimer=150,console.log(n),i>1?this.addMessage(1,n,t.name):this.addMessage(2,n,t.name)}catch(t){}}s.pos=r+a}if(256==(256&i)){t.spotanimId=s.g2;const e=s.g4;t.spotanimOffset=e>>16,t.spotanimLastCycle=this.loopCycle+(65535&e),t.spotanimFrame=0,t.spotanimCycle=0,t.spotanimLastCycle>this.loopCycle&&(t.spotanimFrame=-1),65535==t.spotanimId&&(t.spotanimId=-1)}512==(512&i)&&(t.forceMoveStartSceneTileX=s.g1,t.forceMoveStartSceneTileZ=s.g1,t.forceMoveEndSceneTileX=s.g1,t.forceMoveEndSceneTileZ=s.g1,t.forceMoveEndCycle=s.g2+this.loopCycle,t.forceMoveStartCycle=s.g2+this.loopCycle,t.forceMoveFaceDirection=s.g1,t.pathLength=0,t.pathTileX[0]=t.forceMoveEndSceneTileX,t.pathTileZ[0]=t.forceMoveEndSceneTileZ)};readNpcInfo=(t,e)=>{this.entityRemovalCount=0,this.entityUpdateCount=0,this.readNpcs(t,e),this.readNewNpcs(t,e),this.readNpcUpdates(t,e);for(let t=0;t<this.entityRemovalCount;t++){const e=this.entityRemovalIds[t],i=this.npcs[e];i&&i.cycle!=this.loopCycle&&(i.type=null,this.npcs[e]=null)}if(t.pos!=e)throw new Error(`eek! ${this.username} size mismatch in getnpcpos - pos:${t.pos} psize:${e}`);for(let t=0;t<this.npcCount;t++)if(null==this.npcs[this.npcIds[t]])throw new Error(`eek! ${this.username} null entry in npc list - pos:${t} size:${this.npcCount}`)};readNpcs=(t,e)=>{t.bits();const i=t.gBit(8);if(i<this.npcCount)for(let t=i;t<this.npcCount;t++)this.entityRemovalIds[this.entityRemovalCount++]=this.npcIds[t];if(i>this.npcCount)throw new Error(`eek! ${this.username} Too many npc!`);this.npcCount=0;for(let e=0;e<i;e++){const i=this.npcIds[e],s=this.npcs[i];if(0==t.gBit(1))this.npcIds[this.npcCount++]=i,s&&(s.cycle=this.loopCycle);else{const e=t.gBit(2);if(0==e)this.npcIds[this.npcCount++]=i,s&&(s.cycle=this.loopCycle),this.entityUpdateIds[this.entityUpdateCount++]=i;else if(1==e){this.npcIds[this.npcCount++]=i,s&&(s.cycle=this.loopCycle);const e=t.gBit(3);s?.step(!1,e),1==t.gBit(1)&&(this.entityUpdateIds[this.entityUpdateCount++]=i)}else if(2==e){this.npcIds[this.npcCount++]=i,s&&(s.cycle=this.loopCycle);const e=t.gBit(3);s?.step(!0,e);const a=t.gBit(3);s?.step(!0,a),1==t.gBit(1)&&(this.entityUpdateIds[this.entityUpdateCount++]=i)}else 3==e&&(this.entityRemovalIds[this.entityRemovalCount++]=i)}}};readNewNpcs=(t,e)=>{for(;t.bitPos+21<8*e;){const e=t.gBit(13);if(8191==e)break;null==this.npcs[e]&&(this.npcs[e]=new ut);const i=this.npcs[e];this.npcIds[this.npcCount++]=e,i?(i.cycle=this.loopCycle,i.type=L.get(t.gBit(11)),i.size=i.type.size,i.seqWalkId=i.type.walkanim,i.seqTurnAroundId=i.type.walkanim_b,i.seqTurnLeftId=i.type.walkanim_r,i.seqTurnRightId=i.type.walkanim_l,i.seqStandId=i.type.readyanim):t.gBit(11);let s=t.gBit(5);s>15&&(s-=32);let a=t.gBit(5);a>15&&(a-=32),this.localPlayer&&i?.move(!1,this.localPlayer.pathTileX[0]+s,this.localPlayer.pathTileZ[0]+a),1==t.gBit(1)&&(this.entityUpdateIds[this.entityUpdateCount++]=e)}t.bytes()};readNpcUpdates=(t,e)=>{for(let e=0;e<this.entityUpdateCount;e++){const i=this.entityUpdateIds[e],s=this.npcs[i];if(!s)continue;const a=t.g1;if(s.lastMask=a,s.lastMaskCycle=this.loopCycle,2==(2&a)){let e=t.g2;65535==e&&(e=-1),e==s.primarySeqId&&(s.primarySeqLoop=0);const i=t.g1;(-1==e||-1==s.primarySeqId||d.instances[e].priority>d.instances[s.primarySeqId].priority||0==d.instances[s.primarySeqId].priority)&&(s.primarySeqId=e,s.primarySeqFrame=0,s.primarySeqCycle=0,s.primarySeqDelay=i,s.primarySeqLoop=0)}if(4==(4&a)&&(s.targetId=t.g2,65535==s.targetId&&(s.targetId=-1)),8==(8&a)&&(s.chat=t.gjstr,s.chatTimer=100),16==(16&a)&&(s.damage=t.g1,s.damageType=t.g1,s.combatCycle=this.loopCycle+400,s.health=t.g1,s.totalHealth=t.g1),32==(32&a)&&(s.type=L.get(t.g2),s.seqWalkId=s.type.walkanim,s.seqTurnAroundId=s.type.walkanim_b,s.seqTurnLeftId=s.type.walkanim_r,s.seqTurnRightId=s.type.walkanim_l,s.seqStandId=s.type.readyanim),64==(64&a)){s.spotanimId=t.g2;const e=t.g4;s.spotanimOffset=e>>16,s.spotanimLastCycle=this.loopCycle+(65535&e),s.spotanimFrame=0,s.spotanimCycle=0,s.spotanimLastCycle>this.loopCycle&&(s.spotanimFrame=-1),65535==s.spotanimId&&(s.spotanimId=-1)}128==(128&a)&&(s.targetTileX=t.g2,s.targetTileZ=t.g2,s.lastFaceX=s.targetTileX,s.lastFaceZ=s.targetTileZ)}};unloadTitle=()=>{this.flameActive=!1,this.flamesInterval&&(clearInterval(this.flamesInterval),this.flamesInterval=null),this.imageTitlebox=null,this.imageTitlebutton=null,this.imageRunes=[],this.flameGradient=null,this.flameGradient0=null,this.flameGradient1=null,this.flameGradient2=null,this.flameBuffer0=null,this.flameBuffer1=null,this.flameBuffer3=null,this.flameBuffer2=null,this.imageFlamesLeft=null,this.imageFlamesRight=null};loadArchive=async(t,i,a,r)=>{let n=5,h=await(this.db?.cacheload(t));if(h&&o.crc32(h)!==a&&(h=void 0),h)return new D(h);for(;!h;){await this.showProgress(r,`Requesting ${i}`);try{h=await s(`${gt.HOST}/${t}${a}`)}catch(t){h=void 0;for(let t=n;t>0;t--)await this.showProgress(r,`Error loading - Will retry in ${t} secs.`),await e(1e3);n*=2,n>60&&(n=60)}}return await(this.db?.cachesave(t,h)),new D(h)};setMidi=async(t,e)=>{const i=await s(`${gt.HOST}/${t.replaceAll(" ","_")}_${e}.mid`);!function(t,e){window._tinyMidiPlay&&window._tinyMidiPlay(t,.75)}(X.decompressBz2(new o(Uint8Array.from(i)).g4,i,i.length,4))};drawError=()=>{if(C.fillStyle="black",C.fillRect(0,0,this.width,this.height),this.setFramerate(1),this.errorLoading){this.flameActive=!1,C.font="bold 16px helvetica, sans-serif",C.textAlign="left",C.fillStyle="yellow";let t=35;C.fillText("Sorry, an error has occured whilst loading RuneScape",30,t),t+=50,C.fillStyle="white",C.fillText("To fix this try the following (in order):",30,t),t+=50,C.font="bold 12px helvetica, sans-serif",C.fillText("1: Try closing ALL open web-browser windows, and reloading",30,t),t+=30,C.fillText("2: Try clearing your web-browsers cache from tools->internet options",30,t),t+=30,C.fillText("3: Try using a different game-world",30,t),t+=30,C.fillText("4: Try rebooting your computer",30,t),t+=30,C.fillText("5: Try selecting a different version of Java from the play-game menu",30,t)}if(this.errorHost&&(this.flameActive=!1,C.font="bold 20px helvetica, sans-serif",C.textAlign="left",C.fillStyle="white",C.fillText("Error - unable to load game!",50,50),C.fillText("To play RuneScape make sure you play from",50,100),C.fillText("https://2004scape.org",50,150)),this.errorStarted){this.flameActive=!1,C.font="bold 13px helvetica, sans-serif",C.textAlign="left",C.fillStyle="yellow";let t=35;C.fillText("Error a copy of RuneScape already appears to be loaded",30,t),t+=50,C.fillStyle="white",C.fillText("To fix this try the following (in order):",30,t),t+=50,C.font="bold 12px helvetica, sans-serif",C.fillText("1: Try closing ALL open web-browser windows, and reloading",30,t),t+=30,C.fillText("2: Try rebooting your computer, and reloading",30,t)}};updateTextures=t=>{if(!gt.LOW_MEMORY){if(A.textureCycle[17]>=t){const t=A.textures[17],e=t.width*t.height-1,i=t.width*this.sceneDelta*2,s=t.pixels,a=this.textureBuffer;for(let t=0;t<=e;t++)a[t]=s[t-i&e];t.pixels=a,this.textureBuffer=s,A.pushTexture(17)}if(A.textureCycle[24]>=t){const t=A.textures[24],e=t.width*t.height-1,i=t.width*this.sceneDelta*2,s=t.pixels,a=this.textureBuffer;for(let t=0;t<=e;t++)a[t]=s[t-i&e];t.pixels=a,this.textureBuffer=s,A.pushTexture(24)}}};updateFlames=()=>{if(this.flameBuffer3&&this.flameBuffer2&&this.flameBuffer0&&this.flameLineOffset){for(let t=10;t<117;t++)Math.trunc(100*Math.random())<50&&(this.flameBuffer3[t+32512]=255);for(let t=0;t<100;t++){const t=Math.trunc(124*Math.random())+2+(Math.trunc(128*Math.random())+128<<7);this.flameBuffer3[t]=192}for(let t=1;t<255;t++)for(let e=1;e<127;e++){const i=e+(t<<7);this.flameBuffer2[i]=Math.trunc((this.flameBuffer3[i-1]+this.flameBuffer3[i+1]+this.flameBuffer3[i-128]+this.flameBuffer3[i+128])/4)}this.flameCycle0+=128,this.flameCycle0>this.flameBuffer0.length&&(this.flameCycle0-=this.flameBuffer0.length,this.updateFlameBuffer(this.imageRunes[Math.trunc(12*Math.random())]));for(let t=1;t<255;t++)for(let e=1;e<127;e++){const i=e+(t<<7);let s=this.flameBuffer2[i+128]-Math.trunc(this.flameBuffer0[i+this.flameCycle0&this.flameBuffer0.length-1]/5);s<0&&(s=0),this.flameBuffer3[i]=s}for(let t=0;t<255;t++)this.flameLineOffset[t]=this.flameLineOffset[t+1];if(this.flameLineOffset[255]=Math.trunc(16*Math.sin(this.loopCycle/14)+14*Math.sin(this.loopCycle/15)+12*Math.sin(this.loopCycle/16)),this.flameGradientCycle0>0&&(this.flameGradientCycle0-=4),this.flameGradientCycle1>0&&(this.flameGradientCycle1-=4),0===this.flameGradientCycle0&&0===this.flameGradientCycle1){const t=Math.trunc(2e3*Math.random());0===t?this.flameGradientCycle0=1024:1===t&&(this.flameGradientCycle1=1024)}}};mix=(t,e,i)=>{const s=256-e;return((16711935&t)*s+(16711935&i)*e&4278255360)+((65280&t)*s+(65280&i)*e&16711680)>>8};drawFlames=()=>{if(!(this.flameGradient&&this.flameGradient0&&this.flameGradient1&&this.flameGradient2&&this.flameLineOffset&&this.flameBuffer3))return;const t=256;if(this.flameGradientCycle0>0)for(let t=0;t<256;t++)this.flameGradientCycle0>768?this.flameGradient[t]=this.mix(this.flameGradient0[t],1024-this.flameGradientCycle0,this.flameGradient1[t]):this.flameGradientCycle0>256?this.flameGradient[t]=this.flameGradient1[t]:this.flameGradient[t]=this.mix(this.flameGradient1[t],256-this.flameGradientCycle0,this.flameGradient0[t]);else if(this.flameGradientCycle1>0)for(let t=0;t<256;t++)this.flameGradientCycle1>768?this.flameGradient[t]=this.mix(this.flameGradient0[t],1024-this.flameGradientCycle1,this.flameGradient2[t]):this.flameGradientCycle1>256?this.flameGradient[t]=this.flameGradient2[t]:this.flameGradient[t]=this.mix(this.flameGradient2[t],256-this.flameGradientCycle1,this.flameGradient0[t]);else for(let t=0;t<256;t++)this.flameGradient[t]=this.flameGradient0[t];for(let t=0;t<33920;t++)this.imageTitle0&&this.imageFlamesLeft&&(this.imageTitle0.pixels[t]=this.imageFlamesLeft.pixels[t]);let e=0,i=1152;for(let s=1;s<255;s++){let a=Math.trunc(this.flameLineOffset[s]*(t-s)/t)+22;a<0&&(a=0),e+=a;for(let t=a;t<128;t++){let t=this.flameBuffer3[e++];if(0===t)i++;else{const e=t,s=256-t;if(t=this.flameGradient[t],this.imageTitle0){const a=this.imageTitle0.pixels[i];this.imageTitle0.pixels[i++]=((16711935&t)*e+(16711935&a)*s&4278255360)+((65280&t)*e+(65280&a)*s&16711680)>>8}}}i+=a}this.imageTitle0?.draw(0,0);for(let t=0;t<33920;t++)this.imageTitle1&&this.imageFlamesRight&&(this.imageTitle1.pixels[t]=this.imageFlamesRight.pixels[t]);e=0,i=1176;for(let s=1;s<255;s++){const a=Math.trunc(this.flameLineOffset[s]*(t-s)/t),r=103-a;i+=a;for(let t=0;t<r;t++){let t=this.flameBuffer3[e++];if(0===t)i++;else{const e=t,s=256-t;if(t=this.flameGradient[t],this.imageTitle1){const a=this.imageTitle1.pixels[i];this.imageTitle1.pixels[i++]=((16711935&t)*e+(16711935&a)*s&4278255360)+((65280&t)*e+(65280&a)*s&16711680)>>8}}}e+=128-r,i+=128-r-a}this.imageTitle1?.draw(661,0)}}console.log("RS2 user client - release #225"),(new gt).run().then((()=>{}))})()})();